# Vision API 料金対策実装ガイド

## 🎯 実装した対策

### 1. レート制限（4段階）
- **日次制限**: 無料2回/日、プレミアム10回/日
- **月次制限（ユーザー）**: 無料10回/月、プレミアム100回/月
- **月次制限（全体）**: 500回/月（約1万円）
- **アラート閾値**: 400回で警告

### 2. 重複防止
- 画像ハッシュで24時間以内の同一画像を検出
- 重複時は前回の解析結果を返す（API呼び出しなし）

### 3. サイズ制限
- 5MB以上の画像は処理前に拒否

### 4. 事前確認
- 無料ユーザーの最後の1回は確認プロンプト表示

### 5. 使用量追跡
- 全使用履歴をDBに記録
- 処理時間、画像サイズも記録

## 💰 コスト計算

| プラン | 1日上限 | 月間上限 | 最大コスト |
|--------|---------|----------|------------|
| 無料 | 2回 | 10回 | 20円/月 |
| プレミアム | 10回 | 100回 | 200円/月 |
| 全体上限 | - | 500回 | 1,000円/月 |

## 📊 管理者向けモニタリング

### API エンドポイント
```bash
curl -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  https://your-domain.com/api/admin/vision-stats
```

### レスポンス例
```json
{
  "current": {
    "today": 45,
    "month": 380,
    "costJPY": 760
  },
  "projected": {
    "monthEnd": 520,
    "costJPY": 1040
  },
  "alerts": [{
    "level": "WARNING",
    "message": "月間使用量が警告レベル（80%）に達しています"
  }]
}
```

## 🚨 緊急停止方法

### 1. 環境変数で無効化
```bash
DISABLE_VISION_API=true
```

### 2. 全体上限を下げる
`lib/vision/rate-limiter.ts`の`LIMITS.GLOBAL.monthly`を変更

### 3. データベースで手動停止
```sql
-- 特定ユーザーの使用を停止
UPDATE users SET vision_disabled = true 
WHERE line_user_id = 'USER_ID';
```

## 📝 必要な環境変数

```env
# 管理者API用トークン
ADMIN_API_TOKEN=secure-random-token-here

# Vision API無効化フラグ（緊急時）
DISABLE_VISION_API=false
```

## 🔄 データベースマイグレーション

```bash
# Supabaseでマイグレーション実行
npx supabase migration up
```

## ⚠️ 注意事項

1. **本番環境では必ずADMIN_API_TOKENを設定**
2. **月初にカウンターがリセットされるため、月初は監視強化**
3. **料金アラートが出たら即座に対応**
4. **プレミアムユーザーも無制限ではない**

## 🔍 トラブルシューティング

### 使用量が急増した場合
1. `/api/admin/vision-stats`で詳細確認
2. 特定ユーザーの異常使用をチェック
3. 必要に応じて個別制限を設定

### APIエラーが頻発する場合
1. Claude APIの状態を確認
2. ログで詳細エラーを確認
3. 一時的にVision機能を無効化

## 📈 今後の改善案

1. **動的料金制限**: 使用状況に応じて自動調整
2. **プリペイド制**: ユーザーが事前に回数を購入
3. **画像圧縮**: 送信前に画像を圧縮して品質とコストのバランス
4. **キャッシュ期間延長**: 人気の画像は長期キャッシュ
5. **代替API**: GPT-4V等の安価な代替手段の検討