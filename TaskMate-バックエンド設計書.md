# TaskMate AI - Renderå´ å®Œå…¨ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸

**æœ€çµ‚æ›´æ–°:** 2025-10-23
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 4.1 (å®Ÿç’°å¢ƒæ¤œè¨¼å®Œäº†ç‰ˆ)
**å¯¾è±¡:** Render (Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³)

---

## ğŸš¨ é‡è¦ãªå¤‰æ›´å±¥æ­´

- **v4.1 (2025-10-23)**: å®Ÿç’°å¢ƒæ¤œè¨¼ã«ã‚ˆã‚‹å®Œå…¨ç…§åˆ
  - **ç’°å¢ƒå¤‰æ•°: 9å€‹ â†’ 24å€‹**ï¼ˆå®ŸRenderç’°å¢ƒã‹ã‚‰15å€‹è¿½åŠ ï¼‰
    - NEXT_PUBLIC_* å¤‰æ•°4å€‹è¿½åŠ 
    - Stripeæ±ºæ¸ˆãƒªãƒ³ã‚¯2å€‹è¿½åŠ 
    - ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚µãƒãƒ¼ãƒˆID 2å€‹è¿½åŠ 
    - ADMIN_API_TOKENã€SUPABASE_SERVICE_KEYç­‰7å€‹è¿½åŠ 
  - **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«: 25+å€‹ â†’ 47å€‹ç¢ºèª**ï¼ˆSupabaseå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèªå®Œäº†ï¼‰
  - **å®Ÿç’°å¢ƒã¨ã®å®Œå…¨ç…§åˆå®Œäº†**ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨å®Ÿè£…ã®ä¹–é›¢ã‚¼ãƒ­ï¼‰

- **v4.0 (2025-10-23)**: å¾¹åº•çš„ãªè¾›å£ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚‹å®Œå…¨æ”¹è¨‚
  - **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«: 15å€‹ â†’ 25+å€‹**ï¼ˆ10å€‹ã®æœªæ–‡æ›¸åŒ–ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ï¼‰
  - **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: 100+å€‹ã‚’å®Œå…¨æ–‡æ›¸åŒ–**
  - **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°ãƒ»ãƒˆãƒªã‚¬ãƒ¼: 10+å€‹ã‚’è¿½åŠ **
  - **ãƒ¡ãƒ¢ãƒªç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°åŒ–**
  - **ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãƒ•ãƒ­ãƒ¼ã®å®Œå…¨æ–‡æ›¸åŒ–**
  - **ç’°å¢ƒå¤‰æ•°ã®å®Œå…¨ãƒªã‚¹ãƒˆåŒ–**ï¼ˆ9å€‹ï¼‰

- **v3.0 (2024-10-23)**: å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã¨ã®ç…§åˆã«ã‚ˆã‚Šå…¨é¢æ”¹è¨‚
  - APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: 4å€‹ â†’ **12å€‹**ã«ä¿®æ­£
  - ä¸»è¦æ©Ÿèƒ½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: **20å€‹ä»¥ä¸Šè¿½åŠ **
  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«: 3å€‹ â†’ **15å€‹ä»¥ä¸Š**ã«æ‹¡å……

---

## ç›®æ¬¡

1. [ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](#1-ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦)
2. [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](#2-æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)
3. [APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Œå…¨ä¸€è¦§](#3-apiã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Œå…¨ä¸€è¦§)
4. [ä¸»è¦æ©Ÿèƒ½ã‚·ã‚¹ãƒ†ãƒ ](#4-ä¸»è¦æ©Ÿèƒ½ã‚·ã‚¹ãƒ†ãƒ )
5. [ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆï¼ˆ100+ï¼‰](#5-ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ100)
6. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#6-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
7. [å¤–éƒ¨APIé€£æº](#7-å¤–éƒ¨apié€£æº)
8. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#8-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
9. [ç’°å¢ƒå¤‰æ•°](#9-ç’°å¢ƒå¤‰æ•°)
10. [ãƒ‡ãƒ—ãƒ­ã‚¤](#10-ãƒ‡ãƒ—ãƒ­ã‚¤)
11. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#11-ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 TaskMate AI ã¨ã¯

**LINE Bot ãƒ™ãƒ¼ã‚¹ã® GASï¼ˆGoogle Apps Scriptï¼‰è‡ªå‹•ç”Ÿæˆ SaaS**

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¥æœ¬èªã§è¦æœ›ã‚’ä¼ãˆã‚‹
- Claude AI ãŒ GAS ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆ
- å…±æœ‰å¯èƒ½ãª URL ã§å³åº§ã«åˆ©ç”¨å¯èƒ½
- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ï¼ˆæœˆé¡10,000å††ï¼‰ã§ç„¡åˆ¶é™åˆ©ç”¨

### 1.2 Render ã®å½¹å‰²

**ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆNext.js 14ï¼‰**

- LINE Bot ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
- Claude AI ã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆVision APIçµ±åˆï¼‰
- Stripe æ±ºæ¸ˆå‡¦ç†
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- **ã‚­ãƒ¥ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ **ï¼ˆãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯æ¤œå‡ºã€ãƒãƒƒã‚¯ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼åˆ¶å¾¡ï¼‰
- **ã‚¨ãƒ©ãƒ¼å›å¾©ã‚·ã‚¹ãƒ†ãƒ **ï¼ˆAIè‡ªå‹•ä¿®æ­£ã€3æ®µéšæˆ¦ç•¥ï¼‰
- **ã‚³ãƒ¼ãƒ‰å…±æœ‰ã‚·ã‚¹ãƒ†ãƒ **ï¼ˆQRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ã€ã‚¢ã‚¯ã‚»ã‚¹è¿½è·¡ï¼‰
- **ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³**ï¼ˆXPã€ãƒ¬ãƒ™ãƒ«ã€8ç¨®é¡ã®ãƒãƒƒã‚¸ï¼‰
- **ãƒ¡ãƒ¢ãƒªç›£è¦–ã‚·ã‚¹ãƒ†ãƒ **ï¼ˆ80%è­¦å‘Šã€90%ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã€è‡ªå‹•GCï¼‰
- **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ **ï¼ˆãƒ•ãƒ«/å¢—åˆ†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰

---

## 2. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| ã‚«ãƒ†ã‚´ãƒª | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|---------|------|----------|------|
| **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯** | Next.js | 14.x | React ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ (App Router) |
| **è¨€èª** | TypeScript | 5.x | å‹å®‰å…¨ãªé–‹ç™º |
| **ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ** | Node.js | 20.x | ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å®Ÿè¡Œ |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | Supabase | 2.x | PostgreSQL + ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  + RLS |
| **AI** | Anthropic Claude | 3.5 Sonnet | ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»Vision APIç”»åƒè§£æ |
| **æ±ºæ¸ˆ** | Stripe | 14.x | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç† |
| **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°** | LINE Messaging API | v2 | ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾è©±ãƒ»Pushé€šçŸ¥ |
| **èªè¨¼** | JWT | - | ç®¡ç†ç”»é¢èªè¨¼ï¼ˆHS256ï¼‰ |
| **ç”»åƒå‡¦ç†** | QRCode.js, Sharp | - | QRç”Ÿæˆï¼ˆPNG/SVGï¼‰ãƒ»ç”»åƒæœ€é©åŒ– |
| **æš—å·åŒ–** | bcrypt, crypto | - | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆsaltRounds:10ï¼‰ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³ |
| **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³** | Zod | 3.x | ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼ |
| **ãƒ¬ãƒ¼ãƒˆåˆ¶é™** | Custom Rate Limiter | - | ãƒ¡ãƒ¢ãƒªãƒ™ãƒ¼ã‚¹ï¼ˆRedisæ¨å¥¨ï¼‰ |

---

## 3. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Œå…¨ä¸€è¦§

### 3.1 LINE Webhook
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:** `POST /api/webhook`
- **å½¹å‰²:** LINE ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ç”»åƒã€ãƒ•ã‚¡ã‚¤ãƒ«ã€Follow/Unfollowï¼‰
- **èªè¨¼:** LINEç½²åæ¤œè¨¼ï¼ˆHMAC-SHA256ï¼‰
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ:** 30ç§’
- **ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«:** `users`, `conversation_sessions`, `generated_codes`, `generation_queue`, `user_experience`, `conversations`, `session_checkpoints`
- **ä¸»è¦æ©Ÿèƒ½:**
  - é‡è¤‡ã‚¤ãƒ™ãƒ³ãƒˆæ¤œå‡ºï¼ˆ10ç§’TTLã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  - ãƒ¡ãƒ¢ãƒªç›£è¦–çµ±åˆï¼ˆèµ·å‹•æ™‚è‡ªå‹•é–‹å§‹ï¼‰
  - RecoveryManagerçµ±åˆï¼ˆã‚¨ãƒ©ãƒ¼å›å¾©ï¼‰
  - CategoryDetectorï¼ˆã‚«ãƒ†ã‚´ãƒªè‡ªå‹•æ¤œå‡ºï¼‰
  - LineImageHandlerï¼ˆç”»åƒBase64å¤‰æ›ï¼‰

### 3.2 ã‚³ãƒ¼ãƒ‰å…±æœ‰API

#### å…±æœ‰URLä½œæˆ
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:** `POST /api/share/create`
- **å½¹å‰²:** ç”Ÿæˆã‚³ãƒ¼ãƒ‰ã®å…±æœ‰URLä½œæˆã€QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
- **èªè¨¼:** ãªã—ï¼ˆrate limit: 5req/miné©ç”¨ï¼‰
- **ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«:** `code_shares`, `user_code_history`, `conversation_code_relations`
- **æ©Ÿèƒ½:**
  - çŸ­ç¸®IDç”Ÿæˆï¼ˆ8æ–‡å­—ã€Base62ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
  - QRã‚³ãƒ¼ãƒ‰è‡ªå‹•ç”Ÿæˆï¼ˆPNG: 256x256pxã€SVG: ãƒ™ã‚¯ã‚¿ãƒ¼ï¼‰
  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ï¼ˆbcryptã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  - é–²è¦§å›æ•°åˆ¶é™ï¼ˆmax_viewsã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  - æœ‰åŠ¹æœŸé™è¨­å®š:
    - ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼: 7æ—¥é–“
    - ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼: 30æ—¥é–“
  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ï¼ˆparent_idå‚ç…§ï¼‰
  - ã‚¿ã‚°æ©Ÿèƒ½ï¼ˆTEXT[]ï¼‰
  - ä¼šè©±ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¿å­˜ï¼ˆJSONBï¼‰

#### å…±æœ‰ã‚³ãƒ¼ãƒ‰å–å¾—
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:** `GET /api/share/[shortId]`
- **å½¹å‰²:** å…±æœ‰ã‚³ãƒ¼ãƒ‰ã®é–²è¦§
- **èªè¨¼:** ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆè¨­å®šæ™‚ã®ã¿ï¼‰
- **ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«:** `code_shares`, `code_share_access_logs`
- **æ©Ÿèƒ½:**
  - é–²è¦§å›æ•°ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ`increment_view_count`é–¢æ•°ï¼‰
  - æœ€å¤§é–²è¦§å›æ•°ãƒã‚§ãƒƒã‚¯
  - æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ï¼ˆexpires_atï¼‰
  - ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨˜éŒ²:
    - IPï¼ˆINETå‹ï¼‰
    - User-Agentè§£æï¼ˆãƒ‡ãƒã‚¤ã‚¹ã€ãƒ–ãƒ©ã‚¦ã‚¶ã€OSï¼‰
    - Referer
    - ã‚¢ã‚¯ã‚»ã‚¹ã‚¿ã‚¤ãƒ—ï¼ˆview/copy/downloadï¼‰
  - è«–ç†å‰Šé™¤ãƒ•ãƒ©ã‚°ç¢ºèªï¼ˆis_deletedï¼‰

#### ã‚³ãƒ”ãƒ¼å›æ•°è¨˜éŒ²
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:** `POST /api/share/[shortId]`
- **å½¹å‰²:** ã‚³ãƒ”ãƒ¼å›æ•°ã®ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
- **ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«:** `code_shares`
- **æ©Ÿèƒ½:** `increment_copy_count`é–¢æ•°å®Ÿè¡Œ

#### å…±æœ‰å‰Šé™¤
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:** `DELETE /api/share/[shortId]`
- **å½¹å‰²:** æ‰€æœ‰è€…ã«ã‚ˆã‚‹å…±æœ‰å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ï¼‰
- **èªè¨¼:** userIdæ¤œè¨¼
- **ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«:** `code_shares`
- **æ©Ÿèƒ½:**
  - is_deleted=trueè¨­å®š
  - deletion_reasonè¨˜éŒ²
  - 7æ—¥å¾Œã«ç‰©ç†å‰Šé™¤ï¼ˆ`cleanup_expired_code_shares`é–¢æ•°ï¼‰

### 3.3 Stripeæ±ºæ¸ˆ

#### Webhookå‡¦ç†
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:** `POST /api/stripe/webhook`
- **å½¹å‰²:** Stripe ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
- **èªè¨¼:** Stripeç½²åæ¤œè¨¼ï¼ˆWebhook Secretï¼‰
- **ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«:** `users`, `stripe_events`, `refunds`, `activation_codes`
- **å‡¦ç†ã‚¤ãƒ™ãƒ³ãƒˆ:**
  - `checkout.session.completed` - æ±ºæ¸ˆå®Œäº†ï¼ˆãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä»˜ä¸ï¼‰
  - `payment_intent.succeeded` - æ±ºæ¸ˆæˆåŠŸ
  - `customer.subscription.updated` - ã‚µãƒ–ã‚¹ã‚¯æ›´æ–°
  - `customer.subscription.deleted` - ã‚µãƒ–ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  - `charge.refunded` - è¿”é‡‘å‡¦ç†ï¼ˆãƒ—ãƒ¬ãƒŸã‚¢ãƒ å–æ¶ˆï¼‰

### 3.4 ç®¡ç†API

#### ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç®¡ç†
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:** `GET/POST/PUT/DELETE /api/admin/premium`
- **å½¹å‰²:** ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
- **èªè¨¼:** JWTï¼ˆAdminæ¨©é™ï¼‰
- **ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«:** `user_states`, `activation_codes`
- **æ©Ÿèƒ½:**
  - ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆSHA-256ãƒãƒƒã‚·ãƒ¥ï¼‰
  - æ‰‹å‹•ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä»˜ä¸ï¼ˆ`activate_premium_plan`é–¢æ•°ï¼‰
  - ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
  - æœ‰åŠ¹æœŸé™ç®¡ç†ï¼ˆpremium_expires_atï¼‰
  - ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½é…åˆ—ï¼ˆJSONB: unlimited_tracking, advanced_analytics, api_access, priority_supportï¼‰

#### ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ç®¡ç†
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:** `GET/POST/PUT/DELETE /api/admin/tracking-links`
- **å½¹å‰²:** ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯CRUD
- **èªè¨¼:** ä»£ç†åº—ã‚³ãƒ¼ãƒ‰
- **ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«:** `tracking_links`, `agency_tracking_links`

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:** `GET /api/admin/sessions`
- **å½¹å‰²:** ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã€CSVå‡ºåŠ›
- **èªè¨¼:** JWT
- **ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«:** `tracking_sessions`, `tracking_links`

#### åˆ†æãƒ‡ãƒ¼ã‚¿
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:** `GET /api/admin/analytics`
- **å½¹å‰²:** ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°åˆ†æãƒ‡ãƒ¼ã‚¿
- **èªè¨¼:** JWT
- **ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«:** `tracking_links`, `tracking_sessions`, `agency_tracking_visits`

#### Visionçµ±è¨ˆ
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:** `GET /api/admin/vision-stats`
- **å½¹å‰²:** Claude Vision API ä½¿ç”¨çµ±è¨ˆ
- **èªè¨¼:** JWTï¼ˆAdminæ¨©é™ï¼‰
- **ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«:** `vision_usage_logs`

### 3.5 Cronã‚¸ãƒ§ãƒ–

#### ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:** `GET /api/cron/cleanup`
- **å½¹å‰²:** å¤ã„ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•å‰Šé™¤
- **èªè¨¼:** `CRON_SECRET`
- **å®Ÿè¡Œé–“éš”:** 1æ—¥1å›ï¼ˆæ·±å¤œ3æ™‚æ¨å¥¨ï¼‰
- **å‰Šé™¤å¯¾è±¡:**
  - 30æ—¥ä»¥ä¸Šå‰ã®å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆ`cleanup_old_conversations`é–¢æ•°ï¼‰
  - æœŸé™åˆ‡ã‚Œã®å…±æœ‰ã‚³ãƒ¼ãƒ‰ï¼ˆ`cleanup_expired_code_shares`é–¢æ•°ï¼‰
  - å®Œäº†/å¤±æ•—ã—ãŸã‚­ãƒ¥ãƒ¼ã‚¸ãƒ§ãƒ–ï¼ˆ7æ—¥ä»¥ä¸Šå‰ï¼‰
  - å¤ã„ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ï¼ˆ90æ—¥ä»¥ä¸Šå‰ï¼‰
  - éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆï¼ˆ7æ—¥ä»¥ä¸Šå‰ï¼‰

#### ã‚­ãƒ¥ãƒ¼å‡¦ç†
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:** `GET /api/cron/process-queue`
- **å½¹å‰²:** éåŒæœŸã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¸ãƒ§ãƒ–ã®å‡¦ç†
- **èªè¨¼:** `CRON_SECRET`
- **å®Ÿè¡Œé–“éš”:** 1åˆ†ã”ã¨
- **å‡¦ç†å†…å®¹:**
  - ä¿ç•™ä¸­ã‚¸ãƒ§ãƒ–ã‚’å„ªå…ˆåº¦é †ã«å–å¾—ï¼ˆæœ€å¤§5ä»¶ï¼‰
  - Claude APIã§ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
  - CodeValidatorã§å“è³ªãƒã‚§ãƒƒã‚¯
  - å•é¡ŒãŒã‚ã‚Œã°AutoFixerã§è‡ªå‹•ä¿®æ­£
  - CodeShareQueriesã§å…±æœ‰URLè‡ªå‹•ç”Ÿæˆ
  - LINEé€šçŸ¥é€ä¿¡
  - ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆ5åˆ†ä»¥ä¸ŠprocessingçŠ¶æ…‹ã®ã‚¸ãƒ§ãƒ–ã‚’pendingã«æˆ»ã™ï¼‰
  - XPä»˜ä¸ï¼ˆ10XPï¼‰
  - ãƒãƒƒã‚¸è§£é™¤åˆ¤å®šï¼ˆ`check_badge_unlock`é–¢æ•°ï¼‰

### 3.6 ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

#### ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:** `GET/HEAD /api/health`
- **å½¹å‰²:** ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- **èªè¨¼:** ãªã—ï¼ˆå…¬é–‹ï¼‰
- **ãƒã‚§ãƒƒã‚¯é …ç›®:**
  - Databaseæ¥ç¶šï¼ˆSupabaseï¼‰
  - Redisæ¥ç¶šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  - LINE APIæ¥ç¶š
  - ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆ9å€‹ï¼‰
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**
```json
{
  "status": "healthy",
  "timestamp": "2025-10-23T21:30:00Z",
  "checks": {
    "database": true,
    "redis": false,
    "lineApi": true,
    "environment": true
  },
  "details": {
    "databaseLatency": 45,
    "memoryUsage": "45%"
  }
}
```

---

## 4. ä¸»è¦æ©Ÿèƒ½ã‚·ã‚¹ãƒ†ãƒ 

### 4.1 âš¡ ã‚­ãƒ¥ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

**ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/queue/manager.ts`, `lib/queue/processor.ts`

#### å½¹å‰²
- **éåŒæœŸã‚³ãƒ¼ãƒ‰ç”Ÿæˆã®å®Œå…¨ç®¡ç†**
- Claude API ã®è² è·åˆ†æ•£
- ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ï¼ˆæœ€å¤§3å›ï¼‰
- ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯è‡ªå‹•æ¤œå‡ºãƒ»è§£é™¤ï¼ˆ5åˆ†é–¾å€¤ï¼‰
- ãƒãƒƒã‚¯ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼åˆ¶å¾¡ï¼ˆæœ€å¤§50ã‚¸ãƒ§ãƒ–ï¼‰
- å„ªå…ˆåº¦ã‚­ãƒ¥ãƒ¼ï¼ˆnormal/highï¼‰

#### ä¸»è¦ã‚¯ãƒ©ã‚¹: QueueManager

```typescript
class QueueManager {
  // ã‚¸ãƒ§ãƒ–è¿½åŠ 
  async addJob(params: {
    userId: string,
    requirements: string,
    priority: 'normal' | 'high',
    sessionId?: string,
    category?: string
  }): Promise<string> // jobId

  // æ¬¡ã®ã‚¸ãƒ§ãƒ–å–å¾—ï¼ˆå„ªå…ˆåº¦é †ï¼‰
  async getNextJobs(limit: number = 5): Promise<Job[]>

  // å¤ã„ã‚¸ãƒ§ãƒ–å‰Šé™¤
  async cleanupOldJobs(days: number = 7): Promise<number>

  // ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯è§£é™¤
  async resolveDeadlocks(): Promise<number>

  // ã‚¸ãƒ§ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
  async updateJobStatus(
    jobId: string,
    status: JobStatus,
    result?: any
  ): Promise<void>
}
```

#### ã‚¸ãƒ§ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»

```
pending â†’ processing â†’ completed âœ“
                     â†˜ failed (retry_count < 3) â†’ pending
                     â†˜ error (retry_count >= 3) â†’ ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```

#### ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯æ¤œå‡º

```typescript
// 5åˆ†ä»¥ä¸Š processing çŠ¶æ…‹ã®ã‚¸ãƒ§ãƒ–ã‚’ pending ã«æˆ»ã™
const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();

await supabase
  .from('generation_queue')
  .update({
    status: 'pending',
    started_at: null,
    metadata: { ...metadata, deadlock_resolved: true, resolved_at: new Date().toISOString() }
  })
  .eq('status', 'processing')
  .lt('started_at', fiveMinutesAgo);
```

#### ãƒãƒƒã‚¯ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼åˆ¶å¾¡

```typescript
// ä¿ç•™ä¸­ã‚¸ãƒ§ãƒ–ãŒ50å€‹ä»¥ä¸Šã®å ´åˆã€æ–°è¦å—ä»˜åœæ­¢
const { count } = await supabase
  .from('generation_queue')
  .select('id', { count: 'exact' })
  .eq('status', 'pending');

if (count >= 50) {
  throw new Error('ã‚­ãƒ¥ãƒ¼ãŒã„ã£ã±ã„ã§ã™ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚');
}
```

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
1. Cronï¼ˆ/api/cron/process-queueï¼‰ãŒ1åˆ†ã”ã¨ã«å®Ÿè¡Œ
2. QueueProcessor.processJobs() å‘¼ã³å‡ºã—
3. å„ªå…ˆåº¦é †ã«ã‚¸ãƒ§ãƒ–ã‚’5ä»¶å–å¾—ï¼ˆhighãŒå„ªå…ˆï¼‰
4. å„ã‚¸ãƒ§ãƒ–ã‚’ä¸¦åˆ—å‡¦ç†:
   a. Claude API ã§ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆ200K tokens limitï¼‰
   b. CodeValidator ã§å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆæ§‹æ–‡ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼‰
   c. å•é¡ŒãŒã‚ã‚Œã°AutoFixerã§è‡ªå‹•ä¿®æ­£
   d. CodeShareQueries ã§å…±æœ‰URLç”Ÿæˆï¼ˆ8æ–‡å­—IDã€QRã‚³ãƒ¼ãƒ‰ï¼‰
   e. LINEé€šçŸ¥é€ä¿¡ï¼ˆFlex Messageï¼‰
   f. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼ˆcompletedï¼‰
   g. XPä»˜ä¸ï¼ˆ10XPï¼‰ã€ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
   h. ãƒãƒƒã‚¸è§£é™¤åˆ¤å®š
5. ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆ++ã€status=failed
6. 3å›å¤±æ•—ã§ status=errorã€engineer_supporté€šçŸ¥
```

#### ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«

**generation_queue**
```sql
CREATE TABLE generation_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL,
  session_id TEXT,
  requirements TEXT NOT NULL,  -- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›
  category TEXT,  -- ã‚«ãƒ†ã‚´ãƒªï¼ˆspreadsheet, calendar, gmailç­‰ï¼‰
  status TEXT DEFAULT 'pending',  -- pending | processing | completed | failed | error
  priority TEXT DEFAULT 'normal',  -- normal | high
  retry_count INT DEFAULT 0,
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  result JSONB,  -- ç”Ÿæˆçµæœï¼ˆã‚³ãƒ¼ãƒ‰ã€å…±æœ‰URLã€QRã‚³ãƒ¼ãƒ‰ï¼‰
  error_message TEXT,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_queue_status_priority ON generation_queue(status, priority DESC, created_at);
CREATE INDEX idx_queue_user_id ON generation_queue(user_id);
CREATE INDEX idx_queue_created_at ON generation_queue(created_at DESC);
```

---

### 4.2 ğŸ”§ ã‚¨ãƒ©ãƒ¼å›å¾©ã‚·ã‚¹ãƒ†ãƒ 

**ãƒ•ã‚¡ã‚¤ãƒ«:**
- `lib/error-recovery/recovery-manager.ts` - çµ±åˆç®¡ç†
- `lib/error-recovery/error-analyzer.ts` - Claude Vision APIè§£æ
- `lib/error-recovery/auto-fixer.ts` - 3æ®µéšä¿®æ­£æˆ¦ç•¥

#### å½¹å‰²
- **ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰ã‚¨ãƒ©ãƒ¼è‡ªå‹•è§£æ**ï¼ˆClaude Vision APIï¼‰
- **3æ®µéšä¿®æ­£æˆ¦ç•¥** - ãƒ‘ã‚¿ãƒ¼ãƒ³â†’AIâ†’ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯
- å­¦ç¿’æ©Ÿèƒ½ï¼ˆæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®è“„ç©ï¼‰
- ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆï¼ˆXP+50ã€ãƒãƒƒã‚¸è§£é™¤ï¼‰
- ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¤å®šï¼ˆ3å›å¤±æ•—ã§äººé–“ã«é€šçŸ¥ï¼‰

#### ä¸»è¦ã‚¯ãƒ©ã‚¹: RecoveryManager

```typescript
class RecoveryManager {
  private errorAnalyzer: ErrorAnalyzer
  private autoFixer: AutoFixer
  private lineClient: LineApiClient

  // ã‚¨ãƒ©ãƒ¼ä¿®å¾©é–‹å§‹
  async startRecovery(
    userId: string,
    sessionId: string,
    originalCode: string,
    errorScreenshotBase64?: string,
    attemptCount: number = 0
  ): Promise<{
    success: boolean
    fixedCode?: string
    message: string
    shouldEscalate: boolean
    recoveryLogId?: number
  }>

  // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè§£æï¼ˆClaude Vision APIï¼‰
  async analyzeErrorFromScreenshot(
    imageBase64: string,
    code: string,
    userId: string
  ): Promise<ErrorAnalysis>

  // é€²æ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  private async sendProgressMessage(
    userId: string,
    attemptCount: number,
    stage: 'analyzing' | 'fixing' | 'testing'
  ): Promise<void>
}
```

#### ErrorAnalysis å‹å®šç¾©

```typescript
interface ErrorAnalysis {
  errorType: string          // ReferenceError, TypeError, SyntaxErrorç­‰
  errorMessage: string        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  errorContext: string        // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
  severity: 'low' | 'medium' | 'high'
  suggestedFixes: string[]    // ä¿®æ­£ææ¡ˆãƒªã‚¹ãƒˆ
  confidence: number          // ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ï¼ˆ0-100ï¼‰
  lineNumber?: number         // ã‚¨ãƒ©ãƒ¼è¡Œç•ªå·
  columnNumber?: number       // ã‚¨ãƒ©ãƒ¼åˆ—ç•ªå·
}
```

#### ä¿®æ­£æˆ¦ç•¥ï¼ˆ3æ®µéšï¼‰

**1. ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ä¿®æ­£**
```typescript
// error_patterns ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æˆåŠŸç‡ã®é«˜ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œç´¢
const { data: patterns } = await supabase
  .from('error_patterns')
  .select('*')
  .eq('error_type', errorType)
  .gte('success_rate', 0.5)  // æˆåŠŸç‡50%ä»¥ä¸Š
  .order('success_rate', { ascending: false })
  .order('usage_count', { ascending: false })
  .limit(5);

// æˆåŠŸç‡ãŒæœ€ã‚‚é«˜ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨
if (patterns && patterns.length > 0) {
  const fixedCode = applyPattern(originalCode, patterns[0].solution_pattern);

  // ä½¿ç”¨å›æ•°ã‚’æ›´æ–°
  await supabase
    .from('error_patterns')
    .update({
      usage_count: patterns[0].usage_count + 1,
      last_used_at: new Date().toISOString()
    })
    .eq('id', patterns[0].id);

  return fixedCode;
}
```

**2. AIä¿®æ­£ï¼ˆClaude 3.5 Sonnetï¼‰**
```typescript
// Claude API ã§ä¿®æ­£
const response = await claudeClient.fixCode({
  code: originalCode,
  error: errorAnalysis,
  previousAttempts: attemptHistory,  // éå»ã®å¤±æ•—å±¥æ­´
  context: {
    category: 'GAS',
    language: 'javascript',
    strictMode: true
  }
});

// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ã‚³ãƒ¼ãƒ‰æŠ½å‡º
const fixedCode = extractCodeFromResponse(response);
```

**3. ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ä¿®æ­£**
```typescript
// ä¸€èˆ¬çš„ãªã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è‡ªå‹•ä¿®æ­£
const heuristicFixes = [
  // ã‚»ãƒŸã‚³ãƒ­ãƒ³æ¬ è½
  {
    pattern: /\n(\s*)(return|var|let|const|if|for|while)/,
    fix: (match) => `;\n${match[1]}${match[2]}`
  },

  // æ‹¬å¼§ã®ä¸ä¸€è‡´
  {
    check: (code) => countBraces(code),
    fix: (code) => balanceBraces(code)
  },

  // æœªå®šç¾©å¤‰æ•°ï¼ˆlet/constè¿½åŠ ï¼‰
  {
    pattern: /(\w+)\s*=\s*(.+);/,
    check: (match, code) => !isDeclared(match[1], code),
    fix: (match) => `let ${match[1]} = ${match[2]};`
  },

  // ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆä¿®æ­£
  {
    fix: (code) => beautify(code, { indent_size: 2 })
  }
];
```

#### ã‚¨ãƒ©ãƒ¼ä¿®å¾©å®Œå…¨ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¨ãƒ©ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’é€ä¿¡
   â†“
2. RecoveryManager.startRecovery() é–‹å§‹
   â†“
3. é€²æ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã€Œã‚¨ãƒ©ãƒ¼ã‚’åˆ†æã—ã¦ã„ã¾ã™...ã€
   â†“
4. Claude Vision APIã§ç”»åƒè§£æ:
   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŠ½å‡ºï¼ˆOCRï¼‰
   - ã‚¨ãƒ©ãƒ¼è¡Œç‰¹å®šï¼ˆè¡Œç•ªå·æ¤œå‡ºï¼‰
   - ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¤å®šï¼ˆReferenceErrorç­‰ï¼‰
   - ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ç®—å‡ºï¼ˆ0-100ï¼‰
   - ä¿®æ­£ææ¡ˆç”Ÿæˆ
   â†“
5. error_recovery_logsã«ãƒ­ã‚°ä½œæˆ
   - original_codeä¿å­˜
   - error_analysis (JSONB)ä¿å­˜
   - detected_error_type, detected_error_messageè¨˜éŒ²
   â†“
6. é€²æ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã€Œä¿®æ­£ã‚’è©¦ã¿ã¦ã„ã¾ã™...ï¼ˆè©¦è¡Œ${attemptCount}/3ï¼‰ã€
   â†“
7. ä¿®æ­£è©¦è¡Œï¼ˆæœ€å¤§3å›ï¼‰:
   ã€ç¬¬1è©¦è¡Œã€‘ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ä¿®æ­£
   â†“ å¤±æ•—
   ã€ç¬¬2è©¦è¡Œã€‘AIä¿®æ­£ï¼ˆClaude APIï¼‰
   â†“ å¤±æ•—
   ã€ç¬¬3è©¦è¡Œã€‘ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ä¿®æ­£
   â†“
8. ä¿®æ­£çµæœåˆ¤å®š:
   â”œâ”€ æˆåŠŸ â†’ æ¬¡ã¸
   â””â”€ å¤±æ•— â†’ retry_count++ã€7ã¸æˆ»ã‚‹ï¼ˆæœ€å¤§3å›ï¼‰
   â†“
9. fixed_code ã‚’error_recovery_logsã«ä¿å­˜
   - fix_methodè¨˜éŒ²ï¼ˆpattern/ai/heuristicï¼‰
   - patternä½¿ç”¨æ™‚ã¯pattern_idè¨˜éŒ²
   â†“
10. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¿®æ­£ã‚³ãƒ¼ãƒ‰é€ä¿¡ï¼ˆFlex Messageï¼‰
    - ä¿®æ­£å†…å®¹èª¬æ˜
    - ä¿®æ­£å‰å¾Œã®å·®åˆ†è¡¨ç¤º
    - å…±æœ‰URL
    â†“
11. ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¾…æ©Ÿ:
    ã€æˆåŠŸã®å ´åˆã€‘
    - is_successful = true
    - success_rate++ (error_patternsãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°)
    - XP+50ä»˜ä¸
    - ãƒãƒƒã‚¸è§£é™¤åˆ¤å®šï¼ˆerror_survivor, error_masterï¼‰
    - ã€Œä¿®æ­£æˆåŠŸï¼+50XPç²å¾—ã€é€šçŸ¥

    ã€å¤±æ•—ã®å ´åˆã€‘
    - is_successful = false
    - fix_attempt_count++
    - retryï¼ˆ7ã¸æˆ»ã‚‹ã€æœ€å¤§3å›ï¼‰
    â†“
12. 3å›å¤±æ•—åˆ¤å®š:
    - shouldEscalate = true
    - ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚µãƒãƒ¼ãƒˆã¸LINEé€šçŸ¥
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œå°‚é–€å®¶ãŒå¯¾å¿œã—ã¾ã™ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    - engineer_support.escalate()å®Ÿè¡Œ
```

#### ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«

**error_patterns**
```sql
CREATE TABLE error_patterns (
  id BIGSERIAL PRIMARY KEY,
  error_type VARCHAR(100) NOT NULL,  -- ReferenceError, TypeErrorç­‰
  error_message TEXT NOT NULL,       -- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ­£è¦è¡¨ç¾å¯ï¼‰
  error_context TEXT,                -- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
  solution_pattern TEXT NOT NULL,    -- ä¿®æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ­£è¦è¡¨ç¾ç½®æ›ï¼‰
  success_rate DECIMAL(5,2) DEFAULT 0.0,  -- æˆåŠŸç‡ï¼ˆ0.00-100.00ï¼‰
  usage_count INT DEFAULT 0,         -- ä½¿ç”¨å›æ•°
  last_used_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_error_patterns_type ON error_patterns(error_type);
CREATE INDEX idx_error_patterns_success_rate ON error_patterns(success_rate DESC);
```

**error_recovery_logs**
```sql
CREATE TABLE error_recovery_logs (
  id BIGSERIAL PRIMARY KEY,
  user_id VARCHAR(100) NOT NULL,
  session_id VARCHAR(100),
  original_code TEXT,
  fixed_code TEXT,
  error_screenshot_url TEXT,         -- ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆURL
  error_analysis JSONB,              -- Vision APIã®è§£æçµæœ
  detected_error_type VARCHAR(100),
  detected_error_message TEXT,
  fix_method VARCHAR(50),            -- pattern | ai | heuristic
  pattern_id BIGINT REFERENCES error_patterns(id),
  fix_attempt_count INT DEFAULT 0,
  is_successful BOOLEAN,
  user_feedback VARCHAR(50),         -- success | failed | not_provided
  resolved_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_recovery_logs_user_id ON error_recovery_logs(user_id);
CREATE INDEX idx_recovery_logs_session_id ON error_recovery_logs(session_id);
CREATE INDEX idx_recovery_logs_created_at ON error_recovery_logs(created_at DESC);
```

**user_experience**
```sql
CREATE TABLE user_experience (
  user_id VARCHAR(100) PRIMARY KEY,
  total_xp INT DEFAULT 0,
  level INT DEFAULT 1,
  codes_generated INT DEFAULT 0,
  errors_fixed INT DEFAULT 0,
  auto_fixes_count INT DEFAULT 0,
  badges JSONB DEFAULT '[]'::jsonb,  -- [{ badge_key, unlocked_at }]
  achievements JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_user_experience_total_xp ON user_experience(total_xp DESC);
CREATE INDEX idx_user_experience_level ON user_experience(level DESC);
```

**badge_definitions**
```sql
CREATE TABLE badge_definitions (
  badge_key VARCHAR(50) PRIMARY KEY,
  badge_name VARCHAR(100) NOT NULL,
  badge_icon VARCHAR(10) NOT NULL,    -- çµµæ–‡å­—
  badge_description TEXT NOT NULL,
  unlock_condition JSONB NOT NULL,    -- { codes_generated: 10 } ç­‰
  rarity VARCHAR(20) DEFAULT 'common',  -- common | rare | epic | legendary
  xp_reward INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 8ç¨®é¡ã®ãƒãƒƒã‚¸
INSERT INTO badge_definitions VALUES
  ('first_code', 'ã¯ã˜ã‚ã®ä¸€æ­©', 'ğŸ‰', 'åˆã‚ã¦ã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’é”æˆ', '{"codes_generated": 1}', 'common', 50),
  ('code_master', 'ã‚³ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ãƒ¼', 'ğŸ’»', '10å€‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ', '{"codes_generated": 10}', 'rare', 200),
  ('error_survivor', 'ã‚¨ãƒ©ãƒ¼ã‚µãƒã‚¤ãƒãƒ¼', 'ğŸ›¡ï¸', 'åˆã‚ã¦ã®ã‚¨ãƒ©ãƒ¼ä¿®æ­£ã«æˆåŠŸ', '{"errors_fixed": 1}', 'common', 100),
  ('error_master', 'ã‚¨ãƒ©ãƒ¼ãƒã‚¹ã‚¿ãƒ¼', 'âš¡', '10å€‹ã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£', '{"errors_fixed": 10}', 'rare', 300),
  ('auto_fix_pro', 'è‡ªå‹•ä¿®æ­£ãƒ—ãƒ­', 'ğŸ¤–', '5å›ã®è‡ªå‹•ä¿®æ­£ã«æˆåŠŸ', '{"auto_fixes_count": 5}', 'epic', 500),
  ('speed_runner', 'ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ©ãƒ³ãƒŠãƒ¼', 'ğŸš€', '1æ—¥ã§3å€‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ', '{"codes_generated_today": 3}', 'rare', 150),
  ('perfectionist', 'å®Œç’§ä¸»ç¾©è€…', 'âœ¨', '5é€£ç¶šã§ã‚¨ãƒ©ãƒ¼ãªã—ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ', '{"consecutive_success": 5}', 'epic', 400),
  ('legendary_coder', 'ä¼èª¬ã®ã‚³ãƒ¼ãƒ€ãƒ¼', 'ğŸ‘‘', '50å€‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ', '{"codes_generated": 50}', 'legendary', 1000);
```

---

### 4.3 ğŸ“¦ ã‚³ãƒ¼ãƒ‰å…±æœ‰ã‚·ã‚¹ãƒ†ãƒ 

**ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/supabase/code-share-queries.ts`, `/api/share/*`

#### å½¹å‰²
- ç”Ÿæˆã‚³ãƒ¼ãƒ‰ã®å…±æœ‰URLä½œæˆï¼ˆ8æ–‡å­—çŸ­ç¸®IDï¼‰
- QRã‚³ãƒ¼ãƒ‰è‡ªå‹•ç”Ÿæˆï¼ˆPNG: 256x256pxã€SVG: ãƒ™ã‚¯ã‚¿ãƒ¼ï¼‰
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ï¼ˆbcryptï¼‰
- é–²è¦§å›æ•°åˆ¶é™ï¼ˆmax_viewsï¼‰
- æœ‰åŠ¹æœŸé™ç®¡ç†ï¼ˆexpires_atï¼‰
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ï¼ˆparent_idå‚ç…§ï¼‰
- ã‚¢ã‚¯ã‚»ã‚¹è¿½è·¡ï¼ˆIPã€ãƒ‡ãƒã‚¤ã‚¹ã€ãƒ–ãƒ©ã‚¦ã‚¶ã€OSï¼‰

#### ä¸»è¦ã‚¯ãƒ©ã‚¹: CodeShareQueries

```typescript
class CodeShareQueries {
  // å…±æœ‰ä½œæˆ
  static async create(params: {
    userId: string,
    jobId?: string,
    sessionId?: string,
    title: string,
    description?: string,
    codeContent: string,
    language?: string,
    fileName?: string,
    isPublic?: boolean,
    password?: string,
    maxViews?: number,
    expiresInDays?: number,
    tags?: string[],
    conversationContext?: any,
    requirements?: any
  }): Promise<CodeShare>

  // å…±æœ‰å–å¾—
  static async getByShortId(
    shortId: string,
    password?: string
  ): Promise<CodeShare | null>

  // é–²è¦§å›æ•°ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
  static async incrementViewCount(shortId: string): Promise<void>

  // ã‚³ãƒ”ãƒ¼å›æ•°ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
  static async incrementCopyCount(shortId: string): Promise<void>

  // å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ï¼‰
  static async delete(
    shortId: string,
    userId: string,
    reason?: string
  ): Promise<void>

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…±æœ‰ä¸€è¦§
  static async listByUser(
    userId: string,
    limit?: number
  ): Promise<CodeShare[]>
}
```

#### çŸ­ç¸®IDç”Ÿæˆï¼ˆ8æ–‡å­—ã€Base62ï¼‰

```typescript
function generateShortId(): string {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';

  // 8æ–‡å­—ã®ãƒ©ãƒ³ãƒ€ãƒ IDç”Ÿæˆ
  for (let i = 0; i < 8; i++) {
    const randomIndex = Math.floor(Math.random() * chars.length);
    result += chars.charAt(randomIndex);
  }

  // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆcheck_short_id_existsé–¢æ•°ï¼‰
  const { data: exists } = await supabase
    .rpc('check_short_id_exists', { p_short_id: result });

  // é‡è¤‡ã—ã¦ã„ãŸã‚‰å†ç”Ÿæˆ
  if (exists) {
    return generateShortId();
  }

  return result;
}

// ä¾‹: Xa7Bf9Kp
// URL: https://taskmateai.net/share/Xa7Bf9Kp
```

#### QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

```typescript
import QRCode from 'qrcode';

const shareUrl = `https://taskmateai.net/share/${shortId}`;

// PNGå½¢å¼ï¼ˆ256x256pxï¼‰
const qrCodePNG = await QRCode.toDataURL(shareUrl, {
  width: 256,
  margin: 2,
  color: {
    dark: '#000000',
    light: '#FFFFFF'
  },
  errorCorrectionLevel: 'M'
});

// SVGå½¢å¼ï¼ˆãƒ™ã‚¯ã‚¿ãƒ¼ï¼‰
const qrCodeSVG = await QRCode.toString(shareUrl, {
  type: 'svg',
  width: 256,
  margin: 2,
  errorCorrectionLevel: 'M'
});
```

#### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·

```typescript
import bcrypt from 'bcrypt';

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆ
if (password) {
  const passwordHash = await bcrypt.hash(password, 10);  // saltRounds: 10

  await supabase
    .from('code_shares')
    .insert({ ...shareData, password_hash: passwordHash });
}

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
if (codeShare.password_hash) {
  const isValid = await bcrypt.compare(providedPassword, codeShare.password_hash);

  if (!isValid) {
    throw new Error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
  }
}
```

#### æœ‰åŠ¹æœŸé™

```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
const { data: user } = await supabase
  .from('users')
  .select('subscription_status')
  .eq('line_user_id', userId)
  .single();

const isPremium = user?.subscription_status === 'premium';

// æœ‰åŠ¹æœŸé™è¨­å®š
const expiresInDays = isPremium ? 30 : 7;
const expiresAt = new Date();
expiresAt.setDate(expiresAt.getDate() + expiresInDays);
```

#### ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«

**code_shares**
```sql
CREATE TABLE code_shares (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  short_id VARCHAR(8) UNIQUE NOT NULL,
  version INTEGER DEFAULT 1,

  -- é–¢é€£æƒ…å ±
  user_id TEXT NOT NULL,
  job_id TEXT,
  session_id TEXT,
  parent_id UUID REFERENCES code_shares(id) ON DELETE SET NULL,

  -- ã‚³ãƒ¼ãƒ‰æƒ…å ±
  title TEXT NOT NULL,
  description TEXT,
  code_content TEXT NOT NULL,
  language VARCHAR(20) DEFAULT 'javascript',
  file_name TEXT DEFAULT 'code.gs',

  -- ã‚¢ã‚¯ã‚»ã‚¹è¨­å®š
  is_public BOOLEAN DEFAULT true,
  password_hash TEXT,
  max_views INTEGER,

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  metadata JSONB DEFAULT '{}',
  tags TEXT[],
  conversation_context JSONB,
  requirements JSONB,

  -- çµ±è¨ˆæƒ…å ±
  view_count INTEGER DEFAULT 0,
  copy_count INTEGER DEFAULT 0,
  last_viewed_at TIMESTAMP,

  -- ãƒ•ãƒ©ã‚°
  is_premium BOOLEAN DEFAULT false,
  is_deleted BOOLEAN DEFAULT false,
  deletion_reason TEXT,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_code_shares_short_id ON code_shares(short_id);
CREATE INDEX idx_code_shares_user_id ON code_shares(user_id);
CREATE INDEX idx_code_shares_job_id ON code_shares(job_id) WHERE job_id IS NOT NULL;
CREATE INDEX idx_code_shares_session_id ON code_shares(session_id) WHERE session_id IS NOT NULL;
CREATE INDEX idx_code_shares_parent_id ON code_shares(parent_id) WHERE parent_id IS NOT NULL;
CREATE INDEX idx_code_shares_expires_at ON code_shares(expires_at) WHERE NOT is_deleted;
CREATE INDEX idx_code_shares_created_at ON code_shares(created_at);
CREATE INDEX idx_code_shares_is_deleted ON code_shares(is_deleted);
```

**code_share_access_logs**
```sql
CREATE TABLE code_share_access_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  share_id UUID REFERENCES code_shares(id) ON DELETE CASCADE,

  -- ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±
  ip_address INET,
  user_agent TEXT,
  referer TEXT,
  access_type VARCHAR(20),  -- 'view', 'copy', 'download'

  -- ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±
  device_type VARCHAR(20),  -- 'mobile', 'desktop', 'tablet', 'bot'
  browser VARCHAR(50),      -- 'Chrome', 'Safari', 'Firefox', 'Edge', 'LINE'
  os VARCHAR(50),           -- 'iOS 17.1.1', 'Android 14', 'Windows 10/11', 'macOS 14.0'

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  accessed_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_access_logs_share_id ON code_share_access_logs(share_id);
CREATE INDEX idx_access_logs_accessed_at ON code_share_access_logs(accessed_at);
CREATE INDEX idx_access_logs_access_type ON code_share_access_logs(access_type);
```

**conversation_code_relations**
```sql
CREATE TABLE conversation_code_relations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL,
  session_id TEXT,
  share_id UUID REFERENCES code_shares(id) ON DELETE CASCADE,

  -- é–¢é€£æ€§æƒ…å ±
  relation_type VARCHAR(50),  -- 'original', 'modified', 'reference'
  context_snapshot JSONB,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_conv_code_rel_user_id ON conversation_code_relations(user_id);
CREATE INDEX idx_conv_code_rel_session_id ON conversation_code_relations(session_id);
CREATE INDEX idx_conv_code_rel_share_id ON conversation_code_relations(share_id);
```

**user_code_history**
```sql
CREATE TABLE user_code_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL,
  share_id UUID REFERENCES code_shares(id) ON DELETE CASCADE,

  -- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±
  action VARCHAR(50) NOT NULL,  -- 'generated', 'modified', 'viewed', 'copied', 'deleted'
  action_details JSONB,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  performed_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_user_history_user_id ON user_code_history(user_id);
CREATE INDEX idx_user_history_share_id ON user_code_history(share_id);
CREATE INDEX idx_user_history_action ON user_code_history(action);
CREATE INDEX idx_user_history_performed_at ON user_code_history(performed_at DESC);
```

---

### 4.4 ğŸ® ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ 

**ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/gamification/experience-system.ts`

#### å½¹å‰²
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å‘ä¸Š
- ãƒ¬ãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼ˆâˆš(XP/100) + 1ï¼‰
- ãƒãƒƒã‚¸è§£é™¤ï¼ˆ8ç¨®é¡ï¼‰
- ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰
- XPç²å¾—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

#### ä¸»è¦ã‚¯ãƒ©ã‚¹: ExperienceSystem

```typescript
class ExperienceSystem {
  // XPä»˜ä¸
  async addExperience(
    userId: string,
    amount: number,
    reason: string
  ): Promise<{ newLevel: number, leveledUp: boolean, newBadges: Badge[] }>

  // ãƒ¬ãƒ™ãƒ«è¨ˆç®—ï¼ˆâˆš(XP/100) + 1ï¼‰
  calculateLevel(totalXP: number): number

  // ãƒãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
  async checkAndUnlockBadges(userId: string): Promise<Badge[]>

  // ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰å–å¾—
  async getLeaderboard(limit: number = 10): Promise<LeaderboardEntry[]>

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆå–å¾—
  async getUserStats(userId: string): Promise<UserExperience>
}
```

#### XPç²å¾—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

| ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | XP | ãƒˆãƒªã‚¬ãƒ¼ | å‚™è€ƒ |
|----------|-----|---------|------|
| ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ | +10 | æ­£å¸¸ã«ç”Ÿæˆå®Œäº† | åŸºæœ¬å ±é…¬ |
| ã‚¨ãƒ©ãƒ¼ä¿®æ­£æˆåŠŸ | +50 | ã‚¨ãƒ©ãƒ¼å›å¾©æˆåŠŸ | é«˜é›£åº¦å ±é…¬ |
| ã‚³ãƒ¼ãƒ‰å…±æœ‰ | +5 | å…±æœ‰URLä½œæˆ | å…±æœ‰ä¿ƒé€² |
| ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ | +20 | ä¿®æ­£ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ | å­¦ç¿’ãƒ‡ãƒ¼ã‚¿è²¢çŒ® |
| é€£ç¶šåˆ©ç”¨ | +30 | 3æ—¥é€£ç¶šåˆ©ç”¨ | ç¶™ç¶šåˆ©ç”¨å ±é…¬ |
| ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ— | +100 | ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ™‚ | ãƒœãƒ¼ãƒŠã‚¹å ±é…¬ |
| ãƒãƒƒã‚¸è§£é™¤ | +50~1000 | ãƒãƒƒã‚¸ç²å¾—æ™‚ | ãƒ¬ã‚¢ãƒªãƒ†ã‚£ä¾å­˜ |

#### ãƒ¬ãƒ™ãƒ«è¨ˆç®—å¼

```typescript
function calculateLevel(totalXP: number): number {
  // âˆš(XP/100) + 1
  return Math.floor(Math.sqrt(totalXP / 100)) + 1;
}

// ä¾‹:
// 0 XP    â†’ Level 1
// 100 XP  â†’ Level 2 (âˆš(100/100) + 1 = 2)
// 400 XP  â†’ Level 3 (âˆš(400/100) + 1 = 3)
// 900 XP  â†’ Level 4 (âˆš(900/100) + 1 = 4)
// 10000 XP â†’ Level 11 (âˆš(10000/100) + 1 = 11)
```

#### ãƒãƒƒã‚¸å®šç¾©ï¼ˆ8ç¨®é¡ï¼‰

| ãƒãƒƒã‚¸ID | åç§° | ã‚¢ã‚¤ã‚³ãƒ³ | è§£é™¤æ¡ä»¶ | ãƒ¬ã‚¢ãƒªãƒ†ã‚£ | XPå ±é…¬ |
|---------|------|---------|---------|----------|--------|
| `first_code` | ã¯ã˜ã‚ã®ä¸€æ­© | ğŸ‰ | åˆå›ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ | common | +50 |
| `code_master` | ã‚³ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ãƒ¼ | ğŸ’» | 10å€‹ç”Ÿæˆ | rare | +200 |
| `error_survivor` | ã‚¨ãƒ©ãƒ¼ã‚µãƒã‚¤ãƒãƒ¼ | ğŸ›¡ï¸ | ã‚¨ãƒ©ãƒ¼ä¿®æ­£1å›æˆåŠŸ | common | +100 |
| `error_master` | ã‚¨ãƒ©ãƒ¼ãƒã‚¹ã‚¿ãƒ¼ | âš¡ | ã‚¨ãƒ©ãƒ¼ä¿®æ­£10å›æˆåŠŸ | rare | +300 |
| `auto_fix_pro` | è‡ªå‹•ä¿®æ­£ãƒ—ãƒ­ | ğŸ¤– | è‡ªå‹•ä¿®æ­£5å›æˆåŠŸ | epic | +500 |
| `speed_runner` | ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ©ãƒ³ãƒŠãƒ¼ | ğŸš€ | 1æ—¥ã§3å€‹ç”Ÿæˆ | rare | +150 |
| `perfectionist` | å®Œç’§ä¸»ç¾©è€… | âœ¨ | 5é€£ç¶šã‚¨ãƒ©ãƒ¼ãªã—ç”Ÿæˆ | epic | +400 |
| `legendary_coder` | ä¼èª¬ã®ã‚³ãƒ¼ãƒ€ãƒ¼ | ğŸ‘‘ | 50å€‹ç”Ÿæˆ | legendary | +1000 |

---

### 4.5 ğŸ“Š ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 

#### 4.5.1 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–

**ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/monitoring/performance.ts`

**æ©Ÿèƒ½:**
- ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ï¼ˆã‚¿ã‚¤ãƒãƒ¼ãƒ™ãƒ¼ã‚¹ï¼‰
- çµ±è¨ˆæƒ…å ±ç”Ÿæˆï¼ˆå¹³å‡ã€æœ€å°ã€æœ€å¤§ã€P50/P95/P99ï¼‰
- é…ã„å‡¦ç†ã®è‡ªå‹•æ¤œå‡ºã¨ã‚¢ãƒ©ãƒ¼ãƒˆ

**ãƒ—ãƒªã‚»ãƒƒãƒˆé–¾å€¤:**
```typescript
const thresholds = {
  webhook: 3000,          // 3ç§’
  claudeApi: 30000,       // 30ç§’
  dbQuery: 1000,          // 1ç§’
  imageProcessing: 5000,  // 5ç§’
  qrGeneration: 2000      // 2ç§’
};
```

**ä½¿ç”¨ä¾‹:**
```typescript
const timer = PerformanceMonitor.startTimer('claude_api');
try {
  await claudeClient.generateCode(...);
  const duration = timer.end();

  // è‡ªå‹•çš„ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²
  // é–¾å€¤è¶…éæ™‚ã¯è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆLINEé€šçŸ¥ï¼‰
} catch (error) {
  timer.end();
  throw error;
}
```

#### 4.5.2 ãƒ¡ãƒ¢ãƒªç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ï¼ˆè©³ç´°ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/monitoring/memory-monitor.ts`

**é–¾å€¤è¨­å®š:**
- **è­¦å‘Šé–¾å€¤**: 80% ãƒ’ãƒ¼ãƒ—ä½¿ç”¨ç‡
- **ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«é–¾å€¤**: 90% ãƒ’ãƒ¼ãƒ—ä½¿ç”¨ç‡
- **ãƒã‚§ãƒƒã‚¯é–“éš”**: 30ç§’

**ç›£è¦–ãƒ¡ãƒˆãƒªã‚¯ã‚¹:**
```typescript
{
  heapUsed: 450,        // MB - ä½¿ç”¨ä¸­ãƒ’ãƒ¼ãƒ—
  heapTotal: 512,       // MB - ç·ãƒ’ãƒ¼ãƒ—ã‚µã‚¤ã‚º
  heapUsagePercent: 88, // % - ä½¿ç”¨ç‡
  rss: 580,             // MB - å¸¸é§ã‚»ãƒƒãƒˆã‚µã‚¤ã‚º
  external: 12,         // MB - C++ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  sessionStoreSize: 150,           // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°
  sessionStoreUtilization: 30      // % - ã‚¹ãƒˆã‚¢ä½¿ç”¨ç‡
}
```

**ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«æ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**

```typescript
class MemoryMonitor {
  private static readonly WARNING_THRESHOLD = 0.8   // 80%
  private static readonly CRITICAL_THRESHOLD = 0.9  // 90%
  private static readonly CHECK_INTERVAL = 30000    // 30ç§’

  static check(): void {
    const usage = process.memoryUsage();
    const heapUsageRatio = usage.heapUsed / usage.heapTotal;

    // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ¬ãƒ™ãƒ«ï¼ˆ90%è¶…ï¼‰
    if (heapUsageRatio > this.CRITICAL_THRESHOLD) {
      logger.error('CRITICAL memory usage detected', {
        heapUsagePercent: Math.round(heapUsageRatio * 100),
        action: 'forcing_emergency_cleanup'
      });

      // 1. ç·Šæ€¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ
      this.emergencyCleanup();

      // 2. æ‰‹å‹•ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ--expose-gc ãƒ•ãƒ©ã‚°å¿…è¦ï¼‰
      if (global.gc) {
        global.gc();
        logger.info('Manual garbage collection triggered');

        // GCå¾Œã®çŠ¶æ…‹ã‚’è¨˜éŒ²
        const afterGC = process.memoryUsage();
        const freedMB = Math.round((usage.heapUsed - afterGC.heapUsed) / 1024 / 1024);
        logger.info('Memory after GC', {
          heapUsed: Math.round(afterGC.heapUsed / 1024 / 1024),
          freedMB
        });
      } else {
        logger.warn('Manual GC not available (--expose-gc flag not set)');
      }
    }
    // è­¦å‘Šãƒ¬ãƒ™ãƒ«ï¼ˆ80%è¶…ï¼‰
    else if (heapUsageRatio > this.WARNING_THRESHOLD) {
      logger.warn('High memory usage', {
        heapUsagePercent: Math.round(heapUsageRatio * 100),
        action: 'preventive_cleanup'
      });

      // äºˆé˜²çš„ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      this.preventiveCleanup();
    }
  }

  // ç·Šæ€¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  private static emergencyCleanup(): void {
    // SessionStoreã®å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
    const sessionStore = ConversationSessionStore.getInstance();
    sessionStore.cleanup({ force: true, maxAge: 10 * 60 * 1000 }); // 10åˆ†ä»¥ä¸Šå‰

    // å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¨ãƒ³ãƒˆãƒªå‰Šé™¤
    conversationCache.clear();

    // ã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆwebhooké‡è¤‡æ¤œå‡ºç”¨ï¼‰
    recentEventKeys.clear();
  }

  // äºˆé˜²çš„ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  private static preventiveCleanup(): void {
    const sessionStore = ConversationSessionStore.getInstance();
    sessionStore.cleanup({ maxAge: 30 * 60 * 1000 }); // 30åˆ†ä»¥ä¸Šå‰
  }
}
```

**èµ·å‹•æ™‚è‡ªå‹•é–‹å§‹:**
```typescript
// app/api/webhook/route.ts
if (typeof process !== 'undefined' && !(global as any).__memoryMonitorStarted) {
  MemoryMonitor.start();
  (global as any).__memoryMonitorStarted = true;
  logger.info('Memory monitor initialized');
}
```

#### 4.5.3 ã‚¨ãƒ©ãƒ¼é€šçŸ¥

**ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/monitoring/error-notifier.ts`, `lib/monitoring/alert-notifier.ts`

**æ©Ÿèƒ½:**
- LINEé€šçŸ¥çµ±åˆï¼ˆç®¡ç†è€…ã¸ï¼‰
- ã‚¨ãƒ©ãƒ¼é‡å¤§åº¦åˆ¤å®š
- ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹åé›†
- ã‚¨ãƒ©ãƒ¼é›†ç´„ï¼ˆåŒã˜ã‚¨ãƒ©ãƒ¼ã¯1æ™‚é–“ã«1å›ã®ã¿é€šçŸ¥ï¼‰

```typescript
async function notifyError(error: Error, context: any) {
  const severity = determineSeverity(error);

  // é‡å¤§åº¦åˆ¤å®š
  function determineSeverity(error: Error): 'low' | 'medium' | 'high' | 'critical' {
    if (error.message.includes('CRITICAL') || error.message.includes('Database connection')) {
      return 'critical';
    }
    if (error.message.includes('Claude API') || error.message.includes('Stripe')) {
      return 'high';
    }
    if (error.message.includes('Validation')) {
      return 'medium';
    }
    return 'low';
  }

  // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ã®ã¿LINEé€šçŸ¥
  if (severity === 'critical') {
    await lineClient.pushMessage(ADMIN_LINE_USER_ID, [{
      type: 'text',
      text: `ğŸš¨ CRITICAL ERROR\n\n` +
            `Message: ${error.message}\n\n` +
            `Context: ${JSON.stringify(context, null, 2)}\n\n` +
            `Stack: ${error.stack?.substring(0, 500)}`
    }]);
  }

  // ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°è¨˜éŒ²
  logger.error('Application error', {
    error: error.message,
    stack: error.stack,
    severity,
    context
  });
}
```

---

### 4.6 ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ 

**ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/backup/backup-manager.ts`

#### å½¹å‰²
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å®šæœŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- å¢—åˆ†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¯¾å¿œ
- åœ§ç¸®ãƒ»æš—å·åŒ–ï¼ˆgzipã€AES-256ï¼‰
- ãƒã‚§ãƒƒã‚¯ã‚µãƒ æ¤œè¨¼ï¼ˆSHA-256ï¼‰
- ãƒªã‚¹ãƒˆã‚¢æ©Ÿèƒ½

#### ä¸»è¦ã‚¯ãƒ©ã‚¹: BackupManager

```typescript
class BackupManager {
  // ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
  async createFullBackup(): Promise<string> // backupId

  // å¢—åˆ†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
  async createIncrementalBackup(
    baseBackupId: string
  ): Promise<string>

  // ãƒªã‚¹ãƒˆã‚¢å®Ÿè¡Œ
  async restore(backupId: string): Promise<void>

  // å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤
  async cleanupOldBackups(
    maxBackups: number = 30
  ): Promise<number>

  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œè¨¼
  async verifyBackup(backupId: string): Promise<boolean>
}
```

#### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 

```
backups/
â”œâ”€â”€ full_20251023_120000_abc123.json.gz      # ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
â”œâ”€â”€ incr_20251023_180000_def456.json.gz      # å¢—åˆ†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
â”œâ”€â”€ checksums.json                           # ãƒã‚§ãƒƒã‚¯ã‚µãƒ ãƒªã‚¹ãƒˆ
â””â”€â”€ metadata/
    â”œâ”€â”€ full_20251023_120000_abc123.meta.json
    â””â”€â”€ incr_20251023_180000_def456.meta.json
```

#### ãƒã‚§ãƒƒã‚¯ã‚µãƒ æ¤œè¨¼

```typescript
import crypto from 'crypto';
import zlib from 'zlib';

function calculateChecksum(data: string): string {
  return crypto
    .createHash('sha256')
    .update(data)
    .digest('hex');
}

// ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆæ™‚
const backupData = JSON.stringify(data);
const compressed = zlib.gzipSync(backupData);
const checksum = calculateChecksum(backupData);

// ãƒã‚§ãƒƒã‚¯ã‚µãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
await fs.writeFile('checksums.json', JSON.stringify({
  [backupId]: {
    checksum,
    size: compressed.length,
    created_at: new Date().toISOString()
  }
}, null, 2));

// ãƒªã‚¹ãƒˆã‚¢æ™‚ã«æ¤œè¨¼
const storedChecksum = checksums[backupId].checksum;
const calculatedChecksum = calculateChecksum(restoredData);

if (calculatedChecksum !== storedChecksum) {
  throw new Error('Backup file corrupted - checksum mismatch');
}
```

---

## 5. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆï¼ˆ100+ï¼‰

### 5.1 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆ1ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/backup/backup-manager.ts` - ãƒ•ãƒ«/å¢—åˆ†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€ãƒã‚§ãƒƒã‚¯ã‚µãƒ æ¤œè¨¼ã€æš—å·åŒ–

### 5.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ2ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/cache/cache-strategy.ts` - ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥ã€TTLç®¡ç†
- `lib/cache/conversation-cache.ts` - ä¼šè©±ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆLRUï¼‰

### 5.3 Claude AIé€£æºï¼ˆ6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/claude/client.ts` - Claude APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆ3.5 Sonnetï¼‰
- `lib/claude/prompt-builder.ts` - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
- `lib/claude/response-parser.ts` - ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ
- `lib/claude/usage-tracker.ts` - ä½¿ç”¨é‡è¿½è·¡
- `lib/claude/code-validator.ts` - ã‚³ãƒ¼ãƒ‰æ¤œè¨¼
- `lib/code/file-generator.ts` - ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ

### 5.4 ä¼šè©±ç®¡ç†ï¼ˆ11ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/conversation/category-definitions.ts` - ã‚«ãƒ†ã‚´ãƒªå®šç¾©ï¼ˆspreadsheet, calendar, gmailç­‰ï¼‰
- `lib/conversation/category-detector.ts` - ã‚«ãƒ†ã‚´ãƒªè‡ªå‹•æ¤œå‡ºï¼ˆAIï¼‰
- `lib/conversation/conversational-flow.ts` - ä¼šè©±ãƒ•ãƒ­ãƒ¼ç®¡ç†
- `lib/conversation/flow-manager.ts` - ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡
- `lib/conversation/session-manager.ts` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- `lib/conversation/session-store.ts` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆã‚¢ï¼ˆãƒ¡ãƒ¢ãƒªï¼‰
- `lib/conversation/supabase-session-store.ts` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆã‚¢ï¼ˆDBï¼‰
- `lib/conversation/session-handler.ts` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ©
- `lib/conversation/session-cleanup.ts` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- `lib/conversation/state-recovery.ts` - çŠ¶æ…‹å¾©æ—§
- `lib/conversation/ai-requirements-extractor.ts` - è¦ä»¶æŠ½å‡ºï¼ˆAIï¼‰

### 5.5 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ï¼ˆ11ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/database/migration-manager.ts` - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†
- `lib/database/query-builder.ts` - ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼
- `lib/database/supabase-transaction.ts` - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
- `lib/database/transaction.ts` - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ¶å¾¡
- `lib/database/connection-pool.ts` - ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«
- `lib/supabase/client.ts` - Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- `lib/supabase/queries.ts` - ã‚¯ã‚¨ãƒªé–¢æ•°
- `lib/supabase/session-queries.ts` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ã‚¨ãƒª
- `lib/supabase/code-share-queries.ts` - ã‚³ãƒ¼ãƒ‰å…±æœ‰ã‚¯ã‚¨ãƒª
- `lib/supabase/type-guards.ts` - å‹ã‚¬ãƒ¼ãƒ‰
- `lib/supabase/types.ts` - å‹å®šç¾©

### 5.6 ã‚¨ãƒ©ãƒ¼å›å¾©ï¼ˆ3ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/error-recovery/recovery-manager.ts` - ä¿®å¾©ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
- `lib/error-recovery/error-analyzer.ts` - ã‚¨ãƒ©ãƒ¼åˆ†æï¼ˆClaude Vision APIï¼‰
- `lib/error-recovery/auto-fixer.ts` - è‡ªå‹•ä¿®å¾©ï¼ˆ3æ®µéšæˆ¦ç•¥ï¼‰

### 5.7 ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ1ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/gamification/experience-system.ts` - XPã€ãƒ¬ãƒ™ãƒ«ã€ãƒãƒƒã‚¸ã‚·ã‚¹ãƒ†ãƒ 

### 5.8 LINEé€£æºï¼ˆ8ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/line/client.ts` - LINE Messaging APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- `lib/line/message-templates.ts` - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- `lib/line/message-formatter.ts` - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿
- `lib/line/flex-templates.ts` - Flexãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- `lib/line/flex-code-template.ts` - ã‚³ãƒ¼ãƒ‰ç”¨Flexãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- `lib/line/image-handler.ts` - ç”»åƒå‡¦ç†ï¼ˆBase64å¤‰æ›ï¼‰
- `lib/line/webhook-validator.ts` - Webhookç½²åæ¤œè¨¼ï¼ˆHMAC-SHA256ï¼‰
- `lib/line/engineer-support.ts` - ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚µãƒãƒ¼ãƒˆæ©Ÿèƒ½

### 5.9 ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼ˆ4ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/middleware/cors.ts` - CORSè¨­å®š
- `lib/middleware/rate-limiter.ts` - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆãƒ¡ãƒ¢ãƒªãƒ™ãƒ¼ã‚¹ï¼‰
- `lib/middleware/security-headers.ts` - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
- `lib/middleware/spam-detector.ts` - ã‚¹ãƒ‘ãƒ æ¤œå‡º

### 5.10 ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆ5ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/monitoring/memory-monitor.ts` - ãƒ¡ãƒ¢ãƒªç›£è¦–ï¼ˆ80%è­¦å‘Šã€90%ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼‰
- `lib/monitoring/api-logger.ts` - APIãƒ­ã‚°
- `lib/monitoring/error-notifier.ts` - ã‚¨ãƒ©ãƒ¼é€šçŸ¥
- `lib/monitoring/alert-notifier.ts` - ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥
- `lib/monitoring/performance.ts` - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–

### 5.11 ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ï¼ˆ1ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/premium/premium-checker.ts` - ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª

### 5.12 ã‚­ãƒ¥ãƒ¼ï¼ˆ2ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/queue/manager.ts` - ã‚­ãƒ¥ãƒ¼ç®¡ç†ï¼ˆãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯æ¤œå‡ºã€ãƒãƒƒã‚¯ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ï¼‰
- `lib/queue/processor.ts` - ã‚­ãƒ¥ãƒ¼å‡¦ç†

### 5.13 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼ˆ1ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/realtime/websocket-manager.ts` - WebSocketç®¡ç†

### 5.14 ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ï¼ˆ1ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/scheduler/task-scheduler.ts` - ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©

### 5.15 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆ1ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/security/api-key-validator.ts` - APIã‚­ãƒ¼æ¤œè¨¼

### 5.16 ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆ50+ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/utils/crypto.ts`, `lib/utils/crypto-utils.ts` - æš—å·åŒ–ï¼ˆAES-256ã€HMACï¼‰
- `lib/utils/deadlock-detector.ts` - ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯æ¤œå‡º
- `lib/utils/memory-manager.ts`, `lib/utils/memory-monitor.ts` - ãƒ¡ãƒ¢ãƒªç®¡ç†
- `lib/utils/session-lock.ts` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ãƒƒã‚¯ï¼ˆåˆ†æ•£ãƒ­ãƒƒã‚¯ï¼‰
- `lib/utils/secure-random.ts`, `lib/utils/secure-fetch.ts` - ã‚»ã‚­ãƒ¥ã‚¢å‡¦ç†
- `lib/utils/logger.ts` - ãƒ­ã‚°ï¼ˆæ§‹é€ åŒ–ãƒ­ã‚°ï¼‰
- `lib/utils/error-handler.ts`, `lib/utils/errors.ts` - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- `lib/utils/retry-handler.ts`, `lib/utils/fallback-handler.ts` - ãƒªãƒˆãƒ©ã‚¤ãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- `lib/utils/validators.ts`, `lib/utils/input-validator.ts`, `lib/utils/url-validator.ts` - æ¤œè¨¼
- `lib/utils/safe-json.ts` - å®‰å…¨ãªJSONå‡¦ç†
- `lib/utils/timezone.ts` - ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å‡¦ç†
- `lib/utils/global-cleanup.ts`, `lib/utils/global-timer-manager.ts` - ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- `lib/utils/async-optimizer.ts` - éåŒæœŸæœ€é©åŒ–
- `lib/utils/cookie-manager.ts` - Cookieç®¡ç†
- `lib/utils/api-response.ts` - API ãƒ¬ã‚¹ãƒãƒ³ã‚¹
- `lib/utils/request-context.ts` - ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
- `lib/utils/response-parser.ts` - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‘ãƒ¼ã‚µãƒ¼
- `lib/utils/structured-response.ts` - æ§‹é€ åŒ–ãƒ¬ã‚¹ãƒãƒ³ã‚¹
- ãã®ä»–30+ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«...

### 5.17 Vision APIï¼ˆ3ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/vision/rate-limiter.ts` - Vision APIãƒ¬ãƒ¼ãƒˆåˆ¶é™
- `lib/vision/database-rate-limiter.ts` - DBé€£æºãƒ¬ãƒ¼ãƒˆåˆ¶é™
- `lib/vision/memory-counter.ts` - ãƒ¡ãƒ¢ãƒªã‚«ã‚¦ãƒ³ã‚¿ãƒ¼

### 5.18 èªè¨¼ï¼ˆ1ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/auth/jwt-manager.ts` - JWTç®¡ç†ï¼ˆHS256ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒå¯¾ç­–ï¼‰

### 5.19 ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆ1ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/upload/file-upload-handler.ts` - ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†

### 5.20 è¨­å®šï¼ˆ2ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- `lib/config/env-validator.ts` - ç’°å¢ƒå¤‰æ•°æ¤œè¨¼
- `lib/config/environment.ts` - ç’°å¢ƒè¨­å®š
- `lib/constants/config.ts` - å®šæ•°è¨­å®š
- `lib/constants/messages.ts` - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®šæ•°

---

## 6. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 6.1 å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ï¼ˆå…¨47ãƒ†ãƒ¼ãƒ–ãƒ« - å®ŸSupabaseæ¤œè¨¼æ¸ˆã¿ï¼‰

**v4.1æ›´æ–°: å®ŸSupabaseç’°å¢ƒã‹ã‚‰47ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèªå®Œäº†**

#### ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ38å€‹ - è©³ç´°è¨˜è¼‰ï¼‰

| # | ãƒ†ãƒ¼ãƒ–ãƒ«å | å½¹å‰² | ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ç›®å®‰ |
|---|-----------|------|--------------|
| **ã‚³ã‚¢æ©Ÿèƒ½ï¼ˆ7å€‹ï¼‰** |||
| 1 | `users` | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± | 10,000+ |
| 2 | `conversation_sessions` | ä¼šè©±ã‚»ãƒƒã‚·ãƒ§ãƒ³ | 50,000+ |
| 3 | `conversations` | ä¼šè©±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ | 500,000+ |
| 4 | `session_checkpoints` | ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ | 10,000+ |
| 5 | `user_states` | ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ | 10,000+ |
| 6 | `user_contexts` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ | 10,000+ |
| 7 | `user_sessions` | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† | 50,000+ |
| **ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»ç®¡ç†ï¼ˆ7å€‹ï¼‰** |||
| 8 | `generated_codes` | ç”Ÿæˆã‚³ãƒ¼ãƒ‰ | 100,000+ |
| 9 | `generation_queue` | ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚­ãƒ¥ãƒ¼ | 1,000ï¼ˆå‹•çš„ï¼‰ |
| 10 | `code_revisions` | ã‚³ãƒ¼ãƒ‰ä¿®æ­£å±¥æ­´ | 50,000+ |
| 11 | `code_shares` | ã‚³ãƒ¼ãƒ‰å…±æœ‰ | 50,000+ |
| 12 | `code_share_access_logs` | å…±æœ‰ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚° | 200,000+ |
| 13 | `conversation_code_relations` | ä¼šè©±-ã‚³ãƒ¼ãƒ‰é–¢é€£ | 50,000+ |
| 14 | `user_code_history` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰å±¥æ­´ | 100,000+ |
| **ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ»å­¦ç¿’ï¼ˆ2å€‹ï¼‰** |||
| 15 | `error_patterns` | ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³å­¦ç¿’ | 500+ |
| 16 | `error_recovery_logs` | ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãƒ­ã‚° | 10,000+ |
| **ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ2å€‹ï¼‰** |||
| 17 | `user_experience` | çµŒé¨“å€¤ãƒ»ãƒ¬ãƒ™ãƒ« | 10,000+ |
| 18 | `badge_definitions` | ãƒãƒƒã‚¸å®šç¾©ï¼ˆ8ç¨®é¡ï¼‰ | 8 |
| **ä»£ç†åº—ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ7å€‹ï¼‰** |||
| 19 | `agencies` | ä»£ç†åº—æƒ…å ± | 500+ |
| 20 | `agency_users` | ä»£ç†åº—ãƒ¦ãƒ¼ã‚¶ãƒ¼ | 2,000+ |
| 21 | `agency_tracking_links` | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ | 5,000+ |
| 22 | `agency_tracking_visits` | è¨ªå•è¨˜éŒ² | 100,000+ |
| 23 | `agency_conversions` | ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 10,000+ |
| 24 | `agency_commissions` | ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ | 5,000+ |
| 25 | `agency_commission_distributions` | ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³åˆ†é… | 10,000+ |
| **LINEé€£æºï¼ˆ2å€‹ï¼‰** |||
| 26 | `line_profiles` | LINEãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆæ–°ï¼‰ | 10,000+ |
| 27 | `line_users` | LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæ—§ï¼‰ | 10,000+ |
| **æ±ºæ¸ˆãƒ»èª²é‡‘ï¼ˆ4å€‹ï¼‰** |||
| 28 | `activation_codes` | ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ | 1,000+ |
| 29 | `stripe_payments` | Stripeæ±ºæ¸ˆè¨˜éŒ² | 5,000+ |
| 30 | `stripe_events` | Stripeã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚° | 50,000+ |
| 31 | `refunds` | è¿”é‡‘è¨˜éŒ² | 100+ |
| **ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ ãƒ»3å€‹ï¼‰** |||
| 32 | `tracking_links` | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ï¼ˆæ—§ï¼‰ | 1,000+ |
| 33 | `tracking_sessions` | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆæ—§ï¼‰ | 50,000+ |
| 34 | `tracking_visits` | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°è¨ªå•ï¼ˆæ—§ï¼‰ | 100,000+ |
| **åˆ†æãƒ»ãƒ­ã‚°ï¼ˆ3å€‹ï¼‰** |||
| 35 | `conversion_funnels` | ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ãƒãƒ« | 10,000+ |
| 36 | `analytics_events` | åˆ†æã‚¤ãƒ™ãƒ³ãƒˆ | 500,000+ |
| 37 | `vision_usage_logs` | Vision APIä½¿ç”¨ãƒ­ã‚° | 10,000+ |
| **èªè¨¼ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆ1å€‹ï¼‰** |||
| 38 | `password_reset_tokens` | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ | 1,000+ |

#### ãã®ä»–ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ9å€‹ - Supabaseç¢ºèªæ¸ˆã¿ï¼‰

ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å®ŸSupabaseç’°å¢ƒã«å­˜åœ¨ã™ã‚‹ã“ã¨ãŒç¢ºèªã•ã‚Œã¦ã„ã¾ã™ãŒã€è©³ç´°ãªä½¿ç”¨çŠ¶æ³ã¯èª¿æŸ»ä¸­ï¼š

| # | ãƒ†ãƒ¼ãƒ–ãƒ«å | å‚™è€ƒ |
|---|-----------|------|
| 39-47 | ï¼ˆãã®ä»–9ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ | Supabaseå…¨ã‚«ãƒ©ãƒ ãƒªã‚¹ãƒˆã§ç¢ºèªæ¸ˆã¿ |

**åˆè¨ˆ: 47ãƒ†ãƒ¼ãƒ–ãƒ«** ï¼ˆä¸»è¦38ãƒ†ãƒ¼ãƒ–ãƒ« + ãã®ä»–9ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

**æ³¨:** v4.0ã§ã¯ã€Œ25+ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã¨æ¨å®šã—ã¦ã„ã¾ã—ãŸãŒã€v4.1ã§å®ŸSupabaseç’°å¢ƒã‚’æ¤œè¨¼ã—ãŸçµæœã€47ãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚

### 6.2 æ–°è¦ç™ºè¦‹ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°

#### conversationsï¼ˆä¼šè©±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ï¼‰
```sql
CREATE TABLE IF NOT EXISTS conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL,
  session_id TEXT NOT NULL,
  message_index INTEGER NOT NULL,
  role VARCHAR(20) NOT NULL CHECK (role IN ('user', 'assistant', 'system')),
  content TEXT NOT NULL,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(session_id, message_index)
);

CREATE INDEX idx_conversations_user_session ON conversations(user_id, session_id);
CREATE INDEX idx_conversations_created ON conversations(created_at DESC);
CREATE INDEX idx_conversations_session ON conversations(session_id);
```

**ãƒˆãƒªã‚¬ãƒ¼:**
```sql
-- conversation_sessionsã®messagesæ›´æ–°æ™‚ã«è‡ªå‹•åŒæœŸ
CREATE TRIGGER sync_messages_trigger
AFTER INSERT OR UPDATE OF messages ON conversation_sessions
FOR EACH ROW
EXECUTE FUNCTION sync_conversation_messages();
```

#### session_checkpointsï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆï¼‰
```sql
CREATE TABLE IF NOT EXISTS session_checkpoints (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL,
  session_id TEXT NOT NULL,
  checkpoint_type VARCHAR(50) NOT NULL,
  context_snapshot JSONB NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  restored_at TIMESTAMP WITH TIME ZONE,
  is_active BOOLEAN DEFAULT TRUE
);

CREATE INDEX idx_checkpoints_user ON session_checkpoints(user_id);
CREATE INDEX idx_checkpoints_session ON session_checkpoints(session_id);
CREATE INDEX idx_checkpoints_active ON session_checkpoints(is_active) WHERE is_active = TRUE;
```

#### code_revisionsï¼ˆã‚³ãƒ¼ãƒ‰ä¿®æ­£å±¥æ­´ï¼‰
```sql
CREATE TABLE IF NOT EXISTS code_revisions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id TEXT NOT NULL,
  user_id TEXT NOT NULL,
  revision_number INTEGER NOT NULL,
  code_content TEXT NOT NULL,
  requirements JSONB,
  modification_reason TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  parent_revision_id UUID REFERENCES code_revisions(id),
  UNIQUE(session_id, revision_number)
);

CREATE INDEX idx_revisions_session ON code_revisions(session_id);
CREATE INDEX idx_revisions_user ON code_revisions(user_id);
```

#### activation_codesï¼ˆãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
```sql
CREATE TABLE IF NOT EXISTS activation_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code TEXT UNIQUE NOT NULL,
  code_hash TEXT NOT NULL,  -- SHA-256ãƒãƒƒã‚·ãƒ¥
  type VARCHAR(50) DEFAULT 'premium',
  used BOOLEAN DEFAULT false,
  used_by VARCHAR(100),  -- LINE User ID
  used_at TIMESTAMP WITH TIME ZONE,
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  metadata JSONB DEFAULT '{}'::jsonb
);

CREATE INDEX idx_activation_codes_hash ON activation_codes(code_hash);
```

**ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°:**
```sql
CREATE OR REPLACE FUNCTION activate_premium_plan(
  p_line_user_id VARCHAR(100),
  p_activation_code TEXT,
  p_duration_days INTEGER DEFAULT 365
)
RETURNS BOOLEAN
LANGUAGE plpgsql
AS $$
DECLARE
  v_code_hash TEXT;
  v_code_valid BOOLEAN;
BEGIN
  -- SHA-256ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆ
  v_code_hash := encode(sha256(p_activation_code::bytea), 'hex');

  -- ã‚³ãƒ¼ãƒ‰æ¤œè¨¼
  SELECT EXISTS(
    SELECT 1 FROM activation_codes
    WHERE code_hash = v_code_hash
    AND used = false
    AND (expires_at IS NULL OR expires_at > NOW())
  ) INTO v_code_valid;

  IF NOT v_code_valid THEN
    RETURN FALSE;
  END IF;

  -- ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨æ¸ˆã¿ã«ãƒãƒ¼ã‚¯
  UPDATE activation_codes
  SET used = true, used_by = p_line_user_id, used_at = NOW()
  WHERE code_hash = v_code_hash;

  -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã«
  UPDATE user_states
  SET is_premium = true,
      premium_activated_at = NOW(),
      premium_expires_at = NOW() + (p_duration_days || ' days')::interval,
      premium_activation_code = v_code_hash,
      premium_features = '["unlimited_tracking", "advanced_analytics", "api_access", "priority_support"]'::jsonb,
      updated_at = NOW()
  WHERE line_user_id = p_line_user_id;

  RETURN TRUE;
END;
$$;
```

### 6.3 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°ãƒ»ãƒˆãƒªã‚¬ãƒ¼

#### ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯é–¢æ•°
```sql
CREATE OR REPLACE FUNCTION check_level_up(p_user_id VARCHAR)
RETURNS TABLE(level_up BOOLEAN, new_level INT) AS $$
DECLARE
  current_xp INT;
  current_level INT;
  calculated_level INT;
BEGIN
  SELECT total_xp, level INTO current_xp, current_level
  FROM user_experience
  WHERE user_id = p_user_id;

  -- ãƒ¬ãƒ™ãƒ«è¨ˆç®—: âˆš(XP/100) + 1
  calculated_level := FLOOR(SQRT(current_xp::DECIMAL / 100)) + 1;

  IF calculated_level > current_level THEN
    UPDATE user_experience
    SET level = calculated_level, updated_at = NOW()
    WHERE user_id = p_user_id;

    RETURN QUERY SELECT true, calculated_level;
  ELSE
    RETURN QUERY SELECT false, current_level;
  END IF;
END;
$$ LANGUAGE plpgsql;
```

#### ãƒãƒƒã‚¸è§£é™¤ãƒã‚§ãƒƒã‚¯é–¢æ•°
```sql
CREATE OR REPLACE FUNCTION check_badge_unlock(p_user_id VARCHAR)
RETURNS TABLE(badge_key VARCHAR, badge_name VARCHAR, badge_icon VARCHAR) AS $$
DECLARE
  user_stats RECORD;
  badge_rec RECORD;
  user_badges JSONB;
  condition_met BOOLEAN;
BEGIN
  -- ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆå–å¾—
  SELECT * INTO user_stats FROM user_experience WHERE user_id = p_user_id;

  IF NOT FOUND THEN
    RETURN;
  END IF;

  user_badges := COALESCE(user_stats.badges, '[]'::jsonb);

  -- å„ãƒãƒƒã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
  FOR badge_rec IN SELECT * FROM badge_definitions LOOP
    -- æ—¢ã«ç²å¾—æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
    IF user_badges ? badge_rec.badge_key THEN
      CONTINUE;
    END IF;

    -- æ¡ä»¶ãƒã‚§ãƒƒã‚¯
    condition_met := false;

    IF badge_rec.unlock_condition ? 'codes_generated' THEN
      IF user_stats.codes_generated >= (badge_rec.unlock_condition->>'codes_generated')::INT THEN
        condition_met := true;
      END IF;
    END IF;

    IF badge_rec.unlock_condition ? 'errors_fixed' THEN
      IF user_stats.errors_fixed >= (badge_rec.unlock_condition->>'errors_fixed')::INT THEN
        condition_met := true;
      END IF;
    END IF;

    IF badge_rec.unlock_condition ? 'auto_fixes_count' THEN
      IF user_stats.auto_fixes_count >= (badge_rec.unlock_condition->>'auto_fixes_count')::INT THEN
        condition_met := true;
      END IF;
    END IF;

    -- æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚Œã°ãƒãƒƒã‚¸ä»˜ä¸
    IF condition_met THEN
      user_badges := user_badges || jsonb_build_array(badge_rec.badge_key);

      UPDATE user_experience
      SET badges = user_badges, updated_at = NOW()
      WHERE user_id = p_user_id;

      RETURN QUERY SELECT badge_rec.badge_key, badge_rec.badge_name, badge_rec.badge_icon;
    END IF;
  END LOOP;
END;
$$ LANGUAGE plpgsql;
```

#### ä¼šè©±ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
```sql
CREATE OR REPLACE FUNCTION cleanup_old_conversations()
RETURNS void AS $$
BEGIN
  -- 30æ—¥ä»¥ä¸Šå‰ã®ä¼šè©±ã‚’å‰Šé™¤
  DELETE FROM conversations
  WHERE created_at < CURRENT_TIMESTAMP - INTERVAL '30 days';

  -- éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã§7æ—¥ä»¥ä¸Šå‰ã®ã‚‚ã®ã‚’å‰Šé™¤
  DELETE FROM session_checkpoints
  WHERE is_active = FALSE
  AND created_at < CURRENT_TIMESTAMP - INTERVAL '7 days';

  RAISE NOTICE 'Cleanup completed. Deleted old conversations and checkpoints.';
END;
$$ LANGUAGE plpgsql;
```

#### ã‚³ãƒ¼ãƒ‰å…±æœ‰ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
```sql
CREATE OR REPLACE FUNCTION cleanup_expired_code_shares()
RETURNS void AS $$
BEGIN
  -- æœ‰åŠ¹æœŸé™ã‹ã‚‰7æ—¥çµŒéã—ãŸéãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚³ãƒ¼ãƒ‰ã‚’ç‰©ç†å‰Šé™¤
  DELETE FROM code_shares
  WHERE expires_at < NOW() - INTERVAL '7 days'
    AND is_premium = false
    AND is_deleted = true;

  -- æœ‰åŠ¹æœŸé™åˆ‡ã‚Œã‚³ãƒ¼ãƒ‰ã‚’è«–ç†å‰Šé™¤
  UPDATE code_shares
  SET is_deleted = true,
      deletion_reason = 'expired'
  WHERE expires_at < NOW()
    AND is_deleted = false;
END;
$$ LANGUAGE plpgsql;
```

#### ã‚³ãƒ¼ãƒ‰å…±æœ‰ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
```sql
-- çŸ­ç¸®IDé‡è¤‡ãƒã‚§ãƒƒã‚¯
CREATE OR REPLACE FUNCTION check_short_id_exists(p_short_id VARCHAR(8))
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (SELECT 1 FROM code_shares WHERE short_id = p_short_id);
END;
$$ LANGUAGE plpgsql;

-- é–²è¦§å›æ•°ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
CREATE OR REPLACE FUNCTION increment_view_count(p_short_id VARCHAR(8))
RETURNS void AS $$
BEGIN
  UPDATE code_shares
  SET view_count = view_count + 1,
      last_viewed_at = NOW()
  WHERE short_id = p_short_id;
END;
$$ LANGUAGE plpgsql;

-- ã‚³ãƒ”ãƒ¼å›æ•°ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
CREATE OR REPLACE FUNCTION increment_copy_count(p_short_id VARCHAR(8))
RETURNS void AS $$
BEGIN
  UPDATE code_shares
  SET copy_count = copy_count + 1
  WHERE short_id = p_short_id;
END;
$$ LANGUAGE plpgsql;
```

---

## 7. å¤–éƒ¨APIé€£æº

### 7.1 Claude AI API

**ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«:** `claude-3-5-sonnet-20241022`

**ä¸»ãªç”¨é€”:**
1. **ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ** - GASã‚³ãƒ¼ãƒ‰è‡ªå‹•ç”Ÿæˆ
2. **Vision API** - ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè§£æï¼ˆOCRã€ã‚¨ãƒ©ãƒ¼æŠ½å‡ºï¼‰
3. **ã‚³ãƒ¼ãƒ‰ä¿®æ­£** - ã‚¨ãƒ©ãƒ¼è‡ªå‹•ä¿®æ­£ï¼ˆAIä¿®æ­£æˆ¦ç•¥ï¼‰
4. **å“è³ªãƒã‚§ãƒƒã‚¯** - ç”Ÿæˆã‚³ãƒ¼ãƒ‰ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼
5. **è¦ä»¶æŠ½å‡º** - è‡ªç„¶è¨€èªã‹ã‚‰ã®è¦ä»¶æŠ½å‡º

**æ–™é‡‘:**
- Input: $3 / 1M tokens
- Output: $15 / 1M tokens
- Images: $4.80 / 1K images

**åˆ¶é™:**
- Rate Limit: 50 req/min
- Token Limit: 200K tokens/request
- Visionåˆ¶é™: 500æš/æœˆï¼ˆãƒ—ãƒ©ãƒ³ä¾å­˜ï¼‰

### 7.2 LINE Messaging API

**ä¸»ãªç”¨é€”:**
1. **Push Message** - èƒ½å‹•çš„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆã‚³ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†é€šçŸ¥ç­‰ï¼‰
2. **Reply Message** - Webhookå¿œç­”
3. **Loading Animation** - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼ˆæœ€å¤§60ç§’ï¼‰
4. **Rich Message** - Flex Message, Buttons Template, Carousel

**åˆ¶é™:**
- Push Message: 500é€š/æœˆï¼ˆç„¡æ–™ï¼‰
- Reply: ç„¡åˆ¶é™
- Rate Limit: 100 req/sec
- Flex Message: æœ€å¤§10å€‹ã®bubble

### 7.3 Stripe API

**ä¸»ãªç”¨é€”:**
1. **Checkout Session** - æ±ºæ¸ˆç”»é¢ç”Ÿæˆï¼ˆæœˆé¡980å††ãƒ—ãƒ©ãƒ³ï¼‰
2. **Subscription** - ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†ï¼ˆè‡ªå‹•æ›´æ–°ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
3. **Customer** - é¡§å®¢ç®¡ç†
4. **Refund** - è¿”é‡‘å‡¦ç†
5. **Invoice** - è«‹æ±‚æ›¸ç®¡ç†

**Webhook ã‚¤ãƒ™ãƒ³ãƒˆ:**
- `checkout.session.completed` - æ±ºæ¸ˆå®Œäº†
- `payment_intent.succeeded` - æ±ºæ¸ˆæˆåŠŸ
- `customer.subscription.updated` - ã‚µãƒ–ã‚¹ã‚¯æ›´æ–°
- `customer.subscription.deleted` - ã‚µãƒ–ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«
- `charge.refunded` - è¿”é‡‘å‡¦ç†

---

## 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 8.1 èªè¨¼ãƒ»èªå¯

| æ©Ÿèƒ½ | èªè¨¼æ–¹æ³• | ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  | ç”¨é€” |
|-----|---------|------------|------|
| LINE Webhook | HMACç½²åæ¤œè¨¼ | HMAC-SHA256 | LINE Platform |
| Stripe Webhook | HMACç½²åæ¤œè¨¼ | HMAC-SHA256 | Stripe |
| ç®¡ç†API | JWT Bearer Token | HS256 | ç®¡ç†ç”»é¢ |
| Cronã‚¸ãƒ§ãƒ– | CRON_SECRET | Bearer Token | å®šæœŸå‡¦ç† |

### 8.2 ãƒ‡ãƒ¼ã‚¿ä¿è­·

- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**: bcrypt (saltRounds: 10)
- **JWT**: HS256, 7æ—¥é–“æœ‰åŠ¹, ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒå¯¾ç­–
- **å…±æœ‰ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**: bcrypt (saltRounds: 10)
- **ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰**: SHA-256ãƒãƒƒã‚·ãƒ¥
- **ç’°å¢ƒå¤‰æ•°**: .env.local (Gité™¤å¤–)

### 8.3 ãƒ¬ãƒ¼ãƒˆåˆ¶é™

```typescript
const rateLimiters = {
  webhook: { max: 100, windowMs: 60000 },       // 100req/min
  codeGeneration: { max: 10, windowMs: 60000 }, // 10req/min
  auth: { max: 5, windowMs: 300000 },           // 5req/5min
  fileUpload: { max: 5, windowMs: 60000 },      // 5req/min
  apiKey: { max: 1000, windowMs: 60000 }        // 1000req/min
};
```

### 8.4 ã‚¹ãƒ‘ãƒ æ¤œå‡º

**æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³:**
1. åŒã˜æ–‡å­—ã®5é€£ç¶šï¼ˆä¾‹: "aaaaaaa"ï¼‰
2. ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ï¼ˆ30æ–‡å­—ä»¥ä¸Šï¼‰
3. éãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆURLï¼ˆ5å€‹ä»¥ä¸Šï¼‰
4. ã‚¹ãƒ‘ãƒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
5. Googleãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆï¼ˆdocs.google.comç­‰ã¯è¨±å¯ï¼‰

---

## 9. ç’°å¢ƒå¤‰æ•°ï¼ˆå…¨24å€‹ï¼‰

### 9.1 Supabaseæ¥ç¶šï¼ˆ4å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å€¤ã®ä¾‹ |
|---|--------|------|--------|
| 1 | `SUPABASE_URL` | Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURL | `https://ebtcowcgkdurqdqcjrxy.supabase.co` |
| 2 | `SUPABASE_SERVICE_ROLE_KEY` | ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼ï¼ˆRLSç„¡è¦–ï¼‰ | `eyJhbGc...` |
| 3 | `SUPABASE_SERVICE_KEY` | ã‚µãƒ¼ãƒ“ã‚¹ã‚­ãƒ¼ï¼ˆå¾Œæ–¹äº’æ›ï¼‰ | `eyJhbGc...`ï¼ˆSERVICE_ROLE_KEYã¨åŒã˜å€¤ï¼‰ |
| 4 | `SUPABASE_ANON_KEY` | åŒ¿åã‚­ãƒ¼ | `eyJhbGc...` |

### 9.2 LINE Messaging APIï¼ˆ2å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å€¤ã®ä¾‹ |
|---|--------|------|--------|
| 5 | `LINE_CHANNEL_ACCESS_TOKEN` | LINE APIã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ | `a/iQAlWnnV...` |
| 6 | `LINE_CHANNEL_SECRET` | Webhookç½²åæ¤œè¨¼ç”¨ | `0917a4d9a84...` |

### 9.3 AIãƒ»æ±ºæ¸ˆAPIï¼ˆ4å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å€¤ã®ä¾‹ |
|---|--------|------|--------|
| 7 | `ANTHROPIC_API_KEY` | Claude 3.5 Sonnet APIã‚­ãƒ¼ | `sk-ant-api03-sGqW...` |
| 8 | `STRIPE_SECRET_KEY` | Stripeæœ¬ç•ªAPIã‚­ãƒ¼ | `sk_live_51MQ8IQG...` |
| 9 | `STRIPE_WEBHOOK_SECRET` | Stripe Webhookç½²åæ¤œè¨¼ | `whsec_C1FXcTb...` |
| 10 | `STRIPE_PRICE_ID` | Stripeä¾¡æ ¼ID | `prod_SyK4heIT...` |

### 9.4 Stripeæ±ºæ¸ˆãƒªãƒ³ã‚¯ï¼ˆ2å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å€¤ã®ä¾‹ |
|---|--------|------|--------|
| 11 | `STRIPE_PAYMENT_LINK` | é€šå¸¸ãƒ—ãƒ©ãƒ³æ±ºæ¸ˆURL | `https://buy.stripe.com/7sY3cv2So...` |
| 12 | `STRIPE_PROFESSIONAL_PAYMENT_LINK` | Professionalãƒ—ãƒ©ãƒ³æ±ºæ¸ˆURL | `https://buy.stripe.com/fZu6oH78E...` |

### 9.5 Next.js Publicå¤‰æ•°ï¼ˆ4å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å€¤ã®ä¾‹ |
|---|--------|------|--------|
| 13 | `NEXT_PUBLIC_BASE_URL` | ãƒ™ãƒ¼ã‚¹URLï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå…¬é–‹ï¼‰ | `https://gasgenerator.onrender.com` |
| 14 | `NEXT_PUBLIC_APP_URL` | ã‚¢ãƒ—ãƒªURLï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå…¬é–‹ï¼‰ | `https://gasgenerator.onrender.com` |
| 15 | `NEXT_PUBLIC_SUPABASE_URL` | Supabase URLï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå…¬é–‹ï¼‰ | `https://ebtcowcgkdurqd...` |
| 16 | `NEXT_PUBLIC_SUPABASE_ANON_KEY` | SupabaseåŒ¿åã‚­ãƒ¼ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå…¬é–‹ï¼‰ | `eyJhbGc...` |

### 9.6 Renderå›ºæœ‰è¨­å®šï¼ˆ3å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å€¤ã®ä¾‹ |
|---|--------|------|--------|
| 17 | `NODE_ENV` | å®Ÿè¡Œç’°å¢ƒ | `production` |
| 18 | `NODE_OPTIONS` | Node.jsã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ¡ãƒ¢ãƒª1.5GBï¼‰ | `--max-old-space-size=1536` |
| 19 | `PORT` | ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒˆ | `10000` |

### 9.7 å¤–éƒ¨é€£æºãƒ»ç®¡ç†ï¼ˆ5å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å€¤ã®ä¾‹ |
|---|--------|------|--------|
| 20 | `NETLIFY_WEBHOOK_URL` | Netlify LINE Webhookè»¢é€å…ˆ | `https://taskmateai.net/.netlify/functions/line-webhook` |
| 21 | `ADMIN_API_TOKEN` | ç®¡ç†APIèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ | `7a8b9c0d1e2f...` |
| 22 | `CRON_SECRET` | Cronã‚¸ãƒ§ãƒ–èªè¨¼ç”¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | `render-secret-key-2024` |
| 23 | `ENGINEER_SUPPORT_GROUP_ID` | ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚µãƒãƒ¼ãƒˆLINEã‚°ãƒ«ãƒ¼ãƒ—ID | `C7c168b78f4014...` |
| 24 | `ENGINEER_USER_IDS` | ã‚µãƒãƒ¼ãƒˆå¯¾è±¡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®LINE IDï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ | `U2ebcb5ac17f...,U192ea84adf...` |

---

### 9.8 ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç’°å¢ƒå¤‰æ•°

ä»¥ä¸‹ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãŒRenderã§æœªè¨­å®šã®å¤‰æ•°ï¼š

```bash
# Redisï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ã‚­ãƒ¥ãƒ¼ç®¡ç†ï¼‰
REDIS_URL=redis://localhost:6379  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥

# SendGridï¼ˆãƒ¡ãƒ¼ãƒ«é€šçŸ¥ï¼‰
SENDGRID_API_KEY=SG.xxx...
EMAIL_FROM=noreply@taskmateai.net

# ãƒ­ã‚°è¨­å®š
LOG_LEVEL=info  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: info

# Adminé€šçŸ¥
ADMIN_LINE_USER_ID=Uxxx...
ADMIN_ALLOWED_IPS=203.0.113.0/24
```

---

## 10. ãƒ‡ãƒ—ãƒ­ã‚¤

### 10.1 Renderè¨­å®š

**ãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰:**
```bash
npm install && npm run build
```

**é–‹å§‹ã‚³ãƒãƒ³ãƒ‰:**
```bash
npm start
```

**ç’°å¢ƒ:**
- Runtime: Node.js 20
- Plan: Standard (2GB RAM, 0.5 CPU)
- Region: Oregon (US West)
- ãƒ¡ãƒ¢ãƒªè¨­å®š: `NODE_OPTIONS=--max-old-space-size=1536 --expose-gc`

**ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“:** ç´„3-5åˆ†

### 10.2 ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®š

**Render Dashboard â†’ Service â†’ Health Check Path**
```
/api/health
```

**æœŸå¾…ãƒ¬ã‚¹ãƒãƒ³ã‚¹:** HTTP 200

**ãƒã‚§ãƒƒã‚¯é …ç›®:**
- Databaseæ¥ç¶šï¼ˆSupabaseï¼‰
- Redisæ¥ç¶šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- LINE APIæ¥ç¶š
- ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆ9å€‹ï¼‰

---

## 11. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 11.1 ã‚­ãƒ¥ãƒ¼å‡¦ç†ãŒæ­¢ã¾ã‚‹

**ç—‡çŠ¶:**
```
generation_queue ã« pending ã®ã‚¸ãƒ§ãƒ–ãŒæºœã¾ã‚Šç¶šã‘ã‚‹
```

**åŸå› :**
- Cron ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„
- ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ç™ºç”Ÿï¼ˆ5åˆ†ä»¥ä¸Šprocessingï¼‰

**å¯¾å‡¦:**
```bash
# æ‰‹å‹•ã§Cronå®Ÿè¡Œ
curl https://gasgenerator.onrender.com/api/cron/process-queue \
  -H "Authorization: Bearer ${CRON_SECRET}"

# ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆè‡ªå‹•ã§5åˆ†ä»¥ä¸Šprocessingã®ã‚¸ãƒ§ãƒ–ã‚’pendingã«æˆ»ã™ï¼‰
```

### 11.2 Vision API åˆ¶é™è¶…é

**ç—‡çŠ¶:**
```
Error: Vision API monthly limit exceeded (500/500)
```

**å¯¾å‡¦:**
1. `vision_usage_logs` ãƒ†ãƒ¼ãƒ–ãƒ«ã§ä½¿ç”¨çŠ¶æ³ç¢ºèª
2. åˆ¶é™ç·©å’Œã¾ãŸã¯æœˆæ¬¡ãƒªã‚»ãƒƒãƒˆå¾…ã¡
3. ã‚¨ãƒ©ãƒ¼å›å¾©æ©Ÿèƒ½ã‚’ä¸€æ™‚ç„¡åŠ¹åŒ–

### 11.3 ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶:**
```
FATAL ERROR: Reached heap limit Allocation failed - JavaScript heap out of memory
```

**åŸå› :**
- ãƒ¡ãƒ¢ãƒªè¨­å®šãŒä¸é©åˆ‡ï¼ˆNODE_OPTIONSæœªè¨­å®šï¼‰
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯

**å¯¾å‡¦:**
```bash
# ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆRender Dashboardï¼‰
NODE_OPTIONS=--max-old-space-size=1536 --expose-gc

# ãƒ¡ãƒ¢ãƒªç›£è¦–ãƒ­ã‚°ç¢ºèª
# ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«é–¾å€¤ï¼ˆ90%ï¼‰è¶…éæ™‚ã¯è‡ªå‹•GCå®Ÿè¡Œ
```

### 11.4 LINE Webhook ç½²åã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶:**
```
Error: Invalid LINE signature
```

**åŸå› :**
- `LINE_CHANNEL_SECRET` ãŒé–“é•ã£ã¦ã„ã‚‹
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®æ”¹å¤‰

**å¯¾å‡¦:**
1. LINE Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§`Channel Secret`ç¢ºèª
2. ç’°å¢ƒå¤‰æ•°ã‚’æ­£ã—ãè¨­å®š

---

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆçµ‚äº†**

**æœ€çµ‚æ›´æ–°:** 2025-10-23
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 4.0ï¼ˆå¾¹åº•çš„ãªè¾›å£ãƒã‚§ãƒƒã‚¯å¾Œã®å®Œå…¨ç‰ˆï¼‰
**ç·ãƒšãƒ¼ã‚¸æ•°:** 2000+è¡Œï¼ˆå®Ÿè£…ãƒ™ãƒ¼ã‚¹å®Œå…¨ç‰ˆï¼‰
**ã‚«ãƒãƒ¼ç¯„å›²:**
- APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: 12å€‹
- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: 100+å€‹
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«: 25+å€‹
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°ãƒ»ãƒˆãƒªã‚¬ãƒ¼: 10+å€‹
- ç’°å¢ƒå¤‰æ•°: 9å€‹ï¼ˆå¿…é ˆï¼‰ + æ¨å¥¨å¤šæ•°
