<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMate AI - 代理店管理システム</title>
    <!-- ⚠️ セキュリティ警告: cdn.tailwindcss.comはJITコンパイラのためSRI未対応 -->
    <!-- 本番環境ではビルド時にTailwind CSSをコンパイルして使用することを強く推奨 -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js with SRI (Subresource Integrity) -->
    <!-- 🔧 DEBUGGING: SRI temporarily removed to check if it's blocking Alpine.js -->
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"
            crossorigin="anonymous"
            defer></script>
    <!-- Original with SRI (restore after debugging):
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"
            integrity="sha384-xw/ARJaqXKsFgDt0AhxLQ65mGvCjEjWEReZ6OqiLWJUlIi8y+4zOjsJgYY6YGDX0"
            crossorigin="anonymous"
            defer></script>
    -->

    <!-- Font Awesome with SRI -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
          crossorigin="anonymous"
          referrerpolicy="no-referrer">
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 to-green-50 min-h-screen" x-data="agencyDashboard()" x-init="init()" x-cloak>
    <!-- ログイン画面 -->
    <div x-show="!isAuthenticated && !showRegister" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md border border-emerald-100">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-emerald-600 to-green-600 rounded-full mb-4">
                    <i class="fas fa-chart-line text-3xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">代理店管理システム</h1>
                <p class="text-gray-600 mt-2">TaskMate AI パートナーポータル</p>
            </div>

            <form @submit.prevent="login()" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">メールアドレス</label>
                    <input type="email" x-model="loginForm.email" autocomplete="email" required
                           class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                           placeholder="agency@example.com">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">パスワード</label>
                    <input type="password" x-model="loginForm.password" autocomplete="current-password" required
                           class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                           placeholder="••••••••">
                </div>

                <div class="flex items-center justify-between">
                    <label class="flex items-center">
                        <input type="checkbox" x-model="loginForm.remember" class="rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                        <span class="ml-2 text-sm text-gray-600">ログイン状態を保持</span>
                    </label>
                    <a href="/agency/reset-password.html" class="text-sm text-emerald-600 hover:text-emerald-700">パスワードを忘れた方</a>
                </div>

                <button type="submit" :disabled="loading"
                        class="w-full bg-gradient-to-r from-emerald-600 to-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:from-emerald-700 hover:to-green-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!loading">ログイン</span>
                    <span x-show="loading" class="inline-flex items-center">
                        <i class="fas fa-spinner fa-spin mr-2"></i> ログイン中...
                    </span>
                </button>

                <div x-show="loginError" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                    <span x-text="loginError"></span>
                </div>
            </form>

            <div class="mt-8 pt-6 border-t border-gray-200 text-center space-y-3">
                <p class="text-sm text-gray-600">
                    代理店登録をご希望の方は
                    <button @click="showRegister = true" class="text-emerald-600 hover:text-emerald-700 font-medium">こちら</button>
                </p>
                <p class="text-sm text-gray-600">
                    <a href="/" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left mr-1"></i> メインページに戻る
                    </a>
                </p>
            </div>
        </div>
    </div>

    <!-- 新規登録画面 -->
    <div x-show="!isAuthenticated && showRegister" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg border border-emerald-100">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-emerald-600 to-green-600 rounded-full mb-4">
                    <i class="fas fa-user-plus text-3xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">代理店新規登録</h1>
                <p class="text-gray-600 mt-2">TaskMate AI パートナー登録</p>
            </div>

            <form @submit.prevent="register()" class="space-y-4">
                <!-- 会社情報 -->
                <div class="space-y-4 pb-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700">会社情報</h3>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">会社名 *</label>
                        <input type="text" x-model="registerForm.company_name" autocomplete="organization" required
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="株式会社〇〇">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">代理店名 *</label>
                        <input type="text" x-model="registerForm.agency_name" autocomplete="organization" required
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="〇〇営業所">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">住所</label>
                        <input type="text" x-model="registerForm.address" autocomplete="street-address"
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="東京都〇〇区...">
                    </div>
                </div>

                <!-- 担当者情報 -->
                <div class="space-y-4 pb-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700">担当者情報</h3>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">担当者名 *</label>
                        <input type="text" x-model="registerForm.contact_name" autocomplete="name" required
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="山田太郎">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">メールアドレス *</label>
                        <input type="email" x-model="registerForm.email" autocomplete="email" required
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="contact@company.com">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">電話番号 *</label>
                        <input type="tel" x-model="registerForm.phone" autocomplete="tel" required
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="03-1234-5678">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            招待コード *
                            <span class="text-xs text-gray-500 font-normal ml-2">（代理店から提供されたコード）</span>
                        </label>
                        <input type="text" x-model="registerForm.invitation_code" autocomplete="off" required
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors font-mono"
                               placeholder="例: abc123xyz456"
                               pattern="[a-zA-Z0-9]{8,20}"
                               title="招待コードは英数字8〜20文字です">
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            代理店担当者から提供された招待コードを入力してください
                        </p>
                    </div>
                </div>

                <!-- パスワード情報 -->
                <div class="space-y-4 pb-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700">パスワード設定</h3>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">パスワード *</label>
                        <input type="password" x-model="registerForm.password" autocomplete="new-password" required minlength="8"
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="8文字以上で入力">
                        <p class="text-xs text-gray-500 mt-1">英大文字、英小文字、数字、記号のうち2種類以上を含めてください</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">パスワード（確認）*</label>
                        <input type="password" x-model="registerForm.password_confirm" autocomplete="new-password" required minlength="8"
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="もう一度入力">
                    </div>
                </div>

                <!-- 利用規約 -->
                <div>
                    <label class="flex items-start">
                        <input type="checkbox" x-model="registerForm.agree_terms" required
                               class="mt-1 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                        <span class="ml-2 text-sm text-gray-600">
                            <a href="terms.html" target="_blank" class="text-emerald-600 hover:text-emerald-700">利用規約</a>および
                            <a href="privacy.html" target="_blank" class="text-emerald-600 hover:text-emerald-700">プライバシーポリシー</a>
                            に同意します
                        </span>
                    </label>
                </div>

                <button type="submit" :disabled="loading"
                        class="w-full bg-gradient-to-r from-emerald-600 to-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:from-emerald-700 hover:to-green-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!loading">登録する</span>
                    <span x-show="loading" class="inline-flex items-center">
                        <i class="fas fa-spinner fa-spin mr-2"></i> 登録中...
                    </span>
                </button>

                <div x-show="registerError" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                    <span x-text="registerError"></span>
                </div>

                <div x-show="registerSuccess" class="bg-emerald-50 border border-emerald-200 text-emerald-700 px-4 py-3 rounded-lg">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>登録が完了しました！ログイン画面に移動します...</span>
                </div>
            </form>

            <div class="mt-6 pt-4 border-t border-gray-200 text-center space-y-3">
                <p class="text-sm text-gray-600">
                    既にアカウントをお持ちの方は
                    <button @click="showRegister = false" class="text-emerald-600 hover:text-emerald-700 font-medium">ログイン</button>
                </p>
                <p class="text-sm text-gray-600">
                    <a href="/" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left mr-1"></i> メインページに戻る
                    </a>
                </p>
            </div>
        </div>
    </div>

    <!-- ダッシュボード -->
    <div x-show="isAuthenticated" class="min-h-screen">
        <!-- ヘッダー -->
        <header class="bg-white shadow-sm border-b border-emerald-100">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <div class="inline-flex items-center justify-center w-10 h-10 bg-gradient-to-br from-emerald-600 to-green-600 rounded-full">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900">TaskMate AI 代理店システム</h1>
                            <p class="text-sm text-gray-600" x-text="`${agencyInfo.name} - ${userInfo.name}さん`"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm text-gray-600">今月の成果</p>
                            <p class="text-lg font-bold text-emerald-600" x-text="`¥${stats.monthlyCommission.toLocaleString()}`"></p>
                        </div>
                        <a href="/"
                           class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors border border-gray-300 inline-flex items-center">
                            <i class="fas fa-home mr-2"></i> メインページ
                        </a>
                        <button @click="logout()"
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-sign-out-alt mr-2"></i> ログアウト
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- 統計カード -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">作成リンク数</p>
                            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="stats.totalLinks"></p>
                        </div>
                        <div class="bg-emerald-100 rounded-full p-3">
                            <i class="fas fa-link text-emerald-600"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">総クリック数</p>
                            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="stats.totalClicks"></p>
                        </div>
                        <div class="bg-green-100 rounded-full p-3">
                            <i class="fas fa-mouse-pointer text-green-600"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">コンバージョン数</p>
                            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="stats.totalConversions"></p>
                        </div>
                        <div class="bg-green-100 rounded-full p-3">
                            <i class="fas fa-users text-green-700"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">コンバージョン率</p>
                            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="`${stats.conversionRate}%`"></p>
                        </div>
                        <div class="bg-emerald-100 rounded-full p-3">
                            <i class="fas fa-percentage text-emerald-700"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- タブメニュー -->
            <div class="bg-white rounded-xl shadow-lg border border-emerald-100 mb-8">
                <div class="border-b border-emerald-100">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button @click="activeTab = 'create'"
                                :class="activeTab === 'create' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                            <i class="fas fa-plus-circle mr-2"></i> リンク作成
                        </button>
                        <button @click="activeTab = 'links'; loadTrackingLinks()"
                                :class="activeTab === 'links' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                            <i class="fas fa-link mr-2"></i> リンク管理
                        </button>
                        <button @click="activeTab = 'analytics'; loadAnalytics()"
                                :class="activeTab === 'analytics' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                            <i class="fas fa-chart-bar mr-2"></i> 分析
                        </button>
                        <button @click="activeTab = 'commissions'; loadCommissions()"
                                :class="activeTab === 'commissions' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                            <i class="fas fa-yen-sign mr-2"></i> 報酬
                        </button>
                        <button @click="activeTab = 'billing'; loadBillingStats()"
                                :class="activeTab === 'billing' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                            <i class="fas fa-credit-card mr-2"></i> 課金状況
                        </button>
                        <button @click="activeTab = 'settings'"
                                :class="activeTab === 'settings' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                            <i class="fas fa-cog mr-2"></i> 設定
                        </button>
                    </nav>
                </div>

                <!-- リンク作成タブ -->
                <div x-show="activeTab === 'create'" class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">新規トラッキングリンク作成</h2>

                    <form @submit.prevent="createLink()" class="space-y-4 max-w-2xl">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">キャンペーン名 *</label>
                            <input type="text" x-model="newLink.name" autocomplete="off" required
                                   class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                   placeholder="例: 2024年春のキャンペーン">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">流入元（UTM Source）</label>
                                <input type="text" x-model="newLink.utm_source" autocomplete="off"
                                       class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                       placeholder="例: facebook, twitter, line">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">メディア（UTM Medium）</label>
                                <input type="text" x-model="newLink.utm_medium" autocomplete="off"
                                       class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                       placeholder="例: social, email, banner">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">キャンペーン（UTM Campaign）</label>
                            <input type="text" x-model="newLink.utm_campaign" autocomplete="off"
                                   class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                   placeholder="例: spring_sale_2024">
                        </div>

                        <!-- Info: LINE URL is automatically set from environment -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                                <div>
                                    <p class="text-sm text-blue-800 font-medium">リダイレクト先について</p>
                                    <p class="text-sm text-blue-700 mt-1">トラッキングリンクは自動的にTaskMate公式LINEアカウントへリダイレクトされます。</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex space-x-4">
                            <button type="submit" :disabled="loading"
                                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <span x-show="!loading">リンクを作成</span>
                                <span x-show="loading">
                                    <i class="fas fa-spinner fa-spin mr-2"></i> 作成中...
                                </span>
                            </button>
                            <button type="button" @click="resetForm()"
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium transition-colors">
                                リセット
                            </button>
                        </div>
                    </form>

                    <!-- 作成成功メッセージ -->
                    <div x-show="createdLink" class="mt-6 bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                        <p class="text-emerald-800 font-semibold mb-2">✅ トラッキングリンクを作成しました！</p>
                        <div class="flex items-center space-x-2">
                            <input type="text" :value="createdLink" readonly
                                   class="flex-1 px-3 py-2 bg-white border border-emerald-300 rounded-lg text-sm">
                            <button @click="copyToClipboard(createdLink, $event)"
                                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-copy mr-2"></i> コピー
                            </button>
                        </div>
                    </div>
                </div>

                <!-- リンク管理タブ -->
                <div x-show="activeTab === 'links'" class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">作成済みリンク一覧</h2>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-emerald-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">キャンペーン名</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">トラッキングコード</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">クリック数</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">コンバージョン</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">作成日</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">アクション</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="link in trackingLinks" :key="link.id">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="link.name"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <code x-text="link.tracking_code" class="bg-gray-100 px-2 py-1 rounded"></code>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="link.visit_count"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="link.conversion_count"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(link.created_at)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button @click="copyToClipboard(getTrackingUrl(link.tracking_code), $event)"
                                                    class="bg-emerald-100 hover:bg-emerald-200 text-emerald-600 px-3 py-1 rounded-lg mr-2 transition-colors">
                                                <i class="fas fa-copy"></i> コピー
                                            </button>
                                            <button @click="viewLinkDetails(link)"
                                                    class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-lg transition-colors">
                                                <i class="fas fa-chart-line"></i> 詳細
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 分析タブ -->
                <div x-show="activeTab === 'analytics'" class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">パフォーマンス分析</h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 期間別パフォーマンス -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">期間別パフォーマンス</h3>
                            <canvas id="performanceChart"></canvas>
                        </div>

                        <!-- コンバージョンファネル -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">コンバージョンファネル</h3>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-600">クリック</span>
                                        <span class="text-sm font-semibold" x-text="stats.totalClicks"></span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-8">
                                        <div class="bg-emerald-600 h-8 rounded-full flex items-center justify-center text-white text-xs" style="width: 100%">100%</div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-600">LINE友達追加</span>
                                        <span class="text-sm font-semibold" x-text="stats.totalConversions"></span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-8">
                                        <div class="bg-green-600 h-8 rounded-full flex items-center justify-center text-white text-xs" :style="`width: ${stats.conversionRate}%`">
                                            <span x-text="`${stats.conversionRate}%`"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- トップパフォーマンスキャンペーン -->
                    <div class="mt-6 bg-white rounded-lg border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">トップパフォーマンスキャンペーン</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">順位</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">キャンペーン名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">クリック数</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">コンバージョン</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">CVR</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-for="(campaign, index) in topCampaigns" :key="campaign.id">
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full"
                                                      :class="index === 0 ? 'bg-yellow-100 text-yellow-800' : index === 1 ? 'bg-gray-100 text-gray-800' : index === 2 ? 'bg-orange-100 text-orange-800' : 'bg-gray-50 text-gray-600'"
                                                      x-text="index + 1"></span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="campaign.name"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="campaign.clicks"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="campaign.conversions"></td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-2 py-1 text-xs rounded-full"
                                                      :class="campaign.cvr >= 10 ? 'bg-green-100 text-green-800' : campaign.cvr >= 5 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'"
                                                      x-text="`${campaign.cvr}%`"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 報酬タブ -->
                <div x-show="activeTab === 'commissions'" class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">報酬管理</h2>

                    <!-- 報酬サマリー -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gradient-to-r from-emerald-500 to-green-600 rounded-xl p-6 text-white">
                            <p class="text-sm opacity-90">今月の報酬（予定）</p>
                            <p class="text-3xl font-bold mt-2" x-text="`¥${stats.monthlyCommission.toLocaleString()}`"></p>
                            <p class="text-xs mt-2 opacity-75">手数料率: <span x-text="`${agencyInfo.commission_rate}%`"></span></p>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <p class="text-sm text-gray-600">前月の報酬</p>
                            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="`¥${stats.lastMonthCommission.toLocaleString()}`"></p>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <p class="text-sm text-gray-600">累計報酬</p>
                            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="`¥${stats.totalCommission.toLocaleString()}`"></p>
                        </div>
                    </div>

                    <!-- 報酬履歴 -->
                    <div class="bg-white rounded-lg border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900">報酬履歴</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">期間</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">コンバージョン数</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">売上</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">手数料率</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">報酬額</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ステータス</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払日</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-for="commission in commissions" :key="commission.id">
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="commission.period"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="commission.conversions"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="`¥${commission.sales.toLocaleString()}`"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="`${commission.rate}%`"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900" x-text="`¥${commission.amount.toLocaleString()}`"></td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-2 py-1 text-xs rounded-full"
                                                      :class="commission.status === 'paid' ? 'bg-green-100 text-green-800' : commission.status === 'approved' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'"
                                                      x-text="getStatusLabel(commission.status)"></span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="commission.payment_date || '-'"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 課金状況タブ -->
                <div x-show="activeTab === 'billing'" class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900">紹介ユーザーの課金状況</h2>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm text-gray-600">最終更新: <span x-text="billingStats.lastUpdated ? formatDateTime(billingStats.lastUpdated) : '-'"></span></span>
                            <button @click="loadBillingStats()"
                                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i> 更新
                            </button>
                        </div>
                    </div>

                    <!-- サマリーカード -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-6 text-white">
                            <p class="text-sm opacity-90">現在の課金中ユーザー</p>
                            <p class="text-3xl font-bold mt-2" x-text="billingStats.summary?.activeSubscribers || 0"></p>
                            <p class="text-xs mt-2 opacity-75">
                                <i class="fas fa-check-circle mr-1"></i> アクティブサブスクリプション
                            </p>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <p class="text-sm text-gray-600">総コンバージョン数</p>
                            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="billingStats.summary?.totalConversions || 0"></p>
                            <p class="text-xs mt-2 text-gray-500">
                                <i class="fas fa-user-plus mr-1"></i> LINE友達追加済み
                            </p>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <p class="text-sm text-gray-600">累計報酬（予定）</p>
                            <p class="text-2xl font-bold text-emerald-600 mt-2" x-text="`¥${(billingStats.summary?.totalCommission || 0).toLocaleString()}`"></p>
                            <p class="text-xs mt-2 text-gray-500">
                                <i class="fas fa-calculator mr-1"></i> 手数料率: <span x-text="`${billingStats.summary?.commissionRate || 0}%`"></span>
                            </p>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <p class="text-sm text-gray-600">支払い済み報酬</p>
                            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="`¥${(billingStats.summary?.paidCommission || 0).toLocaleString()}`"></p>
                            <p class="text-xs mt-2 text-gray-500">
                                <i class="fas fa-check mr-1"></i> 確定済み
                            </p>
                        </div>
                    </div>

                    <!-- 個別ユーザーの課金状態テーブル -->
                    <div class="bg-white rounded-lg border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900">個別ユーザーの課金状態</h3>
                            <p class="text-sm text-gray-600 mt-1">あなたが紹介したユーザーのサブスクリプション状況をリアルタイムで確認できます</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ユーザー名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ステータス</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">課金開始日</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">終了予定日</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">プレミアム</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">予定報酬</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-if="!billingStats.billingUsers || billingStats.billingUsers.length === 0">
                                        <tr>
                                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                                <i class="fas fa-inbox text-3xl mb-2"></i>
                                                <p>まだ課金ユーザーがいません</p>
                                                <p class="text-sm mt-1">トラッキングリンクを作成して、ユーザーを紹介しましょう！</p>
                                            </td>
                                        </tr>
                                    </template>
                                    <template x-for="user in billingStats.billingUsers" :key="user.userId">
                                        <tr class="hover:bg-gray-50" :class="user.isActive ? 'bg-green-50' : ''">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <div class="flex-shrink-0 h-10 w-10 bg-gradient-to-br from-emerald-400 to-green-500 rounded-full flex items-center justify-center text-white font-semibold">
                                                        <span x-text="user.displayName?.charAt(0) || '?'"></span>
                                                    </div>
                                                    <div class="ml-4">
                                                        <div class="text-sm font-medium text-gray-900" x-text="user.displayName"></div>
                                                        <div class="text-xs text-gray-500" x-text="`ID: ${user.userId.substring(0, 8)}...`"></div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-3 py-1 text-xs font-semibold rounded-full"
                                                      :class="{
                                                          'bg-green-100 text-green-800': user.subscriptionStatus === 'active',
                                                          'bg-blue-100 text-blue-800': user.subscriptionStatus === 'trialing',
                                                          'bg-yellow-100 text-yellow-800': user.subscriptionStatus === 'past_due',
                                                          'bg-red-100 text-red-800': user.subscriptionStatus === 'canceled',
                                                          'bg-gray-100 text-gray-800': user.subscriptionStatus === 'free' || !user.subscriptionStatus
                                                      }">
                                                    <i class="fas fa-circle mr-1" :class="user.isActive ? 'fa-pulse' : ''"></i>
                                                    <span x-text="getSubscriptionStatusLabel(user.subscriptionStatus)"></span>
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <template x-if="user.subscriptionStartedAt">
                                                    <span x-text="formatDate(user.subscriptionStartedAt)"></span>
                                                </template>
                                                <template x-if="!user.subscriptionStartedAt">
                                                    <span class="text-gray-400">-</span>
                                                </template>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <template x-if="user.subscriptionEndDate">
                                                    <span x-text="formatDate(user.subscriptionEndDate)"></span>
                                                </template>
                                                <template x-if="!user.subscriptionEndDate && user.isActive">
                                                    <span class="text-green-600">継続中</span>
                                                </template>
                                                <template x-if="!user.subscriptionEndDate && !user.isActive">
                                                    <span class="text-gray-400">-</span>
                                                </template>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                <template x-if="user.isPremium">
                                                    <span class="text-yellow-600">
                                                        <i class="fas fa-crown mr-1"></i> プレミアム
                                                    </span>
                                                </template>
                                                <template x-if="!user.isPremium">
                                                    <span class="text-gray-400">-</span>
                                                </template>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">
                                                <template x-if="user.commission > 0">
                                                    <span class="text-emerald-600" x-text="`¥${user.commission.toLocaleString()}`"></span>
                                                </template>
                                                <template x-if="user.commission === 0">
                                                    <span class="text-gray-400">¥0</span>
                                                </template>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 自動更新通知 -->
                    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                            <div>
                                <p class="text-sm text-blue-800 font-medium">リアルタイム自動更新</p>
                                <p class="text-sm text-blue-700 mt-1">このページは30秒ごとに自動で最新の課金情報に更新されます。手動で更新したい場合は、右上の「更新」ボタンをクリックしてください。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 設定タブ -->
                <div x-show="activeTab === 'settings'" class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">アカウント設定</h2>

                    <div class="max-w-2xl space-y-6">
                        <!-- 代理店情報 -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">代理店情報</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">代理店コード</label>
                                    <input type="text" :value="agencyInfo.code" readonly
                                           class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">会社名</label>
                                    <input type="text" x-model="agencyInfo.company_name" autocomplete="organization"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">連絡先メールアドレス</label>
                                    <input type="email" x-model="agencyInfo.contact_email" autocomplete="email"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">電話番号</label>
                                    <input type="tel" x-model="agencyInfo.contact_phone" autocomplete="tel"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                </div>
                            </div>
                        </div>

                        <!-- 振込先情報 -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">振込先情報</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">銀行名</label>
                                    <input type="text" x-model="paymentInfo.bank_name" autocomplete="off"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">支店名</label>
                                    <input type="text" x-model="paymentInfo.branch_name" autocomplete="off"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">口座種別</label>
                                    <select x-model="paymentInfo.account_type" autocomplete="off"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                        <option value="普通">普通</option>
                                        <option value="当座">当座</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">口座番号</label>
                                    <input type="text" x-model="paymentInfo.account_number" autocomplete="off"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">口座名義</label>
                                    <input type="text" x-model="paymentInfo.account_holder" autocomplete="name"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                </div>
                            </div>
                        </div>

                        <!-- セキュリティ設定 -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">セキュリティ設定</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">パスワード</p>
                                        <p class="text-sm text-gray-500">定期的にパスワードを変更してセキュリティを強化しましょう</p>
                                    </div>
                                    <button @click="openChangePasswordModal()"
                                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors border border-gray-300">
                                        <i class="fas fa-key mr-2"></i> パスワード変更
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="flex space-x-4">
                            <button @click="saveSettings()"
                                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                <i class="fas fa-save mr-2"></i> 設定を保存
                            </button>
                            <button @click="cancelSettings()"
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium transition-colors">
                                キャンセル
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- リンク詳細モーダル -->
    <div x-show="linkDetailsModal"
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         @click.self="closeLinkDetailsModal()">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景オーバーレイ -->
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" @click="closeLinkDetailsModal()"></div>

            <!-- モーダルコンテンツ -->
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <!-- ヘッダー -->
                <div class="bg-gradient-to-r from-emerald-600 to-green-600 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-chart-line text-white"></i>
                            </div>
                            <h3 class="ml-3 text-lg font-semibold text-white">トラッキングリンク詳細</h3>
                        </div>
                        <button @click="closeLinkDetailsModal()" class="text-white hover:text-gray-200 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <!-- コンテンツ -->
                <div class="px-6 py-6 max-h-[70vh] overflow-y-auto">
                    <template x-if="selectedLink">
                        <div class="space-y-6">
                            <!-- 基本情報 -->
                            <div class="bg-gradient-to-r from-emerald-50 to-green-50 rounded-lg p-6 border border-emerald-200">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">
                                    <i class="fas fa-info-circle text-emerald-600 mr-2"></i>基本情報
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">キャンペーン名</label>
                                        <p class="text-base font-semibold text-gray-900" x-text="selectedLink.name"></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">作成日</label>
                                        <p class="text-base text-gray-900" x-text="formatDateTime(selectedLink.created_at)"></p>
                                    </div>
                                    <div class="col-span-full">
                                        <label class="block text-sm font-medium text-gray-600 mb-1">トラッキングURL</label>
                                        <div class="flex items-center space-x-2">
                                            <input type="text" :value="getTrackingUrl(selectedLink.tracking_code)" readonly
                                                   class="flex-1 px-3 py-2 bg-white border border-emerald-300 rounded-lg text-sm font-mono">
                                            <button @click="copyToClipboard(getTrackingUrl(selectedLink.tracking_code), $event)"
                                                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg transition-colors whitespace-nowrap">
                                                <i class="fas fa-copy mr-2"></i>コピー
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">トラッキングコード</label>
                                        <code class="inline-block bg-gray-100 px-3 py-1 rounded text-sm" x-text="selectedLink.tracking_code"></code>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">ステータス</label>
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                                              :class="selectedLink.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                            <i :class="selectedLink.is_active ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-1"></i>
                                            <span x-text="selectedLink.is_active ? '有効' : '無効'"></span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- パフォーマンス指標 -->
                            <div class="bg-white rounded-lg border border-gray-200 p-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">
                                    <i class="fas fa-chart-bar text-emerald-600 mr-2"></i>パフォーマンス
                                </h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="text-center p-4 bg-emerald-50 rounded-lg">
                                        <p class="text-sm text-gray-600 mb-1">クリック数</p>
                                        <p class="text-2xl font-bold text-emerald-600" x-text="selectedLink.visit_count || 0"></p>
                                    </div>
                                    <div class="text-center p-4 bg-green-50 rounded-lg">
                                        <p class="text-sm text-gray-600 mb-1">コンバージョン</p>
                                        <p class="text-2xl font-bold text-green-600" x-text="selectedLink.conversion_count || 0"></p>
                                    </div>
                                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                                        <p class="text-sm text-gray-600 mb-1">CVR</p>
                                        <p class="text-2xl font-bold text-blue-600" x-text="calculateCVR() + '%'"></p>
                                    </div>
                                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                                        <p class="text-sm text-gray-600 mb-1">予想報酬</p>
                                        <p class="text-2xl font-bold text-yellow-600" x-text="'¥' + calculateCommission()"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- UTMパラメータ -->
                            <div class="bg-white rounded-lg border border-gray-200 p-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">
                                    <i class="fas fa-tags text-emerald-600 mr-2"></i>UTMパラメータ
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">UTM Source</label>
                                        <p class="text-sm text-gray-900" x-text="selectedLink.utm_source || '-'"></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">UTM Medium</label>
                                        <p class="text-sm text-gray-900" x-text="selectedLink.utm_medium || '-'"></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">UTM Campaign</label>
                                        <p class="text-sm text-gray-900" x-text="selectedLink.utm_campaign || '-'"></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">UTM Term</label>
                                        <p class="text-sm text-gray-900" x-text="selectedLink.utm_term || '-'"></p>
                                    </div>
                                    <div class="col-span-full">
                                        <label class="block text-sm font-medium text-gray-600 mb-1">UTM Content</label>
                                        <p class="text-sm text-gray-900" x-text="selectedLink.utm_content || '-'"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- 最近の訪問履歴 -->
                            <div class="bg-white rounded-lg border border-gray-200 p-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">
                                    <i class="fas fa-history text-emerald-600 mr-2"></i>最近の訪問履歴
                                </h4>
                                <template x-if="linkVisits.length > 0">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">日時</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">デバイス</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ブラウザ</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">OS</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">リファラー</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                                                <template x-for="visit in linkVisits" :key="visit.id">
                                                    <tr>
                                                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-900" x-text="formatDateTime(visit.created_at)"></td>
                                                        <td class="px-4 py-2 whitespace-nowrap text-xs">
                                                            <span class="px-2 py-1 rounded-full text-xs"
                                                                  :class="{
                                                                      'bg-blue-100 text-blue-800': visit.device_type === 'mobile',
                                                                      'bg-purple-100 text-purple-800': visit.device_type === 'tablet',
                                                                      'bg-gray-100 text-gray-800': visit.device_type === 'desktop'
                                                                  }"
                                                                  x-text="visit.device_type || 'unknown'"></span>
                                                        </td>
                                                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-900" x-text="visit.browser || '-'"></td>
                                                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-900" x-text="visit.os || '-'"></td>
                                                        <td class="px-4 py-2 text-xs text-gray-600 truncate max-w-xs" x-text="visit.referrer || '-'"></td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </template>
                                <template x-if="linkVisits.length === 0">
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-inbox text-3xl mb-2"></i>
                                        <p>まだ訪問履歴がありません</p>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- フッター (アクションボタン) -->
                <div class="bg-gray-50 px-6 py-4 flex flex-wrap gap-3 justify-between items-center">
                    <div class="flex gap-2">
                        <button @click="toggleLinkStatus(selectedLink)"
                                class="px-4 py-2 rounded-lg font-medium transition-colors"
                                :class="selectedLink?.is_active ? 'bg-red-100 hover:bg-red-200 text-red-700' : 'bg-green-100 hover:bg-green-200 text-green-700'">
                            <i :class="selectedLink?.is_active ? 'fas fa-ban' : 'fas fa-check-circle'" class="mr-2"></i>
                            <span x-text="selectedLink?.is_active ? '無効化' : '有効化'"></span>
                        </button>
                        <button @click="deleteLinkWithConfirm(selectedLink)"
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-trash mr-2"></i>削除
                        </button>
                    </div>
                    <button @click="closeLinkDetailsModal()"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium transition-colors">
                        閉じる
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- パスワード変更モーダル -->
    <div x-show="changePasswordModal"
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         @click.self="closeChangePasswordModal()">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景オーバーレイ -->
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" @click="closeChangePasswordModal()"></div>

            <!-- モーダルコンテンツ -->
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <!-- ヘッダー -->
                <div class="bg-gradient-to-r from-emerald-600 to-green-600 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-key text-white"></i>
                            </div>
                            <h3 class="ml-3 text-lg font-semibold text-white">パスワード変更</h3>
                        </div>
                        <button @click="closeChangePasswordModal()" class="text-white hover:text-gray-200 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <!-- フォーム -->
                <form @submit.prevent="changePassword()" class="px-6 py-4">
                    <div class="space-y-4">
                        <!-- 現在のパスワード -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                現在のパスワード *
                            </label>
                            <div class="relative">
                                <input :type="showCurrentPassword ? 'text' : 'password'"
                                       x-model="changePasswordForm.currentPassword"
                                       required
                                       class="w-full px-4 py-3 pr-10 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                       placeholder="現在のパスワードを入力">
                                <button type="button"
                                        @click="showCurrentPassword = !showCurrentPassword"
                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <i :class="showCurrentPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                </button>
                            </div>
                        </div>

                        <!-- 新しいパスワード -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                新しいパスワード *
                            </label>
                            <div class="relative">
                                <input :type="showNewPassword ? 'text' : 'password'"
                                       x-model="changePasswordForm.newPassword"
                                       required
                                       minlength="8"
                                       class="w-full px-4 py-3 pr-10 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                       placeholder="8文字以上で入力"
                                       @input="checkPasswordStrength()">
                                <button type="button"
                                        @click="showNewPassword = !showNewPassword"
                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <i :class="showNewPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                </button>
                            </div>
                            <!-- パスワード強度インジケーター -->
                            <div x-show="changePasswordForm.newPassword.length > 0" class="mt-2">
                                <div class="flex items-center space-x-2">
                                    <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="h-full transition-all duration-300"
                                             :class="{
                                                 'w-1/4 bg-red-500': passwordStrength === 'weak',
                                                 'w-2/4 bg-yellow-500': passwordStrength === 'medium',
                                                 'w-3/4 bg-green-500': passwordStrength === 'strong',
                                                 'w-full bg-emerald-600': passwordStrength === 'very-strong'
                                             }"></div>
                                    </div>
                                    <span class="text-xs font-medium"
                                          :class="{
                                              'text-red-600': passwordStrength === 'weak',
                                              'text-yellow-600': passwordStrength === 'medium',
                                              'text-green-600': passwordStrength === 'strong',
                                              'text-emerald-600': passwordStrength === 'very-strong'
                                          }"
                                          x-text="passwordStrengthLabel"></span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">英大文字、英小文字、数字、記号を組み合わせると強度が上がります</p>
                            </div>
                        </div>

                        <!-- 新しいパスワード（確認） -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                新しいパスワード（確認）*
                            </label>
                            <div class="relative">
                                <input :type="showConfirmPassword ? 'text' : 'password'"
                                       x-model="changePasswordForm.confirmPassword"
                                       required
                                       class="w-full px-4 py-3 pr-10 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                       placeholder="もう一度入力">
                                <button type="button"
                                        @click="showConfirmPassword = !showConfirmPassword"
                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <i :class="showConfirmPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                </button>
                            </div>
                            <!-- パスワード一致チェック -->
                            <div x-show="changePasswordForm.confirmPassword.length > 0" class="mt-2">
                                <p class="text-xs"
                                   :class="changePasswordForm.newPassword === changePasswordForm.confirmPassword ? 'text-green-600' : 'text-red-600'">
                                    <i :class="changePasswordForm.newPassword === changePasswordForm.confirmPassword ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i>
                                    <span x-text="changePasswordForm.newPassword === changePasswordForm.confirmPassword ? 'パスワードが一致しています' : 'パスワードが一致しません'"></span>
                                </p>
                            </div>
                        </div>

                        <!-- エラーメッセージ -->
                        <div x-show="changePasswordError"
                             class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                <span x-text="changePasswordError"></span>
                            </div>
                        </div>

                        <!-- 成功メッセージ -->
                        <div x-show="changePasswordSuccess"
                             class="bg-emerald-50 border border-emerald-200 text-emerald-700 px-4 py-3 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span>パスワードが正常に変更されました</span>
                            </div>
                        </div>
                    </div>

                    <!-- ボタン -->
                    <div class="mt-6 flex space-x-3">
                        <button type="submit"
                                :disabled="loading"
                                class="flex-1 bg-gradient-to-r from-emerald-600 to-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:from-emerald-700 hover:to-green-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!loading">
                                <i class="fas fa-check mr-2"></i> 変更する
                            </span>
                            <span x-show="loading" class="inline-flex items-center">
                                <i class="fas fa-spinner fa-spin mr-2"></i> 変更中...
                            </span>
                        </button>
                        <button type="button"
                                @click="closeChangePasswordModal()"
                                :disabled="loading"
                                class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            キャンセル
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- グローバルエラーハンドラ -->
    <script>
        // Alpine.jsの初期化をログ
        console.log('📦 Scripts loading...');

        // グローバルエラーハンドラ
        window.addEventListener('error', function(event) {
            console.error('❌ Global error caught:',  {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });

            // エラーを画面に表示（デバッグ用）
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #fee; color: #c00; padding: 20px; z-index: 99999; font-family: monospace; font-size: 12px; max-height: 300px; overflow: auto;';
            errorDiv.innerHTML = `
                <strong>❌ エラーが発生しました</strong><br>
                <strong>メッセージ:</strong> ${event.message}<br>
                <strong>ファイル:</strong> ${event.filename}<br>
                <strong>行:</strong> ${event.lineno}:${event.colno}<br>
                <strong>スタック:</strong> ${event.error ? event.error.stack : 'なし'}<br>
                <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; background: #c00; color: white; border: none; cursor: pointer;">閉じる</button>
            `;
            document.body.appendChild(errorDiv);
        });

        // Uncaught Promiseエラーハンドラ
        window.addEventListener('unhandledrejection', function(event) {
            console.error('❌ Unhandled promise rejection:', event.reason);

            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #fea; color: #840; padding: 20px; z-index: 99999; font-family: monospace; font-size: 12px; max-height: 300px; overflow: auto;';
            errorDiv.innerHTML = `
                <strong>⚠️  Promise エラーが発生しました</strong><br>
                <strong>理由:</strong> ${event.reason}<br>
                <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; background: #840; color: white; border: none; cursor: pointer;">閉じる</button>
            `;
            document.body.appendChild(errorDiv);
        });

        // Alpine.jsの初期化を監視
        document.addEventListener('alpine:init', () => {
            console.log('🎉 Alpine.js initialized successfully!');
        });

        document.addEventListener('alpine:initializing', () => {
            console.log('🔄 Alpine.js initializing...');
        });

        document.addEventListener('alpine:initialized', () => {
            console.log('✅ Alpine.js fully initialized!');
        });

        // DOMContentLoaded後にAlpine.jsが読み込まれているか確認
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📄 DOM Content Loaded');

            // 3秒後にAlpine.jsがまだ初期化されていない場合は警告
            setTimeout(() => {
                if (!window.Alpine) {
                    console.error('❌ Alpine.js is not loaded after 3 seconds!');
                    alert('Alpine.jsの読み込みに失敗しました。ページを再読み込みしてください。');
                } else {
                    console.log('✅ Alpine.js is loaded:', window.Alpine);
                }
            }, 3000);
        });
    </script>

    <!-- XSS Protection Utility -->
    <script src="xss-protection.js"></script>
    <script src="dashboard.js"></script>

    <!-- Final diagnostic check -->
    <script>
        console.log('🏁 All inline scripts loaded');
        console.log('📊 Current state:', {
            agencyDashboard: typeof window.agencyDashboard,
            Alpine: typeof window.Alpine,
            XSSProtection: typeof window.XSSProtection
        });

        // Wait a bit and check if Alpine initialized
        setTimeout(() => {
            console.log('⏰ After 2 seconds:', {
                Alpine: typeof window.Alpine,
                AlpineReady: window.Alpine ? 'yes' : 'no'
            });

            if (!window.Alpine) {
                console.error('❌❌❌ Alpine.js is NOT loaded after 2 seconds! ❌❌❌');
                console.error('This is likely why the page is white.');
                console.error('Possible causes:');
                console.error('1. Network error loading Alpine.js from CDN');
                console.error('2. SRI hash mismatch (we removed it, so not this)');
                console.error('3. Content Security Policy blocking the script');
                console.error('4. Browser extension blocking the CDN');

                // Show error on page
                document.body.innerHTML = `
                    <div style="padding: 40px; max-width: 800px; margin: 0 auto; font-family: sans-serif;">
                        <h1 style="color: #c00;">❌ Alpine.js Failed to Load</h1>
                        <p><strong>The page cannot initialize because Alpine.js did not load from the CDN.</strong></p>
                        <h2>Possible Solutions:</h2>
                        <ol>
                            <li>Check your internet connection</li>
                            <li>Check if a browser extension is blocking CDN resources</li>
                            <li>Check the browser console (F12) for network errors</li>
                            <li>Try disabling ad blockers or privacy extensions</li>
                            <li>Try a different browser</li>
                        </ol>
                        <h2>Technical Details:</h2>
                        <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto;">
Alpine.js URL: https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js
Alpine.js loaded: No
agencyDashboard function: ${typeof window.agencyDashboard}
XSSProtection loaded: ${typeof window.XSSProtection}
                        </pre>
                        <button onclick="location.reload()" style="background: #10b981; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            🔄 Reload Page
                        </button>
                    </div>
                `;
            } else {
                console.log('✅ Alpine.js loaded successfully!');
            }
        }, 2000);
    </script>
</body>
</html>