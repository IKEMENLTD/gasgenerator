<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMate AI - ä»£ç†åº—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../images/logo.png">
    <link rel="apple-touch-icon" href="../images/logo.png">

    <!-- âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Š: cdn.tailwindcss.comã¯JITã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®ãŸã‚SRIæœªå¯¾å¿œ -->
    <!-- æœ¬ç•ªç’°å¢ƒã§ã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«Tailwind CSSã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js with SRI (Subresource Integrity) -->
    <!-- ğŸ”§ DEBUGGING: SRI temporarily removed to check if it's blocking Alpine.js -->
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"
            crossorigin="anonymous"
            defer></script>
    <!-- Original with SRI (restore after debugging):
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"
            integrity="sha384-xw/ARJaqXKsFgDt0AhxLQ65mGvCjEjWEReZ6OqiLWJUlIi8y+4zOjsJgYY6YGDX0"
            crossorigin="anonymous"
            defer></script>
    -->

    <!-- Font Awesome with SRI -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
          crossorigin="anonymous"
          referrerpolicy="no-referrer">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
            integrity="sha384-DxAVhx0HqN0LqmqPMxCh/J6tP/4tjN6VJxqF1Fv9qKqvPvZwC8x3sE9LqLTR3Ls1"
            crossorigin="anonymous"></script>
    <style>
        [x-cloak] { display: none !important; }

        /* ===== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ (275pxã€œ1440px) ===== */

        /* è¶…å°å‹ãƒ¢ãƒã‚¤ãƒ« (275px-374px) */
        @media (min-width: 275px) and (max-width: 374px) {
            body { font-size: 13px; }
            .dashboard-container { padding: 0.5rem !important; }
            .stat-card { padding: 0.75rem !important; }
            .stat-card h3 { font-size: 0.7rem !important; }
            .stat-card .stat-value { font-size: 1.25rem !important; }
            .btn { padding: 0.5rem 0.75rem !important; font-size: 0.75rem !important; }
            .tab-button { font-size: 0.7rem !important; padding: 0.5rem !important; }
            .table-responsive { font-size: 0.7rem !important; }
            .table-responsive th, .table-responsive td { padding: 0.375rem !important; }
            h1 { font-size: 1.25rem !important; }
            h2 { font-size: 1.1rem !important; }
            h3 { font-size: 0.95rem !important; }
        }

        /* å°å‹ãƒ¢ãƒã‚¤ãƒ« (375px-639px) */
        @media (min-width: 375px) and (max-width: 639px) {
            body { font-size: 14px; }
            .dashboard-container { padding: 0.75rem !important; }
            .stat-card { padding: 1rem !important; }
            .stat-card h3 { font-size: 0.75rem !important; }
            .stat-card .stat-value { font-size: 1.5rem !important; }
            .btn { padding: 0.625rem 1rem !important; font-size: 0.875rem !important; }
            .tab-button { font-size: 0.75rem !important; padding: 0.625rem 0.75rem !important; }
            .table-responsive { font-size: 0.75rem !important; }
            h1 { font-size: 1.5rem !important; }
            h2 { font-size: 1.25rem !important; }
        }

        /* å¤§å‹ãƒ¢ãƒã‚¤ãƒ« (640px-767px) */
        @media (min-width: 640px) and (max-width: 767px) {
            .stat-grid { grid-template-columns: repeat(2, 1fr) !important; }
        }

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ (768px-1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .stat-grid { grid-template-columns: repeat(2, 1fr) !important; }
        }

        /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ— (1024pxä»¥ä¸Š) */
        @media (min-width: 1024px) {
            .stat-grid { grid-template-columns: repeat(4, 1fr) !important; }
        }

        /* å¤§å‹ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ— (1280px-1440px) */
        @media (min-width: 1280px) {
            .dashboard-container { max-width: 1400px; margin: 0 auto; }
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 767px) {
            .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .table-scroll table { min-width: 600px; }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
        .responsive-padding { padding: clamp(0.5rem, 2vw, 2rem); }
        .responsive-text { font-size: clamp(0.875rem, 1.5vw, 1rem); }
        .responsive-heading { font-size: clamp(1.25rem, 3vw, 2rem); }
    </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 to-green-50 min-h-screen" x-data="agencyDashboard()" x-init="init()" x-cloak>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div x-show="!isAuthenticated && !showRegister" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md border border-emerald-100">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-emerald-600 to-green-600 rounded-full mb-4">
                    <i class="fas fa-chart-line text-3xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">ä»£ç†åº—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                <p class="text-gray-600 mt-2">TaskMate AI ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒãƒ¼ã‚¿ãƒ«</p>
            </div>

            <form @submit.prevent="login()" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" x-model="loginForm.email" autocomplete="email" required
                           class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                           placeholder="agency@example.com">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" x-model="loginForm.password" autocomplete="current-password" required
                           class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                           placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>

                <div class="flex items-center justify-between">
                    <label class="flex items-center">
                        <input type="checkbox" x-model="loginForm.remember" class="rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                        <span class="ml-2 text-sm text-gray-600">ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ä¿æŒ</span>
                    </label>
                    <a href="/agency/reset-password.html" class="text-sm text-emerald-600 hover:text-emerald-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹</a>
                </div>

                <button type="submit" :disabled="loading"
                        class="w-full bg-gradient-to-r from-emerald-600 to-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:from-emerald-700 hover:to-green-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!loading">ãƒ­ã‚°ã‚¤ãƒ³</span>
                    <span x-show="loading" class="inline-flex items-center">
                        <i class="fas fa-spinner fa-spin mr-2"></i> ãƒ­ã‚°ã‚¤ãƒ³ä¸­...
                    </span>
                </button>

                <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ä»˜ãï¼‰ -->
                <div x-show="loginError" class="bg-red-50 border border-red-200 text-red-700 px-4 sm:px-6 py-4 rounded-lg space-y-3">
                    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-circle mt-0.5 mr-2 flex-shrink-0"></i>
                        <span x-text="loginError" class="text-sm sm:text-base"></span>
                    </div>

                    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
                    <div x-show="loginErrorData && loginErrorData.actions && loginErrorData.actions.length > 0" class="flex flex-col gap-2 mt-3 pt-3 border-t border-red-300">
                        <template x-for="action in (loginErrorData && loginErrorData.actions) || []" :key="action.type">
                            <!-- LINEå‹é”è¿½åŠ ãƒœã‚¿ãƒ³ -->
                            <a x-show="action.type === 'add_line_friend'"
                               :href="action.url"
                               target="_blank"
                               class="block w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 sm:py-3 px-4 rounded-lg transition-colors text-center text-sm sm:text-base">
                                <i class="fab fa-line mr-2"></i>
                                <span x-text="action.label"></span>
                            </a>

                            <!-- ã‚µãƒãƒ¼ãƒˆå•ã„åˆã‚ã›ãƒœã‚¿ãƒ³ -->
                            <a x-show="action.type === 'contact_support'"
                               :href="action.url"
                               target="_blank"
                               class="block w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 sm:py-3 px-4 rounded-lg transition-colors text-center text-sm sm:text-base border border-gray-300">
                                <i class="fas fa-envelope mr-2"></i>
                                <span x-text="action.label"></span>
                            </a>

                            <!-- ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ -->
                            <button x-show="action.type === 'retry'"
                                    @click="loginError = ''; loginErrorData = null"
                                    class="w-full bg-blue-100 hover:bg-blue-200 text-blue-700 font-medium py-2 sm:py-3 px-4 rounded-lg transition-colors text-sm sm:text-base border border-blue-300">
                                <i class="fas fa-redo mr-2"></i>
                                <span x-text="action.label"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </form>

            <div class="mt-8 pt-6 border-t border-gray-200 text-center space-y-3">
                <p class="text-sm text-gray-600">
                    ä»£ç†åº—ç™»éŒ²ã‚’ã”å¸Œæœ›ã®æ–¹ã¯
                    <button @click="showRegister = true" class="text-emerald-600 hover:text-emerald-700 font-medium">ã“ã¡ã‚‰</button>
                </p>
                <p class="text-sm text-gray-600">
                    <a href="/" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left mr-1"></i> ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                    </a>
                </p>
            </div>
        </div>
    </div>

    <!-- æ–°è¦ç™»éŒ²ç”»é¢ -->
    <div x-show="!isAuthenticated && showRegister" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg border border-emerald-100">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-emerald-600 to-green-600 rounded-full mb-4">
                    <i class="fas fa-user-plus text-3xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">ä»£ç†åº—æ–°è¦ç™»éŒ²</h1>
                <p class="text-gray-600 mt-2">TaskMate AI ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ç™»éŒ²</p>
            </div>

            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
            <div class="mb-8">
                <div class="flex items-center justify-between max-w-md mx-auto">
                    <!-- Step 1: åŸºæœ¬æƒ…å ± -->
                    <div class="flex flex-col items-center flex-1">
                        <div class="w-10 h-10 rounded-full bg-emerald-600 text-white flex items-center justify-center font-bold mb-2">
                            <i class="fas fa-check text-sm"></i>
                        </div>
                        <span class="text-xs font-medium text-emerald-600">åŸºæœ¬æƒ…å ±</span>
                    </div>

                    <!-- Connector -->
                    <div class="flex-1 h-1 bg-gray-300 mx-2 relative" style="top: -12px;">
                        <div class="h-full bg-emerald-600 transition-all duration-500" style="width: 0%;" x-bind:style="registerSuccess ? 'width: 100%' : 'width: 0%'"></div>
                    </div>

                    <!-- Step 2: LINEé€£æº -->
                    <div class="flex flex-col items-center flex-1">
                        <div class="w-10 h-10 rounded-full transition-all duration-300 flex items-center justify-center font-bold mb-2"
                             x-bind:class="registerSuccess ? 'bg-emerald-600 text-white' : 'bg-gray-300 text-gray-600'">
                            <i class="fab fa-line text-sm"></i>
                        </div>
                        <span class="text-xs font-medium transition-colors duration-300"
                              x-bind:class="registerSuccess ? 'text-emerald-600' : 'text-gray-500'">LINEé€£æº</span>
                    </div>

                    <!-- Connector -->
                    <div class="flex-1 h-1 bg-gray-300 mx-2 relative" style="top: -12px;"></div>

                    <!-- Step 3: å®Œäº† -->
                    <div class="flex flex-col items-center flex-1">
                        <div class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold mb-2">
                            <i class="fas fa-flag-checkered text-sm"></i>
                        </div>
                        <span class="text-xs font-medium text-gray-500">å®Œäº†</span>
                    </div>
                </div>
            </div>

            <form @submit.prevent="register()" class="space-y-4">
                <!-- ä¼šç¤¾æƒ…å ± -->
                <div class="space-y-4 pb-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700">ä¼šç¤¾æƒ…å ±</h3>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä¼šç¤¾å *</label>
                        <input type="text" x-model="registerForm.company_name" autocomplete="organization" required
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="æ ªå¼ä¼šç¤¾ã€‡ã€‡">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä»£ç†åº—å *</label>
                        <input type="text" x-model="registerForm.agency_name" autocomplete="organization" required
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="ã€‡ã€‡å–¶æ¥­æ‰€">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä½æ‰€</label>
                        <input type="text" x-model="registerForm.address" autocomplete="street-address"
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="æ±äº¬éƒ½ã€‡ã€‡åŒº...">
                    </div>
                </div>

                <!-- æ‹…å½“è€…æƒ…å ± -->
                <div class="space-y-4 pb-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700">æ‹…å½“è€…æƒ…å ±</h3>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ‹…å½“è€…å *</label>
                        <input type="text" x-model="registerForm.contact_name" autocomplete="name" required
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="å±±ç”°å¤ªéƒ">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                        <input type="email" x-model="registerForm.email" autocomplete="email" required
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="contact@company.com">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é›»è©±ç•ªå· *</label>
                        <input type="tel" x-model="registerForm.phone" autocomplete="tel" required
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="03-1234-5678">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            æ‹›å¾…ã‚³ãƒ¼ãƒ‰ *
                            <span class="text-xs text-gray-500 font-normal ml-2">ï¼ˆä»£ç†åº—ã‹ã‚‰æä¾›ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ï¼‰</span>
                        </label>
                        <input type="text" x-model="registerForm.invitation_code" autocomplete="off" required
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors font-mono"
                               placeholder="ä¾‹: abc123xyz456"
                               pattern="[a-zA-Z0-9]{8,20}"
                               title="æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã¯è‹±æ•°å­—8ã€œ20æ–‡å­—ã§ã™">
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            ä»£ç†åº—æ‹…å½“è€…ã‹ã‚‰æä¾›ã•ã‚ŒãŸæ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                        </p>
                    </div>
                </div>

                <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æƒ…å ± -->
                <div class="space-y-4 pb-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š</h3>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
                        <input type="password" x-model="registerForm.password" autocomplete="new-password" required minlength="8"
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›">
                        <p class="text-xs text-gray-500 mt-1">è‹±å¤§æ–‡å­—ã€è‹±å°æ–‡å­—ã€æ•°å­—ã€è¨˜å·ã®ã†ã¡2ç¨®é¡ä»¥ä¸Šã‚’å«ã‚ã¦ãã ã•ã„</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰*</label>
                        <input type="password" x-model="registerForm.password_confirm" autocomplete="new-password" required minlength="8"
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                               placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›">
                    </div>
                </div>

                <!-- åˆ©ç”¨è¦ç´„ -->
                <div>
                    <label class="flex items-start">
                        <input type="checkbox" x-model="registerForm.agree_terms" required
                               class="mt-1 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                        <span class="ml-2 text-sm text-gray-600">
                            <a href="terms.html" target="_blank" class="text-emerald-600 hover:text-emerald-700">åˆ©ç”¨è¦ç´„</a>ãŠã‚ˆã³
                            <a href="privacy.html" target="_blank" class="text-emerald-600 hover:text-emerald-700">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
                            ã«åŒæ„ã—ã¾ã™
                        </span>
                    </label>
                </div>

                <button type="submit" :disabled="loading"
                        class="w-full bg-gradient-to-r from-emerald-600 to-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:from-emerald-700 hover:to-green-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!loading">ç™»éŒ²ã™ã‚‹</span>
                    <span x-show="loading" class="inline-flex items-center">
                        <i class="fas fa-spinner fa-spin mr-2"></i> ç™»éŒ²ä¸­...
                    </span>
                </button>

                <div x-show="registerError" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                    <span x-text="registerError"></span>
                </div>

                <div x-show="registerSuccess" class="bg-emerald-50 border border-emerald-200 text-emerald-700 px-4 py-3 rounded-lg">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ç§»å‹•ã—ã¾ã™...</span>
                </div>
            </form>

            <div class="mt-6 pt-4 border-t border-gray-200 text-center space-y-3">
                <p class="text-sm text-gray-600">
                    æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯
                    <button @click="showRegister = false" class="text-emerald-600 hover:text-emerald-700 font-medium">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </p>
                <p class="text-sm text-gray-600">
                    <a href="/" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left mr-1"></i> ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                    </a>
                </p>
            </div>
        </div>
    </div>

    <!-- LINEèªè¨¼ä¸­ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div x-show="loading && (registerSuccess || (!isAuthenticated && !showRegister))"
         x-cloak
         class="fixed inset-0 bg-gradient-to-br from-emerald-600 to-green-600 overflow-y-auto z-50">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="text-center text-white">
                <!-- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãLINEã‚¢ã‚¤ã‚³ãƒ³ -->
                <div class="inline-flex items-center justify-center w-24 h-24 bg-white rounded-full mb-6 animate-pulse">
                    <i class="fab fa-line text-5xl text-emerald-600"></i>
                </div>

                <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ -->
                <div class="mb-6">
                    <div class="inline-block">
                        <svg class="animate-spin h-12 w-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>

                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <div class="space-y-3">
                    <h2 class="text-2xl sm:text-3xl font-bold">LINEé€£æºå‡¦ç†ä¸­...</h2>
                    <p class="text-sm sm:text-base text-emerald-100">
                        ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„
                    </p>
                    <div class="flex items-center justify-center space-x-1 text-emerald-100">
                        <span class="animate-bounce" style="animation-delay: 0s;">â—</span>
                        <span class="animate-bounce" style="animation-delay: 0.2s;">â—</span>
                        <span class="animate-bounce" style="animation-delay: 0.4s;">â—</span>
                    </div>
                </div>

                <!-- æ³¨æ„äº‹é … -->
                <div class="mt-8 bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-4 max-w-md mx-auto">
                    <p class="text-xs sm:text-sm text-emerald-50">
                        <i class="fas fa-info-circle mr-2"></i>
                        ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»éŒ²å®Œäº†ç”»é¢ -->
    <div x-show="registerSuccess && !loading && !showLineConfirmModal"
         x-cloak
         class="fixed inset-0 bg-gradient-to-br from-emerald-600 to-green-600 overflow-y-auto p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 sm:p-12 w-full max-w-2xl my-8 mx-auto">
            <!-- æˆåŠŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-emerald-600 to-green-600 rounded-full mb-6 animate-bounce">
                    <i class="fas fa-check text-5xl text-white"></i>
                </div>
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-3">
                    ç™»éŒ²å®Œäº†ï¼
                </h1>
                <p class="text-lg text-gray-600">
                    TaskMate AI ä»£ç†åº—ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¸ã‚ˆã†ã“ã
                </p>
            </div>

            <!-- è©³ç´°æƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
            <div class="space-y-4 mb-8">
                <!-- ä»£ç†åº—ã‚³ãƒ¼ãƒ‰ -->
                <div class="bg-gradient-to-r from-emerald-50 to-green-50 border-2 border-emerald-200 rounded-xl p-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold text-emerald-900">
                            <i class="fas fa-id-card mr-2"></i>ã‚ãªãŸã®ä»£ç†åº—ã‚³ãƒ¼ãƒ‰
                        </h3>
                        <span class="text-xs bg-emerald-600 text-white px-3 py-1 rounded-full">
                            ä¿å­˜æ¨å¥¨
                        </span>
                    </div>
                    <div class="flex items-center justify-between bg-white rounded-lg p-4">
                        <code class="text-2xl sm:text-3xl font-bold text-emerald-600" x-text="pendingRegistrationData?.agency_code || 'AG...'"></code>
                        <button @click="copyToClipboard(pendingRegistrationData?.agency_code || '', $event)"
                                class="bg-emerald-100 hover:bg-emerald-200 text-emerald-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-copy mr-1"></i> ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                    <p class="text-xs text-emerald-700 mt-3">
                        ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ã€ä¸‹ä½ä»£ç†åº—ã‚’æ‹›å¾…ã§ãã¾ã™
                    </p>
                </div>

                <!-- æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                    <h3 class="text-sm font-semibold text-blue-900 mb-4">
                        <i class="fas fa-route mr-2"></i>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
                    </h3>
                    <ol class="space-y-3 text-sm text-blue-800">
                        <li class="flex items-start">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-600 text-white rounded-full mr-3 flex-shrink-0 text-xs font-bold">1</span>
                            <span>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ä»£ç†åº—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹</span>
                        </li>
                        <li class="flex items-start">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-600 text-white rounded-full mr-3 flex-shrink-0 text-xs font-bold">2</span>
                            <span>ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ãŠå®¢æ§˜ã«å…±æœ‰</span>
                        </li>
                        <li class="flex items-start">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-600 text-white rounded-full mr-3 flex-shrink-0 text-xs font-bold">3</span>
                            <span>æˆç´„ã”ã¨ã«å ±é…¬ãŒè‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™</span>
                        </li>
                    </ol>
                </div>

                <!-- æ©Ÿèƒ½ç´¹ä»‹ -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-lg p-4 text-center">
                        <i class="fas fa-chart-line text-2xl text-purple-600 mb-2"></i>
                        <p class="text-xs font-semibold text-purple-900">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æ</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 rounded-lg p-4 text-center">
                        <i class="fas fa-users text-2xl text-orange-600 mb-2"></i>
                        <p class="text-xs font-semibold text-orange-900">4æ®µéšç´¹ä»‹åˆ¶åº¦</p>
                    </div>
                    <div class="bg-gradient-to-br from-pink-50 to-pink-100 border border-pink-200 rounded-lg p-4 text-center">
                        <i class="fas fa-yen-sign text-2xl text-pink-600 mb-2"></i>
                        <p class="text-xs font-semibold text-pink-900">è‡ªå‹•å ±é…¬è¨ˆç®—</p>
                    </div>
                </div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="flex flex-col sm:flex-row gap-3">
                <button @click="showRegister = false; registerSuccess = false; pendingRegistrationData = null"
                        class="flex-1 bg-gradient-to-r from-emerald-600 to-green-600 text-white py-4 px-6 rounded-xl font-bold text-lg hover:from-emerald-700 hover:to-green-700 transition-all duration-200 shadow-lg hover:shadow-xl">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
                </button>
            </div>

            <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ -->
            <p class="text-center text-sm text-gray-500 mt-6">
                <i class="fas fa-clock mr-1"></i>
                3ç§’å¾Œã«è‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ç§»å‹•ã—ã¾ã™
            </p>
        </div>
    </div>

    <!-- LINEé€£æºç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div x-show="showLineConfirmModal"
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto p-4 z-50"
         @click.self="showLineConfirmModal = false">
        <div class="relative bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-md my-8 mx-auto transform transition-all"
             @click.stop>
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-emerald-600 to-green-600 rounded-full mb-4">
                    <i class="fab fa-line text-3xl text-white"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-2">LINEé€£æºã‚’é–‹å§‹ã—ã¾ã™</h2>
                <p class="text-sm text-gray-600">ã‚ã¨å°‘ã—ã§ç™»éŒ²å®Œäº†ã§ã™ï¼</p>
            </div>

            <!-- èª¬æ˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="space-y-4 mb-6">
                <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                    <p class="text-sm font-semibold text-emerald-900 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
                    </p>
                    <ol class="text-sm text-emerald-800 space-y-1 ml-6 list-decimal">
                        <li>LINEã‚¢ãƒ—ãƒªã§ãƒ­ã‚°ã‚¤ãƒ³</li>
                        <li>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æºã‚’æ‰¿èª</li>
                        <li>ç™»éŒ²å®Œäº†</li>
                    </ol>
                </div>

                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                    <p class="text-sm text-amber-800">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <strong>é‡è¦ï¼š</strong>LINEã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„
                    </p>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-xs text-blue-800">
                        <i class="fas fa-shield-alt mr-2"></i>
                        LINEé€£æºã¯æœ¬äººç¢ºèªã®ãŸã‚ã«å¿…è¦ã§ã™ã€‚ãŠå®¢æ§˜ã®å€‹äººæƒ…å ±ã¯å®‰å…¨ã«ä¿è­·ã•ã‚Œã¾ã™ã€‚
                    </p>
                </div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="flex flex-col sm:flex-row gap-3">
                <button @click="proceedToLineAuth()"
                        :disabled="loading"
                        class="flex-1 bg-gradient-to-r from-emerald-600 to-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:from-emerald-700 hover:to-green-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                    <i class="fab fa-line mr-2 text-lg"></i>
                    <span x-show="!loading">LINEé€£æºã‚’é–‹å§‹</span>
                    <span x-show="loading" class="inline-flex items-center">
                        <i class="fas fa-spinner fa-spin mr-2"></i> æº–å‚™ä¸­...
                    </span>
                </button>
                <button @click="showLineConfirmModal = false"
                        :disabled="loading"
                        class="flex-1 sm:flex-initial sm:px-6 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>

            <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ï¼ˆå³ä¸Šï¼‰ -->
            <button @click="showLineConfirmModal = false"
                    :disabled="loading"
                    class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors disabled:opacity-50"
                    aria-label="é–‰ã˜ã‚‹">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>

    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <div x-show="isAuthenticated" class="min-h-screen">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="bg-white shadow-sm border-b border-emerald-100">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div class="inline-flex items-center justify-center w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-emerald-600 to-green-600 rounded-full flex-shrink-0">
                            <i class="fas fa-chart-line text-white text-sm sm:text-base"></i>
                        </div>
                        <div class="min-w-0">
                            <h1 class="text-sm sm:text-base md:text-lg lg:text-xl font-bold text-gray-900 whitespace-nowrap">TaskMate AI ä»£ç†åº—</h1>
                            <p class="text-xs sm:text-sm text-gray-600 truncate max-w-[150px] sm:max-w-[200px] md:max-w-none" x-text="`${agencyInfo.name} - ${userInfo.name}ã•ã‚“`"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div class="text-right hidden sm:block">
                            <p class="text-xs sm:text-sm text-gray-600">ä»Šæœˆã®æˆæœ</p>
                            <p class="text-sm sm:text-base md:text-lg font-bold text-emerald-600" x-text="`Â¥${stats.monthlyCommission.toLocaleString()}`"></p>
                        </div>
                        <a href="/"
                           class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2 sm:px-4 sm:py-2 rounded-lg transition-colors border border-gray-300 inline-flex items-center">
                            <i class="fas fa-home sm:mr-2"></i> <span class="hidden sm:inline">ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸</span>
                        </a>
                        <button @click="logout()"
                                class="bg-red-500 hover:bg-red-600 text-white p-2 sm:px-4 sm:py-2 rounded-lg transition-colors">
                            <i class="fas fa-sign-out-alt sm:mr-2"></i> <span class="hidden sm:inline">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="dashboard-container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
            <div class="stat-grid grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="stat-card bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm text-gray-600">ä½œæˆãƒªãƒ³ã‚¯æ•°</h3>
                            <p class="stat-value text-2xl font-bold text-gray-900 mt-2" x-text="stats.totalLinks"></p>
                        </div>
                        <div class="bg-emerald-100 rounded-full p-3">
                            <i class="fas fa-link text-emerald-600"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm text-gray-600">ç·ã‚¯ãƒªãƒƒã‚¯æ•°</h3>
                            <p class="stat-value text-2xl font-bold text-gray-900 mt-2" x-text="stats.totalClicks"></p>
                        </div>
                        <div class="bg-green-100 rounded-full p-3">
                            <i class="fas fa-mouse-pointer text-green-600"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm text-gray-600">ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•°</h3>
                            <p class="stat-value text-2xl font-bold text-gray-900 mt-2" x-text="stats.totalConversions"></p>
                        </div>
                        <div class="bg-green-100 rounded-full p-3">
                            <i class="fas fa-users text-green-700"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm text-gray-600">ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡</h3>
                            <p class="stat-value text-2xl font-bold text-gray-900 mt-2" x-text="`${stats.conversionRate}%`"></p>
                        </div>
                        <div class="bg-emerald-100 rounded-full p-3">
                            <i class="fas fa-percentage text-emerald-700"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4æ®µéšä»£ç†åº—åˆ¶åº¦ - éšå±¤æƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-emerald-100 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-sitemap text-emerald-600 mr-2"></i>
                        ã‚ãªãŸã®éšå±¤æƒ…å ±
                    </h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 sm:gap-6">
                    <!-- æ‹›å¾…ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§æœ€åˆã«è¡¨ç¤ºï¼‰ -->
                    <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-lg p-3 sm:p-4 border border-amber-200 order-first md:order-last">
                        <p class="text-xs sm:text-sm text-gray-600 mb-1 sm:mb-2">ã‚ãªãŸã®æ‹›å¾…ã‚³ãƒ¼ãƒ‰</p>
                        <div class="flex items-center space-x-1 sm:space-x-2">
                            <code class="bg-white px-2 py-3 sm:px-3 sm:py-4 rounded border border-amber-300 font-mono text-sm sm:text-base font-semibold text-gray-900 flex-1 break-all" x-text="agencyInfo.code"></code>
                            <button @click="copyToClipboard(agencyInfo.code, $event)"
                                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-2 py-3 sm:px-3 sm:py-4 rounded transition-colors flex-shrink-0"
                                    title="ã‚³ãƒ”ãƒ¼">
                                <i class="fas fa-copy text-sm sm:text-base"></i>
                            </button>
                        </div>
                        <p class="text-[10px] sm:text-xs text-gray-500 mt-1 sm:mt-2" x-show="agencyInfo.level < 4">
                            æ–°è¦ä»£ç†åº—ã‚’æ‹›å¾…ã§ãã¾ã™
                        </p>
                        <p class="text-[10px] sm:text-xs text-red-500 mt-1 sm:mt-2" x-show="agencyInfo.level >= 4">
                            æœ€å¤§éšå±¤ã«é”ã—ã¦ã„ã¾ã™
                        </p>
                    </div>

                    <!-- éšå±¤ãƒ¬ãƒ™ãƒ« -->
                    <div class="bg-gradient-to-br from-emerald-50 to-green-50 rounded-lg p-3 sm:p-4 border border-emerald-200">
                        <p class="text-xs sm:text-sm text-gray-600 mb-1">éšå±¤ãƒ¬ãƒ™ãƒ«</p>
                        <p class="text-lg sm:text-xl md:text-2xl font-bold text-emerald-600 whitespace-nowrap" x-text="getLevelLabel(agencyInfo.level)">
                            çµ±æ‹¬ä»£ç†åº—
                        </p>
                        <p class="text-[10px] sm:text-xs text-gray-500 mt-1">
                            Level <span x-text="agencyInfo.level"></span>
                        </p>
                    </div>

                    <!-- è‡ªå·±å ±é…¬ç‡ -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-3 sm:p-4 border border-blue-200">
                        <p class="text-xs sm:text-sm text-gray-600 mb-1">è‡ªå·±å ±é…¬ç‡</p>
                        <p class="text-2xl sm:text-3xl font-bold text-blue-600">
                            <span x-text="agencyInfo.own_commission_rate"></span>%
                        </p>
                        <p class="text-[10px] sm:text-xs text-gray-500 mt-1">æ¡ˆä»¶æˆç´„æ™‚ã®å ±é…¬</p>
                    </div>

                    <!-- ãƒªãƒ•ã‚¡ãƒ©ãƒ«å ±é…¬ç‡ -->
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-3 sm:p-4 border border-purple-200">
                        <p class="text-xs sm:text-sm text-gray-600 mb-1 whitespace-nowrap">å‚˜ä¸‹ã‹ã‚‰ã®è‡ªå‹•å¸ã„ä¸Šã’</p>
                        <p class="text-2xl sm:text-3xl font-bold text-purple-600">
                            <span x-text="getReferralRate()"></span>%
                        </p>
                        <p class="text-[10px] sm:text-xs text-gray-500 mt-1">ä¸‹ä½ä»£ç†åº—ã®æˆç´„æ™‚</p>
                    </div>
                </div>
            </div>

            <!-- ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
            <div class="bg-white rounded-xl shadow-lg border border-emerald-100 mb-8">
                <div class="border-b border-emerald-100 overflow-x-auto">
                    <nav class="flex space-x-1 sm:space-x-4 md:space-x-8 px-2 sm:px-4 md:px-6 min-w-max" aria-label="Tabs">
                        <button @click="activeTab = 'create'"
                                :class="activeTab === 'create' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-3 px-2 sm:px-3 border-b-2 font-medium text-xs sm:text-sm transition-colors whitespace-nowrap flex-shrink-0 flex flex-col sm:flex-row items-center">
                            <i class="fas fa-plus-circle sm:mr-2 text-xs sm:text-sm"></i> <span class="text-[10px] sm:text-xs md:text-sm">ãƒªãƒ³ã‚¯ä½œæˆ</span>
                        </button>
                        <button @click="activeTab = 'links'; loadTrackingLinks()"
                                :class="activeTab === 'links' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-3 px-2 sm:px-3 border-b-2 font-medium text-xs sm:text-sm transition-colors whitespace-nowrap flex-shrink-0 flex flex-col sm:flex-row items-center">
                            <i class="fas fa-link sm:mr-2 text-xs sm:text-sm"></i> <span class="text-[10px] sm:text-xs md:text-sm">ãƒªãƒ³ã‚¯ç®¡ç†</span>
                        </button>
                        <button @click="activeTab = 'analytics'; loadAnalytics()"
                                :class="activeTab === 'analytics' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-3 px-2 sm:px-3 border-b-2 font-medium text-xs sm:text-sm transition-colors whitespace-nowrap flex-shrink-0 flex flex-col sm:flex-row items-center">
                            <i class="fas fa-chart-bar sm:mr-2 text-xs sm:text-sm"></i> <span class="text-[10px] sm:text-xs md:text-sm">åˆ†æ</span>
                        </button>
                        <button @click="activeTab = 'commissions'; loadCommissions(); loadCommissionHistory()"
                                :class="activeTab === 'commissions' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-3 px-2 sm:px-3 border-b-2 font-medium text-xs sm:text-sm transition-colors whitespace-nowrap flex-shrink-0 flex flex-col sm:flex-row items-center">
                            <i class="fas fa-yen-sign sm:mr-2 text-xs sm:text-sm"></i> <span class="text-[10px] sm:text-xs md:text-sm">å ±é…¬</span>
                        </button>
                        <button @click="activeTab = 'billing'; loadBillingStats()"
                                :class="activeTab === 'billing' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-3 px-2 sm:px-3 border-b-2 font-medium text-xs sm:text-sm transition-colors whitespace-nowrap flex-shrink-0 flex flex-col sm:flex-row items-center">
                            <i class="fas fa-credit-card sm:mr-2 text-xs sm:text-sm"></i> <span class="text-[10px] sm:text-xs md:text-sm">èª²é‡‘çŠ¶æ³</span>
                        </button>
                        <button @click="activeTab = 'settings'"
                                :class="activeTab === 'settings' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-3 px-2 sm:px-3 border-b-2 font-medium text-xs sm:text-sm transition-colors whitespace-nowrap flex-shrink-0 flex flex-col sm:flex-row items-center">
                            <i class="fas fa-cog sm:mr-2 text-xs sm:text-sm"></i> <span class="text-[10px] sm:text-xs md:text-sm">è¨­å®š</span>
                        </button>
                    </nav>
                </div>

                <!-- ãƒªãƒ³ã‚¯ä½œæˆã‚¿ãƒ– -->
                <div x-show="activeTab === 'create'" class="p-4 sm:p-6">
                    <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-900 mb-4 sm:mb-6">ãƒªãƒ³ã‚¯ä½œæˆ</h2>

                    <form @submit.prevent="createLink()" class="space-y-3 sm:space-y-4 max-w-2xl">
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å *</label>
                            <input type="text" x-model="newLink.name" autocomplete="off" required
                                   class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                   placeholder="ä¾‹: 2024å¹´æ˜¥ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³">
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">æµå…¥å…ƒ</label>
                                <input type="text" x-model="newLink.utm_source" autocomplete="off"
                                       class="w-full px-3 sm:px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 text-sm"
                                       placeholder="ä¾‹: facebook">
                            </div>
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">ãƒ¡ãƒ‡ã‚£ã‚¢</label>
                                <input type="text" x-model="newLink.utm_medium" autocomplete="off"
                                       class="w-full px-3 sm:px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 text-sm"
                                       placeholder="ä¾‹: social">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</label>
                            <input type="text" x-model="newLink.utm_campaign" autocomplete="off"
                                   class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                   placeholder="ä¾‹: spring_sale_2024">
                        </div>

                        <!-- Info: LINE URL is automatically set from environment -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 sm:p-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-2 sm:mr-3 text-sm flex-shrink-0"></i>
                                <div class="min-w-0">
                                    <p class="text-xs sm:text-sm text-blue-800 font-medium">ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã«ã¤ã„ã¦</p>
                                    <p class="text-xs sm:text-sm text-blue-700 mt-1">ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ã¯è‡ªå‹•çš„ã«TaskMateå…¬å¼LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ã€‚</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex space-x-4">
                            <button type="submit" :disabled="loading"
                                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <span x-show="!loading">ãƒªãƒ³ã‚¯ã‚’ä½œæˆ</span>
                                <span x-show="loading">
                                    <i class="fas fa-spinner fa-spin mr-2"></i> ä½œæˆä¸­...
                                </span>
                            </button>
                            <button type="button" @click="resetForm()"
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium transition-colors">
                                ãƒªã‚»ãƒƒãƒˆ
                            </button>
                        </div>
                    </form>

                    <!-- ä½œæˆæˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                    <div x-show="createdLink" class="mt-6 bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                        <p class="text-emerald-800 font-semibold mb-2">âœ… ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸï¼</p>
                        <div class="flex items-center space-x-2">
                            <input type="text" :value="createdLink" readonly
                                   class="flex-1 px-3 py-2 bg-white border border-emerald-300 rounded-lg text-sm">
                            <button @click="copyToClipboard(createdLink, $event)"
                                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-copy mr-2"></i> ã‚³ãƒ”ãƒ¼
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ãƒªãƒ³ã‚¯ç®¡ç†ã‚¿ãƒ– -->
                <div x-show="activeTab === 'links'" class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">ä½œæˆæ¸ˆã¿ãƒªãƒ³ã‚¯ä¸€è¦§</h2>

                    <div class="table-scroll overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-emerald-50">
                                <tr>
                                    <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">ã‚³ãƒ¼ãƒ‰</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">ã‚¯ãƒªãƒƒã‚¯</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">CV</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">ä½œæˆæ—¥</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="link in trackingLinks" :key="link.id">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="link.name"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <code x-text="link.tracking_code" class="bg-gray-100 px-2 py-1 rounded"></code>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="link.visit_count"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="link.conversion_count"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(link.created_at)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button @click="copyToClipboard(getTrackingUrl(link.tracking_code), $event)"
                                                    class="bg-emerald-100 hover:bg-emerald-200 text-emerald-600 px-3 py-1 rounded-lg mr-2 transition-colors">
                                                <i class="fas fa-copy"></i> ã‚³ãƒ”ãƒ¼
                                            </button>
                                            <button @click="viewLinkDetails(link)"
                                                    class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded-lg transition-colors">
                                                <i class="fas fa-chart-line"></i> è©³ç´°
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- åˆ†æã‚¿ãƒ– -->
                <div x-show="activeTab === 'analytics'" class="p-4 sm:p-6">
                    <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-900 mb-4 sm:mb-6">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ</h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                        <!-- æœŸé–“åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ -->
                        <div class="bg-white rounded-lg border border-gray-200 p-4 sm:p-6">
                            <h3 class="text-sm sm:text-base md:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">æœŸé–“åˆ¥</h3>
                            <canvas id="performanceChart"></canvas>
                        </div>

                        <!-- ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ãƒãƒ« -->
                        <div class="bg-white rounded-lg border border-gray-200 p-4 sm:p-6">
                            <h3 class="text-sm sm:text-base md:text-lg font-semibold text-gray-900 mb-3 sm:mb-4 whitespace-nowrap">CVãƒ•ã‚¡ãƒãƒ«</h3>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-600">ã‚¯ãƒªãƒƒã‚¯</span>
                                        <span class="text-sm font-semibold" x-text="stats.totalClicks"></span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-8">
                                        <div class="bg-emerald-600 h-8 rounded-full flex items-center justify-center text-white text-xs" style="width: 100%">100%</div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-600">LINEå‹é”è¿½åŠ </span>
                                        <span class="text-sm font-semibold" x-text="stats.totalConversions"></span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-8">
                                        <div class="bg-green-600 h-8 rounded-full flex items-center justify-center text-white text-xs" :style="`width: ${stats.conversionRate}%`">
                                            <span x-text="`${stats.conversionRate}%`"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ãƒˆãƒƒãƒ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ -->
                    <div class="mt-4 sm:mt-6 bg-white rounded-lg border border-gray-200 p-4 sm:p-6">
                        <h3 class="text-sm sm:text-base md:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">ãƒˆãƒƒãƒ—ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</h3>
                        <div class="table-scroll overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">é †ä½</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">åå‰</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">ã‚¯ãƒªãƒƒã‚¯</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">CV</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">CVR</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-for="(campaign, index) in topCampaigns" :key="campaign.id">
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full"
                                                      :class="index === 0 ? 'bg-yellow-100 text-yellow-800' : index === 1 ? 'bg-gray-100 text-gray-800' : index === 2 ? 'bg-orange-100 text-orange-800' : 'bg-gray-50 text-gray-600'"
                                                      x-text="index + 1"></span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="campaign.name"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="campaign.clicks"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="campaign.conversions"></td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-2 py-1 text-xs rounded-full"
                                                      :class="campaign.cvr >= 10 ? 'bg-green-100 text-green-800' : campaign.cvr >= 5 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'"
                                                      x-text="`${campaign.cvr}%`"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- å ±é…¬ã‚¿ãƒ– -->
                <div x-show="activeTab === 'commissions'" class="p-4 sm:p-6">
                    <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-900 mb-4 sm:mb-6">å ±é…¬ç®¡ç†</h2>

                    <!-- å ±é…¬ã‚µãƒãƒªãƒ¼ -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
                        <div class="bg-gradient-to-r from-emerald-500 to-green-600 rounded-xl p-4 sm:p-6 text-white">
                            <p class="text-xs sm:text-sm opacity-90 whitespace-nowrap">ä»Šæœˆã®å ±é…¬</p>
                            <p class="text-2xl sm:text-3xl font-bold mt-1 sm:mt-2" x-text="`Â¥${stats.monthlyCommission.toLocaleString()}`"></p>
                            <p class="text-[10px] sm:text-xs mt-1 sm:mt-2 opacity-75 whitespace-nowrap">æ‰‹æ•°æ–™ç‡: <span x-text="`${agencyInfo.own_commission_rate}%`"></span></p>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 p-4 sm:p-6">
                            <p class="text-xs sm:text-sm text-gray-600 whitespace-nowrap">å‰æœˆã®å ±é…¬</p>
                            <p class="text-xl sm:text-2xl font-bold text-gray-900 mt-1 sm:mt-2" x-text="`Â¥${stats.lastMonthCommission.toLocaleString()}`"></p>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 p-4 sm:p-6">
                            <p class="text-xs sm:text-sm text-gray-600 whitespace-nowrap">ç´¯è¨ˆå ±é…¬</p>
                            <p class="text-xl sm:text-2xl font-bold text-gray-900 mt-1 sm:mt-2" x-text="`Â¥${stats.totalCommission.toLocaleString()}`"></p>
                        </div>
                    </div>

                    <!-- 4æ®µéšä»£ç†åº—åˆ¶åº¦ - è©³ç´°ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ -->
                    <div class="bg-white rounded-lg border border-emerald-200 mb-8">
                        <div class="px-6 py-4 border-b border-emerald-100 bg-gradient-to-r from-emerald-50 to-green-50">
                            <div class="flex items-center justify-between">
                                <h3 class="text-sm sm:text-base md:text-lg font-semibold text-gray-900">
                                    <i class="fas fa-layer-group text-emerald-600 mr-1 sm:mr-2 text-xs sm:text-sm"></i>
                                    åˆ†é…å±¥æ­´
                                </h3>
                                <button @click="loadCommissionHistory()"
                                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-2 py-1 sm:px-3 sm:py-1.5 rounded text-xs sm:text-sm transition-colors">
                                    <i class="fas fa-sync-alt mr-1 text-xs sm:text-sm"></i> æ›´æ–°
                                </button>
                            </div>
                            <p class="text-[10px] sm:text-xs text-gray-600 mt-1">4æ®µéšãƒªãƒ•ã‚¡ãƒ©ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹å ±é…¬åˆ†é…ã®è©³ç´°</p>
                        </div>
                        <div class="table-scroll">
                            <template x-if="loadingCommissions">
                                <div class="p-12 text-center">
                                    <i class="fas fa-spinner fa-spin text-3xl text-emerald-600 mb-4"></i>
                                    <p class="text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
                                </div>
                            </template>
                            <template x-if="!loadingCommissions && commissionHistory.length === 0">
                                <div class="p-12 text-center">
                                    <i class="fas fa-inbox text-5xl text-gray-300 mb-4"></i>
                                    <p class="text-gray-600">ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                                    <p class="text-sm text-gray-500 mt-2">æ¡ˆä»¶æˆç´„ã¾ãŸã¯å‚˜ä¸‹ã‹ã‚‰ã®å¸ã„ä¸Šã’ãŒç™ºç”Ÿã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                                </div>
                            </template>
                            <template x-if="!loadingCommissions && commissionHistory.length > 0">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 sm:px-4 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">æ—¥æ™‚</th>
                                            <th class="px-3 sm:px-4 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">ç¨®åˆ¥</th>
                                            <th class="px-3 sm:px-4 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">ç·é¡</th>
                                            <th class="px-3 sm:px-4 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">ç‡</th>
                                            <th class="px-3 sm:px-4 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">å ±é…¬</th>
                                            <th class="px-3 sm:px-4 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">æˆç´„åº—</th>
                                            <th class="px-3 sm:px-4 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">çŠ¶æ³</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="commission in commissionHistory" :key="commission.id">
                                            <tr class="hover:bg-gray-50 transition-colors">
                                                <td class="px-3 sm:px-4 py-3 whitespace-nowrap text-xs sm:text-sm text-gray-900" x-text="formatDateTime(commission.created_at)"></td>
                                                <td class="px-3 sm:px-4 py-3 whitespace-nowrap">
                                                    <span class="px-1.5 sm:px-2 py-0.5 sm:py-1 text-[10px] sm:text-xs rounded-full font-medium"
                                                          :class="commission.commission_type === 'own' ? 'bg-emerald-100 text-emerald-700' : 'bg-purple-100 text-purple-700'"
                                                          x-text="getCommissionTypeLabel(commission.commission_type)"></span>
                                                </td>
                                                <td class="px-3 sm:px-4 py-3 whitespace-nowrap text-xs sm:text-sm text-gray-700" x-text="`Â¥${(commission.deal_amount || 0).toLocaleString()}`"></td>
                                                <td class="px-3 sm:px-4 py-3 whitespace-nowrap text-xs sm:text-sm text-gray-700" x-text="`${commission.commission_rate || 0}%`"></td>
                                                <td class="px-3 sm:px-4 py-3 whitespace-nowrap text-xs sm:text-sm font-semibold text-emerald-600" x-text="`Â¥${(commission.commission_amount || 0).toLocaleString()}`"></td>
                                                <td class="px-3 sm:px-4 py-3 whitespace-nowrap text-xs sm:text-sm text-gray-600" x-text="commission.closing_agency_name || '-'"></td>
                                                <td class="px-3 sm:px-4 py-3 whitespace-nowrap">
                                                    <span class="px-1.5 sm:px-2 py-0.5 sm:py-1 text-[10px] sm:text-xs rounded-full"
                                                          :class="commission.payment_status === 'paid' ? 'bg-green-100 text-green-800' : commission.payment_status === 'approved' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'"
                                                          x-text="getStatusLabel(commission.payment_status)"></span>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </template>
                        </div>
                    </div>

                    <!-- å ±é…¬å±¥æ­´ -->
                    <div class="bg-white rounded-lg border border-gray-200">
                        <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200">
                            <h3 class="text-sm sm:text-base md:text-lg font-semibold text-gray-900">å ±é…¬å±¥æ­´</h3>
                        </div>
                        <div class="table-scroll overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">æœŸé–“</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">CVæ•°</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">å£²ä¸Š</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">ç‡</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">å ±é…¬</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">çŠ¶æ…‹</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase whitespace-nowrap">æ”¯æ‰•æ—¥</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-for="commission in commissions" :key="commission.id">
                                        <tr>
                                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900" x-text="commission.period"></td>
                                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500" x-text="commission.conversions"></td>
                                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500" x-text="`Â¥${commission.sales.toLocaleString()}`"></td>
                                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500" x-text="`${commission.rate}%`"></td>
                                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-semibold text-gray-900" x-text="`Â¥${commission.amount.toLocaleString()}`"></td>
                                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                                                <span class="px-1.5 sm:px-2 py-0.5 sm:py-1 text-[10px] sm:text-xs rounded-full"
                                                      :class="commission.status === 'paid' ? 'bg-green-100 text-green-800' : commission.status === 'approved' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'"
                                                      x-text="getStatusLabel(commission.status)"></span>
                                            </td>
                                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500" x-text="commission.payment_date || '-'"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- èª²é‡‘çŠ¶æ³ã‚¿ãƒ– -->
                <div x-show="activeTab === 'billing'" class="p-4 sm:p-6">
                    <div class="flex justify-between items-center mb-4 sm:mb-6">
                        <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-900 whitespace-nowrap">èª²é‡‘çŠ¶æ³</h2>
                        <div class="flex items-center space-x-2 sm:space-x-4">
                            <span class="text-xs sm:text-sm text-gray-600 hidden sm:inline whitespace-nowrap">æœ€çµ‚æ›´æ–°: <span x-text="billingStats.lastUpdated ? formatDateTime(billingStats.lastUpdated) : '-'"></span></span>
                            <button @click="loadBillingStats()"
                                    class="bg-emerald-600 hover:bg-emerald-700 text-white p-2 sm:px-4 sm:py-2 rounded-lg transition-colors flex items-center">
                                <i class="fas fa-sync-alt text-sm sm:mr-2"></i> <span class="hidden sm:inline">æ›´æ–°</span>
                            </button>
                        </div>
                    </div>

                    <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
                        <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-4 sm:p-6 text-white">
                            <p class="text-xs sm:text-sm opacity-90 whitespace-nowrap">èª²é‡‘ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼</p>
                            <p class="text-2xl sm:text-3xl font-bold mt-2" x-text="billingStats.summary?.activeSubscribers || 0"></p>
                            <p class="text-[10px] sm:text-xs mt-1 sm:mt-2 opacity-75 whitespace-nowrap">
                                <i class="fas fa-check-circle mr-1 text-[10px] sm:text-xs"></i> å¥‘ç´„ä¸­
                            </p>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-200 p-4 sm:p-6">
                            <p class="text-xs sm:text-sm text-gray-600 whitespace-nowrap">ç·CVæ•°</p>
                            <p class="text-xl sm:text-2xl font-bold text-gray-900 mt-2" x-text="billingStats.summary?.totalConversions || 0"></p>
                            <p class="text-[10px] sm:text-xs mt-1 sm:mt-2 text-gray-500 whitespace-nowrap">
                                <i class="fas fa-user-plus mr-1 text-[10px] sm:text-xs"></i> LINEè¿½åŠ æ¸ˆã¿
                            </p>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-200 p-4 sm:p-6">
                            <p class="text-xs sm:text-sm text-gray-600 whitespace-nowrap">ç´¯è¨ˆå ±é…¬(äºˆå®š)</p>
                            <p class="text-xl sm:text-2xl font-bold text-emerald-600 mt-2" x-text="`Â¥${(billingStats.summary?.totalCommission || 0).toLocaleString()}`"></p>
                            <p class="text-[10px] sm:text-xs mt-1 sm:mt-2 text-gray-500 whitespace-nowrap">
                                <i class="fas fa-calculator mr-1 text-[10px] sm:text-xs"></i> ç‡: <span x-text="`${billingStats.summary?.commissionRate || 0}%`"></span>
                            </p>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-200 p-4 sm:p-6">
                            <p class="text-xs sm:text-sm text-gray-600 whitespace-nowrap">æ”¯æ‰•æ¸ˆå ±é…¬</p>
                            <p class="text-xl sm:text-2xl font-bold text-gray-900 mt-2" x-text="`Â¥${(billingStats.summary?.paidCommission || 0).toLocaleString()}`"></p>
                            <p class="text-[10px] sm:text-xs mt-1 sm:mt-2 text-gray-500 whitespace-nowrap">
                                <i class="fas fa-check mr-1 text-[10px] sm:text-xs"></i> ç¢ºå®šæ¸ˆã¿
                            </p>
                        </div>
                    </div>

                    <!-- å€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª²é‡‘çŠ¶æ…‹ãƒ†ãƒ¼ãƒ–ãƒ« -->
                    <div class="bg-white rounded-lg border border-gray-200">
                        <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200">
                            <h3 class="text-base sm:text-lg font-semibold text-gray-900">å€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª²é‡‘çŠ¶æ…‹</h3>
                            <p class="text-xs sm:text-sm text-gray-600 mt-1">ç´¹ä»‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª²é‡‘çŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèª</p>
                        </div>
                        <div class="table-scroll overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">çŠ¶æ…‹</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">é–‹å§‹æ—¥</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">çµ‚äº†æ—¥</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">ãƒ—ãƒ©ãƒ³</th>
                                        <th class="px-3 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">å ±é…¬</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-if="!billingStats.billingUsers || billingStats.billingUsers.length === 0">
                                        <tr>
                                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                                <i class="fas fa-inbox text-3xl mb-2"></i>
                                                <p>ã¾ã èª²é‡‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</p>
                                                <p class="text-sm mt-1">ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç´¹ä»‹ã—ã¾ã—ã‚‡ã†ï¼</p>
                                            </td>
                                        </tr>
                                    </template>
                                    <template x-for="user in billingStats.billingUsers" :key="user.userId">
                                        <tr class="hover:bg-gray-50" :class="user.isActive ? 'bg-green-50' : ''">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <div class="flex-shrink-0 h-10 w-10 bg-gradient-to-br from-emerald-400 to-green-500 rounded-full flex items-center justify-center text-white font-semibold">
                                                        <span x-text="user.displayName?.charAt(0) || '?'"></span>
                                                    </div>
                                                    <div class="ml-4">
                                                        <div class="text-sm font-medium text-gray-900" x-text="user.displayName"></div>
                                                        <div class="text-xs text-gray-500" x-text="`ID: ${user.userId.substring(0, 8)}...`"></div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-3 py-1 text-xs font-semibold rounded-full"
                                                      :class="{
                                                          'bg-green-100 text-green-800': user.subscriptionStatus === 'active',
                                                          'bg-blue-100 text-blue-800': user.subscriptionStatus === 'trialing',
                                                          'bg-yellow-100 text-yellow-800': user.subscriptionStatus === 'past_due',
                                                          'bg-red-100 text-red-800': user.subscriptionStatus === 'canceled',
                                                          'bg-gray-100 text-gray-800': user.subscriptionStatus === 'free' || !user.subscriptionStatus
                                                      }">
                                                    <i class="fas fa-circle mr-1" :class="user.isActive ? 'fa-pulse' : ''"></i>
                                                    <span x-text="getSubscriptionStatusLabel(user.subscriptionStatus)"></span>
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <template x-if="user.subscriptionStartedAt">
                                                    <span x-text="formatDate(user.subscriptionStartedAt)"></span>
                                                </template>
                                                <template x-if="!user.subscriptionStartedAt">
                                                    <span class="text-gray-400">-</span>
                                                </template>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <template x-if="user.subscriptionEndDate">
                                                    <span x-text="formatDate(user.subscriptionEndDate)"></span>
                                                </template>
                                                <template x-if="!user.subscriptionEndDate && user.isActive">
                                                    <span class="text-green-600">ç¶™ç¶šä¸­</span>
                                                </template>
                                                <template x-if="!user.subscriptionEndDate && !user.isActive">
                                                    <span class="text-gray-400">-</span>
                                                </template>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                <template x-if="user.isPremium">
                                                    <span class="text-yellow-600">
                                                        <i class="fas fa-crown mr-1"></i> ãƒ—ãƒ¬ãƒŸã‚¢ãƒ 
                                                    </span>
                                                </template>
                                                <template x-if="!user.isPremium">
                                                    <span class="text-gray-400">-</span>
                                                </template>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">
                                                <template x-if="user.commission > 0">
                                                    <span class="text-emerald-600" x-text="`Â¥${user.commission.toLocaleString()}`"></span>
                                                </template>
                                                <template x-if="user.commission === 0">
                                                    <span class="text-gray-400">Â¥0</span>
                                                </template>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- è‡ªå‹•æ›´æ–°é€šçŸ¥ -->
                    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                            <div>
                                <p class="text-sm text-blue-800 font-medium">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è‡ªå‹•æ›´æ–°</p>
                                <p class="text-sm text-blue-700 mt-1">ã“ã®ãƒšãƒ¼ã‚¸ã¯30ç§’ã”ã¨ã«è‡ªå‹•ã§æœ€æ–°ã®èª²é‡‘æƒ…å ±ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚æ‰‹å‹•ã§æ›´æ–°ã—ãŸã„å ´åˆã¯ã€å³ä¸Šã®ã€Œæ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <!-- å‚˜ä¸‹ã‹ã‚‰ã®å ±é…¬ç¢ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼ -->
                    <div class="mt-6 sm:mt-8 bg-white rounded-lg border border-purple-200">
                        <div class="px-6 py-4 border-b border-purple-100 bg-gradient-to-r from-purple-50 to-indigo-50">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-sm sm:text-base md:text-lg font-semibold text-gray-900 flex items-center">
                                        <i class="fas fa-users text-purple-600 mr-2"></i>
                                        å‚˜ä¸‹ã‹ã‚‰ã®å ±é…¬ç¢ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼
                                    </h3>
                                    <p class="text-xs sm:text-sm text-gray-600 mt-1">ã‚ãªãŸã®å‚˜ä¸‹ä»£ç†åº—ãŒç²å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒªãƒ•ã‚¡ãƒ©ãƒ«å ±é…¬</p>
                                </div>
                                <button @click="loadReferralUsers()" class="bg-purple-600 hover:bg-purple-700 text-white px-2 py-1 sm:px-3 sm:py-1.5 rounded text-xs sm:text-sm transition-colors">
                                    <i class="fas fa-sync-alt mr-1"></i> æ›´æ–°
                                </button>
                            </div>
                        </div>

                        <!-- Summary Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 sm:p-6 bg-gray-50">
                            <div class="bg-white rounded-lg border border-gray-200 p-4">
                                <p class="text-xs sm:text-sm text-gray-600">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</p>
                                <p class="text-xl sm:text-2xl font-bold text-gray-900 mt-1" x-text="referralSummary.totalUsers">0</p>
                            </div>
                            <div class="bg-white rounded-lg border border-gray-200 p-4">
                                <p class="text-xs sm:text-sm text-gray-600">å¥‘ç´„ä¸­</p>
                                <p class="text-xl sm:text-2xl font-bold text-green-600 mt-1" x-text="referralSummary.activeSubscriptions">0</p>
                            </div>
                            <div class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-lg p-4 text-white">
                                <p class="text-xs sm:text-sm opacity-90">ãƒªãƒ•ã‚¡ãƒ©ãƒ«å ±é…¬</p>
                                <p class="text-xl sm:text-2xl font-bold mt-1" x-text="`Â¥${referralSummary.totalReferralCommission.toLocaleString()}`">Â¥0</p>
                                <p class="text-xs mt-1 opacity-75">â€»èª²é‡‘ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿</p>
                            </div>
                        </div>

                        <!-- Referral Users Table -->
                        <div class="table-scroll overflow-x-auto">
                            <template x-if="referralUsers.length === 0">
                                <div class="p-12 text-center">
                                    <i class="fas fa-users text-5xl text-gray-300 mb-4"></i>
                                    <p class="text-gray-600">å‚˜ä¸‹ã‹ã‚‰ã®å ±é…¬ç¢ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</p>
                                    <p class="text-sm text-gray-500 mt-2">å‚˜ä¸‹ä»£ç†åº—ãŒç²å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª²é‡‘ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                                </div>
                            </template>
                            <template x-if="referralUsers.length > 0">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap">LINEå</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap">èª²é‡‘çŠ¶æ…‹</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap">ç²å¾—ä»£ç†åº—</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap">èª²é‡‘é–‹å§‹æ—¥</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap">ãƒªãƒ•ã‚¡ãƒ©ãƒ«ç‡</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap">ã‚ãªãŸã®å ±é…¬</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="user in referralUsers" :key="user.id">
                                            <tr class="hover:bg-gray-50 transition-colors">
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex items-center">
                                                        <template x-if="user.line_picture">
                                                            <img :src="user.line_picture" class="w-8 h-8 rounded-full mr-2" alt="">
                                                        </template>
                                                        <template x-if="!user.line_picture">
                                                            <div class="w-8 h-8 rounded-full bg-gray-300 mr-2 flex items-center justify-center">
                                                                <i class="fas fa-user text-gray-500 text-xs"></i>
                                                            </div>
                                                        </template>
                                                        <span class="text-sm font-medium text-gray-900" x-text="user.line_name"></span>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="px-2 py-1 text-xs rounded-full"
                                                          :class="user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                                        <i class="fas fa-circle mr-1" :class="user.is_active ? 'fa-pulse' : ''"></i>
                                                        <span x-text="user.is_active ? 'å¥‘ç´„ä¸­' : 'è§£ç´„æ¸ˆã¿'"></span>
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="user.acquired_agency_name"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(user.subscription_started_at)"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                                                    <span x-text="`${user.referral_rate}%`"></span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">
                                                    <template x-if="user.is_active">
                                                        <span class="text-purple-600" x-text="`Â¥${user.referral_commission.toLocaleString()}`"></span>
                                                    </template>
                                                    <template x-if="!user.is_active">
                                                        <span class="text-gray-400">Â¥0</span>
                                                    </template>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- è¨­å®šã‚¿ãƒ– -->
                <div x-show="activeTab === 'settings'" class="p-4 sm:p-6">
                    <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-900 mb-4 sm:mb-6">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</h2>

                    <div class="max-w-2xl space-y-4 sm:space-y-6">
                        <!-- ä»£ç†åº—æƒ…å ± -->
                        <div class="bg-white rounded-lg border border-gray-200 p-4 sm:p-6">
                            <h3 class="text-sm sm:text-base md:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">ä»£ç†åº—æƒ…å ±</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ä»£ç†åº—ã‚³ãƒ¼ãƒ‰</label>
                                    <input type="text" :value="agencyInfo.code" readonly
                                           class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¼šç¤¾å</label>
                                    <input type="text" x-model="agencyInfo.company_name" autocomplete="organization"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">é€£çµ¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                    <input type="email" x-model="agencyInfo.contact_email" autocomplete="email"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">é›»è©±ç•ªå·</label>
                                    <input type="tel" x-model="agencyInfo.contact_phone" autocomplete="tel"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                </div>
                            </div>
                        </div>

                        <!-- æŒ¯è¾¼å…ˆæƒ…å ± -->
                        <div class="bg-white rounded-lg border border-gray-200 p-4 sm:p-6">
                            <h3 class="text-sm sm:text-base md:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">æŒ¯è¾¼å…ˆæƒ…å ±</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">éŠ€è¡Œå</label>
                                    <input type="text" x-model="paymentInfo.bank_name" autocomplete="off"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æ”¯åº—å</label>
                                    <input type="text" x-model="paymentInfo.branch_name" autocomplete="off"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å£åº§ç¨®åˆ¥</label>
                                    <select x-model="paymentInfo.account_type" autocomplete="off"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                        <option value="æ™®é€š">æ™®é€š</option>
                                        <option value="å½“åº§">å½“åº§</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å£åº§ç•ªå·</label>
                                    <input type="text" x-model="paymentInfo.account_number" autocomplete="off"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å£åº§åç¾©</label>
                                    <input type="text" x-model="paymentInfo.account_holder" autocomplete="name"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                </div>
                            </div>
                        </div>

                        <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š -->
                        <div class="bg-white rounded-lg border border-gray-200 p-4 sm:p-6">
                            <h3 class="text-sm sm:text-base md:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</p>
                                        <p class="text-sm text-gray-500">å®šæœŸçš„ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã—ã¾ã—ã‚‡ã†</p>
                                    </div>
                                    <button @click="openChangePasswordModal()"
                                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors border border-gray-300">
                                        <i class="fas fa-key mr-2"></i> ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="flex space-x-4">
                            <button @click="saveSettings()"
                                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                <i class="fas fa-save mr-2"></i> è¨­å®šã‚’ä¿å­˜
                            </button>
                            <button @click="cancelSettings()"
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium transition-colors">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ãƒªãƒ³ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div x-show="linkDetailsModal"
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         @click.self="closeLinkDetailsModal()">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- èƒŒæ™¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" @click="closeLinkDetailsModal()"></div>

            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="bg-gradient-to-r from-emerald-600 to-green-600 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-chart-line text-white"></i>
                            </div>
                            <h3 class="ml-3 text-lg font-semibold text-white">ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯è©³ç´°</h3>
                        </div>
                        <button @click="closeLinkDetailsModal()" class="text-white hover:text-gray-200 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                <div class="px-6 py-6 max-h-[70vh] overflow-y-auto">
                    <template x-if="selectedLink">
                        <div class="space-y-6">
                            <!-- åŸºæœ¬æƒ…å ± -->
                            <div class="bg-gradient-to-r from-emerald-50 to-green-50 rounded-lg p-6 border border-emerald-200">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">
                                    <i class="fas fa-info-circle text-emerald-600 mr-2"></i>åŸºæœ¬æƒ…å ±
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å</label>
                                        <p class="text-base font-semibold text-gray-900" x-text="selectedLink.name"></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">ä½œæˆæ—¥</label>
                                        <p class="text-base text-gray-900" x-text="formatDateTime(selectedLink.created_at)"></p>
                                    </div>
                                    <div class="col-span-full">
                                        <label class="block text-sm font-medium text-gray-600 mb-1">ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°URL</label>
                                        <div class="flex items-center space-x-2">
                                            <input type="text" :value="getTrackingUrl(selectedLink.tracking_code)" readonly
                                                   class="flex-1 px-3 py-2 bg-white border border-emerald-300 rounded-lg text-sm font-mono">
                                            <button @click="copyToClipboard(getTrackingUrl(selectedLink.tracking_code), $event)"
                                                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg transition-colors whitespace-nowrap">
                                                <i class="fas fa-copy mr-2"></i>ã‚³ãƒ”ãƒ¼
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ¼ãƒ‰</label>
                                        <code class="inline-block bg-gray-100 px-3 py-1 rounded text-sm" x-text="selectedLink.tracking_code"></code>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                                              :class="selectedLink.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                            <i :class="selectedLink.is_active ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-1"></i>
                                            <span x-text="selectedLink.is_active ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'"></span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ -->
                            <div class="bg-white rounded-lg border border-gray-200 p-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">
                                    <i class="fas fa-chart-bar text-emerald-600 mr-2"></i>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
                                </h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="text-center p-4 bg-emerald-50 rounded-lg">
                                        <p class="text-sm text-gray-600 mb-1">ã‚¯ãƒªãƒƒã‚¯æ•°</p>
                                        <p class="text-2xl font-bold text-emerald-600" x-text="selectedLink.visit_count || 0"></p>
                                    </div>
                                    <div class="text-center p-4 bg-green-50 rounded-lg">
                                        <p class="text-sm text-gray-600 mb-1">ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³</p>
                                        <p class="text-2xl font-bold text-green-600" x-text="selectedLink.conversion_count || 0"></p>
                                    </div>
                                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                                        <p class="text-sm text-gray-600 mb-1">CVR</p>
                                        <p class="text-2xl font-bold text-blue-600" x-text="calculateCVR() + '%'"></p>
                                    </div>
                                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                                        <p class="text-sm text-gray-600 mb-1">äºˆæƒ³å ±é…¬</p>
                                        <p class="text-2xl font-bold text-yellow-600" x-text="'Â¥' + calculateCommission()"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ -->
                            <div class="bg-white rounded-lg border border-gray-200 p-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">
                                    <i class="fas fa-tags text-emerald-600 mr-2"></i>UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">UTM Source</label>
                                        <p class="text-sm text-gray-900" x-text="selectedLink.utm_source || '-'"></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">UTM Medium</label>
                                        <p class="text-sm text-gray-900" x-text="selectedLink.utm_medium || '-'"></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">UTM Campaign</label>
                                        <p class="text-sm text-gray-900" x-text="selectedLink.utm_campaign || '-'"></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-1">UTM Term</label>
                                        <p class="text-sm text-gray-900" x-text="selectedLink.utm_term || '-'"></p>
                                    </div>
                                    <div class="col-span-full">
                                        <label class="block text-sm font-medium text-gray-600 mb-1">UTM Content</label>
                                        <p class="text-sm text-gray-900" x-text="selectedLink.utm_content || '-'"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- æœ€è¿‘ã®è¨ªå•å±¥æ­´ -->
                            <div class="bg-white rounded-lg border border-gray-200 p-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">
                                    <i class="fas fa-history text-emerald-600 mr-2"></i>æœ€è¿‘ã®è¨ªå•å±¥æ­´
                                </h4>
                                <template x-if="linkVisits.length > 0">
                                    <div class="table-scroll overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ—¥æ™‚</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">LINEå</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ãƒ‡ãƒã‚¤ã‚¹</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ãƒ–ãƒ©ã‚¦ã‚¶</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">OS</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ãƒªãƒ•ã‚¡ãƒ©ãƒ¼</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                                                <template x-for="visit in linkVisits" :key="visit.id">
                                                    <tr>
                                                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-900" x-text="formatDateTime(visit.created_at)"></td>
                                                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-900">
                                                            <span x-show="visit.line_display_name" class="flex items-center">
                                                                <i class="fab fa-line text-green-500 mr-1"></i>
                                                                <span x-text="visit.line_display_name"></span>
                                                            </span>
                                                            <span x-show="!visit.line_display_name" class="text-gray-400">-</span>
                                                        </td>
                                                        <td class="px-4 py-2 whitespace-nowrap text-xs">
                                                            <span class="px-2 py-1 rounded-full text-xs"
                                                                  :class="{
                                                                      'bg-blue-100 text-blue-800': visit.device_type === 'mobile',
                                                                      'bg-purple-100 text-purple-800': visit.device_type === 'tablet',
                                                                      'bg-gray-100 text-gray-800': visit.device_type === 'desktop'
                                                                  }"
                                                                  x-text="visit.device_type || 'unknown'"></span>
                                                        </td>
                                                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-900" x-text="visit.browser || '-'"></td>
                                                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-900" x-text="visit.os || '-'"></td>
                                                        <td class="px-4 py-2 text-xs text-gray-600 truncate max-w-xs" x-text="visit.referrer || '-'"></td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </template>
                                <template x-if="linkVisits.length === 0">
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-inbox text-3xl mb-2"></i>
                                        <p>ã¾ã è¨ªå•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- ãƒ•ãƒƒã‚¿ãƒ¼ (ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³) -->
                <div class="bg-gray-50 px-6 py-4 flex flex-wrap gap-3 justify-between items-center">
                    <div class="flex gap-2">
                        <button @click="toggleLinkStatus(selectedLink)"
                                class="px-4 py-2 rounded-lg font-medium transition-colors"
                                :class="selectedLink?.is_active ? 'bg-red-100 hover:bg-red-200 text-red-700' : 'bg-green-100 hover:bg-green-200 text-green-700'">
                            <i :class="selectedLink?.is_active ? 'fas fa-ban' : 'fas fa-check-circle'" class="mr-2"></i>
                            <span x-text="selectedLink?.is_active ? 'ç„¡åŠ¹åŒ–' : 'æœ‰åŠ¹åŒ–'"></span>
                        </button>
                        <button @click="deleteLinkWithConfirm(selectedLink)"
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-trash mr-2"></i>å‰Šé™¤
                        </button>
                    </div>
                    <button @click="closeLinkDetailsModal()"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium transition-colors">
                        é–‰ã˜ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div x-show="changePasswordModal"
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         @click.self="closeChangePasswordModal()">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- èƒŒæ™¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" @click="closeChangePasswordModal()"></div>

            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="bg-gradient-to-r from-emerald-600 to-green-600 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-key text-white"></i>
                            </div>
                            <h3 class="ml-3 text-lg font-semibold text-white">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
                        </div>
                        <button @click="closeChangePasswordModal()" class="text-white hover:text-gray-200 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
                <form @submit.prevent="changePassword()" class="px-6 py-4">
                    <div class="space-y-4">
                        <!-- ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *
                            </label>
                            <div class="relative">
                                <input :type="showCurrentPassword ? 'text' : 'password'"
                                       x-model="changePasswordForm.currentPassword"
                                       required
                                       class="w-full px-4 py-3 pr-10 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                       placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                                <button type="button"
                                        @click="showCurrentPassword = !showCurrentPassword"
                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <i :class="showCurrentPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                </button>
                            </div>
                        </div>

                        <!-- æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *
                            </label>
                            <div class="relative">
                                <input :type="showNewPassword ? 'text' : 'password'"
                                       x-model="changePasswordForm.newPassword"
                                       required
                                       minlength="8"
                                       class="w-full px-4 py-3 pr-10 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                       placeholder="8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›"
                                       @input="checkPasswordStrength()">
                                <button type="button"
                                        @click="showNewPassword = !showNewPassword"
                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <i :class="showNewPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                </button>
                            </div>
                            <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
                            <div x-show="changePasswordForm.newPassword.length > 0" class="mt-2">
                                <div class="flex items-center space-x-2">
                                    <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="h-full transition-all duration-300"
                                             :class="{
                                                 'w-1/4 bg-red-500': passwordStrength === 'weak',
                                                 'w-2/4 bg-yellow-500': passwordStrength === 'medium',
                                                 'w-3/4 bg-green-500': passwordStrength === 'strong',
                                                 'w-full bg-emerald-600': passwordStrength === 'very-strong'
                                             }"></div>
                                    </div>
                                    <span class="text-xs font-medium"
                                          :class="{
                                              'text-red-600': passwordStrength === 'weak',
                                              'text-yellow-600': passwordStrength === 'medium',
                                              'text-green-600': passwordStrength === 'strong',
                                              'text-emerald-600': passwordStrength === 'very-strong'
                                          }"
                                          x-text="passwordStrengthLabel"></span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">è‹±å¤§æ–‡å­—ã€è‹±å°æ–‡å­—ã€æ•°å­—ã€è¨˜å·ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨å¼·åº¦ãŒä¸ŠãŒã‚Šã¾ã™</p>
                            </div>
                        </div>

                        <!-- æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰*
                            </label>
                            <div class="relative">
                                <input :type="showConfirmPassword ? 'text' : 'password'"
                                       x-model="changePasswordForm.confirmPassword"
                                       required
                                       class="w-full px-4 py-3 pr-10 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                       placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›">
                                <button type="button"
                                        @click="showConfirmPassword = !showConfirmPassword"
                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <i :class="showConfirmPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                </button>
                            </div>
                            <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ãƒã‚§ãƒƒã‚¯ -->
                            <div x-show="changePasswordForm.confirmPassword.length > 0" class="mt-2">
                                <p class="text-xs"
                                   :class="changePasswordForm.newPassword === changePasswordForm.confirmPassword ? 'text-green-600' : 'text-red-600'">
                                    <i :class="changePasswordForm.newPassword === changePasswordForm.confirmPassword ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i>
                                    <span x-text="changePasswordForm.newPassword === changePasswordForm.confirmPassword ? 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¦ã„ã¾ã™' : 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“'"></span>
                                </p>
                            </div>
                        </div>

                        <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                        <div x-show="changePasswordError"
                             class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                <span x-text="changePasswordError"></span>
                            </div>
                        </div>

                        <!-- æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                        <div x-show="changePasswordSuccess"
                             class="bg-emerald-50 border border-emerald-200 text-emerald-700 px-4 py-3 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸ</span>
                            </div>
                        </div>
                    </div>

                    <!-- ãƒœã‚¿ãƒ³ -->
                    <div class="mt-6 flex space-x-3">
                        <button type="submit"
                                :disabled="loading"
                                class="flex-1 bg-gradient-to-r from-emerald-600 to-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:from-emerald-700 hover:to-green-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!loading">
                                <i class="fas fa-check mr-2"></i> å¤‰æ›´ã™ã‚‹
                            </span>
                            <span x-show="loading" class="inline-flex items-center">
                                <i class="fas fa-spinner fa-spin mr-2"></i> å¤‰æ›´ä¸­...
                            </span>
                        </button>
                        <button type="button"
                                @click="closeChangePasswordModal()"
                                :disabled="loading"
                                class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ© -->
    <script>
        // Alpine.jsã®åˆæœŸåŒ–ã‚’ãƒ­ã‚°
        console.log('ğŸ“¦ Scripts loading...');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
        window.addEventListener('error', function(event) {
            console.error('âŒ Global error caught:',  {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });

            // ã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢ã«è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #fee; color: #c00; padding: 20px; z-index: 99999; font-family: monospace; font-size: 12px; max-height: 300px; overflow: auto;';
            errorDiv.innerHTML = `
                <strong>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</strong><br>
                <strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${event.message}<br>
                <strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ${event.filename}<br>
                <strong>è¡Œ:</strong> ${event.lineno}:${event.colno}<br>
                <strong>ã‚¹ã‚¿ãƒƒã‚¯:</strong> ${event.error ? event.error.stack : 'ãªã—'}<br>
                <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; background: #c00; color: white; border: none; cursor: pointer;">é–‰ã˜ã‚‹</button>
            `;
            document.body.appendChild(errorDiv);
        });

        // Uncaught Promiseã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
        window.addEventListener('unhandledrejection', function(event) {
            console.error('âŒ Unhandled promise rejection:', event.reason);

            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #fea; color: #840; padding: 20px; z-index: 99999; font-family: monospace; font-size: 12px; max-height: 300px; overflow: auto;';
            errorDiv.innerHTML = `
                <strong>âš ï¸  Promise ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</strong><br>
                <strong>ç†ç”±:</strong> ${event.reason}<br>
                <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; background: #840; color: white; border: none; cursor: pointer;">é–‰ã˜ã‚‹</button>
            `;
            document.body.appendChild(errorDiv);
        });

        // Alpine.jsã®åˆæœŸåŒ–ã‚’ç›£è¦–
        document.addEventListener('alpine:init', () => {
            console.log('ğŸ‰ Alpine.js initialized successfully!');
        });

        document.addEventListener('alpine:initializing', () => {
            console.log('ğŸ”„ Alpine.js initializing...');
        });

        document.addEventListener('alpine:initialized', () => {
            console.log('âœ… Alpine.js fully initialized!');
        });

        // DOMContentLoadedå¾Œã«Alpine.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“„ DOM Content Loaded');

            // 3ç§’å¾Œã«Alpine.jsãŒã¾ã åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯è­¦å‘Š
            setTimeout(() => {
                if (!window.Alpine) {
                    console.error('âŒ Alpine.js is not loaded after 3 seconds!');
                    alert('Alpine.jsã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                } else {
                    console.log('âœ… Alpine.js is loaded:', window.Alpine);
                }
            }, 3000);
        });
    </script>

    <!-- XSS Protection Utility -->
    <script src="xss-protection.js"></script>
    <script src="dashboard.js"></script>

    <!-- Final diagnostic check -->
    <script>
        console.log('ğŸ All inline scripts loaded');
        console.log('ğŸ“Š Current state:', {
            agencyDashboard: typeof window.agencyDashboard,
            Alpine: typeof window.Alpine,
            XSSProtection: typeof window.XSSProtection
        });

        // Wait a bit and check if Alpine initialized
        setTimeout(() => {
            console.log('â° After 2 seconds:', {
                Alpine: typeof window.Alpine,
                AlpineReady: window.Alpine ? 'yes' : 'no'
            });

            if (!window.Alpine) {
                console.error('âŒâŒâŒ Alpine.js is NOT loaded after 2 seconds! âŒâŒâŒ');
                console.error('This is likely why the page is white.');
                console.error('Possible causes:');
                console.error('1. Network error loading Alpine.js from CDN');
                console.error('2. SRI hash mismatch (we removed it, so not this)');
                console.error('3. Content Security Policy blocking the script');
                console.error('4. Browser extension blocking the CDN');

                // Show error on page
                document.body.innerHTML = `
                    <div style="padding: 40px; max-width: 800px; margin: 0 auto; font-family: sans-serif;">
                        <h1 style="color: #c00;">âŒ Alpine.js Failed to Load</h1>
                        <p><strong>The page cannot initialize because Alpine.js did not load from the CDN.</strong></p>
                        <h2>Possible Solutions:</h2>
                        <ol>
                            <li>Check your internet connection</li>
                            <li>Check if a browser extension is blocking CDN resources</li>
                            <li>Check the browser console (F12) for network errors</li>
                            <li>Try disabling ad blockers or privacy extensions</li>
                            <li>Try a different browser</li>
                        </ol>
                        <h2>Technical Details:</h2>
                        <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto;">
Alpine.js URL: https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js
Alpine.js loaded: No
agencyDashboard function: ${typeof window.agencyDashboard}
XSSProtection loaded: ${typeof window.XSSProtection}
                        </pre>
                        <button onclick="location.reload()" style="background: #10b981; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            ğŸ”„ Reload Page
                        </button>
                    </div>
                `;
            } else {
                console.log('âœ… Alpine.js loaded successfully!');
            }
        }, 2000);
    </script>
</body>
</html>