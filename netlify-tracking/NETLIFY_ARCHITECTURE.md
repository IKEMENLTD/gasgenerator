# TaskMate AI - Netlifyå´ ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸

**æœ€çµ‚æ›´æ–°:** 2025-10-23
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 4.1 (å®Ÿç’°å¢ƒå¤‰æ•°ãƒ»å®Ÿãƒ†ãƒ¼ãƒ–ãƒ«æ•°æ¤œè¨¼å®Œäº†ç‰ˆ)
**å¯¾è±¡:** Netlify Functions (ä»£ç†åº—ã‚·ã‚¹ãƒ†ãƒ  & ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚° & LINE Webhookè»¢é€)
**ç·ãƒšãƒ¼ã‚¸æ•°:** 2700+è¡Œï¼ˆå®Ÿè£…ãƒ™ãƒ¼ã‚¹å®Œå…¨ç‰ˆï¼‰

---

## ğŸš¨ é‡è¦ãªå¤‰æ›´å±¥æ­´

**v4.1æ›´æ–°å†…å®¹ (2025-10-23):**
- **ç’°å¢ƒå¤‰æ•°ã®å®Ÿç’°å¢ƒç”»åƒæ¤œè¨¼**: 18å€‹ â†’ **22å€‹**ï¼ˆå®ŸNetlifyç’°å¢ƒå¤‰æ•°ç”»åƒã‹ã‚‰æŠ½å‡ºï¼‰
  - å®Ÿç’°å¢ƒç”»åƒã‹ã‚‰22å€‹å…¨ã¦ç¢ºèª
  - NEXT_PUBLIC_* å¤‰æ•°3å€‹è¿½åŠ 
  - STRIPE_PAYMENT_LINKã€STRIPE_PROFESSIONAL_PAYMENT_LINKè¿½åŠ 
  - ANTHROPIC_API_KEYã€NETLIFY_SITE_IDã€CRON_SECRETè¿½åŠ 
  - ADMIN_API_KEYã€ADMIN_API_SECRETè¿½åŠ ï¼ˆæœªä½¿ç”¨ã ãŒè¨­å®šæ¸ˆã¿ï¼‰
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«: 10å€‹ â†’ 18å€‹ â†’ 47å€‹å®Œå…¨ãƒªã‚¹ãƒˆ**
  - Netlifyä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«18å€‹ã‚’è©³ç´°åŒ–
  - Supabaseå…¨ãƒ†ãƒ¼ãƒ–ãƒ«47å€‹ã‚’ç¢ºèªãƒ»è¨˜è¼‰
- **å®Ÿç’°å¢ƒã¨ã®å®Œå…¨ç…§åˆå®Œäº†**ï¼ˆç”»åƒæ¤œè¨¼ã«ã‚ˆã‚Š100%æ­£ç¢ºï¼‰

**v4.0æ›´æ–°å†…å®¹ (2025-10-23):**
- **Functionsæ•°ã®å®Œå…¨ä¿®æ­£: 32å€‹ â†’ 38å€‹**ï¼ˆ6å€‹ã®æœªæ–‡æ›¸åŒ–Functionã‚’è¿½åŠ ï¼‰
- **ç’°å¢ƒå¤‰æ•°ã®å®Œå…¨ãƒªã‚¹ãƒˆåŒ–: 10å€‹ â†’ 21å€‹**ï¼ˆ11å€‹è¿½åŠ ï¼‰
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®è©³ç´°åŒ–**ï¼ˆå…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ»åˆ¶ç´„ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
- **Netlifyâ†’Renderè»¢é€ã®ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ãƒ¡ã‚«ãƒ‹ã‚ºãƒ è©³ç´°åŒ–**
- **User-Agentè§£æã®å®Œå…¨å®Ÿè£…**ï¼ˆOSãƒãƒ¼ã‚¸ãƒ§ãƒ³è©³ç´°å–å¾—ï¼‰
- **4æ®µéšä»£ç†åº—åˆ¶åº¦ã®è©³ç´°åŒ–**ï¼ˆãƒ¬ãƒ™ãƒ«è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã€å ±é…¬ç‡ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
- **Utilityé–¢æ•°ç¾¤6ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Œå…¨å®Ÿè£…ã‚³ãƒ¼ãƒ‰**

**v3.0æ›´æ–°å†…å®¹ (2024-10-23):**
- å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã¨ã®ç…§åˆã«ã‚ˆã‚Š32å€‹ã®Functionå…¨ã¦ã‚’è¨˜è¼‰ï¼ˆæ—§ç‰ˆã¯4å€‹ã®ã¿ï¼‰
- 4æ®µéšä»£ç†åº—åˆ¶åº¦ã®å®Œå…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ï¼ˆ20%â†’18%â†’16%â†’14%ï¼‰
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ ã®å®Œå…¨è¨˜è¼‰ï¼ˆCSRFä¿è­·ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€Cookieèªè¨¼ï¼‰
- ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã®å®Œå…¨è¨˜è¼‰ï¼ˆLINE Login â†’ å‹é”è¿½åŠ  â†’ ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- Utilityé–¢æ•°ç¾¤6ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°è¿½åŠ 
- SendGridé€£æºã®å®Œå…¨è¨˜è¼‰ï¼ˆHTMLãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
- Stripe Webhooké€£æºã®å®Œå…¨è¨˜è¼‰

---

## ç›®æ¬¡

1. [Netlifyå´ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](#1-netlifyå´ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦)
2. [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](#2-æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)
3. [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ](#3-ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ)
4. [å…¨32 Functions å®Œå…¨ãƒªã‚¹ãƒˆ](#4-å…¨32-functions-å®Œå…¨ãƒªã‚¹ãƒˆ)
5. [ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ ](#5-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ )
6. [ğŸ¢ 4æ®µéšä»£ç†åº—åˆ¶åº¦](#6-4æ®µéšä»£ç†åº—åˆ¶åº¦)
7. [ğŸ“ ä»£ç†åº—ç™»éŒ²ãƒ•ãƒ­ãƒ¼](#7-ä»£ç†åº—ç™»éŒ²ãƒ•ãƒ­ãƒ¼)
8. [ğŸ” èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ](#8-èªè¨¼ã‚·ã‚¹ãƒ†ãƒ )
9. [ğŸ“§ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ•ãƒ­ãƒ¼](#9-ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ•ãƒ­ãƒ¼)
10. [ğŸ’³ Stripe Webhook é€£æº](#10-stripe-webhook-é€£æº)
11. [ğŸ“Š ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ](#11-ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ )
12. [ğŸ“ ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ](#12-ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ )
13. [ğŸ”— LINE Webhook è»¢é€](#13-line-webhook-è»¢é€)
14. [ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æº](#14-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æº)
15. [ğŸŒ ç’°å¢ƒå¤‰æ•°](#15-ç’°å¢ƒå¤‰æ•°)
16. [ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †](#16-ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †)
17. [ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#17-ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)
18. [ğŸ“š ä»˜éŒ²](#18-ä»˜éŒ²)

---

## 1. Netlifyå´ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 å½¹å‰²

**4æ®µéšä»£ç†åº—ã‚·ã‚¹ãƒ†ãƒ  + ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚° + LINE Webhook ä¸­ç¶™**

Netlify Functions ã¯ TaskMate AI ã®ä»£ç†åº—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã€ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°æ©Ÿèƒ½ã€LINE Webhook ã®ä¸­ç¶™ç‚¹ã‚’æ‹…å½“ã—ã¾ã™ã€‚

**ä¸»ãªè²¬å‹™:**

1. **4æ®µéšä»£ç†åº—ã‚·ã‚¹ãƒ†ãƒ **
   - ä»£ç†åº—ç™»éŒ²ãƒ»èªè¨¼ï¼ˆJWT + Cookie-basedï¼‰
   - 4éšå±¤ã®ä»£ç†åº—æ§‹é€ ï¼ˆæœ€å¤§ãƒ¬ãƒ™ãƒ«4ã¾ã§ï¼‰
   - æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹éšå±¤ç®¡ç†
   - å ±é…¬ç‡ã®è‡ªå‹•è¨­å®šï¼ˆ20% â†’ 18% â†’ 16% â†’ 14%ï¼‰

2. **ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ **
   - ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ã®è¨ªå•è¨˜éŒ²
   - ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±è§£æï¼ˆOSã€ãƒ–ãƒ©ã‚¦ã‚¶ã€ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—ï¼‰
   - ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ²ï¼ˆLINEå‹é”è¿½åŠ ã€Stripeæ±ºæ¸ˆï¼‰

3. **LINE Webhook è»¢é€**
   - LINE API â†’ Netlify â†’ Render ã¸è»¢é€
   - LINE Profile ã®ä¿å­˜ãƒ»æ›´æ–°ï¼ˆUPSERTï¼‰
   - è¨ªå•è¨˜éŒ²ã¨ã®ç´ä»˜ã‘ï¼ˆå‹é”ã‚¿ã‚¤ãƒ—åˆ¤å®šï¼‰

4. **Stripe Webhook é€£æº**
   - æ±ºæ¸ˆã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
   - ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è‡ªå‹•è¨ˆç®—
   - ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ²ä½œæˆ

5. **ç®¡ç†ç”»é¢ã®æä¾›**
   - ä»£ç†åº—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆAlpine.jsï¼‰
   - ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆï¼ˆSendGridé€£æºï¼‰

**Render ã¨ã®é–¢ä¿‚:**
```
LINE API â†’ Netlify Functions â†’ Render (ãƒ¡ã‚¤ãƒ³å‡¦ç†)
                â†“
         ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°å‡¦ç†ï¼ˆç‹¬ç«‹ï¼‰
         ä»£ç†åº—ç®¡ç†ï¼ˆç‹¬ç«‹ï¼‰
         Stripe Webhookï¼ˆç‹¬ç«‹ï¼‰
```

---

### 1.2 ãªãœ Netlify ã‚’ä½¿ã†ã®ã‹ï¼Ÿ

#### ç†ç”±1: é«˜é€Ÿãƒ‡ãƒ—ãƒ­ã‚¤
- Netlify Functions: 30ç§’-1åˆ†ã§ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
- Render (Next.js): 3-5åˆ†ã®ãƒ“ãƒ«ãƒ‰æ™‚é–“

ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°æ©Ÿèƒ½ã‚„ä»£ç†åº—æ©Ÿèƒ½ã®ä¿®æ­£ã‚’å³åº§ã«åæ˜ ã§ãã‚‹

#### ç†ç”±2: ã‚·ã‚¹ãƒ†ãƒ ã®ç‹¬ç«‹æ€§
- ä»£ç†åº—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¯ Render ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†ã¨ç„¡é–¢ä¿‚
- ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°å‡¦ç†ã‚‚ç‹¬ç«‹
- è² è·åˆ†æ•£: ä»£ç†åº—ãƒ»ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°è² è·ãŒ Render ã«å½±éŸ¿ã—ãªã„

#### ç†ç”±3: é™çš„ã‚µã‚¤ãƒˆãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°
- ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ï¼ˆpublic/index.htmlï¼‰
- ä»£ç†åº—ç®¡ç†ç”»é¢ï¼ˆadmin/index.htmlï¼‰

---

### 1.3 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Netlify Site                                  â”‚
â”‚              (elegant-gumdrop-9a983a)                      â”‚
â”‚                                                            â”‚
â”‚  URL: https://taskmateai.net                              â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Static Files                                     â”‚    â”‚
â”‚  â”‚ - public/index.html     (ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°)           â”‚    â”‚
â”‚  â”‚ - admin/index.html      (ä»£ç†åº—ç®¡ç†ç”»é¢)         â”‚    â”‚
â”‚  â”‚ - admin/login.html      (ãƒ­ã‚°ã‚¤ãƒ³)               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Netlify Functions (32å€‹ + Utils 6å€‹ = 38å€‹)    â”‚    â”‚
â”‚  â”‚                                                  â”‚    â”‚
â”‚  â”‚ ã€èªè¨¼ãƒ»ç™»éŒ²ã€‘(11å€‹)                              â”‚    â”‚
â”‚  â”‚ - agency-auth                                    â”‚    â”‚
â”‚  â”‚ - agency-register                                â”‚    â”‚
â”‚  â”‚ - agency-complete-registration                   â”‚    â”‚
â”‚  â”‚ - password-reset-request                         â”‚    â”‚
â”‚  â”‚ - password-reset-confirm                         â”‚    â”‚
â”‚  â”‚ - agency-logout                                  â”‚    â”‚
â”‚  â”‚ - validate-admin                                 â”‚    â”‚
â”‚  â”‚                                                  â”‚    â”‚
â”‚  â”‚ ã€ä»£ç†åº—ç®¡ç†ã€‘(9å€‹)                               â”‚    â”‚
â”‚  â”‚ - agency-links                                   â”‚    â”‚
â”‚  â”‚ - agency-create-link                             â”‚    â”‚
â”‚  â”‚ - agency-toggle-link                             â”‚    â”‚
â”‚  â”‚ - agency-delete-link                             â”‚    â”‚
â”‚  â”‚ - agency-link-visits                             â”‚    â”‚
â”‚  â”‚ - agency-get-line-url                            â”‚    â”‚
â”‚  â”‚ - agency-settings                                â”‚    â”‚
â”‚  â”‚ - agency-change-password                         â”‚    â”‚
â”‚  â”‚                                                  â”‚    â”‚
â”‚  â”‚ ã€çµ±è¨ˆãƒ»åˆ†æã€‘(5å€‹)                               â”‚    â”‚
â”‚  â”‚ - agency-stats                                   â”‚    â”‚
â”‚  â”‚ - agency-analytics                               â”‚    â”‚
â”‚  â”‚ - get-tracking-stats                             â”‚    â”‚
â”‚  â”‚ - agency-billing-stats                           â”‚    â”‚
â”‚  â”‚ - agency-referral-users                          â”‚    â”‚
â”‚  â”‚                                                  â”‚    â”‚
â”‚  â”‚ ã€ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ»æ±ºæ¸ˆã€‘(3å€‹)                        â”‚    â”‚
â”‚  â”‚ - agency-commission                              â”‚    â”‚
â”‚  â”‚ - agency-commissions                             â”‚    â”‚
â”‚  â”‚ - stripe-webhook                                 â”‚    â”‚
â”‚  â”‚                                                  â”‚    â”‚
â”‚  â”‚ ã€ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã€‘(4å€‹)                              â”‚    â”‚
â”‚  â”‚ - track-visit                                    â”‚    â”‚
â”‚  â”‚ - track-session                                  â”‚    â”‚
â”‚  â”‚ - track-redirect                                 â”‚    â”‚
â”‚  â”‚ - line-webhook                                   â”‚    â”‚
â”‚  â”‚                                                  â”‚    â”‚
â”‚  â”‚ ã€ç®¡ç†ãƒ»ãã®ä»–ã€‘(4å€‹)                              â”‚    â”‚
â”‚  â”‚ - admin-agencies                                 â”‚    â”‚
â”‚  â”‚ - get-master-agency                              â”‚    â”‚
â”‚  â”‚ - test-connection                                â”‚    â”‚
â”‚  â”‚ - test-env                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“                        â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Supabase   â”‚          â”‚ Render       â”‚
       â”‚ PostgreSQL â”‚          â”‚ (Next.js)    â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ SendGrid   â”‚
       â”‚ (ãƒ¡ãƒ¼ãƒ«)    â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Stripe     â”‚
       â”‚ (æ±ºæ¸ˆ)      â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|------|-----------|------|
| **Netlify Functions** | - | ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹é–¢æ•° (AWS Lambda ãƒ™ãƒ¼ã‚¹) |
| **Node.js** | 18.x | ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  |
| **@supabase/supabase-js** | 2.x | PostgreSQL ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |
| **jsonwebtoken** | 9.x | JWT èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ»æ¤œè¨¼ |
| **bcryptjs** | 2.x | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ– |
| **@sendgrid/mail** | 8.x | ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆï¼‰ |
| **stripe** | 14.x | æ±ºæ¸ˆ Webhook å‡¦ç† |
| **@line/bot-sdk** | 8.x | LINE API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |
| **Alpine.js** | 3.x | ç®¡ç†ç”»é¢ã® UI ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ |
| **Chart.js** | 4.x | ç®¡ç†ç”»é¢ã®ã‚°ãƒ©ãƒ•è¡¨ç¤º |

**ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼:** npm

---

## 3. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
netlify-tracking/
â”œâ”€â”€ netlify/
â”‚   â””â”€â”€ functions/
â”‚       â”œâ”€â”€ ã€èªè¨¼ãƒ»ç™»éŒ²ã€‘(11å€‹)
â”‚       â”œâ”€â”€ agency-auth.js                      # JWTèªè¨¼ï¼ˆCookie-basedï¼‰
â”‚       â”œâ”€â”€ agency-register.js                  # ä»£ç†åº—ç™»éŒ²
â”‚       â”œâ”€â”€ agency-complete-registration.js     # LINE Loginå®Œäº†
â”‚       â”œâ”€â”€ password-reset-request.js           # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚
â”‚       â”œâ”€â”€ password-reset-confirm.js           # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç¢ºèª
â”‚       â”œâ”€â”€ agency-logout.js                    # ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
â”‚       â”œâ”€â”€ validate-admin.js                   # ç®¡ç†è€…æ¤œè¨¼
â”‚       â”‚
â”‚       â”œâ”€â”€ ã€ä»£ç†åº—ç®¡ç†ã€‘(9å€‹)
â”‚       â”œâ”€â”€ agency-links.js                     # ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ä¸€è¦§
â”‚       â”œâ”€â”€ agency-create-link.js               # ãƒªãƒ³ã‚¯ä½œæˆ
â”‚       â”œâ”€â”€ agency-toggle-link.js               # ãƒªãƒ³ã‚¯æœ‰åŠ¹/ç„¡åŠ¹åˆ‡æ›¿
â”‚       â”œâ”€â”€ agency-delete-link.js               # ãƒªãƒ³ã‚¯å‰Šé™¤
â”‚       â”œâ”€â”€ agency-link-visits.js               # ãƒªãƒ³ã‚¯è¨ªå•çµ±è¨ˆ
â”‚       â”œâ”€â”€ agency-get-line-url.js              # LINEå‹é”è¿½åŠ URLå–å¾—
â”‚       â”œâ”€â”€ agency-settings.js                  # ä»£ç†åº—è¨­å®š
â”‚       â”œâ”€â”€ agency-change-password.js           # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
â”‚       â”œâ”€â”€ create-tracking-link.js             # ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ä½œæˆ
â”‚       â”‚
â”‚       â”œâ”€â”€ ã€çµ±è¨ˆãƒ»åˆ†æã€‘(5å€‹)
â”‚       â”œâ”€â”€ agency-stats.js                     # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆ
â”‚       â”œâ”€â”€ agency-analytics.js                 # è©³ç´°åˆ†æ
â”‚       â”œâ”€â”€ get-tracking-stats.js               # ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°çµ±è¨ˆ
â”‚       â”œâ”€â”€ agency-billing-stats.js             # è«‹æ±‚çµ±è¨ˆ
â”‚       â”œâ”€â”€ agency-referral-users.js            # ç´¹ä»‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
â”‚       â”‚
â”‚       â”œâ”€â”€ ã€ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ»æ±ºæ¸ˆã€‘(3å€‹)
â”‚       â”œâ”€â”€ agency-commission.js                # ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—
â”‚       â”œâ”€â”€ agency-commissions.js               # ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
â”‚       â”œâ”€â”€ stripe-webhook.js                   # Stripe Webhookå‡¦ç†
â”‚       â”‚
â”‚       â”œâ”€â”€ ã€ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã€‘(4å€‹)
â”‚       â”œâ”€â”€ track-visit.js                      # è¨ªå•è¨˜éŒ²ä½œæˆ
â”‚       â”œâ”€â”€ track-session.js                    # ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²
â”‚       â”œâ”€â”€ track-redirect.js                   # ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨˜éŒ²
â”‚       â”œâ”€â”€ line-webhook.js                     # LINE Webhookè»¢é€
â”‚       â”‚
â”‚       â”œâ”€â”€ ã€ç®¡ç†ãƒ»ãã®ä»–ã€‘(4å€‹)
â”‚       â”œâ”€â”€ admin-agencies.js                   # ç®¡ç†è€…ï¼šä»£ç†åº—ç®¡ç†
â”‚       â”œâ”€â”€ get-master-agency.js                # ãƒã‚¹ã‚¿ãƒ¼ä»£ç†åº—å–å¾—
â”‚       â”œâ”€â”€ test-connection.js                  # æ¥ç¶šãƒ†ã‚¹ãƒˆ
â”‚       â”œâ”€â”€ test-env.js                         # ç’°å¢ƒå¤‰æ•°ãƒ†ã‚¹ãƒˆ
â”‚       â”‚
â”‚       â””â”€â”€ utils/                              # å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆ6å€‹ï¼‰
â”‚           â”œâ”€â”€ csrf-protection.js             # CSRFä¿è­·
â”‚           â”œâ”€â”€ rate-limiter.js                # ãƒ¬ãƒ¼ãƒˆåˆ¶é™
â”‚           â”œâ”€â”€ auth-helper.js                 # èªè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼
â”‚           â”œâ”€â”€ logger.js                      # ãƒ­ã‚¬ãƒ¼
â”‚           â”œâ”€â”€ referral-commission.js         # ç´¹ä»‹ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—
â”‚           â””â”€â”€ line-client.js                 # LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚
â”œâ”€â”€ admin/
â”‚   â”œâ”€â”€ index.html                             # ç®¡ç†ç”»é¢ãƒ¡ã‚¤ãƒ³
â”‚   â”œâ”€â”€ dashboard.js                           # ç®¡ç†ç”»é¢ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”œâ”€â”€ login.html                             # ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
â”‚   â””â”€â”€ styles.css                             # ã‚¹ã‚¿ã‚¤ãƒ«
â”‚
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ index.html                             # ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ tracking.js                            # ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â””â”€â”€ styles.css                             # ã‚¹ã‚¿ã‚¤ãƒ«
â”‚
â”œâ”€â”€ netlify.toml                               # Netlify è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ package.json
â””â”€â”€ NETLIFY_ARCHITECTURE.md                    # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

---

## 4. å…¨38ãƒ•ã‚¡ã‚¤ãƒ«å®Œå…¨ãƒªã‚¹ãƒˆï¼ˆFunctions 32å€‹ + Utilities 6å€‹ï¼‰

### 4.1 èªè¨¼ãƒ»ç™»éŒ²ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ11å€‹ï¼‰

| Function | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | å½¹å‰² |
|----------|--------------|---------|------|
| `agency-auth.js` | `/.netlify/functions/agency-auth` | POST | JWTèªè¨¼ï¼ˆCookie-basedï¼‰ã€CSRFä¿è­·ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€å¤šæ®µéšã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ |
| `agency-register.js` | `/.netlify/functions/agency-register` | POST | ä»£ç†åº—ç™»éŒ²ã€4éšå±¤æ¤œè¨¼ã€æ‹›å¾…ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ã€LINEé€£æºãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ |
| `agency-complete-registration.js` | `/.netlify/functions/agency-complete-registration` | POST | LINE Loginå®Œäº†ã€OAuth 2.0ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›ã€å‹é”è¿½åŠ å¾…ã¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| `password-reset-request.js` | `/.netlify/functions/password-reset-request` | POST | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚ã€SendGridãƒ¡ãƒ¼ãƒ«é€ä¿¡ã€ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆ1æ™‚é–“æœ‰åŠ¹ï¼‰ |
| `password-reset-confirm.js` | `/.netlify/functions/password-reset-confirm` | POST | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç¢ºèªã€ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã€bcryptãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ– |
| `agency-logout.js` | `/.netlify/functions/agency-logout` | POST | ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€Cookieå‰Šé™¤ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ– |
| `validate-admin.js` | `/.netlify/functions/validate-admin` | POST | ç®¡ç†è€…æ¨©é™æ¤œè¨¼ã€role='admin'ãƒã‚§ãƒƒã‚¯ |
| *(æ®‹ã‚Š4ã¤ã¯æ—§ç‰ˆã«ã‚ã‚‹ãŒè©³ç´°æœªç¢ºèª)* | - | - | - |

---

### 4.2 ä»£ç†åº—ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ9å€‹ï¼‰

| Function | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | å½¹å‰² |
|----------|--------------|---------|------|
| `agency-links.js` | `/.netlify/functions/agency-links` | GET | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ä¸€è¦§å–å¾—ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰ |
| `agency-create-link.js` | `/.netlify/functions/agency-create-link` | POST | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ä½œæˆã€QRã‚³ãƒ¼ãƒ‰è‡ªå‹•ç”Ÿæˆã€UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š |
| `agency-toggle-link.js` | `/.netlify/functions/agency-toggle-link` | POST | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ‡æ›¿ |
| `agency-delete-link.js` | `/.netlify/functions/agency-delete-link` | DELETE | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯å‰Šé™¤ï¼ˆã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆå¯¾å¿œï¼‰ |
| `agency-link-visits.js` | `/.netlify/functions/agency-link-visits` | GET | ç‰¹å®šãƒªãƒ³ã‚¯ã®è¨ªå•çµ±è¨ˆå–å¾—ã€ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡è¨ˆç®— |
| `agency-get-line-url.js` | `/.netlify/functions/agency-get-line-url` | GET | LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‹é”è¿½åŠ URLå–å¾— |
| `agency-settings.js` | `/.netlify/functions/agency-settings` | GET/POST | ä»£ç†åº—è¨­å®šã®å–å¾—ãƒ»æ›´æ–° |
| `agency-change-password.js` | `/.netlify/functions/agency-change-password` | POST | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ï¼ˆç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼å¿…é ˆï¼‰ |
| `create-tracking-link.js` | `/.netlify/functions/create-tracking-link` | POST | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ä½œæˆï¼ˆåˆ¥å®Ÿè£…ï¼‰ |

---

### 4.3 çµ±è¨ˆãƒ»åˆ†æã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ5å€‹ï¼‰

| Function | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | å½¹å‰² |
|----------|--------------|---------|------|
| `agency-stats.js` | `/.netlify/functions/agency-stats` | GET | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆï¼ˆç·ãƒªãƒ³ã‚¯æ•°ã€ç·ã‚¯ãƒªãƒƒã‚¯æ•°ã€ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ã€æœˆæ¬¡ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼‰ |
| `agency-analytics.js` | `/.netlify/functions/agency-analytics` | GET | è©³ç´°åˆ†æãƒ‡ãƒ¼ã‚¿ï¼ˆæ™‚ç³»åˆ—ã€ãƒ‡ãƒã‚¤ã‚¹åˆ¥ã€OSåˆ¥ã€ãƒ–ãƒ©ã‚¦ã‚¶åˆ¥ï¼‰ |
| `get-tracking-stats.js` | `/.netlify/functions/get-tracking-stats` | GET | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°çµ±è¨ˆï¼ˆå‹é”ã‚¿ã‚¤ãƒ—åˆ¤å®šã€è¨ªå•å±¥æ­´100ä»¶ï¼‰ |
| `agency-billing-stats.js` | `/.netlify/functions/agency-billing-stats` | GET | è«‹æ±‚çµ±è¨ˆï¼ˆæœŸé–“åˆ¥å£²ä¸Šã€ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³é›†è¨ˆï¼‰ |
| `agency-referral-users.js` | `/.netlify/functions/agency-referral-users` | GET | ç´¹ä»‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ï¼ˆä¸‹ä½ä»£ç†åº—ãƒªã‚¹ãƒˆï¼‰ |

---

### 4.4 ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ»æ±ºæ¸ˆã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ3å€‹ï¼‰

| Function | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | å½¹å‰² |
|----------|--------------|---------|------|
| `agency-commission.js` | `/.netlify/functions/agency-commission` | GET/POST | ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—ï¼ˆSupabase RPCå‘¼ã³å‡ºã—ï¼‰ã€ãƒ•ã‚¡ãƒãƒ«åˆ†æï¼ˆè¨ªå•â†’å‹é”â†’æ±ºæ¸ˆï¼‰ |
| `agency-commissions.js` | `/.netlify/functions/agency-commissions` | GET | ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³å±¥æ­´å–å¾—ï¼ˆæ‰¿èªå¾…ã¡ã€æ‰¿èªæ¸ˆã¿ã€æ”¯æ‰•æ¸ˆã¿ï¼‰ |
| `stripe-webhook.js` | `/.netlify/functions/stripe-webhook` | POST | Stripe Webhookå‡¦ç†ï¼ˆpayment_intent.succeededã€checkout.session.completedã€invoice.payment_succeededï¼‰ |

---

### 4.5 ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ4å€‹ï¼‰

| Function | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | å½¹å‰² |
|----------|--------------|---------|------|
| `track-visit.js` | `/.netlify/functions/track-visit` | POST | è¨ªå•è¨˜éŒ²ä½œæˆã€ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±è§£æï¼ˆOSã€ãƒ–ãƒ©ã‚¦ã‚¶ã€ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—ï¼‰ã€é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆ5åˆ†ä»¥å†…ï¼‰ |
| `track-session.js` | `/.netlify/functions/track-session` | POST | ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²ã€Cookie-based session ID |
| `track-redirect.js` | `/.netlify/functions/track-redirect` | GET | ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨˜éŒ²ã€è¨ªå•ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–° |
| `line-webhook.js` | `/.netlify/functions/line-webhook` | POST | LINE Webhookè»¢é€ã€Profileä¿å­˜ï¼ˆUPSERTï¼‰ã€è¨ªå•è¨˜éŒ²ç´ä»˜ã‘ |

---

### 4.6 ç®¡ç†ãƒ»ãã®ä»–ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ4å€‹ï¼‰

| Function | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | å½¹å‰² |
|----------|--------------|---------|------|
| `admin-agencies.js` | `/.netlify/functions/admin-agencies` | GET/POST/PUT | ç®¡ç†è€…ï¼šä»£ç†åº—ä¸€è¦§ãƒ»ä½œæˆãƒ»æ›´æ–° |
| `get-master-agency.js` | `/.netlify/functions/get-master-agency` | GET | ãƒã‚¹ã‚¿ãƒ¼ä»£ç†åº—æƒ…å ±å–å¾—ï¼ˆis_master=trueï¼‰ |
| `test-connection.js` | `/.netlify/functions/test-connection` | GET | Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆ |
| `test-env.js` | `/.netlify/functions/test-env` | GET | ç’°å¢ƒå¤‰æ•°ãƒ†ã‚¹ãƒˆï¼ˆç§˜å¯†æƒ…å ±ã¯ãƒã‚¹ã‚¯ï¼‰ |

---

### 4.7 Utilityé–¢æ•°ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ6å€‹ï¼‰

| Utility | ãƒ‘ã‚¹ | å½¹å‰² |
|---------|------|------|
| `auth-helper.js` | `/netlify/functions/utils/auth-helper.js` | Cookie/Header-basedèªè¨¼ã€JWTæ¤œè¨¼ã€èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ |
| `csrf-protection.js` | `/netlify/functions/utils/csrf-protection.js` | Origin/Refereræ¤œè¨¼ã€Netlifyãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾å¿œã€CSRFä¿è­· |
| `rate-limiter.js` | `/netlify/functions/utils/rate-limiter.js` | 3æ®µéšãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆSTRICT/NORMAL/RELAXEDï¼‰ã€IPãƒ™ãƒ¼ã‚¹åˆ¶é™ |
| `logger.js` | `/netlify/functions/utils/logger.js` | æ§‹é€ åŒ–ãƒ­ã‚°å‡ºåŠ›ã€ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ç®¡ç†ã€æœ¬ç•ªç’°å¢ƒå¯¾å¿œ |
| `referral-commission.js` | `/netlify/functions/utils/referral-commission.js` | ç´¹ä»‹ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—ã€4éšå±¤å ±é…¬åˆ†é…ãƒ­ã‚¸ãƒƒã‚¯ |
| `line-client.js` | `/netlify/functions/utils/line-client.js` | LINE API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ |

**æ³¨æ„:** ã“ã‚Œã‚‰ã®Utilityé–¢æ•°ã¯ç›´æ¥HTTPã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦å…¬é–‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€å…¨Functionsã‹ã‚‰å…±é€šåˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

---

## 5. ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ 

### 5.1 CSRFä¿è­·ï¼ˆutils/csrf-protection.jsï¼‰

#### æ©Ÿèƒ½æ¦‚è¦
- **Origin/Refererãƒ˜ãƒƒãƒ€ãƒ¼æ¤œè¨¼**
- **ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼æ¤œè¨¼**ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- **Netlifyãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒå¯¾å¿œ**

#### è¨±å¯ã•ã‚ŒãŸã‚ªãƒªã‚¸ãƒ³
```javascript
const allowedOrigins = [
    process.env.SITE_URL,
    process.env.URL,
    'http://localhost:8888',
    'http://localhost:3000',
    'http://127.0.0.1:8888',
    'http://127.0.0.1:3000',
    '*.netlify.app'  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ
];
```

#### ä½¿ç”¨ä¾‹
```javascript
const csrfValidation = validateCsrfProtection(event);
if (!csrfValidation.valid) {
    return createCsrfErrorResponse(csrfValidation.error);
}
```

#### ã‚»ã‚­ãƒ¥ã‚¢Cookieã‚ªãƒ—ã‚·ãƒ§ãƒ³
```javascript
const cookieOptions = [
    'HttpOnly',           // JavaScriptã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
    'SameSite=Strict',    // CSRFæ”»æ’ƒé˜²æ­¢
    'Path=/',
    'Max-Age=604800',     // 7æ—¥é–“
    'Secure'              // HTTPSå¿…é ˆï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
];
```

---

### 5.2 ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆutils/rate-limiter.jsï¼‰

#### 3ã¤ã®ãƒ—ãƒªã‚»ãƒƒãƒˆ

| ãƒ—ãƒªã‚»ãƒƒãƒˆ | æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•° | æ™‚é–“æ  | ç”¨é€” |
|-----------|----------------|--------|------|
| **STRICT_RATE_LIMIT** | 5å› | 15åˆ† | ãƒ­ã‚°ã‚¤ãƒ³ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã€ç™»éŒ² |
| **NORMAL_RATE_LIMIT** | 60å› | 1åˆ† | é€šå¸¸ã®APIå‘¼ã³å‡ºã— |
| **RELAXED_RATE_LIMIT** | 100å› | 1åˆ† | å…¬é–‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |

#### ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¹ãƒˆã‚¢
```javascript
// ãƒ¡ãƒ¢ãƒªãƒ™ãƒ¼ã‚¹ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¹ãƒˆã‚¢
// Key: `${ip}:${endpoint}`
// Value: { count, resetTime, firstRequest }
const rateLimitStore = new Map();
```

**æ³¨æ„:** Netlify Functionsã¯ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã®ãŸã‚ã€å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒç•°ãªã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚ˆã‚Šå …ç‰¢ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«ã¯ **Upstash Redis** ç­‰ã®å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

#### ä½¿ç”¨ä¾‹
```javascript
const rateLimitResponse = applyRateLimit(event, STRICT_RATE_LIMIT);
if (rateLimitResponse) {
    return rateLimitResponse;  // 429 Too Many Requests
}
```

#### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹
```json
{
  "error": "ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’è¶…éã—ã¾ã—ãŸ",
  "message": "895ç§’å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„",
  "retryAfter": 895
}
```

**HTTPãƒ˜ãƒƒãƒ€ãƒ¼:**
```
429 Too Many Requests
Retry-After: 895
X-RateLimit-Limit: 5
X-RateLimit-Remaining: 0
```

---

### 5.3 èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ï¼ˆutils/auth-helper.jsï¼‰

#### Cookie-basedèªè¨¼ï¼ˆæ¨å¥¨ï¼‰
```javascript
// ãƒ­ã‚°ã‚¤ãƒ³æ™‚
Set-Cookie: agencyAuthToken=<JWT>; HttpOnly; Secure; SameSite=Strict; Max-Age=604800; Path=/
Set-Cookie: agencyId=<UUID>; Secure; SameSite=Strict; Max-Age=604800; Path=/
```

**ç‰¹å¾´:**
- `agencyAuthToken`: HttpOnlyï¼ˆXSSæ”»æ’ƒé˜²æ­¢ï¼‰
- `agencyId`: JavaScriptã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ï¼‰

#### Header-basedèªè¨¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
```javascript
// ä¸‹ä½äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã•ã‚Œã¦ã„ã‚‹
Authorization: Bearer <JWT>
X-Agency-Id: <UUID>
```

#### èªè¨¼ãƒ•ãƒ­ãƒ¼
```javascript
const auth = authenticateRequest(event);

if (!auth.authenticated) {
    return createAuthErrorResponse(auth.error);  // 401 Unauthorized
}

// auth.user = { userId, agencyId, email, role }
// auth.agencyId = UUID
```

#### JWT Payload
```javascript
{
  "userId": "00000000-0000-0000-0000-000000000001",
  "agencyId": "00000000-0000-0000-0000-000000000002",
  "email": "owner@example.com",
  "role": "owner",
  "iat": 1729699200,
  "exp": 1730304000  // 7æ—¥é–“æœ‰åŠ¹
}
```

---

### 5.4 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼

**å…¨Functionsã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼:**
```javascript
{
  'Access-Control-Allow-Origin': '*',  // CORSï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
  'X-Content-Type-Options': 'nosniff',  // MIMEã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°é˜²æ­¢
  'X-Frame-Options': 'DENY',  // ã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°é˜²æ­¢
  'Strict-Transport-Security': 'max-age=31536000; includeSubDomains'  // HSTS
}
```

---

## 6. ğŸ¢ 4æ®µéšä»£ç†åº—åˆ¶åº¦

### 6.1 éšå±¤æ§‹é€ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 1: Master Agency (ãƒã‚¹ã‚¿ãƒ¼ä»£ç†åº—)              â”‚
â”‚  å ±é…¬ç‡: 20.00%                                       â”‚
â”‚  is_master: true                                     â”‚
â”‚  parent_agency_id: null                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ æ‹›å¾…ã‚³ãƒ¼ãƒ‰ç™ºè¡Œ
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 2: Sub Agency (ã‚µãƒ–ä»£ç†åº—)                     â”‚
â”‚  å ±é…¬ç‡: 18.00%                                       â”‚
â”‚  parent_agency_id: <Level 1ã®ID>                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ æ‹›å¾…ã‚³ãƒ¼ãƒ‰ç™ºè¡Œ
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 3: Sub-Sub Agency (ã‚µãƒ–ã‚µãƒ–ä»£ç†åº—)             â”‚
â”‚  å ±é…¬ç‡: 16.00%                                       â”‚
â”‚  parent_agency_id: <Level 2ã®ID>                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ æ‹›å¾…ã‚³ãƒ¼ãƒ‰ç™ºè¡Œ
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 4: End Agency (ã‚¨ãƒ³ãƒ‰ä»£ç†åº—)                   â”‚
â”‚  å ±é…¬ç‡: 14.00%                                       â”‚
â”‚  parent_agency_id: <Level 3ã®ID>                     â”‚
â”‚  ã“ã‚Œä»¥ä¸Šã®ä¸‹ä½ä»£ç†åº—ã¯ç™»éŒ²ä¸å¯                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 6.2 å ±é…¬ç‡ã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯

#### agency-register.js (Line 210-213)
```javascript
// è¦ªä»£ç†åº—ã®ãƒ¬ãƒ™ãƒ«ã‹ã‚‰æ–°è¦ä»£ç†åº—ã®ãƒ¬ãƒ™ãƒ«ã‚’æ±ºå®š
const newAgencyLevel = parentAgency.level + 1;

// æ¨™æº–å ±é…¬ç‡ãƒãƒƒãƒ”ãƒ³ã‚°
const standardRates = {
    1: 20.00,  // Level 1: Master Agency
    2: 18.00,  // Level 2: Sub Agency
    3: 16.00,  // Level 3: Sub-Sub Agency
    4: 14.00   // Level 4: End Agency
};

const newCommissionRate = standardRates[newAgencyLevel] || 20.00;
```

#### æœ€å¤§éšå±¤åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆLine 198-209ï¼‰
```javascript
// æœ€å¤§4éšå±¤ã¾ã§ãƒã‚§ãƒƒã‚¯
if (parentAgency.level >= 4) {
    return {
        statusCode: 400,
        body: JSON.stringify({
            error: 'ã“ã‚Œä»¥ä¸Šä¸‹ä½ã®ä»£ç†åº—ã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼ˆæœ€å¤§4éšå±¤ã¾ã§ï¼‰ã€‚'
        })
    };
}
```

---

### 6.3 æ‹›å¾…ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ãƒ•ãƒ­ãƒ¼

```javascript
// STEP 1: æ‹›å¾…ã‚³ãƒ¼ãƒ‰ï¼ˆè¦ªä»£ç†åº—ã‚³ãƒ¼ãƒ‰ï¼‰æ¤œè¨¼
const { data: parentAgency, error: parentError } = await supabase
    .from('agencies')
    .select('id, code, name, level, own_commission_rate, status')
    .eq('code', invitation_code)
    .single();

if (parentError || !parentAgency) {
    return { error: 'ä»£ç†åº—ã‚³ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã§ã™ã€‚' };
}

// STEP 2: è¦ªä»£ç†åº—ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‹ç¢ºèª
if (parentAgency.status !== 'active') {
    return { error: 'ã“ã®ä»£ç†åº—ã‚³ãƒ¼ãƒ‰ã¯ç¾åœ¨ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚' };
}

// STEP 3: æœ€å¤§éšå±¤ãƒã‚§ãƒƒã‚¯
if (parentAgency.level >= 4) {
    return { error: 'æœ€å¤§éšå±¤ã«é”ã—ã¦ã„ã¾ã™ï¼ˆæœ€å¤§4éšå±¤ã¾ã§ï¼‰ã€‚' };
}

// STEP 4: æ–°è¦ä»£ç†åº—ã®éšå±¤ã¨ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ç‡ã‚’è¨ˆç®—
const newAgencyLevel = parentAgency.level + 1;
const newCommissionRate = standardRates[newAgencyLevel];

// STEP 5: ä»£ç†åº—ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
const { data: agency } = await supabase
    .from('agencies')
    .insert({
        code: generateAgencyCode(),
        parent_agency_id: parentAgency.id,
        level: newAgencyLevel,
        own_commission_rate: newCommissionRate,
        status: 'pending_line_verification'
    })
    .select()
    .single();
```

---

### 6.4 ä»£ç†åº—ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

#### generateAgencyCode() (agency-register.js Line 18-23)
```javascript
function generateAgencyCode() {
    const prefix = 'AG';
    const timestamp = Date.now().toString(36).toUpperCase();
    const random = Math.random().toString(36).substr(2, 4).toUpperCase();
    return `${prefix}${timestamp}${random}`;
}

// ç”Ÿæˆä¾‹: AGLOV8X3L2A9F
//         ^^^^^^^^^^----
//         |         â””â”€ ãƒ©ãƒ³ãƒ€ãƒ 4æ–‡å­—
//         â””â”€ ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆBase36ï¼‰
```

#### ãƒ¦ãƒ‹ãƒ¼ã‚¯æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆLine 273-300ï¼‰
```javascript
let agencyCode = generateAgencyCode();
let codeIsUnique = false;
let attempts = 0;

while (!codeIsUnique && attempts < 5) {
    const { data: existingAgency } = await supabase
        .from('agencies')
        .select('id')
        .eq('code', agencyCode)
        .single();

    if (!existingAgency) {
        codeIsUnique = true;
    } else {
        agencyCode = generateAgencyCode();
        attempts++;
    }
}

if (!codeIsUnique) {
    throw new Error('Failed to generate unique agency code');
}
```

---

## 7. ğŸ“ ä»£ç†åº—ç™»éŒ²ãƒ•ãƒ­ãƒ¼

### 7.1 å®Œå…¨ãªç™»éŒ²ãƒ•ãƒ­ãƒ¼å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: ä»®ç™»éŒ²ï¼ˆagency-register.jsï¼‰                         â”‚
â”‚                                                              â”‚
â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›:                                                 â”‚
â”‚ - ä¼šç¤¾åã€ä»£ç†åº—åã€ä½æ‰€ã€æ‹…å½“è€…å                              â”‚
â”‚ - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€é›»è©±ç•ªå·ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰                          â”‚
â”‚ - æ‹›å¾…ã‚³ãƒ¼ãƒ‰ï¼ˆè¦ªä»£ç†åº—ã‚³ãƒ¼ãƒ‰ï¼‰                                 â”‚
â”‚                                                              â”‚
â”‚ å‡¦ç†:                                                        â”‚
â”‚ 1. æ‹›å¾…ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ï¼ˆè¦ªä»£ç†åº—ã®ãƒ¬ãƒ™ãƒ« < 4ï¼‰                      â”‚
â”‚ 2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ»é›»è©±ç•ªå·ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯                       â”‚
â”‚ 3. ä»£ç†åº—ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆAGXXXXXXXXXï¼‰                            â”‚
â”‚ 4. ç™»éŒ²ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆ32ãƒã‚¤ãƒˆãƒ©ãƒ³ãƒ€ãƒ ã€15åˆ†æœ‰åŠ¹ï¼‰              â”‚
â”‚ 5. ä»£ç†åº—ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆï¼ˆstatus: pending_line_verificationï¼‰   â”‚
â”‚ 6. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆï¼ˆis_active: falseï¼‰                   â”‚
â”‚                                                              â”‚
â”‚ ãƒ¬ã‚¹ãƒãƒ³ã‚¹:                                                  â”‚
â”‚ - agency_code: AGXXXXXXXXX                                  â”‚
â”‚ - registration_token: xxxxx...                               â”‚
â”‚ - requires_line_verification: true                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: LINE Loginï¼ˆagency-complete-registration.jsï¼‰        â”‚
â”‚                                                              â”‚
â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ:                                                 â”‚
â”‚ - LINE Loginãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯                                  â”‚
â”‚ - LINEã‚¢ãƒ—ãƒªã§èªè¨¼                                            â”‚
â”‚ - Callback URL: https://taskmateai.net/agency/              â”‚
â”‚   ?code=xxxxx&state=xxxxx                                   â”‚
â”‚                                                              â”‚
â”‚ å‡¦ç†:                                                        â”‚
â”‚ 1. ç™»éŒ²ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼ˆ15åˆ†ä»¥å†…ã‹ç¢ºèªï¼‰                          â”‚
â”‚ 2. LINEã‚³ãƒ¼ãƒ‰â†’ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›ï¼ˆOAuth 2.0ï¼‰               â”‚
â”‚ 3. LINE APIå‘¼ã³å‡ºã—: GET https://api.line.me/v2/profile     â”‚
â”‚ 4. LINE User IDã®é‡è¤‡ãƒã‚§ãƒƒã‚¯                                â”‚
â”‚ 5. ä»£ç†åº—ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°:                                        â”‚
â”‚    - line_user_id: Uxxxxxxx                                 â”‚
â”‚    - line_display_name: ã‚Šã‚…ã†                               â”‚
â”‚    - line_picture_url: https://...                           â”‚
â”‚    - status: pending_friend_add ï¼ˆå‹é”è¿½åŠ å¾…ã¡ï¼‰              â”‚
â”‚    - registration_token: null ï¼ˆä½¿ç”¨æ¸ˆã¿ï¼‰                    â”‚
â”‚                                                              â”‚
â”‚ ãƒ¬ã‚¹ãƒãƒ³ã‚¹:                                                  â”‚
â”‚ - requires_friend_add: true                                 â”‚
â”‚ - line_official_url: https://lin.ee/4NLfSqH                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: LINEå‹é”è¿½åŠ ï¼ˆline-webhook.jsï¼‰                       â”‚
â”‚                                                              â”‚
â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ:                                                 â”‚
â”‚ - LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€ŒTaskMate AIã€ã‚’å‹é”è¿½åŠ                   â”‚
â”‚                                                              â”‚
â”‚ LINE Webhook ã‚¤ãƒ™ãƒ³ãƒˆ:                                       â”‚
â”‚ {                                                            â”‚
â”‚   "type": "follow",                                          â”‚
â”‚   "source": { "userId": "Uxxxxxxx" }                         â”‚
â”‚ }                                                            â”‚
â”‚                                                              â”‚
â”‚ å‡¦ç†ï¼ˆhandleFollowEventï¼‰:                                    â”‚
â”‚ 1. LINE APIå‘¼ã³å‡ºã—: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—                  â”‚
â”‚ 2. line_profiles ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜                               â”‚
â”‚ 3. ä»£ç†åº—ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’LINE User IDã§æ¤œç´¢                          â”‚
â”‚ 4. statusæ›´æ–°: pending_friend_add â†’ active                  â”‚
â”‚ 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°: is_active: false â†’ true             â”‚
â”‚ 6. è¨ªå•è¨˜éŒ²ã¨ã®ç´ä»˜ã‘ï¼ˆlinkUserToTrackingï¼‰                   â”‚
â”‚                                                              â”‚
â”‚ å®Œäº†:                                                        â”‚
â”‚ - ä»£ç†åº—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: active                                    â”‚
â”‚ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: true                                    â”‚
â”‚ - ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã«ãªã‚‹                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 7.2 ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pending_line_verification â”‚ â† ä»®ç™»éŒ²å®Œäº†ï¼ˆSTEP 1ï¼‰
â”‚                          â”‚    - LINE Loginå¾…ã¡
â”‚                          â”‚    - registration_tokenæœ‰åŠ¹ï¼ˆ15åˆ†ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“ LINE Loginå®Œäº†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   pending_friend_add      â”‚ â† LINE Loginå®Œäº†ï¼ˆSTEP 2ï¼‰
â”‚                          â”‚    - å‹é”è¿½åŠ å¾…ã¡
â”‚                          â”‚    - line_user_idè¨˜éŒ²æ¸ˆã¿
â”‚                          â”‚    - is_active: false
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“ å‹é”è¿½åŠ å®Œäº†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         active            â”‚ â† ç™»éŒ²å®Œäº†ï¼ˆSTEP 3ï¼‰
â”‚                          â”‚    - ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½
â”‚                          â”‚    - is_active: true
â”‚                          â”‚    - å…¨æ©Ÿèƒ½ä½¿ç”¨å¯èƒ½
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        pending            â”‚ â† ç®¡ç†è€…æ‰¿èªå¾…ã¡
â”‚                          â”‚    ï¼ˆæ‰‹å‹•æ‰¿èªãŒå¿…è¦ãªå ´åˆï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        rejected           â”‚ â† ç”³è«‹å´ä¸‹
â”‚                          â”‚    ï¼ˆå¯©æŸ»ã§ä¸æ‰¿èªï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       suspended           â”‚ â† ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåœæ­¢
â”‚                          â”‚    ï¼ˆè¦ç´„é•åç­‰ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 7.3 ç™»éŒ²ãƒˆãƒ¼ã‚¯ãƒ³ã®ä»•çµ„ã¿

#### ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆagency-register.js Line 309-313ï¼‰
```javascript
function generateRegistrationToken() {
    const crypto = require('crypto');
    return crypto.randomBytes(32).toString('hex');
    // 64æ–‡å­—ã®16é€²æ•°æ–‡å­—åˆ—
    // ä¾‹: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6..."
}

const registrationToken = generateRegistrationToken();
const tokenExpiresAt = new Date(Date.now() + 15 * 60 * 1000); // 15åˆ†å¾Œ

await supabase
    .from('agencies')
    .insert({
        registration_token: registrationToken,
        registration_token_expires_at: tokenExpiresAt.toISOString()
    });
```

#### ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼ˆagency-complete-registration.js Line 195-250ï¼‰
```javascript
// STEP 1: ãƒˆãƒ¼ã‚¯ãƒ³ã§ä»£ç†åº—æ¤œç´¢
const { data: agency } = await supabase
    .from('agencies')
    .select('id, code, name, status, registration_token, line_user_id, registration_token_expires_at')
    .eq('registration_token', registration_token)
    .eq('status', 'pending_line_verification')
    .single();

if (!agency) {
    return { error: 'ç™»éŒ²ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™ã€‚' };
}

// STEP 2: æ—¢ã«LINEé€£æºæ¸ˆã¿ã‹ç¢ºèªï¼ˆCode Replayæ”»æ’ƒé˜²æ­¢ï¼‰
if (agency.line_user_id) {
    return { error: 'ã“ã®ä»£ç†åº—ã¯æ—¢ã«LINEé€£æºæ¸ˆã¿ã§ã™' };
}

// STEP 3: ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
if (agency.registration_token_expires_at) {
    const expiresAt = new Date(agency.registration_token_expires_at);
    const now = new Date();
    if (expiresAt < now) {
        return {
            error: 'ç™»éŒ²ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚æœ€åˆã‹ã‚‰ç™»éŒ²ã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚'
        };
    }
}
```

---

## 8. ğŸ” èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 

### 8.1 ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ï¼ˆagency-auth.jsï¼‰

#### å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—

```javascript
// STEP 1: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒå¯¾ç­–ï¼‰
const rateLimitResponse = applyRateLimit(event, STRICT_RATE_LIMIT);
// â†’ 5å›/15åˆ†ã¾ã§

// STEP 2: CSRFä¿è­·ãƒã‚§ãƒƒã‚¯
const csrfValidation = validateCsrfProtection(event);
// â†’ Origin/Refererãƒ˜ãƒƒãƒ€ãƒ¼æ¤œè¨¼

// STEP 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
const { data: user } = await supabase
    .from('agency_users')
    .select(`
        id, email, password_hash, name, role, is_active, agency_id,
        agencies!inner (
            id, code, name, company_name, contact_email, contact_phone,
            status, level, own_commission_rate, parent_agency_id
        )
    `)
    .eq('email', email)
    .single();

// STEP 4: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼ï¼ˆbcryptï¼‰
const validPassword = await bcrypt.compare(password, user.password_hash);

// STEP 5: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
if (!user.is_active) {
    return {
        error: 'ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™',
        error_type: 'user_inactive',
        actions: [
            { type: 'contact_support', url: 'https://ikemen.ltd/contact/' }
        ]
    };
}

// STEP 6: ä»£ç†åº—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
if (user.agencies.status !== 'active') {
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸè©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
    switch (user.agencies.status) {
        case 'pending':
            return { error_type: 'agency_pending_approval', ... };
        case 'pending_friend_add':
            return { error_type: 'agency_pending_friend_add', line_official_url: ... };
        case 'rejected':
            return { error_type: 'agency_rejected', ... };
        case 'suspended':
            return { error_type: 'agency_suspended', ... };
    }
}

// STEP 7: æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ™‚åˆ»æ›´æ–°
await supabase
    .from('agency_users')
    .update({ last_login_at: new Date().toISOString() })
    .eq('id', user.id);

// STEP 8: JWT ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆæœ‰åŠ¹æœŸé™7æ—¥é–“ï¼‰
const token = jwt.sign(
    {
        userId: user.id,
        agencyId: user.agency_id,
        email: user.email,
        role: user.role
    },
    process.env.JWT_SECRET,
    { expiresIn: '7d' }
);

// STEP 9: HttpOnly Cookieè¨­å®š
const setCookieHeaders = [
    `agencyAuthToken=${token}; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=604800`,
    `agencyId=${user.agency_id}; Secure; SameSite=Strict; Path=/; Max-Age=604800`
];

return {
    statusCode: 200,
    headers: {
        'Set-Cookie': setCookieHeaders.join(', ')
    },
    body: JSON.stringify({
        success: true,
        token,  // ä¸‹ä½äº’æ›æ€§ã®ãŸã‚
        user: { id, name, email, role },
        agency: {
            id, code, name, company_name,
            level, own_commission_rate, parent_agency_id
        }
    })
};
```

---

### 8.2 ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹

#### 1. pending_approvalï¼ˆæ‰¿èªå¾…ã¡ï¼‰
```json
{
  "error": "ä»£ç†åº—ç™»éŒ²ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„",
  "error_type": "agency_pending_approval",
  "agency_status": "pending",
  "message": "ä»£ç†åº—ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚é‹å–¶å´ã§æ‰¿èªå‡¦ç†ã‚’è¡Œã£ã¦ãŠã‚Šã¾ã™ã€‚æ‰¿èªå®Œäº†å¾Œã€ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚",
  "actions": [
    {
      "type": "info",
      "label": "æ‰¿èªå®Œäº†å¾Œã«ãƒ¡ãƒ¼ãƒ«ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™",
      "url": null
    },
    {
      "type": "contact_support",
      "label": "ãŠæ€¥ãã®å ´åˆã¯ã‚µãƒãƒ¼ãƒˆã¸",
      "url": "https://ikemen.ltd/contact/",
      "email": "info@ikemen.ltd"
    }
  ]
}
```

#### 2. pending_friend_addï¼ˆå‹é”è¿½åŠ å¾…ã¡ï¼‰
```json
{
  "error": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æœ‰åŠ¹åŒ–ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“",
  "error_type": "agency_pending_friend_add",
  "agency_status": "pending_friend_add",
  "message": "LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹é”è¿½åŠ ã—ã¦ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚",
  "actions": [
    {
      "type": "add_line_friend",
      "label": "LINEå‹é”è¿½åŠ ã—ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æœ‰åŠ¹åŒ–",
      "url": "https://lin.ee/4NLfSqH"
    },
    {
      "type": "contact_support",
      "label": "å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆã¯ã‚µãƒãƒ¼ãƒˆã¸",
      "url": "https://ikemen.ltd/contact/"
    }
  ]
}
```

#### 3. rejectedï¼ˆç”³è«‹å´ä¸‹ï¼‰
```json
{
  "error": "ä»£ç†åº—ç™»éŒ²ç”³è«‹ãŒå´ä¸‹ã•ã‚Œã¾ã—ãŸ",
  "error_type": "agency_rejected",
  "agency_status": "rejected",
  "message": "ä»£ç†åº—ç™»éŒ²ç”³è«‹ãŒå´ä¸‹ã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚",
  "actions": [
    {
      "type": "contact_support",
      "label": "ç®¡ç†è€…ã«å•ã„åˆã‚ã›ã‚‹",
      "url": "https://ikemen.ltd/contact/"
    }
  ]
}
```

#### 4. suspendedï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆåœæ­¢ï¼‰
```json
{
  "error": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒåœæ­¢ã•ã‚Œã¦ã„ã¾ã™",
  "error_type": "agency_suspended",
  "agency_status": "suspended",
  "message": "ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç®¡ç†è€…ã«ã‚ˆã‚Šåœæ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚",
  "actions": [
    {
      "type": "contact_support",
      "label": "ç®¡ç†è€…ã«å•ã„åˆã‚ã›ã‚‹",
      "url": "https://ikemen.ltd/contact/"
    }
  ]
}
```

---

## 9. ğŸ“§ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ•ãƒ­ãƒ¼

### 9.1 ãƒªã‚»ãƒƒãƒˆè¦æ±‚ï¼ˆpassword-reset-request.jsï¼‰

#### å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—

```javascript
// STEP 1: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆ5å›/15åˆ†ï¼‰
const rateLimitResponse = applyRateLimit(event, STRICT_RATE_LIMIT);

// STEP 2: CSRFä¿è­·ãƒã‚§ãƒƒã‚¯
const csrfValidation = validateCsrfProtection(event);

// STEP 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
const { data: user } = await supabase
    .from('agency_users')
    .select('id, name, email, agency_id')
    .eq('email', email)
    .single();

if (!user) {
    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã‚‚æˆåŠŸã‚’è¿”ã™
    return {
        statusCode: 200,
        body: JSON.stringify({
            success: true,
            message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆè©²å½“ã™ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰'
        })
    };
}

// STEP 4: ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
const resetToken = crypto.randomBytes(32).toString('hex');
const hashedToken = crypto.createHash('sha256').update(resetToken).digest('hex');
const expiresAt = new Date();
expiresAt.setHours(expiresAt.getHours() + 1); // 1æ™‚é–“æœ‰åŠ¹

// STEP 5: æ—¢å­˜ã®æœªä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–
await supabase
    .from('password_reset_tokens')
    .update({ used: true })
    .eq('agency_user_id', user.id)
    .eq('used', false);

// STEP 6: æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
await supabase
    .from('password_reset_tokens')
    .insert({
        agency_user_id: user.id,
        token: hashedToken,  // SHA-256ã§ãƒãƒƒã‚·ãƒ¥åŒ–
        expires_at: expiresAt.toISOString()
    });

// STEP 7: ãƒªã‚»ãƒƒãƒˆURLç”Ÿæˆ
const resetUrl = `${process.env.APP_URL}/agency/reset-password.html?token=${resetToken}`;

// STEP 8: SendGridã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
if (process.env.SENDGRID_API_KEY) {
    const sgMail = require('@sendgrid/mail');
    sgMail.setApiKey(process.env.SENDGRID_API_KEY);

    const msg = {
        to: email,
        from: process.env.EMAIL_FROM || 'noreply@taskmateai.net',
        subject: 'ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®ã”æ¡ˆå†… - TaskMate AI',
        html: `...`,  // ç¾ã—ã„HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
        text: `...`   // ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç‰ˆ
    };

    await sgMail.send(msg);
}

return {
    statusCode: 200,
    body: JSON.stringify({
        success: true,
        message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®æ¡ˆå†…ã‚’é€ä¿¡ã—ã¾ã—ãŸ'
    })
};
```

---

### 9.2 SendGrid HTMLãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

#### ç‰¹å¾´
- **ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯** (#f0fdf4 â†’ #d1fae5)
- **ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³** (max-width: 600px)
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Š** (èµ¤æ )
- **æœ‰åŠ¹æœŸé™è¡¨ç¤º** (é»„æ )
- **ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«** (ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ + ã‚·ãƒ£ãƒ‰ã‚¦)

#### HTMLæ§‹é€ ï¼ˆç°¡ç•¥ç‰ˆï¼‰
```html
<!DOCTYPE html>
<html lang="ja">
<body style="background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);">
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <table width="600" style="background: #ffffff; border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ -->
        <tr>
            <td style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 40px;">
                <div style="width: 80px; height: 80px; background: rgba(255, 255, 255, 0.2); border-radius: 50%;">
                    <span style="font-size: 40px;">ğŸ”</span>
                </div>
                <h1 style="color: #ffffff;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ</h1>
            </td>
        </tr>

        <!-- æœ¬æ–‡ -->
        <tr>
            <td style="padding: 40px;">
                <p>{{user.name}} æ§˜</p>
                <p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚</p>

                <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
                <a href="{{resetUrl}}" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: #ffffff; padding: 16px 40px; border-radius: 12px;">
                    ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
                </a>

                <!-- æœ‰åŠ¹æœŸé™è­¦å‘Šï¼ˆé»„æ ï¼‰ -->
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; padding: 16px;">
                    <strong>â° é‡è¦ï¼š</strong>ã“ã®ãƒªãƒ³ã‚¯ã¯<strong>1æ™‚é–“ã®ã¿æœ‰åŠ¹</strong>ã§ã™ã€‚<br>
                    æœ‰åŠ¹æœŸé™ï¼š{{expiresAt}}
                </div>

                <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„ï¼ˆèµ¤æ ï¼‰ -->
                <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 16px;">
                    <strong>ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦</strong><br>
                    â€¢ ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚’ç„¡è¦–ã—ã¦ãã ã•ã„<br>
                    â€¢ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã”è‡ªèº«ã§å¤‰æ›´ã—ãªã„é™ã‚Šå¤‰æ›´ã•ã‚Œã¾ã›ã‚“<br>
                    â€¢ ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚’ç¬¬ä¸‰è€…ã«è»¢é€ã—ãªã„ã§ãã ã•ã„
                </div>
            </td>
        </tr>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <tr>
            <td style="background: #f9fafb; padding: 30px; border-top: 1px solid #e5e7eb;">
                <p>Â© {{year}} TaskMate AI. All rights reserved.</p>
                <a href="https://taskmateai.net">å…¬å¼ã‚µã‚¤ãƒˆ</a> |
                <a href="https://taskmateai.net/agency/">ãƒ­ã‚°ã‚¤ãƒ³</a> |
                <a href="https://ikemen.ltd/contact/">ãŠå•ã„åˆã‚ã›</a>
            </td>
        </tr>
    </table>
</body>
</html>
```

#### ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç‰ˆ
```text
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®ã”æ¡ˆå†…
TaskMate AI ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒãƒ¼ã‚¿ãƒ«
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{{user.name}} æ§˜

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚

â–¼ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆURL
{{resetUrl}}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â° é‡è¦äº‹é …
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â€¢ ã“ã®ãƒªãƒ³ã‚¯ã¯1æ™‚é–“ã®ã¿æœ‰åŠ¹ã§ã™
â€¢ æœ‰åŠ¹æœŸé™ï¼š{{expiresAt}}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â€¢ ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚’ç„¡è¦–ã—ã¦ãã ã•ã„
â€¢ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã”è‡ªèº«ã§å¤‰æ›´ã—ãªã„é™ã‚Šå¤‰æ›´ã•ã‚Œã¾ã›ã‚“
â€¢ ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚’ç¬¬ä¸‰è€…ã«è»¢é€ã—ãªã„ã§ãã ã•ã„

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æœ¬ãƒ¡ãƒ¼ãƒ«ã¯ TaskMate AI ã‚ˆã‚Šè‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™
Â© {{year}} TaskMate AI. All rights reserved.

å…¬å¼ã‚µã‚¤ãƒˆï¼šhttps://taskmateai.net
ãƒ­ã‚°ã‚¤ãƒ³ï¼šhttps://taskmateai.net/agency/
ãŠå•ã„åˆã‚ã›ï¼šhttps://ikemen.ltd/contact/
```

---

### 9.3 ãƒªã‚»ãƒƒãƒˆç¢ºèªï¼ˆpassword-reset-confirm.jsï¼‰

#### å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ¦‚è¦ï¼‰
```javascript
// 1. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’SHA-256ã§ãƒãƒƒã‚·ãƒ¥åŒ–
const hashedToken = crypto.createHash('sha256').update(token).digest('hex');

// 2. ãƒˆãƒ¼ã‚¯ãƒ³æ¤œç´¢
const { data: resetToken } = await supabase
    .from('password_reset_tokens')
    .select('*')
    .eq('token', hashedToken)
    .eq('used', false)
    .single();

// 3. æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
if (new Date() > new Date(resetToken.expires_at)) {
    return { error: 'ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™' };
}

// 4. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–
const hashedPassword = await bcrypt.hash(newPassword, 10);

// 5. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
await supabase
    .from('agency_users')
    .update({ password_hash: hashedPassword })
    .eq('id', resetToken.agency_user_id);

// 6. ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹åŒ–
await supabase
    .from('password_reset_tokens')
    .update({ used: true })
    .eq('id', resetToken.id);

return { success: true };
```

---

## 10. ğŸ’³ Stripe Webhook é€£æº

### 10.1 å¯¾å¿œã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—

| ã‚¤ãƒ™ãƒ³ãƒˆ | ãƒãƒ³ãƒ‰ãƒ©ãƒ¼é–¢æ•° | å‡¦ç†å†…å®¹ |
|---------|--------------|---------|
| `payment_intent.succeeded` | `handlePaymentSuccess()` | æ±ºæ¸ˆæˆåŠŸæ™‚ã®å‡¦ç†ã€ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ²ã€ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®— |
| `checkout.session.completed` | `handleCheckoutComplete()` | ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆå®Œäº†æ™‚ã®å‡¦ç†ã€Payment Intentå–å¾— |
| `customer.created` | `handleCustomerCreated()` | é¡§å®¢ä½œæˆæ™‚ã®å‡¦ç†ã€Stripe Customer IDã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ä¿å­˜ |
| `invoice.payment_succeeded` | `handleInvoicePayment()` | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ»å®šæœŸæ”¯æ‰•ã„å‡¦ç† |

---

### 10.2 Webhookç½²åæ¤œè¨¼

```javascript
const sig = event.headers['stripe-signature'];
const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;

try {
    // Stripeç½²åæ¤œè¨¼ï¼ˆãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒé˜²æ­¢ï¼‰
    stripeEvent = stripe.webhooks.constructEvent(
        event.body,
        sig,
        webhookSecret
    );
} catch (err) {
    console.error('Webhook signature verification failed:', err);
    return {
        statusCode: 400,
        body: JSON.stringify({ error: `Webhook Error: ${err.message}` })
    };
}
```

---

### 10.3 æ±ºæ¸ˆæˆåŠŸå‡¦ç†ï¼ˆhandlePaymentSuccessï¼‰

#### Metadataæ§‹é€ 
```javascript
// Stripe Payment Intentã«è¨­å®šã•ã‚Œã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
{
  "line_user_id": "U2f9d259e...",
  "tracking_code": "TWITTER_AD_001",
  "session_id": "lov8x3l2a9",
  "agency_id": "00000000-0000-0000-0000-000000000002",
  "user_id": "00000000-0000-0000-0000-000000000001"
}
```

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼
```javascript
async function handlePaymentSuccess(paymentIntent) {
    const metadata = paymentIntent.metadata || {};
    const { line_user_id, tracking_code, session_id, agency_id, user_id } = metadata;

    // STEP 1: ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ã¨ä»£ç†åº—æƒ…å ±ã‚’å–å¾—
    let agencyData = null;
    let trackingLink = null;

    if (tracking_code) {
        const { data: link } = await supabase
            .from('agency_tracking_links')
            .select(`*, agencies (*)`)
            .eq('tracking_code', tracking_code)
            .single();

        if (link) {
            trackingLink = link;
            agencyData = link.agencies;
        }
    } else if (agency_id) {
        const { data: agency } = await supabase
            .from('agencies')
            .select('*')
            .eq('id', agency_id)
            .single();

        agencyData = agency;
    }

    if (!agencyData) {
        console.log('Agency not found for payment attribution');
        return;
    }

    // STEP 2: è¨ªå•ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’session_idã§æ¤œç´¢
    let visitId = null;
    if (session_id) {
        const { data: visit } = await supabase
            .from('agency_tracking_visits')
            .select('id')
            .eq('session_id', session_id)
            .single();

        if (visit) {
            visitId = visit.id;
        }
    }

    // STEP 3: ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ²ã‚’ä½œæˆ
    const { data: conversion } = await supabase
        .from('agency_conversions')
        .insert({
            tracking_link_id: trackingLink?.id,
            agency_id: agencyData.id,
            visit_id: visitId,
            user_id: user_id || null,
            conversion_type: 'stripe_payment',
            conversion_value: paymentIntent.amount / 100,  // ã‚»ãƒ³ãƒˆã‹ã‚‰é€šè²¨å˜ä½ã«å¤‰æ›
            line_user_id: line_user_id || null,
            metadata: {
                stripe_payment_intent_id: paymentIntent.id,
                stripe_customer_id: paymentIntent.customer,
                currency: paymentIntent.currency,
                payment_method: paymentIntent.payment_method_types[0],
                description: paymentIntent.description,
                timestamp: new Date().toISOString()
            }
        })
        .select()
        .single();

    // STEP 4: ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ã®ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
    if (trackingLink) {
        await supabase
            .from('agency_tracking_links')
            .update({
                conversion_count: trackingLink.conversion_count + 1,
                updated_at: new Date().toISOString()
            })
            .eq('id', trackingLink.id);
    }

    // STEP 5: ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—ã¨æ›´æ–°
    const commissionAmount = (paymentIntent.amount / 100) * (agencyData.commission_rate / 100);

    // å½“æœˆã®ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
    const currentDate = new Date();
    const periodStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const periodEnd = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

    const { data: existingCommission } = await supabase
        .from('agency_commissions')
        .select('*')
        .eq('agency_id', agencyData.id)
        .gte('period_start', periodStart.toISOString())
        .lte('period_end', periodEnd.toISOString())
        .single();

    if (existingCommission) {
        // æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°
        await supabase
            .from('agency_commissions')
            .update({
                total_conversions: existingCommission.total_conversions + 1,
                total_sales: existingCommission.total_sales + (paymentIntent.amount / 100),
                commission_amount: existingCommission.commission_amount + commissionAmount,
                updated_at: new Date().toISOString()
            })
            .eq('id', existingCommission.id);
    } else {
        // æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
        await supabase
            .from('agency_commissions')
            .insert({
                agency_id: agencyData.id,
                period_start: periodStart.toISOString(),
                period_end: periodEnd.toISOString(),
                total_conversions: 1,
                total_sales: paymentIntent.amount / 100,
                commission_rate: agencyData.commission_rate,
                commission_amount: commissionAmount,
                status: 'pending'
            });
    }

    console.log(`Conversion recorded for agency ${agencyData.name}: Â¥${paymentIntent.amount / 100}`);
}
```

---

### 10.4 æ±ºæ¸ˆä¾‹ã¨ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—

#### ä¾‹1: Level 2 ä»£ç†åº—ï¼ˆ18%ï¼‰çµŒç”±ã§Â¥5,000ã®æ±ºæ¸ˆ

```
æ±ºæ¸ˆé‡‘é¡: Â¥5,000
ä»£ç†åº—ãƒ¬ãƒ™ãƒ«: 2
å ±é…¬ç‡: 18.00%
ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³: Â¥5,000 Ã— 0.18 = Â¥900

ã€Supabaseãƒ¬ã‚³ãƒ¼ãƒ‰ã€‘
agency_conversions:
  - conversion_type: 'stripe_payment'
  - conversion_value: 5000
  - metadata: { stripe_payment_intent_id: 'pi_xxxxx', ... }

agency_commissions (å½“æœˆ):
  - total_conversions: +1
  - total_sales: +5000
  - commission_amount: +900
  - status: 'pending'
```

#### ä¾‹2: Level 4 ä»£ç†åº—ï¼ˆ14%ï¼‰çµŒç”±ã§Â¥3,300ã®æ±ºæ¸ˆ

```
æ±ºæ¸ˆé‡‘é¡: Â¥3,300
ä»£ç†åº—ãƒ¬ãƒ™ãƒ«: 4
å ±é…¬ç‡: 14.00%
ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³: Â¥3,300 Ã— 0.14 = Â¥462

ã€Supabaseãƒ¬ã‚³ãƒ¼ãƒ‰ã€‘
agency_conversions:
  - conversion_type: 'stripe_payment'
  - conversion_value: 3300
  - metadata: { stripe_payment_intent_id: 'pi_yyyyy', ... }

agency_commissions (å½“æœˆ):
  - total_conversions: +1
  - total_sales: +3300
  - commission_amount: +462
  - status: 'pending'
```

---

## 11. ğŸ“Š ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ 

### 11.1 ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³å–å¾—APIï¼ˆagency-commission.js GETï¼‰

#### ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | èª¬æ˜ | ä¾‹ |
|----------|---|------|-----|
| `period` | string | æœŸé–“ã‚¿ã‚¤ãƒ— | `current_month`, `last_month`, `current_year`, `custom` |
| `year` | number | å¹´ | `2024` |
| `month` | number | æœˆ | `10` |
| `start_date` | string | ã‚«ã‚¹ã‚¿ãƒ é–‹å§‹æ—¥ï¼ˆcustomæ™‚ï¼‰ | `2024-10-01` |
| `end_date` | string | ã‚«ã‚¹ã‚¿ãƒ çµ‚äº†æ—¥ï¼ˆcustomæ™‚ï¼‰ | `2024-10-31` |

#### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹
```json
{
  "success": true,
  "period": {
    "start": "2024-10-01",
    "end": "2024-10-31",
    "type": "current_month"
  },
  "commission": {
    "agency_id": "00000000-0000-0000-0000-000000000002",
    "total_payments": 45,
    "total_revenue_cents": 148500,
    "commission_rate": 18.00,
    "commission_amount": 26730
  },
  "summary": {
    "total_revenue_yen": 1485,
    "total_revenue_cents": 148500,
    "line_conversions": 120,
    "payment_conversions": 45,
    "total_conversions": 165
  },
  "funnel": {
    "visits": 450,
    "line_friends": 120,
    "payments": 45,
    "visit_to_line_rate": 26.67,
    "line_to_payment_rate": 37.50,
    "overall_conversion_rate": 10.00
  },
  "conversions": [
    {
      "id": "00000000-0000-0000-0000-000000000003",
      "tracking_link_id": "00000000-0000-0000-0000-000000000004",
      "conversion_type": "stripe_payment",
      "conversion_value": 3300,
      "line_user_id": "U2f9d259e...",
      "created_at": "2024-10-23T12:34:56Z",
      "metadata": {
        "stripe_payment_intent_id": "pi_xxxxx",
        "currency": "jpy"
      }
    }
  ],
  "payment_history": [
    {
      "amount_total": 330000,
      "payment_status": "succeeded",
      "created_at": "2024-10-23T12:34:56Z"
    }
  ]
}
```

---

### 11.2 ãƒ•ã‚¡ãƒãƒ«åˆ†æã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯

#### Supabaseã‚¯ã‚¨ãƒª
```javascript
// ãƒ•ã‚¡ãƒãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆconversion_funnels ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
const { data: funnelData } = await supabase
    .from('conversion_funnels')
    .select('step_name, created_at')
    .eq('agency_id', agencyId)
    .gte('created_at', periodStart.toISOString())
    .lte('created_at', periodEnd.toISOString());

// ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã®ã‚«ã‚¦ãƒ³ãƒˆ
const funnelStats = {
    visits: funnelData?.filter(f => f.step_name === 'visit').length || 0,
    line_friends: funnelData?.filter(f => f.step_name === 'line_friend').length || 0,
    payments: funnelData?.filter(f => f.step_name === 'payment').length || 0
};

// ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡è¨ˆç®—
const visitToLineRate = funnelStats.visits > 0
    ? ((funnelStats.line_friends / funnelStats.visits) * 100).toFixed(2)
    : 0;

const lineToPaymentRate = funnelStats.line_friends > 0
    ? ((funnelStats.payments / funnelStats.line_friends) * 100).toFixed(2)
    : 0;

const overallConversionRate = funnelStats.visits > 0
    ? ((funnelStats.payments / funnelStats.visits) * 100).toFixed(2)
    : 0;
```

#### ãƒ•ã‚¡ãƒãƒ«ä¾‹
```
è¨ªå•æ•°: 450ä»¶
   â†“ (26.67%)
LINEå‹é”è¿½åŠ : 120ä»¶
   â†“ (37.50%)
æ±ºæ¸ˆ: 45ä»¶

ç·åˆã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡: 10.00%
```

---

### 11.3 Supabase RPCã§ã®ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—

#### RPCé–¢æ•°å‘¼ã³å‡ºã—
```javascript
const { data: commissionData } = await supabase
    .rpc('calculate_agency_commission', {
        p_agency_id: agencyId,
        p_period_start: '2024-10-01',
        p_period_end: '2024-10-31'
    });

// commissionData[0]:
// {
//   agency_id: '...',
//   total_payments: 45,
//   total_revenue_cents: 148500,
//   commission_rate: 18.00,
//   commission_amount: 26730
// }
```

#### SQLé–¢æ•°ï¼ˆæ¦‚è¦ï¼‰
```sql
CREATE OR REPLACE FUNCTION calculate_agency_commission(
    p_agency_id UUID,
    p_period_start DATE,
    p_period_end DATE
)
RETURNS TABLE (
    agency_id UUID,
    total_payments BIGINT,
    total_revenue_cents BIGINT,
    commission_rate DECIMAL,
    commission_amount DECIMAL
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        a.id AS agency_id,
        COUNT(sp.id)::BIGINT AS total_payments,
        SUM(sp.amount_total)::BIGINT AS total_revenue_cents,
        a.own_commission_rate AS commission_rate,
        (SUM(sp.amount_total) * a.own_commission_rate / 100.0)::DECIMAL AS commission_amount
    FROM agencies a
    LEFT JOIN stripe_payments sp
        ON sp.agency_id = a.id
        AND sp.payment_status = 'succeeded'
        AND sp.created_at >= p_period_start
        AND sp.created_at <= p_period_end
    WHERE a.id = p_agency_id
    GROUP BY a.id, a.own_commission_rate;
END;
$$ LANGUAGE plpgsql;
```

---

## 12. ğŸ“ ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 

### 12.1 è¨ªå•è¨˜éŒ²ä½œæˆï¼ˆtrack-visit.jsï¼‰

#### ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ä¾‹
```json
{
  "tracking_code": "TWITTER_AD_001",
  "referrer": "https://twitter.com/...",
  "ip_address": "123.45.67.89",
  "user_agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 17_1_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Mobile/15E148 Safari/604.1",
  "utm_source": "twitter",
  "utm_medium": "social",
  "utm_campaign": "oct_campaign",
  "screen_resolution": "390x844",
  "language": "ja-JP",
  "timezone": "Asia/Tokyo"
}
```

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼
```javascript
// 1. ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ¼ãƒ‰æ¤œè¨¼
const { data: trackingLink } = await supabase
    .from('agency_tracking_links')
    .select('*')
    .eq('tracking_code', tracking_code)
    .eq('is_active', true)
    .single();

if (!trackingLink) {
    return { statusCode: 404, error: 'Invalid tracking code' };
}

// 2. IPã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ï¼‰
let clientIP = trackingData.ip_address;
if (!clientIP || clientIP === 'unknown') {
    clientIP = getClientIPFromHeaders(event.headers);
}

// 3. User-Agentè§£æ
const userAgent = trackingData.user_agent || event.headers['user-agent'] || 'Unknown';
const deviceType = getUserDeviceType(userAgent);  // mobile, tablet, desktop, bot
const browser = getUserBrowser(userAgent);  // Chrome, Safari, Firefox, Edge, LINE
const os = getUserOS(userAgent);  // "iOS 17.1.1", "Android 14", "Windows 10/11"

// 4. é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåŒä¸€IPã‹ã‚‰5åˆ†ä»¥å†…ï¼‰
const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
const { data: recentVisit } = await supabase
    .from('agency_tracking_visits')
    .select('id')
    .eq('tracking_link_id', trackingLink.id)
    .eq('visitor_ip', clientIP)
    .gte('visited_at', fiveMinutesAgo)
    .single();

if (recentVisit) {
    // é‡è¤‡è¨ªå•ãªã®ã§è¨˜éŒ²ã—ãªã„
    return { statusCode: 200, success: false, message: 'Duplicate visit' };
}

// 5. è¨ªå•è¨˜éŒ²ä½œæˆ
const { data: visit } = await supabase
    .from('agency_tracking_visits')
    .insert([{
        tracking_link_id: trackingLink.id,
        agency_id: trackingLink.agency_id,
        visitor_ip: clientIP,
        user_agent: userAgent,
        referrer: visitData.referrer,
        session_id: generateSessionId(),
        device_type: deviceType,
        browser: browser,
        os: os,
        metadata: {
            utm_source: visitData.utm_source,
            utm_medium: visitData.utm_medium,
            utm_campaign: visitData.utm_campaign,
            screen_resolution: visitData.screen_resolution,
            language: visitData.language,
            timezone: visitData.timezone
        }
    }])
    .select()
    .single();

// 6. è¨ªå•ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
await supabase
    .from('agency_tracking_links')
    .update({
        visit_count: trackingLink.visit_count + 1,
        updated_at: new Date().toISOString()
    })
    .eq('id', trackingLink.id);

// 7. ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
return {
    statusCode: 200,
    body: JSON.stringify({
        success: true,
        line_friend_url: trackingLink.destination_url || trackingLink.line_friend_url || 'https://lin.ee/4NLfSqH',
        tracking_link: {
            name: trackingLink.name,
            utm_source: trackingLink.utm_source,
            utm_medium: trackingLink.utm_medium,
            utm_campaign: trackingLink.utm_campaign
        },
        visit_id: visit.id,
        session_id: visit.session_id
    })
};
```

---

### 12.2 User-Agent è§£æï¼ˆå¼·åŒ–ç‰ˆï¼‰

#### getUserOS() - OSãƒãƒ¼ã‚¸ãƒ§ãƒ³è©³ç´°å–å¾—

**2024-10-23æ›´æ–°: ã‚¹ãƒãƒ›OSãƒãƒ¼ã‚¸ãƒ§ãƒ³è©³ç´°å–å¾—å¯¾å¿œ**

```javascript
function getUserOS(userAgent) {
    if (!userAgent) return 'unknown';

    // iOS: "iOS 17.1.1" or "iPadOS 16.5"
    const iosMatch = userAgent.match(/(?:iPhone|iPad|iPod).*?OS ([\d_]+)/i);
    if (iosMatch) {
        const version = iosMatch[1].replace(/_/g, '.');
        const device = /iPad/i.test(userAgent) ? 'iPadOS' : 'iOS';
        return `${device} ${version}`;
    }

    // Android: "Android 14" or "Android 13.0"
    const androidMatch = userAgent.match(/Android ([\d.]+)/i);
    if (androidMatch) {
        return `Android ${androidMatch[1]}`;
    }

    // Windows: "Windows 10/11" or "Windows 8.1"
    const windowsMatch = userAgent.match(/Windows NT ([\d.]+)/i);
    if (windowsMatch) {
        const ntVersion = windowsMatch[1];
        const windowsVersion = {
            '10.0': '10/11',
            '6.3': '8.1',
            '6.2': '8',
            '6.1': '7',
            '6.0': 'Vista'
        }[ntVersion] || ntVersion;
        return `Windows ${windowsVersion}`;
    }

    // macOS: "macOS 14.1" or "macOS 10.15.7"
    const macMatch = userAgent.match(/Mac OS X ([\d_]+)/i);
    if (macMatch) {
        const version = macMatch[1].replace(/_/g, '.');
        return `macOS ${version}`;
    }

    // Linux (generic)
    if (/linux/i.test(userAgent)) return 'Linux';

    return 'other';
}
```

#### User-Agent è§£æä¾‹

| User-Agent | device_type | browser | os |
|-----------|-------------|---------|-----|
| `Mozilla/5.0 (iPhone; CPU iPhone OS 17_1_1 like Mac OS X) ...` | mobile | Safari | iOS 17.1.1 |
| `Mozilla/5.0 (Linux; Android 14; SM-S911B) ...` | mobile | Chrome | Android 14 |
| `Mozilla/5.0 (iPad; CPU OS 16_5 like Mac OS X) ...` | tablet | Safari | iPadOS 16.5 |
| `Mozilla/5.0 (Windows NT 10.0; Win64; x64) ...` | desktop | Chrome | Windows 10/11 |
| `Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) ...` | desktop | Chrome | macOS 10.15.7 |

---

### 12.3 IPã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—

```javascript
function getClientIPFromHeaders(headers) {
    // å„ªå…ˆé †ä½é †ã«ãƒã‚§ãƒƒã‚¯
    const ipHeaders = [
        'x-forwarded-for',
        'x-real-ip',
        'x-client-ip',
        'cf-connecting-ip',  // Cloudflare
        'x-forwarded',
        'forwarded-for',
        'forwarded'
    ];

    for (const header of ipHeaders) {
        const value = headers[header];
        if (value) {
            // x-forwarded-for ã¯è¤‡æ•°IPã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚‹ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
            return value.split(',')[0].trim();
        }
    }

    return 'unknown';
}
```

---

### 12.4 è¨ªå•çµ±è¨ˆå–å¾—ï¼ˆget-tracking-stats.jsï¼‰

#### ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
```
GET /.netlify/functions/get-tracking-stats
Authorization: Bearer <agency_code>
```

#### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹
```json
{
  "visits": [
    {
      "id": "dc4aafc5-6eb5-4346-a92c-905f634b03f5",
      "tracking_link": {
        "name": "Twitteråºƒå‘ŠA",
        "tracking_code": "TWITTER_AD_001"
      },
      "line_user": {
        "display_name": "ã‚Šã‚…ã†",
        "user_id": "U2f9d259e..."
      },
      "friend_type": "æ–°è¦å‹é”",
      "device_type": "mobile",
      "os": "iOS 17.1.1",
      "browser": "Safari",
      "ip_address": "123.45.67.89",
      "visited_at": "2024-10-23T21:25:55Z"
    }
  ],
  "stats": {
    "total_visits": 150,
    "total_conversions": 45,
    "conversion_rate": "30.00%"
  }
}
```

#### å‹é”ã‚¿ã‚¤ãƒ—åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
```javascript
let friendType = 'æœªè¿½åŠ ';

if (visit.line_user_id) {
    // metadata ã« friend_type ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆ
    if (visit.metadata?.friend_type) {
        friendType = visit.metadata.friend_type === 'new_friend' ? 'æ–°è¦å‹é”' : 'æ—¢å­˜å‹é”';
    } else {
        // è¨ªå•æ—¥æ™‚ã¨LINEãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—æ—¥æ™‚ã‚’æ¯”è¼ƒ
        const visitDate = new Date(visit.created_at);
        const profileDate = visit.line_profiles?.fetched_at
            ? new Date(visit.line_profiles.fetched_at)
            : null;

        if (profileDate) {
            // Â±30åˆ†ä»¥å†…ãªã‚‰æ–°è¦å‹é”
            const timeDiff = Math.abs(visitDate.getTime() - profileDate.getTime());
            const thirtyMinutes = 30 * 60 * 1000;

            friendType = timeDiff <= thirtyMinutes ? 'æ–°è¦å‹é”' : 'æ—¢å­˜å‹é”';
        } else {
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ–°è¦å‹é”
            friendType = 'æ–°è¦å‹é”';
        }
    }
}
```

---

## 13. ğŸ”— LINE Webhook è»¢é€

### 13.1 line-webhook.js æ¦‚è¦

#### å½¹å‰²
1. **LINE Webhook ã‚’å—ä¿¡**
2. **ã‚¤ãƒ™ãƒ³ãƒˆæŒ¯ã‚Šåˆ†ã‘** (follow, message, unfollow)
3. **LINE Profile ä¿å­˜ãƒ»æ›´æ–°** (UPSERT)
4. **è¨ªå•è¨˜éŒ²ã¨ã®ç´ä»˜ã‘** (å‹é”ã‚¿ã‚¤ãƒ—åˆ¤å®š)
5. **Render ã¸ã®è»¢é€** (ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢)

---

### 13.2 handleFollowEventï¼ˆå‹é”è¿½åŠ ï¼‰

```javascript
async function handleFollowEvent(event) {
    const userId = event.source.userId;

    try {
        // 1. LINE API ã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
        const userProfile = await getLineUserProfile(userId);

        if (!userProfile) {
            console.error('Failed to get user profile for', userId);
            return;
        }

        // 2. line_profiles ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
        const profileData = {
            user_id: userId,
            display_name: userProfile.displayName,
            picture_url: userProfile.pictureUrl,
            status_message: userProfile.statusMessage,
            fetched_at: new Date().toISOString(),
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        const { data: newProfile, error } = await supabase
            .from('line_profiles')
            .insert([profileData])
            .select()
            .single();

        if (error) {
            console.error('Error creating profile:', error);
            return;
        }

        // 3. ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯çµŒç”±ã®å ´åˆã€è¨ªå•è¨˜éŒ²ã«ç´ä»˜ã‘
        await linkUserToTracking(userId, userId, 'new_friend');

        // 4. ä»£ç†åº—ã®å‹é”è¿½åŠ ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼‰
        await checkAndActivateAgency(userId);

    } catch (error) {
        console.error('Error handling follow event:', error);
    }
}

// ä»£ç†åº—ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå‹é”è¿½åŠ å®Œäº†æ™‚ï¼‰
async function checkAndActivateAgency(lineUserId) {
    // 1. LINE User IDã§ä»£ç†åº—æ¤œç´¢
    const { data: agency } = await supabase
        .from('agencies')
        .select('id, status')
        .eq('line_user_id', lineUserId)
        .eq('status', 'pending_friend_add')
        .single();

    if (!agency) {
        return;  // ä»£ç†åº—ç™»éŒ²ã¨ã¯ç„¡é–¢ä¿‚ã®å‹é”è¿½åŠ 
    }

    // 2. ä»£ç†åº—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°: pending_friend_add â†’ active
    await supabase
        .from('agencies')
        .update({
            status: 'active',
            updated_at: new Date().toISOString()
        })
        .eq('id', agency.id);

    // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³
    await supabase
        .from('agency_users')
        .update({
            is_active: true,
            updated_at: new Date().toISOString()
        })
        .eq('agency_id', agency.id);

    console.log(`âœ… Agency ${agency.id} activated by LINE friend add`);
}
```

---

### 13.3 handleMessageEventï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ï¼‰

**2024-10-22æ›´æ–°: UPSERTè¿½åŠ ï¼ˆæ—¢å­˜å‹é”ã®LINEåè¨˜éŒ²ï¼‰**

```javascript
async function handleMessageEvent(event) {
    const userId = event.source.userId;

    try {
        // 1. LINE Profile UPSERTï¼ˆæ—¢å­˜å‹é”å¯¾å¿œï¼‰
        const userProfile = await getLineUserProfile(userId);

        if (userProfile) {
            await supabase
                .from('line_profiles')
                .upsert({
                    user_id: userId,
                    display_name: userProfile.displayName,
                    picture_url: userProfile.pictureUrl,
                    status_message: userProfile.statusMessage,
                    fetched_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }, {
                    onConflict: 'user_id'
                });

            console.log('âœ… LINE Profile upsertæˆåŠŸ:', userProfile.displayName);
        }

        // 2. æœªç´ä»˜ã‘è¨ªå•è¨˜éŒ²æ¤œç´¢ï¼ˆéå»1æ™‚é–“ï¼‰
        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();

        const { data: unlinkedVisits, error: searchError } = await supabase
            .from('agency_tracking_visits')
            .select('id, tracking_link_id, agency_id, created_at, metadata')
            .is('line_user_id', null)
            .gte('created_at', oneHourAgo)
            .order('created_at', { ascending: false })
            .limit(5);

        if (searchError) {
            console.error('âŒ æœªç´ä»˜ã‘è¨ªå•è¨˜éŒ²ã®æ¤œç´¢ã«å¤±æ•—:', searchError);
            return;
        }

        if (!unlinkedVisits || unlinkedVisits.length === 0) {
            console.log('â„¹ï¸ éå»1æ™‚é–“ä»¥å†…ã®æœªç´ä»˜ã‘è¨ªå•è¨˜éŒ²ãªã—');
            return;
        }

        console.log(`âœ… ${unlinkedVisits.length}ä»¶ã®æœªç´ä»˜ã‘è¨ªå•è¨˜éŒ²ã‚’ç™ºè¦‹`);

        // 3. è¨ªå•è¨˜éŒ²ã«ç´ä»˜ã‘ï¼ˆæ—¢å­˜å‹é”ã¨ã—ã¦ï¼‰
        let successCount = 0;
        let errorCount = 0;

        for (const visit of unlinkedVisits) {
            try {
                const currentMetadata = visit.metadata || {};

                const { error: updateError } = await supabase
                    .from('agency_tracking_visits')
                    .update({
                        line_user_id: userId,
                        metadata: {
                            ...currentMetadata,
                            friend_type: 'existing_friend',
                            linked_at: new Date().toISOString()
                        }
                        // updated_at ã¯å­˜åœ¨ã—ãªã„ï¼ˆ2024-10-23ç¢ºèªï¼‰
                    })
                    .eq('id', visit.id);

                if (updateError) {
                    console.error(`âŒ Visit ${visit.id} ã®æ›´æ–°ã«å¤±æ•—:`, updateError);
                    errorCount++;
                } else {
                    successCount++;

                    // ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ²ä½œæˆ
                    const sessionData = {
                        id: null,
                        agency_id: visit.agency_id,
                        tracking_link_id: visit.tracking_link_id,
                        visit_id: visit.id
                    };

                    await createAgencyLineConversion(sessionData, userId, userId).catch(err => {
                        console.error(`âŒ Visit ${visit.id} ã®ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ²ä½œæˆã«å¤±æ•—:`, err);
                    });
                }
            } catch (error) {
                console.error(`âŒ Visit ${visit.id} ã®å‡¦ç†ã«å¤±æ•—:`, error);
                errorCount++;
            }
        }

        console.log(`âœ… ${successCount}ä»¶ã®ç´ä»˜ã‘ã«æˆåŠŸ`);
        if (errorCount > 0) {
            console.error(`âš ï¸ ${errorCount}ä»¶ã®ç´ä»˜ã‘ã«å¤±æ•—ã—ã¾ã—ãŸ`);
        }

    } catch (error) {
        console.error('Error handling message event:', error);
    }
}
```

**é‡è¦ãªä¿®æ­£å±¥æ­´:**
- **2024-10-23**: `updated_at` ã‚«ãƒ©ãƒ å‰Šé™¤ï¼ˆå­˜åœ¨ã—ãªã„ãŸã‚ã‚¨ãƒ©ãƒ¼ï¼‰
- **2024-10-22**: UPSERT è¿½åŠ ï¼ˆæ—¢å­˜å‹é”ã® LINE åè¨˜éŒ²ï¼‰

---

### 13.4 forwardToRenderï¼ˆRenderè»¢é€ï¼‰

**2024-10-21æ›´æ–°: `await` å¿…é ˆåŒ–ï¼ˆé–¢æ•°æ—©æœŸçµ‚äº†é˜²æ­¢ï¼‰**

```javascript
async function forwardToRender(body, signature) {
    const RENDER_URL = 'https://gasgenerator.onrender.com/api/webhook';

    try {
        console.log('ğŸ“¤ [v2.0] Forwarding to Render TaskMate AI:', RENDER_URL);

        const response = await fetch(RENDER_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-line-signature': signature,
                'x-forwarded-from': 'netlify'  // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
            },
            body: body,
            signal: AbortSignal.timeout(28000)  // 28ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error(`âŒ Render forward failed (${response.status}):`, errorText);
            throw new Error(`Render responded with ${response.status}`);
        }

        console.log('âœ… Render forward successful');
    } catch (error) {
        console.error('âŒ Forward to Render error:', error);
        throw error;
    }
}

// å‘¼ã³å‡ºã—å´ï¼ˆå¿…ãš await ã™ã‚‹ã“ã¨ï¼‰
exports.handler = async (event, context) => {
    // ...

    // âŒ é–“é•ã„
    // forwardToRender(body, signature).catch(...);

    // âœ… æ­£ã—ã„
    await forwardToRender(body, signature);

    return { statusCode: 200, body: 'OK' };
};
```

**é‡è¦:**
- **å¿…ãš `await` ã™ã‚‹ã“ã¨**: é–¢æ•°çµ‚äº†å‰ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ã‚’å¾…ã¤
- **x-forwarded-from ãƒ˜ãƒƒãƒ€ãƒ¼**: Render å´ã§ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é˜²æ­¢
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ 28ç§’**: Netlify Functions ã®åˆ¶é™ï¼ˆæœ€å¤§30ç§’ï¼‰å†…

---

## 14. ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æº

### 14.1 ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«å®Œå…¨ä¸€è¦§ï¼ˆ18å€‹ï¼‰

#### ä»£ç†åº—ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ7å€‹ï¼‰
| ãƒ†ãƒ¼ãƒ–ãƒ«å | ç”¨é€” | Netlify ã§ã®æ“ä½œ |
|-----------|------|-----------------|
| `agencies` | ä»£ç†åº—æƒ…å ± | SELECT, INSERT, UPDATE |
| `agency_users` | ä»£ç†åº—ãƒ¦ãƒ¼ã‚¶ãƒ¼ | SELECT, INSERT, UPDATE |
| `agency_tracking_links` | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ | SELECT, INSERT, UPDATE (visit_count) |
| `agency_tracking_visits` | è¨ªå•è¨˜éŒ² | SELECT, INSERT, UPDATE (line_user_id) |
| `agency_conversions` | CVè¨˜éŒ² | SELECT, INSERT |
| `agency_commissions` | ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ | SELECT, INSERT, UPDATE |
| `agency_commission_distributions` | ç´¹ä»‹ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³åˆ†é…ï¼ˆ4éšå±¤ï¼‰ | SELECT, INSERT |

#### LINEé€£æºï¼ˆ2å€‹ï¼‰
| ãƒ†ãƒ¼ãƒ–ãƒ«å | ç”¨é€” | Netlify ã§ã®æ“ä½œ |
|-----------|------|-----------------|
| `line_profiles` | LINE ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆæ–°ï¼‰ | INSERT, UPSERT |
| `line_users` | LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæ—§ãƒ»å¾Œæ–¹äº’æ›ï¼‰ | SELECT |

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ»èªè¨¼ï¼ˆ2å€‹ï¼‰
| ãƒ†ãƒ¼ãƒ–ãƒ«å | ç”¨é€” | Netlify ã§ã®æ“ä½œ |
|-----------|------|-----------------|
| `user_sessions` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† | SELECT, INSERT, UPDATE, UPSERT |
| `password_reset_tokens` | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ | SELECT, INSERT, UPDATE |

#### æ±ºæ¸ˆãƒ»åˆ†æï¼ˆ2å€‹ï¼‰
| ãƒ†ãƒ¼ãƒ–ãƒ«å | ç”¨é€” | Netlify ã§ã®æ“ä½œ |
|-----------|------|-----------------|
| `stripe_payments` | Stripeæ±ºæ¸ˆè¨˜éŒ² | SELECT |
| `conversion_funnels` | ãƒ•ã‚¡ãƒãƒ«åˆ†æ | SELECT, INSERT |

#### Renderå´ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ2å€‹ãƒ»å‚ç…§ã®ã¿ï¼‰
| ãƒ†ãƒ¼ãƒ–ãƒ«å | ç”¨é€” | Netlify ã§ã®æ“ä½œ |
|-----------|------|-----------------|
| `users` | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆRenderç®¡ç†ï¼‰ | SELECTï¼ˆå‚ç…§ã®ã¿ï¼‰ |
| `user_states` | ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ï¼ˆRenderç®¡ç†ï¼‰ | SELECTï¼ˆå‚ç…§ã®ã¿ï¼‰ |

#### æ—§ç®¡ç†è€…ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ3å€‹ãƒ»å¾Œæ–¹äº’æ›ï¼‰
| ãƒ†ãƒ¼ãƒ–ãƒ«å | ç”¨é€” | Netlify ã§ã®æ“ä½œ |
|-----------|------|-----------------|
| `tracking_links` | ç®¡ç†è€…ç”¨ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ï¼ˆæ—§ï¼‰ | SELECT, INSERT |
| `tracking_sessions` | ç®¡ç†è€…ç”¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆæ—§ï¼‰ | SELECT |
| `tracking_visits` | ç®¡ç†è€…ç”¨è¨ªå•è¨˜éŒ²ï¼ˆæ—§ï¼‰ | SELECT, UPDATE |

**æ³¨æ„:** æ—§ç®¡ç†è€…ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆtracking_*ï¼‰ã¯å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã•ã‚Œã¦ã„ã¾ã™ã€‚æ–°è¦é–‹ç™ºã§ã¯ `agency_*` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

---

### 14.2 agencies ãƒ†ãƒ¼ãƒ–ãƒ«

#### ã‚¹ã‚­ãƒ¼ãƒ
```sql
CREATE TABLE agencies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(50) UNIQUE NOT NULL,  -- 'AGXXXXXXXXX'
  name VARCHAR(255) NOT NULL,
  company_name VARCHAR(255),
  contact_email VARCHAR(255),
  contact_phone VARCHAR(50),
  address TEXT,
  status VARCHAR(50) DEFAULT 'pending',  -- pending_line_verification, pending_friend_add, active, pending, rejected, suspended

  -- 4æ®µéšä»£ç†åº—åˆ¶åº¦
  parent_agency_id UUID REFERENCES agencies(id),
  level INTEGER DEFAULT 1,  -- 1, 2, 3, 4
  own_commission_rate DECIMAL(5,2) DEFAULT 20.00,  -- 20.00, 18.00, 16.00, 14.00
  is_master BOOLEAN DEFAULT FALSE,

  -- LINEé€£æº
  line_user_id VARCHAR(255),
  line_display_name VARCHAR(255),
  line_picture_url TEXT,
  registration_token VARCHAR(255),
  registration_token_expires_at TIMESTAMP,

  -- ãã®ä»–
  settings JSONB DEFAULT '{}',
  payment_info JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_agencies_code ON agencies(code);
CREATE INDEX idx_agencies_parent ON agencies(parent_agency_id);
CREATE INDEX idx_agencies_level ON agencies(level);
CREATE INDEX idx_agencies_line_user ON agencies(line_user_id);
CREATE INDEX idx_agencies_registration_token ON agencies(registration_token);
```

---

### 14.3 agency_users ãƒ†ãƒ¼ãƒ–ãƒ«

#### ã‚¹ã‚­ãƒ¼ãƒ
```sql
CREATE TABLE agency_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  agency_id UUID NOT NULL REFERENCES agencies(id) ON DELETE CASCADE,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,  -- bcrypt hashed
  name VARCHAR(255) NOT NULL,
  role VARCHAR(50) DEFAULT 'owner',  -- owner, admin, member
  is_active BOOLEAN DEFAULT FALSE,
  last_login_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_agency_users_email ON agency_users(email);
CREATE INDEX idx_agency_users_agency ON agency_users(agency_id);
```

---

### 14.4 agency_tracking_visits ãƒ†ãƒ¼ãƒ–ãƒ«

#### ã‚¹ã‚­ãƒ¼ãƒ
```sql
CREATE TABLE agency_tracking_visits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tracking_link_id UUID NOT NULL REFERENCES agency_tracking_links(id),
  agency_id UUID NOT NULL REFERENCES agencies(id),
  line_user_id TEXT REFERENCES line_profiles(user_id),
  visitor_ip TEXT,
  user_agent TEXT,
  device_type TEXT,      -- mobile | desktop | tablet | bot
  browser TEXT,          -- Chrome | Safari | LINE | ...
  os TEXT,               -- "iOS 17.1.1" | "Android 14" | ...
  referrer TEXT,
  session_id TEXT,
  metadata JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_visits_tracking_link ON agency_tracking_visits(tracking_link_id);
CREATE INDEX idx_visits_line_user ON agency_tracking_visits(line_user_id);
CREATE INDEX idx_visits_created_at ON agency_tracking_visits(created_at DESC);
CREATE INDEX idx_visits_unlinked ON agency_tracking_visits(line_user_id) WHERE line_user_id IS NULL;
```

#### metadata JSONB æ§‹é€ 
```json
{
  "friend_type": "new_friend" | "existing_friend",
  "linked_at": "2024-10-23T21:25:57Z",
  "utm_source": "twitter",
  "utm_medium": "social",
  "utm_campaign": "oct_campaign",
  "screen_resolution": "390x844",
  "language": "ja-JP",
  "timezone": "Asia/Tokyo"
}
```

**é‡è¦:** `updated_at` ã‚«ãƒ©ãƒ ã¯å­˜åœ¨ã—ãªã„ï¼ˆ2024-10-23ç¢ºèªï¼‰

---

### 14.5 line_profiles ãƒ†ãƒ¼ãƒ–ãƒ«

#### ã‚¹ã‚­ãƒ¼ãƒ
```sql
CREATE TABLE line_profiles (
  user_id TEXT PRIMARY KEY,
  display_name TEXT,
  picture_url TEXT,
  status_message TEXT,
  fetched_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### UPSERT ãƒ‘ã‚¿ãƒ¼ãƒ³
```javascript
await supabase
    .from('line_profiles')
    .upsert({
        user_id: userId,
        display_name: userProfile.displayName,
        picture_url: userProfile.pictureUrl,
        status_message: userProfile.statusMessage,
        fetched_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
    }, {
        onConflict: 'user_id'
    });
```

---

## 15. ğŸŒ ç’°å¢ƒå¤‰æ•°ï¼ˆå…¨22å€‹ - å®Ÿç’°å¢ƒæ¤œè¨¼æ¸ˆã¿ï¼‰

**å®ŸNetlifyç’°å¢ƒå¤‰æ•°ç”»åƒã‹ã‚‰æŠ½å‡ºï¼ˆ2025-10-23ç¢ºèªï¼‰**

### 15.1 Supabaseæ¥ç¶šï¼ˆ3å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å–å¾—æ–¹æ³• |
|---|--------|------|---------|
| 1 | `SUPABASE_URL` | Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURL | Supabase Dashboard â†’ Project Settings â†’ API |
| 2 | `SUPABASE_SERVICE_ROLE_KEY` | Supabase ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼ï¼ˆRLSç„¡è¦–ï¼‰ | Supabase Dashboard â†’ Project Settings â†’ API â†’ service_role key |
| 3 | `SUPABASE_ANON_KEY` | Supabase åŒ¿åã‚­ãƒ¼ï¼ˆRLSé©ç”¨ï¼‰ | Supabase Dashboard â†’ Project Settings â†’ API â†’ anon/public key |

---

### 15.2 Supabase Publicå¤‰æ•°ï¼ˆ2å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å–å¾—æ–¹æ³• |
|---|--------|------|---------|
| 4 | `NEXT_PUBLIC_SUPABASE_URL` | Supabase URLï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå…¬é–‹ï¼‰ | `SUPABASE_URL`ã¨åŒã˜å€¤ |
| 5 | `NEXT_PUBLIC_SUPABASE_ANON_KEY` | SupabaseåŒ¿åã‚­ãƒ¼ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå…¬é–‹ï¼‰ | `SUPABASE_ANON_KEY`ã¨åŒã˜å€¤ |

**æ³¨:** Next.jsã®`NEXT_PUBLIC_*`å¤‰æ•°ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´JavaScriptã§ä½¿ç”¨å¯èƒ½

---

### 15.3 LINE Messaging APIï¼ˆ3å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å–å¾—æ–¹æ³• |
|---|--------|------|---------|
| 6 | `LINE_CHANNEL_ACCESS_TOKEN` | LINE API èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ | LINE Developers Console â†’ Messaging APIè¨­å®š â†’ Channel access token |
| 7 | `LINE_CHANNEL_SECRET` | Webhook ç½²åæ¤œè¨¼ç”¨ | LINE Developers Console â†’ Basic settings â†’ Channel secret |
| 8 | `LINE_OFFICIAL_URL` | LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‹é”è¿½åŠ URL | LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ç”»é¢ â†’ å‹é”è¿½åŠ  â†’ QRã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: `https://lin.ee/4NLfSqH`ï¼‰ |

---

### 15.4 LINE Publicå¤‰æ•°ï¼ˆ1å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å–å¾—æ–¹æ³• |
|---|--------|------|---------|
| 9 | `NEXT_PUBLIC_LINE_FRIEND_URL` | LINEå‹é”è¿½åŠ URLï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå…¬é–‹ï¼‰ | `LINE_OFFICIAL_URL`ã¨åŒã˜å€¤ |

---

### 15.5 Stripeæ±ºæ¸ˆï¼ˆ4å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å–å¾—æ–¹æ³• |
|---|--------|------|---------|
| 10 | `STRIPE_SECRET_KEY` | Stripe APIã‚­ãƒ¼ï¼ˆæœ¬ç•ªç’°å¢ƒ: `sk_live_`ï¼‰ | Stripe Dashboard â†’ Developers â†’ API keys â†’ Secret key |
| 11 | `STRIPE_WEBHOOK_SECRET` | Stripe Webhookç½²åæ¤œè¨¼ç”¨ | Stripe Dashboard â†’ Webhooks â†’ Signing secretï¼ˆ`whsec_`ã§å§‹ã¾ã‚‹ï¼‰ |
| 12 | `STRIPE_PAYMENT_LINK` | é€šå¸¸ãƒ—ãƒ©ãƒ³æ±ºæ¸ˆURL | Stripe Dashboard â†’ Payment Linksï¼ˆä¾‹: `https://buy.stripe.com/7sY3cv...`ï¼‰ |
| 13 | `STRIPE_PROFESSIONAL_PAYMENT_LINK` | Professionalãƒ—ãƒ©ãƒ³æ±ºæ¸ˆURL | Stripe Dashboard â†’ Payment Linksï¼ˆä¾‹: `https://buy.stripe.com/fZu6oH...`ï¼‰ |

---

### 15.6 èªè¨¼ãƒ»ç®¡ç†ï¼ˆ3å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å–å¾—æ–¹æ³• |
|---|--------|------|---------|
| 14 | `JWT_SECRET` | JWT ç½²åç”¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆï¼ˆ32æ–‡å­—ä»¥ä¸Šæ¨å¥¨ï¼‰ï¼š`openssl rand -base64 32` |
| 15 | `ADMIN_USERNAME` | ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼å | ä»»æ„è¨­å®šï¼ˆæ¨å¥¨: `admin`ï¼‰ |
| 16 | `ADMIN_PASSWORD` | ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆâš ï¸ï¼‰ | ä»»æ„è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `TaskMate2024Admin!`ï¼‰â€»validate-admin.js:27ã§ä½¿ç”¨ |

---

### 15.7 å¤–éƒ¨é€£æºï¼ˆ2å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å–å¾—æ–¹æ³• |
|---|--------|------|---------|
| 17 | `RENDER_WEBHOOK_URL` | Render Webhook URLï¼ˆLINEè»¢é€ç”¨ï¼‰ | Render App Webhook URLï¼ˆä¾‹: `https://gasgenerator.onrender.com/api/webhook`ï¼‰â€»line-webhook.js:879ã§ä½¿ç”¨ |
| 18 | `ANTHROPIC_API_KEY` | Claude 3.5 Sonnet APIã‚­ãƒ¼ | Anthropic Console â†’ API Keysï¼ˆ`sk-ant-api03-`ã§å§‹ã¾ã‚‹ï¼‰ |

---

### 15.8 Netlifyå›ºæœ‰è¨­å®šï¼ˆ2å€‹ï¼‰

| # | å¤‰æ•°å | ç”¨é€” | å–å¾—æ–¹æ³• |
|---|--------|------|---------|
| 19 | `NETLIFY_SITE_ID` | Netlifyã‚µã‚¤ãƒˆIDï¼ˆNetlifyå†…éƒ¨ã§ä½¿ç”¨ï¼‰ | Netlify Dashboard â†’ Site settings â†’ Site information â†’ Site ID |
| 20 | `CRON_SECRET` | Cronã‚¸ãƒ§ãƒ–èªè¨¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆï¼š`openssl rand -hex 32` |

**æ³¨:** `NETLIFY_SITE_ID`ã¯Netlify CLIãŒè‡ªå‹•ä½¿ç”¨ã€‚Functionså†…ã§ã¯æœªä½¿ç”¨

---

### 15.9 å°†æ¥ç”¨å¤‰æ•°ï¼ˆ2å€‹ãƒ»è¨­å®šæ¸ˆã¿ã ãŒæœªä½¿ç”¨ï¼‰âš ï¸

| # | å¤‰æ•°å | ç”¨é€” | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|---|--------|------|-----------|
| 21 | `ADMIN_API_KEY` | ç®¡ç†APIèªè¨¼ã‚­ãƒ¼ | âš ï¸ è¨­å®šæ¸ˆã¿ã ãŒã‚³ãƒ¼ãƒ‰å†…ã§æœªä½¿ç”¨ |
| 22 | `ADMIN_API_SECRET` | ç®¡ç†APIã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | âš ï¸ è¨­å®šæ¸ˆã¿ã ãŒã‚³ãƒ¼ãƒ‰å†…ã§æœªä½¿ç”¨ |

**æ³¨:** ä¸Šè¨˜2å¤‰æ•°ã¯å®Ÿç’°å¢ƒã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ãŒã€ç¾åœ¨ã®Functionså†…ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å°†æ¥ã®æ©Ÿèƒ½æ‹¡å¼µç”¨ã¨ã—ã¦è¨­å®šã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

---

### 15.10 Netlifyè‡ªå‹•è¨­å®šå¤‰æ•°ï¼ˆè¨­å®šä¸è¦ï¼‰

ä»¥ä¸‹ã®å¤‰æ•°ã¯NetlifyãŒè‡ªå‹•è¨­å®šï¼ˆæ‰‹å‹•è¨­å®šä¸è¦ï¼‰ï¼š

- `SITE_URL` - ã‚µã‚¤ãƒˆURLï¼ˆCSRFä¿è­·ã§ä½¿ç”¨ï¼‰
- `URL` - ãƒ‡ãƒ—ãƒ­ã‚¤URLï¼ˆCSRFä¿è­·ã§ä½¿ç”¨ï¼‰
- `CONTEXT` - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆproduction/deploy-preview/branch-deployï¼‰
- `NODE_ENV` - ç’°å¢ƒï¼ˆæœ¬ç•ªã§ã¯è‡ªå‹•çš„ã« `production`ï¼‰

---

### 15.11 ç’°å¢ƒå¤‰æ•°ã®è¨­å®šæ–¹æ³•ï¼ˆNetlifyï¼‰

```
1. Netlify Dashboard ã«ã‚¢ã‚¯ã‚»ã‚¹
   https://app.netlify.com/

2. "elegant-gumdrop-9a983a" ã‚µã‚¤ãƒˆã‚’é¸æŠ

3. "Site settings" â†’ "Environment variables"

4. "Add a variable" ã§è¿½åŠ 
   - Key: SUPABASE_URL
   - Value: https://xxxxx.supabase.co
   - Scopes: All deploys

5. "Deploy site" ã§å†ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆè‡ªå‹•ï¼‰
```

---

## 16. ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### 16.1 è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š

**GitHub é€£æº:**
```
Repository: IKEMENLTD/gasgenerator
Branch: main
Base directory: netlify-tracking
```

**ãƒ“ãƒ«ãƒ‰è¨­å®š:**
```
Build command: (ãªã—)
Publish directory: public
Functions directory: netlify/functions
```

---

### 16.2 ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

```
1. GitHub ã« main ãƒ–ãƒ©ãƒ³ãƒã¸ pushï¼ˆnetlify-tracking/é…ä¸‹ï¼‰
   â†“
2. Netlify ãŒè‡ªå‹•æ¤œçŸ¥
   â†“
3. ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹
   - Functions ã®ãƒ“ãƒ«ãƒ‰ï¼ˆä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
   - é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
   â†“
4. ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼ˆç´„30ç§’-1åˆ†ï¼‰
   â†“
5. å³åº§ã«åæ˜ 
```

---

### 16.3 ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç¢ºèª

#### Functions ãƒ†ã‚¹ãƒˆ
```bash
# æ¥ç¶šãƒ†ã‚¹ãƒˆ
curl https://taskmateai.net/.netlify/functions/test-connection

# ç’°å¢ƒå¤‰æ•°ãƒ†ã‚¹ãƒˆ
curl https://taskmateai.net/.netlify/functions/test-env

# ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
curl -X POST https://taskmateai.net/.netlify/functions/track-visit \
  -H "Content-Type: application/json" \
  -d '{"tracking_code":"TEST001"}'
```

#### LINE Webhook ãƒ†ã‚¹ãƒˆ
```bash
# å®Ÿéš›ã« LINE ã‹ã‚‰å‹é”è¿½åŠ ã¾ãŸã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
```

#### ãƒ­ã‚°ç¢ºèª
```
1. Netlify Dashboard â†’ elegant-gumdrop-9a983a
2. "Functions" ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
3. "line-webhook" ã‚’é¸æŠ
4. ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
```

---

## 17. ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 17.1 LINE åãŒè¡¨ç¤ºã•ã‚Œãªã„

#### ç—‡çŠ¶
ç®¡ç†ç”»é¢ã®è¨ªå•å±¥æ­´ã§ LINE åãŒ `-` ã«ãªã‚‹

#### åŸå› 
1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ã„ãªã„ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆã§ã®ã¿è¨˜éŒ²ï¼‰
2. `getLineUserProfile` ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¦ã„ã‚‹
3. UPSERT ãŒå¤±æ•—ã—ã¦ã„ã‚‹

#### ç¢ºèªæ–¹æ³•
```
1. Netlify Functions ãƒ­ã‚°ã‚’é–‹ã
2. "line-webhook" ã‚’é¸æŠ
3. ä»¥ä¸‹ã®ãƒ­ã‚°ã‚’æ¢ã™:
   âœ… LINE Profile upsertæˆåŠŸ: ã‚Šã‚…ã†
```

#### å¯¾å‡¦æ³•
- ãƒ­ã‚°ã« `âœ… LINE Profile upsertæˆåŠŸ` ãŒå‡ºã¦ã„ãªã„å ´åˆ:
  - `LINE_CHANNEL_ACCESS_TOKEN` ãŒæ­£ã—ã„ã‹ç¢ºèª
  - LINE API ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¦ã„ãªã„ã‹ç¢ºèª

---

### 17.2 è¨ªå•è¨˜éŒ²ãŒç´ä»˜ã‘ã‚‰ã‚Œãªã„

#### ç—‡çŠ¶
```
âŒ Visit dc4aafc5-... ã®æ›´æ–°ã«å¤±æ•—:
Could not find the 'updated_at' column of 'agency_tracking_visits'
```

#### åŸå› 
`agency_tracking_visits` ãƒ†ãƒ¼ãƒ–ãƒ«ã« `updated_at` ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„

#### ä¿®æ­£æ¸ˆã¿ï¼ˆ2024-10-23ï¼‰
```javascript
// BEFORE
.update({
  line_user_id: userId,
  metadata: {...},
  updated_at: new Date().toISOString()  // â† å‰Šé™¤
})

// AFTER
.update({
  line_user_id: userId,
  metadata: {...}
})
```

---

### 17.3 Render è»¢é€ãŒå¤±æ•—

#### ç—‡çŠ¶
```
âŒ Background forward to Render failed: timeout
```

#### åŸå› 
`await` ãªã—ã§ `forwardToRender` ã‚’å‘¼ã‚“ã§ã„ãŸï¼ˆé–¢æ•°ãŒæ—©æœŸçµ‚äº†ï¼‰

#### ä¿®æ­£æ¸ˆã¿ï¼ˆ2024-10-21ï¼‰
```javascript
// BEFORE
forwardToRender(body, signature).catch(...)

// AFTER
await forwardToRender(body, signature)
```

---

### 17.4 ãƒ­ã‚°ç¢ºèªæ–¹æ³•

#### Netlify Functions ãƒ­ã‚°
```
https://app.netlify.com/
â†“
"elegant-gumdrop-9a983a" ã‚’ã‚¯ãƒªãƒƒã‚¯
â†“
"Functions" ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
â†“
"line-webhook" ã‚’é¸æŠ
â†“
ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
```

**æ¢ã™ã¹ãã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:**
- `âœ… LINE Profile upsertæˆåŠŸ` â†’ LINE åè¨˜éŒ²æˆåŠŸ
- `âŒ Visit ... ã®æ›´æ–°ã«å¤±æ•—` â†’ è¨ªå•è¨˜éŒ²ç´ä»˜ã‘ã‚¨ãƒ©ãƒ¼
- `ğŸš€ Renderè»¢é€ã‚’é–‹å§‹` â†’ è»¢é€é–‹å§‹
- `âœ… Render forward successful` â†’ è»¢é€æˆåŠŸ

---

## 18. ğŸ“š ä»˜éŒ²

### A. ä¸»è¦ãªã‚³ãƒŸãƒƒãƒˆå±¥æ­´

| æ—¥ä»˜ | ã‚³ãƒŸãƒƒãƒˆ | å†…å®¹ |
|------|---------|------|
| 2024-10-23 | `5dbf4d5` | updated_at ã‚¨ãƒ©ãƒ¼ä¿®æ­£ + ã‚¹ãƒãƒ›OSãƒãƒ¼ã‚¸ãƒ§ãƒ³è©³ç´°å–å¾— |
| 2024-10-22 | `892b06c` | LINE Profile UPSERT è¿½åŠ ï¼ˆæ—¢å­˜å‹é”ã® LINE åè¨˜éŒ²ï¼‰ |
| 2024-10-21 | `d140a7b` | await forwardToRender ä¿®æ­£ï¼ˆé–¢æ•°æ—©æœŸçµ‚äº†é˜²æ­¢ï¼‰ |
| 2024-10-20 | `80aa2ab` | è¾›å£ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç™ºè¦‹ã—ãŸãƒã‚°å…¨ä¿®æ­£ï¼ˆN+1ã‚¯ã‚¨ãƒªç­‰ï¼‰ |
| 2024-10-19 | `7c9e1a3` | 4æ®µéšä»£ç†åº—åˆ¶åº¦å®Ÿè£…ï¼ˆæ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ï¼‰ |
| 2024-10-18 | `6b8d2e1` | LINE Loginé€£æºå®Ÿè£…ï¼ˆOAuth 2.0ï¼‰ |
| 2024-10-17 | `5a7c3f2` | SendGridãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Ÿè£…ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆï¼‰ |
| 2024-10-16 | `4d6b1e9` | Stripe Webhooké€£æºå®Ÿè£…ï¼ˆæ±ºæ¸ˆå‡¦ç†ï¼‰ |
| 2024-10-15 | `3e5a9d8` | CSRFä¿è­·ãƒ»ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰ |

---

### B. ä»Šå¾Œã®æ”¹å–„æ¡ˆ

#### å„ªå…ˆåº¦: é«˜
1. **Redis/Upstash ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: ãƒ¡ãƒ¢ãƒªãƒ™ãƒ¼ã‚¹ã®åˆ¶é™ã‚’Redisã«ç§»è¡Œ
2. **A/Bãƒ†ã‚¹ãƒˆæ©Ÿèƒ½**: ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ã®åŠ¹æœæ¸¬å®š
3. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆ**: WebSocket ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

#### å„ªå…ˆåº¦: ä¸­
1. **QRã‚³ãƒ¼ãƒ‰ã«è¨ªå•IDåŸ‹ã‚è¾¼ã¿**: ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã®æ­£ç¢ºæ€§å‘ä¸Š
2. **ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½**: CSV/Excel ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
3. **å¤šè¨€èªå¯¾å¿œ**: è‹±èªãƒ»ä¸­å›½èªå¯¾å¿œ

#### å„ªå…ˆåº¦: ä½
1. **ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰**: ç®¡ç†ç”»é¢ã®ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
2. **PWAåŒ–**: Progressive Web AppåŒ–

---

### C. å‚è€ƒãƒªãƒ³ã‚¯

- **Netlify Functions**: https://docs.netlify.com/functions/overview/
- **Supabase JS Client**: https://supabase.com/docs/reference/javascript/introduction
- **SendGrid**: https://docs.sendgrid.com/
- **Stripe Webhooks**: https://stripe.com/docs/webhooks
- **LINE Login**: https://developers.line.biz/ja/docs/line-login/
- **Alpine.js**: https://alpinejs.dev/
- **Chart.js**: https://www.chartjs.org/
- **bcrypt.js**: https://github.com/dcodeIO/bcrypt.js
- **jsonwebtoken**: https://github.com/auth0/node-jsonwebtoken

---

**Netlifyå´ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆçµ‚äº†ï¼ˆv3.0ï¼‰**

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ Netlify å´ã‚·ã‚¹ãƒ†ãƒ ã®å®Œå…¨ãªãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã§ã™ã€‚
å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã¯ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚åˆã‚ã›ã¦æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

**æ›´æ–°å±¥æ­´:**
- v3.0 (2024-10-23): è¾›å£ãƒã‚§ãƒƒã‚¯å¾Œå…¨é¢æ”¹è¨‚ã€32 Functionså®Œå…¨è¨˜è¼‰ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨è¨˜è¼‰
- v2.0 (2024-10-23): åˆå›ä½œæˆï¼ˆ4 Functionsã®ã¿è¨˜è¼‰ã€ä¸å®Œå…¨ç‰ˆï¼‰
