# ğŸ” ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ 404 ã‚¨ãƒ©ãƒ¼ ãƒ‡ãƒãƒƒã‚°ã‚¬ã‚¤ãƒ‰

## ğŸ¯ å•é¡Œã®æ¦‚è¦

ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ï¼ˆ`/t/[tracking_code]`ï¼‰ã‚’é–‹ãã¨ã€Netlifyã®404ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚

## ğŸ“Š å®Ÿè£…ã—ãŸè¨ºæ–­æ©Ÿèƒ½

### 1. è©³ç´°ãƒ­ã‚°ã®è¿½åŠ 

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªãƒ­ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼š

#### `track-redirect.js` - ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆé–¢æ•°
- ğŸ”— Functionå‘¼ã³å‡ºã—ãƒ­ã‚°
- ğŸ“ ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¹ã¨ãƒ¡ã‚½ãƒƒãƒ‰
- ğŸ” ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ¼ãƒ‰æŠ½å‡ºãƒ­ã‚°
- ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢ãƒ­ã‚°
- âœ…/âŒ å„ã‚¹ãƒ†ãƒƒãƒ—ã®æˆåŠŸ/å¤±æ•—ãƒ­ã‚°
- ğŸš€ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè¡Œãƒ­ã‚°
- ğŸ“Š è¨ªå•ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ãƒ­ã‚°

#### `agency-create-link.js` - ãƒªãƒ³ã‚¯ä½œæˆé–¢æ•°
- âœ… ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ­ã‚°
- ğŸ”— ãƒªãƒ³ã‚¯ä½œæˆå‡¦ç†ãƒ­ã‚°
- ğŸ“Š ä½œæˆã•ã‚ŒãŸãƒªãƒ³ã‚¯ã®è©³ç´°æƒ…å ±
- âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°ãƒ­ã‚°

### 2. ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«

#### `test-redirect.html` - ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸
ã‚¢ã‚¯ã‚»ã‚¹: `https://your-site.netlify.app/test-redirect.html`

æ©Ÿèƒ½ï¼š
- ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆ
- ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã®å‹•ä½œç¢ºèª
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è©³ç´°è¡¨ç¤º
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°è¡¨ç¤º

## ğŸ” è€ƒãˆã‚‰ã‚Œã‚‹åŸå› ã¨è¨ºæ–­æ–¹æ³•

### åŸå›  1: ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å­˜åœ¨ã—ãªã„

**ç—‡çŠ¶:**
- 404ã‚¨ãƒ©ãƒ¼
- ãƒ­ã‚°ã«ã€ŒTracking link not foundã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

**è¨ºæ–­æ–¹æ³•:**
1. Supabase Dashboardã«ãƒ­ã‚°ã‚¤ãƒ³
2. Table Editor â†’ `agency_tracking_links` ã‚’é–‹ã
3. ä½œæˆã—ãŸãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢
4. ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª

**è§£æ±ºæ–¹æ³•:**
- ãƒªãƒ³ã‚¯ã‚’å†ä½œæˆ
- `is_active` ã‚«ãƒ©ãƒ ãŒ `true` ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª

### åŸå›  2: Netlify Function ãŒæ­£ã—ããƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ãªã„

**ç—‡çŠ¶:**
- 404ã‚¨ãƒ©ãƒ¼
- Netlify ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ404ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**è¨ºæ–­æ–¹æ³•:**
```bash
# Netlify CLIã§ç¢ºèª
netlify functions:list

# å‡ºåŠ›ã« track-redirect ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
```

**è§£æ±ºæ–¹æ³•:**
```bash
# å†ãƒ‡ãƒ—ãƒ­ã‚¤
git add .
git commit -m "Update track-redirect function with logging"
git push origin main
```

### åŸå›  3: ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

**ç—‡çŠ¶:**
- 500ã‚¨ãƒ©ãƒ¼
- ãƒ­ã‚°ã«ã€ŒMissing Supabase environment variablesã€

**è¨ºæ–­æ–¹æ³•:**
Netlify Dashboard:
1. Site settings â†’ Environment variables
2. ä»¥ä¸‹ã®å¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª:
   - `SUPABASE_URL`
   - `SUPABASE_SERVICE_ROLE_KEY`
   - `JWT_SECRET`

**è§£æ±ºæ–¹æ³•:**
- ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ /æ›´æ–°
- ã‚µã‚¤ãƒˆã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤

### åŸå›  4: netlify.toml ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®šã®å•é¡Œ

**è¨ºæ–­æ–¹æ³•:**
`netlify.toml` ã‚’ç¢ºèªï¼š

```toml
[[redirects]]
  from = "/t/:tracking_code"
  to = "/.netlify/functions/track-redirect/:tracking_code"
  status = 200
```

**è§£æ±ºæ–¹æ³•:**
- è¨­å®šãŒæ­£ã—ã„ã“ã¨ã‚’ç¢ºèª
- `status = 200` (ãƒ—ãƒ­ã‚­ã‚·)ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª

### åŸå›  5: Function ã®ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼

**è¨ºæ–­æ–¹æ³•:**
```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆ
netlify dev

# ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:8888/t/test-code ã«ã‚¢ã‚¯ã‚»ã‚¹
```

Netlify Dashboard ã§ãƒ­ã‚°ã‚’ç¢ºèª:
1. Functions â†’ track-redirect
2. Logs ã‚¿ãƒ–ã‚’é–‹ã
3. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª

## ğŸ› ï¸ ãƒ‡ãƒãƒƒã‚°æ‰‹é †ï¼ˆæ¨å¥¨ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ— 1: ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã§ãƒ†ã‚¹ãƒˆ

1. `https://your-site.netlify.app/test-redirect.html` ã‚’é–‹ã
2. ä½œæˆã—ãŸãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›
3. ã€Œãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. çµæœã¨ãƒ­ã‚°ã‚’ç¢ºèª

### ã‚¹ãƒ†ãƒƒãƒ— 2: Netlify Function ãƒ­ã‚°ã‚’ç¢ºèª

```bash
# Netlify CLI ã‚’ä½¿ç”¨
netlify functions:log track-redirect

# ã¾ãŸã¯ Netlify Dashboard ã§ç¢ºèª
# Functions â†’ track-redirect â†’ Logs
```

### ã‚¹ãƒ†ãƒƒãƒ— 3: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç¢ºèª

1. Supabase Dashboard ã«ãƒ­ã‚°ã‚¤ãƒ³
2. Table Editor â†’ `agency_tracking_links`
3. ä½œæˆã—ãŸãƒªãƒ³ã‚¯ã‚’æ¤œç´¢
4. ä»¥ä¸‹ã‚’ç¢ºèª:
   - `tracking_code` ãŒæ­£ã—ã„ã‹
   - `is_active` ãŒ `true` ã‹
   - `line_friend_url` ã¾ãŸã¯ `destination_url` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹

### ã‚¹ãƒ†ãƒƒãƒ— 4: ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆ

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§
cd /mnt/c/Users/ooxmi/Downloads/gas-generator/netlify-tracking

# Netlify Dev ã‚’èµ·å‹•
netlify dev

# åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ãƒ†ã‚¹ãƒˆ
curl -v http://localhost:8888/t/your-tracking-code
```

## ğŸ“‹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ç¢ºèª:

- [ ] `netlify.toml` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®šãŒã‚ã‚‹
- [ ] ç’°å¢ƒå¤‰æ•°ãŒã™ã¹ã¦è¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] Supabase ãƒ†ãƒ¼ãƒ–ãƒ« `agency_tracking_links` ãŒå­˜åœ¨ã™ã‚‹
- [ ] Function ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ï¼ˆ`netlify functions:list`ï¼‰
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã—ã¦å‹•ä½œã—ã¦ã„ã‚‹ï¼ˆ`netlify dev`ï¼‰
- [ ] ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã§ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ¼ãƒ‰ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° ã‚³ãƒãƒ³ãƒ‰

```bash
# Function ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
netlify functions:list

# Function ã®ãƒ­ã‚°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèª
netlify functions:log track-redirect --follow

# ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œ
netlify dev

# ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ…‹ã‚’ç¢ºèª
netlify status

# Function ã‚’æ‰‹å‹•ã§ãƒ†ã‚¹ãƒˆ
curl -v https://your-site.netlify.app/t/test-code
```

## ğŸ“ ã‚µãƒãƒ¼ãƒˆæƒ…å ±

### ãƒ­ã‚°ã®è¦‹æ–¹

**æˆåŠŸæ™‚:**
```
ğŸ”— Track-redirect function called
ğŸ“ Full path: /t/abc123xyz789
ğŸ” Extracted tracking code: abc123xyz789
âœ… Tracking link found: {...}
ğŸš€ Redirecting to: https://line.me/...
```

**å¤±æ•—æ™‚ï¼ˆãƒªãƒ³ã‚¯ãŒå­˜åœ¨ã—ãªã„ï¼‰:**
```
ğŸ”— Track-redirect function called
ğŸ“ Full path: /t/invalid-code
ğŸ” Extracted tracking code: invalid-code
âš ï¸ Tracking link not found: invalid-code
```

**å¤±æ•—æ™‚ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ï¼‰:**
```
ğŸ”— Track-redirect function called
ğŸ“ Full path: /t/abc123xyz789
âŒ Database error when fetching tracking link: {...}
```

### ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨è§£æ±ºç­–

| ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | åŸå›  | è§£æ±ºç­– |
|-----------------|------|-------|
| "Tracking code not found" | ãƒ‘ã‚¹ã«ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ¼ãƒ‰ãŒãªã„ | URLã‚’ç¢ºèª |
| "Tracking link not found" | DBã«ãƒªãƒ³ã‚¯ãŒå­˜åœ¨ã—ãªã„ | ãƒªãƒ³ã‚¯ã‚’å†ä½œæˆ |
| "Missing Supabase environment variables" | ç’°å¢ƒå¤‰æ•°æœªè¨­å®š | Netlifyã§è¨­å®š |
| "Database error" | Supabaseæ¥ç¶šã‚¨ãƒ©ãƒ¼ | èªè¨¼æƒ…å ±ã‚’ç¢ºèª |
| Netlify 404ãƒšãƒ¼ã‚¸ | FunctionãŒå‘¼ã°ã‚Œã¦ã„ãªã„ | netlify.tomlç¢ºèª |

## ğŸ“ è¿½åŠ ã®è¨ºæ–­æƒ…å ±

### NODE_ENV ã®ç¢ºèª

æœ¬ç•ªç’°å¢ƒã§ã¯ã€å¤šãã®ãƒ­ã‚°ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¾ã™ã€‚
é–‹ç™ºç’°å¢ƒã§è©³ç´°ãªãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹ã«ã¯:

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º
netlify dev

# ã¾ãŸã¯ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
export NODE_ENV=development
```

### æœ¬ç•ªç’°å¢ƒã§ã®ãƒ­ã‚°ç¢ºèª

```bash
# Netlify CLI ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç¢ºèª
netlify functions:log track-redirect --follow

# ã¾ãŸã¯ Netlify Dashboard
# https://app.netlify.com/sites/your-site/functions/track-redirect
```

---

**ä½œæˆæ—¥:** 2025-10-17
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 1.0
**é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«:** track-redirect.js, agency-create-link.js, test-redirect.html
