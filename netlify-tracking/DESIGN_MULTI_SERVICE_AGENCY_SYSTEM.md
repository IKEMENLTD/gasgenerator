# ãƒãƒ«ãƒã‚µãƒ¼ãƒ“ã‚¹å‹ä»£ç†åº—ã‚·ã‚¹ãƒ†ãƒ  è¨­è¨ˆæ›¸ v1.0

**ä½œæˆæ—¥**: 2025-01-21
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æœ€çµ‚ç‰ˆ
**å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ **: TaskMate AI ä»£ç†åº—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#1-æ¦‚è¦)
2. [ç¾çŠ¶åˆ†æ](#2-ç¾çŠ¶åˆ†æ)
3. [è¦ä»¶å®šç¾©](#3-è¦ä»¶å®šç¾©)
4. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ](#4-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ)
5. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#5-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
6. [ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIè¨­è¨ˆ](#6-ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰apiè¨­è¨ˆ)
7. [ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­è¨ˆ](#7-ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­è¨ˆ)
8. [ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆ](#8-ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆ)
9. [ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»](#9-ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»)
10. [å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#10-å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)
11. [ãƒªã‚¹ã‚¯åˆ†æ](#11-ãƒªã‚¹ã‚¯åˆ†æ)
12. [ä»˜éŒ²](#12-ä»˜éŒ²)

---

## 1. æ¦‚è¦

### 1.1 ç›®çš„

ç¾åœ¨ã® TaskMate AI å°‚ç”¨ä»£ç†åº—ã‚·ã‚¹ãƒ†ãƒ ã‚’ã€**è¤‡æ•°ã®å…¬å¼LINEã‚µãƒ¼ãƒ“ã‚¹ã‚’1ã¤ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç®¡ç†ã§ãã‚‹ãƒãƒ«ãƒã‚µãƒ¼ãƒ“ã‚¹å‹ã‚·ã‚¹ãƒ†ãƒ **ã«æ‹¡å¼µã™ã‚‹ã€‚

### 1.2 è¨­è¨ˆåŸå‰‡

- **Single Source of Truth**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯1ã¤ï¼ˆSupabaseï¼‰
- **Service Isolation**: ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ç‹¬ç«‹ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
- **Centralized Management**: ä»£ç†åº—ç®¡ç†ã¯1ã¤ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- **Flexible Commission**: ã‚µãƒ¼ãƒ“ã‚¹Ã—ä»£ç†åº—ã”ã¨ã«ç•°ãªã‚‹å ±é…¬ç‡
- **Backward Compatibility**: æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã‚’å£Šã•ãªã„æ®µéšçš„ç§»è¡Œ

### 1.3 ã‚¹ã‚³ãƒ¼ãƒ—

**å¯¾è±¡**:
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒæ‹¡å¼µ
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIä¿®æ­£
- ä»£ç†åº—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰UIæ‹¡å¼µ
- å„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°æ©Ÿèƒ½å®Ÿè£…

**å¯¾è±¡å¤–**:
- å„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™º
- ç®¡ç†è€…å‘ã‘ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†ç”»é¢ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
- è‡ªå‹•æ”¯æ‰•ã„ã‚·ã‚¹ãƒ†ãƒ 

---

## 2. ç¾çŠ¶åˆ†æ

### 2.1 ç¾è¡Œã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
TaskMate AI (1ã‚µãƒ¼ãƒ“ã‚¹å°‚ç”¨)
â”œâ”€ Domain: taskmateai.net
â”œâ”€ Database: Supabase (å˜ä¸€ã‚µãƒ¼ãƒ“ã‚¹æƒ³å®š)
â”œâ”€ Backend: Netlify Functions
â””â”€ Frontend: ä»£ç†åº—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

åˆ¶é™äº‹é …:
âŒ è¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾å¿œã—ã¦ã„ãªã„
âŒ ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã®å ±é…¬ç‡è¨­å®šãŒã§ããªã„
âŒ åˆ¥ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã®é‹ç”¨ãŒã§ããªã„
```

### 2.2 èª²é¡Œ

1. **ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰**
   - LINEèªè¨¼æƒ…å ±ãŒç’°å¢ƒå¤‰æ•°ã®ã¿
   - ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ ã«ã¯ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãŒå¿…é ˆ

2. **ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºå®š**
   - taskmateai.net ä»¥å¤–ã§é‹ç”¨ã§ããªã„
   - æ–°ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ æ™‚ã«åˆ¥ãƒªãƒã‚¸ãƒˆãƒªãŒå¿…è¦

3. **å ±é…¬ç‡å›ºå®š**
   - å…¨ä»£ç†åº—ä¸€å¾‹20%
   - ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã®æŸ”è»Ÿãªè¨­å®šä¸å¯

4. **ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ä¸å¯**
   - ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ã®çµ±è¨ˆãŒå–ã‚Œãªã„
   - æ··åœ¨ãƒªã‚¹ã‚¯

---

## 3. è¦ä»¶å®šç¾©

### 3.1 æ©Ÿèƒ½è¦ä»¶

#### FR-1: ãƒãƒ«ãƒã‚µãƒ¼ãƒ“ã‚¹å¯¾å¿œ
- [ ] è¤‡æ•°ã®å…¬å¼LINEã‚µãƒ¼ãƒ“ã‚¹ã‚’ç™»éŒ²å¯èƒ½
- [ ] ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ç‹¬ç«‹ã—ãŸLINEèªè¨¼æƒ…å ±
- [ ] ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ç‹¬ç«‹ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³

#### FR-2: çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- [ ] 1ã¤ã®ä»£ç†åº—ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§å…¨ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†
- [ ] ã‚µãƒ¼ãƒ“ã‚¹é¸æŠãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- [ ] å…¨ã‚µãƒ¼ãƒ“ã‚¹çµ±åˆçµ±è¨ˆè¡¨ç¤º

#### FR-3: æŸ”è»Ÿãªå ±é…¬è¨­å®š
- [ ] ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå ±é…¬ç‡
- [ ] ä»£ç†åº—Ã—ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã®å€‹åˆ¥å ±é…¬ç‡
- [ ] ãƒªãƒ•ã‚¡ãƒ©ãƒ«å ±é…¬ã‚‚ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«è¨­å®šå¯èƒ½

#### FR-4: ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
- [ ] ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ç•°ãªã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ç”Ÿæˆ
- [ ] ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’è‡ªå‹•è­˜åˆ¥
- [ ] ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ã®ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ²

#### FR-5: ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã¨çµ±åˆ
- [ ] ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿åˆ†é›¢
- [ ] å…¨ã‚µãƒ¼ãƒ“ã‚¹çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ
- [ ] ã‚µãƒ¼ãƒ“ã‚¹é–“ã§ã®ãƒ‡ãƒ¼ã‚¿æ··åœ¨é˜²æ­¢

### 3.2 éæ©Ÿèƒ½è¦ä»¶

#### NFR-1: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- API ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: 500ms ä»¥å†…
- ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ æ™‚ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´: ä¸è¦

#### NFR-2: ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£
- ã‚µãƒ¼ãƒ“ã‚¹æ•°: ç„¡åˆ¶é™ï¼ˆDBå®¹é‡ã®ç¯„å›²å†…ï¼‰
- ä»£ç†åº—æ•°: 10,000 ä»£ç†åº—ã¾ã§å¯¾å¿œ

#### NFR-3: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ç‹¬ç«‹ã—ãŸLINEç½²åæ¤œè¨¼
- CORSè¨­å®šã§è¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯

#### NFR-4: ä¿å®ˆæ€§
- ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ ã¯DBç™»éŒ²ã®ã¿
- æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¸ã®å½±éŸ¿æœ€å°åŒ–

---

## 4. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### 4.1 å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Supabaseï¼ˆå…±é€šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰                â”‚
â”‚  - agenciesï¼ˆä»£ç†åº—ãƒã‚¹ã‚¿ãƒ¼ï¼‰                         â”‚
â”‚  - servicesï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒã‚¹ã‚¿ãƒ¼ï¼‰                       â”‚
â”‚  - agency_service_settingsï¼ˆä»£ç†åº—Ã—ã‚µãƒ¼ãƒ“ã‚¹è¨­å®šï¼‰    â”‚
â”‚  - agency_tracking_linksï¼ˆãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ï¼‰       â”‚
â”‚  - agency_conversionsï¼ˆã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰              â”‚
â”‚  - line_profilesï¼ˆLINEãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†‘
                          â”‚ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†ç´„
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
        â†“                 â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»£ç†åº—ç®¡ç†     â”‚  â”‚ TaskMate AI  â”‚  â”‚ Service B    â”‚
â”‚ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â”‚  â”‚              â”‚  â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Domain:       â”‚  â”‚ Domain:      â”‚  â”‚ Domain:      â”‚
â”‚ agency.       â”‚  â”‚ taskmateai   â”‚  â”‚ newservice   â”‚
â”‚ platform.com  â”‚  â”‚ .net         â”‚  â”‚ .com         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ©Ÿèƒ½:         â”‚  â”‚ æ©Ÿèƒ½:        â”‚  â”‚ æ©Ÿèƒ½:        â”‚
â”‚ - å…¨ã‚µãƒ¼ãƒ“ã‚¹  â”‚  â”‚ - ã‚¢ãƒ—ãƒª     â”‚  â”‚ - ã‚¢ãƒ—ãƒª     â”‚
â”‚   çµ±åˆç®¡ç†    â”‚  â”‚ - LP         â”‚  â”‚ - LP         â”‚
â”‚ - ãƒªãƒ³ã‚¯ç”Ÿæˆ  â”‚  â”‚ - /t/:code   â”‚  â”‚ - /t/:code   â”‚
â”‚ - çµ±è¨ˆè¡¨ç¤º    â”‚  â”‚   ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆâ”‚  â”‚   ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆâ”‚
â”‚ - å ±é…¬ç®¡ç†    â”‚  â”‚              â”‚  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ å…±é€šãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API    â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚ Netlify Functions     â”‚
              â”‚ - LINE Webhook        â”‚
              â”‚ - ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°è¨˜éŒ²    â”‚
              â”‚ - çµ±è¨ˆè¨ˆç®—            â”‚
              â”‚ - å ±é…¬è¨ˆç®—            â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†‘
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
        â†“                 â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LINEå…¬å¼      â”‚  â”‚ LINEå…¬å¼      â”‚  â”‚ LINEå…¬å¼      â”‚
â”‚ TaskMate AI   â”‚  â”‚ Service B     â”‚  â”‚ Service C     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

#### ã‚±ãƒ¼ã‚¹1: ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ç”Ÿæˆ

```
ä»£ç†åº—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
  â†“
1. ã‚µãƒ¼ãƒ“ã‚¹é¸æŠï¼ˆä¾‹: TaskMate AIï¼‰
  â†“
2. POST /agency-create-link
   {
     service_id: "taskmate-uuid",
     utm_campaign: "æ˜¥ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³"
   }
  â†“
3. DB: services ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ tracking_base_url å–å¾—
   â†’ "https://taskmateai.net/t"
  â†“
4. ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ: "abc123"
  â†“
5. å®ŒæˆURL: "https://taskmateai.net/t/abc123"
  â†“
6. DB: agency_tracking_links ã«ä¿å­˜
   - service_id: taskmate-uuid
   - tracking_code: abc123
   - agency_id: xxx
```

#### ã‚±ãƒ¼ã‚¹2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼
  â†“
1. ã‚¯ãƒªãƒƒã‚¯: https://taskmateai.net/t/abc123
  â†“
2. GET /track-redirect?code=abc123
  â†“
3. DB: tracking_code ã‹ã‚‰ service_id, agency_id å–å¾—
  â†“
4. ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²ï¼ˆagency_tracking_visitsï¼‰
   - service_id: taskmate-uuid
   - agency_id: xxx
   - visitor_ip, user_agent, etc.
  â†“
5. visit_count ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
  â†“
6. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆå–å¾—ï¼ˆservices.app_redirect_urlï¼‰
   â†’ "https://taskmateai.net/app"
  â†“
7. 302 Redirect
```

#### ã‚±ãƒ¼ã‚¹3: LINEå‹é”è¿½åŠ 

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒLINEå‹é”è¿½åŠ 
  â†“
1. LINE Webhook â†’ POST /.netlify/functions/line-webhook?service=taskmate
  â†“
2. service_id å–å¾—ï¼ˆã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¾ãŸã¯ãƒ‘ã‚¹ï¼‰
  â†“
3. DB: services ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ LINEèªè¨¼æƒ…å ±å–å¾—
  â†“
4. ç½²åæ¤œè¨¼ï¼ˆã‚µãƒ¼ãƒ“ã‚¹å›ºæœ‰ã® channel_secretï¼‰
  â†“
5. ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œç´¢ï¼ˆéå»1æ™‚é–“ä»¥å†…ï¼‰
   WHERE service_id = taskmate-uuid
     AND visitor_ip = xxx
  â†“
6. ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ²ï¼ˆagency_conversionsï¼‰
   - service_id: taskmate-uuid
   - agency_id: xxx
   - conversion_type: line_friend
  â†“
7. conversion_count ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
  â†“
8. å ±é…¬è¨ˆç®—
   - agency_service_settings ã‹ã‚‰å ±é…¬ç‡å–å¾—
   - ãªã‘ã‚Œã° services.default_commission_rate
```

### 4.3 ãƒ‰ãƒ¡ã‚¤ãƒ³æ§‹æˆ

#### ãƒ‘ã‚¿ãƒ¼ãƒ³: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å‹ï¼ˆæ¨å¥¨ï¼‰

```
1. å…±é€šãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API
   Domain: api.platform.comï¼ˆã¾ãŸã¯æ—¢å­˜ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰
   å½¹å‰²: Netlify Functions ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°

2. ä»£ç†åº—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
   Domain: agency.platform.com
   å½¹å‰²: å…¨ã‚µãƒ¼ãƒ“ã‚¹çµ±åˆç®¡ç†ç”»é¢

3. TaskMate AI
   Domain: taskmateai.net
   å½¹å‰²: TaskMate ã‚¢ãƒ—ãƒª + ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
   APIå‘¼ã³å‡ºã—å…ˆ: api.platform.com

4. Service B
   Domain: newservice.com
   å½¹å‰²: Service B ã‚¢ãƒ—ãƒª + ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
   APIå‘¼ã³å‡ºã—å…ˆ: api.platform.com
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯1ç®‡æ‰€ï¼ˆä¿å®ˆæ€§å‘ä¸Šï¼‰
- âœ… ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«å®Œå…¨ç‹¬ç«‹ã—ãŸãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
- âœ… æ–°ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ æ™‚ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã¿ä½œæˆ

---

## 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 5.1 æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«

#### 5.1.1 `services` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒã‚¹ã‚¿ãƒ¼ï¼‰

```sql
CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- åŸºæœ¬æƒ…å ±
  name TEXT NOT NULL,
  description TEXT,
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'maintenance')),

  -- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»URLè¨­å®š
  domain TEXT UNIQUE NOT NULL,
  tracking_base_url TEXT NOT NULL,           -- ä¾‹: https://taskmateai.net/t
  app_redirect_url TEXT NOT NULL,            -- ä¾‹: https://taskmateai.net/app
  line_add_redirect_url TEXT,                -- LINEå‹é”è¿½åŠ å¾Œã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆ

  -- LINEè¨­å®š
  line_channel_id TEXT UNIQUE NOT NULL,
  line_channel_secret TEXT NOT NULL,
  line_channel_access_token TEXT NOT NULL,
  line_official_url TEXT NOT NULL,           -- ä¾‹: https://lin.ee/xxx

  -- å ±é…¬è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
  default_commission_rate DECIMAL(5,2) NOT NULL DEFAULT 20.00,
  default_referral_rate DECIMAL(5,2) NOT NULL DEFAULT 2.00,
  subscription_price INTEGER NOT NULL DEFAULT 10000,  -- æœˆé¡æ–™é‡‘ï¼ˆå††ï¼‰

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_services_status ON services(status);
CREATE INDEX idx_services_domain ON services(domain);

-- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
INSERT INTO services (
  name, description, domain, tracking_base_url, app_redirect_url,
  line_channel_id, line_channel_secret, line_channel_access_token, line_official_url,
  default_commission_rate, default_referral_rate, subscription_price
) VALUES (
  'TaskMate AI',
  'AIæ­è¼‰ã®ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ',
  'taskmateai.net',
  'https://taskmateai.net/t',
  'https://taskmateai.net/app',
  'LINE_CHANNEL_ID_TASKMATE',
  'LINE_CHANNEL_SECRET_TASKMATE',
  'LINE_ACCESS_TOKEN_TASKMATE',
  'https://lin.ee/FMy4xlx',
  20.00,
  2.00,
  10000
);
```

#### 5.1.2 `agency_service_settings` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä»£ç†åº—Ã—ã‚µãƒ¼ãƒ“ã‚¹è¨­å®šï¼‰

```sql
CREATE TABLE agency_service_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- é–¢é€£
  agency_id UUID NOT NULL REFERENCES agencies(id) ON DELETE CASCADE,
  service_id UUID NOT NULL REFERENCES services(id) ON DELETE CASCADE,

  -- ã‚«ã‚¹ã‚¿ãƒ å ±é…¬ç‡ï¼ˆNULL ã®å ´åˆã¯ services.default_* ã‚’ä½¿ç”¨ï¼‰
  commission_rate DECIMAL(5,2),              -- ä¾‹: 25.00 (25%)
  referral_rate DECIMAL(5,2),                -- ä¾‹: 3.00 (3%)

  -- çŠ¶æ…‹
  is_active BOOLEAN DEFAULT true,

  -- ãƒ¡ãƒ¢
  notes TEXT,

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  UNIQUE(agency_id, service_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_agency_service_settings_agency ON agency_service_settings(agency_id);
CREATE INDEX idx_agency_service_settings_service ON agency_service_settings(service_id);
CREATE INDEX idx_agency_service_settings_active ON agency_service_settings(is_active);
```

#### 5.1.3 `line_profile_services` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆLINEãƒ¦ãƒ¼ã‚¶ãƒ¼Ã—ã‚µãƒ¼ãƒ“ã‚¹é–¢é€£ï¼‰

```sql
-- LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹ã§å‹é”è¿½åŠ ã™ã‚‹å¯èƒ½æ€§ã«å¯¾å¿œ
CREATE TABLE line_profile_services (
  line_user_id TEXT NOT NULL REFERENCES line_profiles(user_id) ON DELETE CASCADE,
  service_id UUID NOT NULL REFERENCES services(id) ON DELETE CASCADE,

  is_friend BOOLEAN DEFAULT true,
  added_at TIMESTAMP DEFAULT NOW(),
  unfollowed_at TIMESTAMP,

  PRIMARY KEY (line_user_id, service_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_line_profile_services_service ON line_profile_services(service_id);
CREATE INDEX idx_line_profile_services_is_friend ON line_profile_services(is_friend);
```

### 5.2 æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‹¡å¼µ

#### 5.2.1 `agency_tracking_links`

```sql
ALTER TABLE agency_tracking_links
  ADD COLUMN service_id UUID REFERENCES services(id) ON DELETE RESTRICT;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
CREATE INDEX idx_agency_tracking_links_service ON agency_tracking_links(service_id);

-- NOT NULLåˆ¶ç´„ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå¾Œï¼‰
-- ALTER TABLE agency_tracking_links ALTER COLUMN service_id SET NOT NULL;
```

#### 5.2.2 `agency_tracking_visits`

```sql
ALTER TABLE agency_tracking_visits
  ADD COLUMN service_id UUID REFERENCES services(id) ON DELETE RESTRICT;

CREATE INDEX idx_agency_tracking_visits_service ON agency_tracking_visits(service_id);
```

#### 5.2.3 `agency_conversions`

```sql
ALTER TABLE agency_conversions
  ADD COLUMN service_id UUID REFERENCES services(id) ON DELETE RESTRICT;

CREATE INDEX idx_agency_conversions_service ON agency_conversions(service_id);
```

#### 5.2.4 `agency_commissions`

```sql
ALTER TABLE agency_commissions
  ADD COLUMN service_id UUID REFERENCES services(id) ON DELETE RESTRICT;

CREATE INDEX idx_agency_commissions_service ON agency_commissions(service_id);
```

### 5.3 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ERå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  services    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)      â”‚â—„â”€â”€â”€â”€â”€â”
â”‚ name         â”‚      â”‚
â”‚ domain       â”‚      â”‚
â”‚ line_*       â”‚      â”‚
â”‚ default_*    â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                            â”‚
        â”‚                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ agency_service_  â”‚     â”‚ agency_tracking_links  â”‚
â”‚ settings         â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     â”‚ id (PK)                â”‚
â”‚ id (PK)          â”‚     â”‚ agency_id (FK)         â”‚
â”‚ agency_id (FK)   â”‚     â”‚ service_id (FK) â—„â”€â”€â”€â”€â”€â”€â”¤
â”‚ service_id (FK)  â”‚     â”‚ tracking_code          â”‚
â”‚ commission_rate  â”‚     â”‚ visit_count            â”‚
â”‚ referral_rate    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
        â–²                            â”‚
        â”‚                            â–¼
        â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚ agency_tracking_visits â”‚
        â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                â”‚ tracking_link_id (FK)  â”‚
        â”‚                â”‚ service_id (FK)        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”         â”‚ visitor_ip             â”‚
â”‚  agencies    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚
â”‚ id (PK)      â”‚                     â”‚
â”‚ code         â”‚                     â–¼
â”‚ name         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ level        â”‚         â”‚ agency_conversions     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
                         â”‚ agency_id (FK)         â”‚
                         â”‚ service_id (FK)        â”‚
                         â”‚ line_user_id           â”‚
                         â”‚ conversion_type        â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ agency_commissions     â”‚
                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
                         â”‚ agency_id (FK)         â”‚
                         â”‚ service_id (FK)        â”‚
                         â”‚ commission_amount      â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIè¨­è¨ˆ

### 6.1 Webhookå‡¦ç†

#### 6.1.1 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­è¨ˆ

**æ¨å¥¨**: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ–¹å¼

```
/.netlify/functions/line-webhook?service={service_slug}

ä¾‹:
/.netlify/functions/line-webhook?service=taskmate
/.netlify/functions/line-webhook?service=serviceb
```

**ç†ç”±**:
- Netlify Functionsã§ãƒ‘ã‚¹å¤‰æ•°ãŒä½¿ã„ã¥ã‚‰ã„
- ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯å®Ÿè£…ãŒç°¡å˜
- LINE Developers ã§è¨­å®šã—ã‚„ã™ã„

#### 6.1.2 å®Ÿè£…ï¼ˆline-webhook.jsï¼‰

```javascript
// netlify/functions/line-webhook.js
const { createClient } = require('@supabase/supabase-js');
const crypto = require('crypto');

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

exports.handler = async (event) => {
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type, X-Line-Signature',
    'Access-Control-Allow-Methods': 'POST, OPTIONS'
  };

  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }

  try {
    // 1. ã‚µãƒ¼ãƒ“ã‚¹è­˜åˆ¥
    const serviceSlug = event.queryStringParameters?.service;
    if (!serviceSlug) {
      return {
        statusCode: 400,
        headers,
        body: JSON.stringify({ error: 'Missing service parameter' })
      };
    }

    // 2. ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±å–å¾—
    const { data: service, error: serviceError } = await supabase
      .from('services')
      .select('*')
      .eq('domain', `${serviceSlug}.*`)  // ç°¡æ˜“ãƒãƒƒãƒ”ãƒ³ã‚°
      .or(`name.ilike.%${serviceSlug}%`) // ã¾ãŸã¯åå‰ã§æ¤œç´¢
      .eq('status', 'active')
      .single();

    if (serviceError || !service) {
      console.error('Service not found:', serviceSlug);
      return {
        statusCode: 404,
        headers,
        body: JSON.stringify({ error: 'Service not found' })
      };
    }

    // 3. LINEç½²åæ¤œè¨¼ï¼ˆã‚µãƒ¼ãƒ“ã‚¹å›ºæœ‰ã®secretï¼‰
    const signature = event.headers['x-line-signature'];
    const body = event.body;

    const hash = crypto
      .createHmac('SHA256', service.line_channel_secret)
      .update(body)
      .digest('base64');

    if (signature !== hash) {
      return {
        statusCode: 401,
        headers,
        body: JSON.stringify({ error: 'Invalid signature' })
      };
    }

    // 4. ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
    const webhookBody = JSON.parse(body);
    const events = webhookBody.events;

    for (const evt of events) {
      await processLineEvent(evt, service);
    }

    return { statusCode: 200, headers, body: JSON.stringify({ success: true }) };

  } catch (error) {
    console.error('LINE webhook error:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Internal server error' })
    };
  }
};

async function processLineEvent(event, service) {
  if (event.type === 'follow') {
    await handleFollowEvent(event, service);
  } else if (event.type === 'unfollow') {
    await handleUnfollowEvent(event, service);
  }
  // ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—...
}

async function handleFollowEvent(event, service) {
  const userId = event.source.userId;

  // 1. LINEãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ãƒ»ä¿å­˜ï¼ˆæ—¢å­˜å‡¦ç†ï¼‰
  // ...

  // 2. line_profile_services ã«è¨˜éŒ²
  await supabase
    .from('line_profile_services')
    .upsert({
      line_user_id: userId,
      service_id: service.id,
      is_friend: true,
      added_at: new Date().toISOString()
    });

  // 3. ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œç´¢ï¼ˆéå»1æ™‚é–“ä»¥å†…ï¼‰
  const oneHourAgo = new Date(Date.now() - 3600000).toISOString();

  const { data: sessions } = await supabase
    .from('agency_tracking_visits')
    .select('tracking_link_id, agency_id, session_id')
    .eq('service_id', service.id)  // â† ã‚µãƒ¼ãƒ“ã‚¹ã§ãƒ•ã‚£ãƒ«ã‚¿
    .gte('created_at', oneHourAgo)
    .order('created_at', { ascending: false });

  if (!sessions || sessions.length === 0) {
    console.log('No matching session found for service:', service.name);
    return;
  }

  const session = sessions[0];

  // 4. ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ²
  const conversionData = {
    agency_id: session.agency_id,
    service_id: service.id,  // â† ã‚µãƒ¼ãƒ“ã‚¹IDè¨˜éŒ²
    line_user_id: userId,
    conversion_type: 'line_friend',
    tracking_link_id: session.tracking_link_id,
    session_id: session.session_id,
    metadata: {
      service_name: service.name,
      line_official_url: service.line_official_url
    }
  };

  await supabase
    .from('agency_conversions')
    .insert([conversionData]);

  // 5. conversion_count ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
  if (session.tracking_link_id) {
    await supabase
      .from('agency_tracking_links')
      .update({
        conversion_count: supabase.raw('conversion_count + 1')
      })
      .eq('id', session.tracking_link_id);
  }

  console.log(`Conversion recorded for service: ${service.name}`);
}
```

### 6.2 ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ç”ŸæˆAPI

#### 6.2.1 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```
POST /.netlify/functions/agency-create-link
```

#### 6.2.2 ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```json
{
  "service_id": "uuid",
  "name": "æ˜¥ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³",
  "utm_source": "twitter",
  "utm_medium": "social",
  "utm_campaign": "spring2025",
  "utm_term": "",
  "utm_content": ""
}
```

#### 6.2.3 å®Ÿè£…

```javascript
// netlify/functions/agency-create-link.js
exports.handler = async (event) => {
  // èªè¨¼å‡¦ç†...

  const { service_id, name, utm_source, utm_medium, utm_campaign } = JSON.parse(event.body);

  // 1. ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±å–å¾—
  const { data: service, error: serviceError } = await supabase
    .from('services')
    .select('tracking_base_url, status')
    .eq('id', service_id)
    .single();

  if (serviceError || !service || service.status !== 'active') {
    return {
      statusCode: 400,
      body: JSON.stringify({ error: 'Invalid or inactive service' })
    };
  }

  // 2. ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
  const trackingCode = generateTrackingCode(); // UUID ã¾ãŸã¯çŸ­ç¸®ã‚³ãƒ¼ãƒ‰

  // 3. ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ä¿å­˜
  const { data: link, error: linkError } = await supabase
    .from('agency_tracking_links')
    .insert({
      agency_id: agencyId,
      service_id: service_id,  // â† ã‚µãƒ¼ãƒ“ã‚¹IDä¿å­˜
      tracking_code: trackingCode,
      name: name,
      utm_source: utm_source,
      utm_medium: utm_medium,
      utm_campaign: utm_campaign,
      // ...
    })
    .select()
    .single();

  if (linkError) {
    console.error('Error creating link:', linkError);
    return {
      statusCode: 500,
      body: JSON.stringify({ error: 'Failed to create link' })
    };
  }

  // 4. å®Œå…¨URLç”Ÿæˆ
  const fullUrl = `${service.tracking_base_url}/${trackingCode}`;

  return {
    statusCode: 200,
    body: JSON.stringify({
      tracking_code: trackingCode,
      url: fullUrl,
      short_url: fullUrl  // çŸ­ç¸®URLæ©Ÿèƒ½ã¯å°†æ¥å®Ÿè£…
    })
  };
};

function generateTrackingCode() {
  // ãƒ©ãƒ³ãƒ€ãƒ 8æ–‡å­—ã®è‹±æ•°å­—
  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
  let code = '';
  for (let i = 0; i < 8; i++) {
    code += chars[Math.floor(Math.random() * chars.length)];
  }
  return code;
}
```

### 6.3 çµ±è¨ˆãƒ»åˆ†æAPI

#### 6.3.1 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```
GET /.netlify/functions/agency-stats?service_id={uuid}
GET /.netlify/functions/agency-analytics?service_id={uuid}
```

#### 6.3.2 å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

```javascript
// å…¨APIã§å…±é€šã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†

async function getStats(agencyId, serviceId = null) {
  let query = supabase
    .from('agency_tracking_links')
    .select('visit_count')
    .eq('agency_id', agencyId);

  // ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  if (serviceId && serviceId !== 'all') {
    query = query.eq('service_id', serviceId);
  }

  const { data } = await query;

  const totalClicks = data?.reduce((sum, link) => sum + (link.visit_count || 0), 0) || 0;

  return { totalClicks };
}
```

### 6.4 å ±é…¬è¨ˆç®—API

#### 6.4.1 å ±é…¬ç‡å–å¾—ãƒ­ã‚¸ãƒƒã‚¯

```javascript
async function getCommissionRate(agencyId, serviceId) {
  // 1. ä»£ç†åº—Ã—ã‚µãƒ¼ãƒ“ã‚¹è¨­å®šã‚’ç¢ºèª
  const { data: settings } = await supabase
    .from('agency_service_settings')
    .select('commission_rate')
    .eq('agency_id', agencyId)
    .eq('service_id', serviceId)
    .eq('is_active', true)
    .single();

  if (settings?.commission_rate) {
    return settings.commission_rate;
  }

  // 2. ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå ±é…¬ç‡ã‚’ä½¿ç”¨
  const { data: service } = await supabase
    .from('services')
    .select('default_commission_rate')
    .eq('id', serviceId)
    .single();

  return service?.default_commission_rate || 0;
}

async function calculateCommission(conversion) {
  const rate = await getCommissionRate(conversion.agency_id, conversion.service_id);

  // ã‚µãƒ¼ãƒ“ã‚¹ã®æœˆé¡æ–™é‡‘å–å¾—
  const { data: service } = await supabase
    .from('services')
    .select('subscription_price')
    .eq('id', conversion.service_id)
    .single();

  const subscriptionPrice = service?.subscription_price || 10000;
  const commissionAmount = subscriptionPrice * (rate / 100);

  return {
    rate: rate,
    amount: Math.round(commissionAmount)
  };
}
```

### 6.5 CORSè¨­å®š

```javascript
// ã™ã¹ã¦ã®APIé–¢æ•°ã§å…±é€š

const headers = {
  'Access-Control-Allow-Origin': '*',  // ã¾ãŸã¯è¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒªã‚¹ãƒˆ
  'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-Agency-Id',
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
  'Access-Control-Allow-Credentials': 'true'
};

// æœ¬ç•ªç’°å¢ƒã§ã¯å‹•çš„ã«è¨­å®š
const allowedOrigins = [
  'https://agency.platform.com',
  'https://taskmateai.net',
  'https://newservice.com'
];

const origin = event.headers.origin;
if (allowedOrigins.includes(origin)) {
  headers['Access-Control-Allow-Origin'] = origin;
}
```

---

## 7. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­è¨ˆ

### 7.1 ä»£ç†åº—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆçµ±åˆç®¡ç†ç”»é¢ï¼‰

#### 7.1.1 URLæ§‹æˆ

```
https://agency.platform.com/
â”œâ”€ /              ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
â”œâ”€ /dashboard     ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
â”‚   â”œâ”€ ?service=all          å…¨ã‚µãƒ¼ãƒ“ã‚¹è¡¨ç¤º
â”‚   â”œâ”€ ?service=taskmate     TaskMate AIã®ã¿
â”‚   â””â”€ ?service=serviceb     Service Bã®ã¿
```

#### 7.1.2 ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```javascript
// dashboard.js
{
  // ã‚µãƒ¼ãƒ“ã‚¹é¸æŠ
  selectedServiceId: 'all',  // 'all' | service_id
  services: [
    {
      id: 'uuid',
      name: 'TaskMate AI',
      domain: 'taskmateai.net',
      commission_rate: 20,  // ã“ã®ä»£ç†åº—ã®å ±é…¬ç‡
      status: 'active'
    },
    {
      id: 'uuid',
      name: 'Service B',
      domain: 'newservice.com',
      commission_rate: 15,
      status: 'active'
    }
  ],

  // çµ±è¨ˆï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ï¼‰
  stats: {
    totalLinks: 10,
    totalClicks: 500,
    totalConversions: 50,
    conversionRate: 10,
    monthlyCommission: 100000
  },

  // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ï¼ˆã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ä»˜ãï¼‰
  trackingLinks: [
    {
      id: 'xxx',
      service_id: 'uuid',
      service_name: 'TaskMate AI',
      service_color: '#10b981',  // ã‚µãƒ¼ãƒ“ã‚¹åˆ¥è‰²åˆ†ã‘
      tracking_code: 'abc123',
      url: 'https://taskmateai.net/t/abc123',
      visit_count: 100,
      conversion_count: 10
    }
  ]
}
```

#### 7.1.3 UIå¤‰æ›´

##### ã‚µãƒ¼ãƒ“ã‚¹é¸æŠUIï¼ˆå…¨ã‚¿ãƒ–å…±é€šï¼‰

```html
<!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¸Šéƒ¨ -->
<div class="service-selector bg-white rounded-lg border p-4 mb-6">
  <label class="text-sm font-medium text-gray-700 mb-2">ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿</label>
  <select x-model="selectedServiceId" @change="loadDashboardData()"
          class="w-full px-4 py-2 border rounded-lg">
    <option value="all">ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹</option>
    <template x-for="service in services" :key="service.id">
      <option :value="service.id" x-text="service.name"></option>
    </template>
  </select>
</div>
```

##### ãƒªãƒ³ã‚¯ä½œæˆã‚¿ãƒ–

```html
<!-- ã‚µãƒ¼ãƒ“ã‚¹é¸æŠã‚’è¿½åŠ  -->
<div class="form-group">
  <label>ã‚µãƒ¼ãƒ“ã‚¹ *</label>
  <select x-model="newLink.service_id" required>
    <option value="">ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠ</option>
    <template x-for="service in services" :key="service.id">
      <option :value="service.id" x-text="service.name"></option>
    </template>
  </select>
</div>

<!-- å ±é…¬ç‡è¡¨ç¤º -->
<div class="bg-blue-50 p-3 rounded" x-show="newLink.service_id">
  <p class="text-sm text-blue-800">
    ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã®å ±é…¬ç‡:
    <span x-text="`${getServiceCommissionRate(newLink.service_id)}%`"></span>
  </p>
</div>
```

##### ãƒªãƒ³ã‚¯ä¸€è¦§

```html
<!-- ã‚µãƒ¼ãƒ“ã‚¹ãƒãƒƒã‚¸è¿½åŠ  -->
<template x-for="link in trackingLinks" :key="link.id">
  <tr>
    <td>
      <!-- ã‚µãƒ¼ãƒ“ã‚¹ãƒãƒƒã‚¸ -->
      <span class="px-2 py-1 text-xs rounded-full"
            :style="`background: ${link.service_color}20; color: ${link.service_color}`"
            x-text="link.service_name"></span>
    </td>
    <td x-text="link.name"></td>
    <td>
      <a :href="link.url" target="_blank" class="text-blue-600">
        <span x-text="link.url"></span>
      </a>
    </td>
    <!-- ... -->
  </tr>
</template>
```

##### Analyticsã‚¿ãƒ–

```html
<!-- ã‚µãƒ¼ãƒ“ã‚¹æ¯”è¼ƒã‚°ãƒ©ãƒ•è¿½åŠ  -->
<div class="bg-white rounded-lg border p-6">
  <h3>ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
  <canvas id="serviceComparisonChart"></canvas>
</div>

<!-- æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é©ç”¨ -->
```

##### å ±é…¬ã‚¿ãƒ–

```html
<!-- ã‚µãƒ¼ãƒ“ã‚¹åˆ¥å ±é…¬å†…è¨³ -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <template x-for="service in services" :key="service.id">
    <div class="bg-white rounded-lg border p-4">
      <p class="text-sm text-gray-600" x-text="service.name"></p>
      <p class="text-2xl font-bold text-emerald-600 mt-2"
         x-text="`Â¥${getServiceCommission(service.id).toLocaleString()}`"></p>
      <p class="text-xs text-gray-500 mt-1"
         x-text="`å ±é…¬ç‡: ${service.commission_rate}%`"></p>
    </div>
  </template>
</div>
```

#### 7.1.4 JavaScriptå¤‰æ›´

```javascript
// dashboard.js

// åˆæœŸåŒ–æ™‚ã«ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§ã‚’å–å¾—
async init() {
  await this.loadServices();
  await this.login();
},

async loadServices() {
  try {
    const response = await fetch('/.netlify/functions/agency-services', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('agencyAuthToken')}`,
        'X-Agency-Id': localStorage.getItem('agencyId')
      }
    });

    if (response.ok) {
      const data = await response.json();
      this.services = data.services || [];

      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹é¸æŠã‚’å¾©å…ƒ
      const params = new URLSearchParams(window.location.search);
      this.selectedServiceId = params.get('service') || 'all';
    }
  } catch (error) {
    console.error('Error loading services:', error);
  }
},

// å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—æ™‚ã«ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
async loadDashboardData() {
  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ›´æ–°
  const url = new URL(window.location);
  url.searchParams.set('service', this.selectedServiceId);
  window.history.pushState({}, '', url);

  await Promise.all([
    this.loadStats(),
    this.loadLinks(),
    this.loadAnalytics(),
    this.loadCommissions()
  ]);
},

async loadStats() {
  const serviceParam = this.selectedServiceId !== 'all'
    ? `?service_id=${this.selectedServiceId}`
    : '';

  const response = await fetch(`/.netlify/functions/agency-stats${serviceParam}`, {
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('agencyAuthToken')}`,
      'X-Agency-Id': localStorage.getItem('agencyId')
    }
  });

  if (response.ok) {
    const data = await response.json();
    this.stats = data;
  }
},

// ã‚µãƒ¼ãƒ“ã‚¹ã®å ±é…¬ç‡å–å¾—
getServiceCommissionRate(serviceId) {
  const service = this.services.find(s => s.id === serviceId);
  return service?.commission_rate || 0;
},

// ã‚µãƒ¼ãƒ“ã‚¹åˆ¥å ±é…¬è¨ˆç®—
getServiceCommission(serviceId) {
  return this.commissions
    .filter(c => c.service_id === serviceId)
    .reduce((sum, c) => sum + c.amount, 0);
}
```

### 7.2 å„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

#### 7.2.1 ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè£…

**å¿…é ˆæ©Ÿèƒ½**: å„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã« `/t/:code` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…

##### Next.js ã®å ´åˆï¼ˆTaskMate AIï¼‰

```typescript
// app/t/[code]/page.tsx
import { redirect } from 'next/navigation';

export default async function TrackingRedirect({
  params
}: {
  params: { code: string }
}) {
  const { code } = params;

  try {
    // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°APIå‘¼ã³å‡ºã—
    const response = await fetch(
      `https://api.platform.com/.netlify/functions/track-redirect?code=${code}`,
      {
        headers: {
          'X-Forwarded-For': headers().get('x-forwarded-for') || '',
          'User-Agent': headers().get('user-agent') || ''
        }
      }
    );

    const data = await response.json();

    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆï¼ˆã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‹ã‚‰å–å¾—ï¼‰
    const redirectUrl = data.redirect_url || '/app';

    redirect(redirectUrl);
  } catch (error) {
    console.error('Tracking error:', error);
    redirect('/app'); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¢ãƒ—ãƒªãƒˆãƒƒãƒ—ã¸
  }
}
```

##### é™çš„HTML ã®å ´åˆï¼ˆService Bï¼‰

```html
<!-- newservice.com/t/index.html -->
<!DOCTYPE html>
<html>
<head>
  <title>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...</title>
  <script>
    // URLã‹ã‚‰ tracking_code å–å¾—
    const pathParts = window.location.pathname.split('/');
    const trackingCode = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];

    if (trackingCode && trackingCode !== 't') {
      // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°APIå‘¼ã³å‡ºã—
      fetch(`https://api.platform.com/.netlify/functions/track-redirect?code=${trackingCode}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          visitor_ip: '', // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§å–å¾—
          user_agent: navigator.userAgent,
          referrer: document.referrer
        })
      })
      .then(res => res.json())
      .then(data => {
        // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        window.location.href = data.redirect_url || '/';
      })
      .catch(err => {
        console.error('Tracking error:', err);
        window.location.href = '/';
      });
    } else {
      window.location.href = '/';
    }
  </script>
</head>
<body>
  <div style="text-align: center; padding: 50px;">
    <p>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...</p>
  </div>
</body>
</html>
```

#### 7.2.2 ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```javascript
// netlify/functions/track-redirect.js
exports.handler = async (event) => {
  const trackingCode = event.queryStringParameters?.code;

  if (!trackingCode) {
    return {
      statusCode: 400,
      body: JSON.stringify({ error: 'Missing tracking code' })
    };
  }

  try {
    // 1. ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯æ¤œç´¢
    const { data: link, error: linkError } = await supabase
      .from('agency_tracking_links')
      .select('id, agency_id, service_id')
      .eq('tracking_code', trackingCode)
      .single();

    if (linkError || !link) {
      return {
        statusCode: 404,
        body: JSON.stringify({ error: 'Tracking link not found' })
      };
    }

    // 2. ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±å–å¾—
    const { data: service } = await supabase
      .from('services')
      .select('app_redirect_url')
      .eq('id', link.service_id)
      .single();

    // 3. è¨ªå•è¨˜éŒ²
    const visitorIp = event.headers['x-forwarded-for'] || event.headers['client-ip'];
    const userAgent = event.headers['user-agent'];
    const sessionId = generateSessionId();

    await supabase
      .from('agency_tracking_visits')
      .insert({
        tracking_link_id: link.id,
        agency_id: link.agency_id,
        service_id: link.service_id,  // â† ã‚µãƒ¼ãƒ“ã‚¹IDè¨˜éŒ²
        visitor_ip: visitorIp,
        user_agent: userAgent,
        session_id: sessionId,
        // ...
      });

    // 4. visit_count ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    await supabase
      .from('agency_tracking_links')
      .update({
        visit_count: supabase.raw('visit_count + 1')
      })
      .eq('id', link.id);

    // 5. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆURLè¿”å´
    return {
      statusCode: 200,
      headers: {
        'Access-Control-Allow-Origin': '*'
      },
      body: JSON.stringify({
        redirect_url: service?.app_redirect_url || '/',
        session_id: sessionId
      })
    };

  } catch (error) {
    console.error('Tracking error:', error);
    return {
      statusCode: 500,
      body: JSON.stringify({ error: 'Internal server error' })
    };
  }
};
```

---

## 8. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆ

### 8.1 ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š

#### 8.1.1 Netlify Siteæ§‹æˆï¼ˆæ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰

```
Site 1: ä»£ç†åº—ç®¡ç† + å…±é€šAPI
â”œâ”€ Domain: agency.platform.com
â”œâ”€ Functions: /.netlify/functions/*
â”œâ”€ Deploy: netlify-tracking/
â””â”€ å½¹å‰²: ä»£ç†åº—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ + å…¨API

Site 2: TaskMate AI
â”œâ”€ Domain: taskmateai.net
â”œâ”€ Deploy: taskmate-ai/
â”œâ”€ APIå‘¼ã³å‡ºã—: agency.platform.com/.netlify/functions/*
â””â”€ å½¹å‰²: TaskMate ã‚¢ãƒ—ãƒª + ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

Site 3: Service B
â”œâ”€ Domain: newservice.com
â”œâ”€ Deploy: service-b/
â”œâ”€ APIå‘¼ã³å‡ºã—: agency.platform.com/.netlify/functions/*
â””â”€ å½¹å‰²: Service B ã‚¢ãƒ—ãƒª + ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- å„ã‚µãƒ¼ãƒ“ã‚¹å®Œå…¨ç‹¬ç«‹
- API ã¯1ç®‡æ‰€ã§ç®¡ç†
- ãƒ‡ãƒ—ãƒ­ã‚¤ã‚‚ç‹¬ç«‹

#### 8.1.2 DNSè¨­å®š

```
# ä»£ç†åº—ç®¡ç†
agency.platform.com  â†’  Netlify Site 1

# TaskMate AI
taskmateai.net       â†’  Netlify Site 2
www.taskmateai.net   â†’  taskmateai.net (CNAME)

# Service B
newservice.com       â†’  Netlify Site 3
www.newservice.com   â†’  newservice.com (CNAME)
```

### 8.2 ç’°å¢ƒå¤‰æ•°ç®¡ç†

#### 8.2.1 ä»£ç†åº—ç®¡ç†ã‚µã‚¤ãƒˆï¼ˆSite 1ï¼‰

```bash
# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJ...

# JWT
JWT_SECRET=xxx

# CORSï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
ALLOWED_ORIGINS=https://agency.platform.com,https://taskmateai.net,https://newservice.com
```

**é‡è¦**: LINEèªè¨¼æƒ…å ±ã¯**ç’°å¢ƒå¤‰æ•°ã«å…¥ã‚Œãªã„**ï¼ˆDBã‹ã‚‰å‹•çš„å–å¾—ï¼‰

#### 8.2.2 å„ã‚µãƒ¼ãƒ“ã‚¹ã‚µã‚¤ãƒˆï¼ˆSite 2, 3...ï¼‰

```bash
# ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°API URL
TRACKING_API_URL=https://agency.platform.com/.netlify/functions

# ã‚µãƒ¼ãƒ“ã‚¹å›ºæœ‰ã®è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
```

### 8.3 Netlifyè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

#### 8.3.1 ä»£ç†åº—ç®¡ç†ã‚µã‚¤ãƒˆï¼ˆnetlify.tomlï¼‰

```toml
[build]
  publish = "netlify-tracking/agency"
  functions = "netlify-tracking/netlify/functions"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

[[headers]]
  for = "/.netlify/functions/*"
  [headers.values]
    Access-Control-Allow-Origin = "*"
    Access-Control-Allow-Headers = "Content-Type, Authorization, X-Agency-Id, X-Line-Signature"
    Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"
```

#### 8.3.2 TaskMate AIã‚µã‚¤ãƒˆï¼ˆnetlify.tomlï¼‰

```toml
[build]
  command = "npm run build"
  publish = ".next"

[[redirects]]
  from = "/t/:code"
  to = "/t/[code]"
  status = 200

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
```

### 8.4 LINE Developersè¨­å®š

#### å„ã‚µãƒ¼ãƒ“ã‚¹ã®Webhook URLè¨­å®š

```
TaskMate AI:
â””â”€ Webhook URL: https://agency.platform.com/.netlify/functions/line-webhook?service=taskmate

Service B:
â””â”€ Webhook URL: https://agency.platform.com/.netlify/functions/line-webhook?service=serviceb

Service C:
â””â”€ Webhook URL: https://agency.platform.com/.netlify/functions/line-webhook?service=servicec
```

**æ³¨æ„**: `service` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã‚µãƒ¼ãƒ“ã‚¹è­˜åˆ¥ç”¨ï¼ˆname ã¾ãŸã¯slugï¼‰

---

## 9. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»

### 9.1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †

#### Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™

```sql
-- Step 1: æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
\i 001_create_services_table.sql
\i 002_create_agency_service_settings_table.sql
\i 003_create_line_profile_services_table.sql

-- Step 2: æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚«ãƒ©ãƒ è¿½åŠ 
ALTER TABLE agency_tracking_links ADD COLUMN service_id UUID;
ALTER TABLE agency_tracking_visits ADD COLUMN service_id UUID;
ALTER TABLE agency_conversions ADD COLUMN service_id UUID;
ALTER TABLE agency_commissions ADD COLUMN service_id UUID;

-- Step 3: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_agency_tracking_links_service ON agency_tracking_links(service_id);
CREATE INDEX idx_agency_tracking_visits_service ON agency_tracking_visits(service_id);
CREATE INDEX idx_agency_conversions_service ON agency_conversions(service_id);
CREATE INDEX idx_agency_commissions_service ON agency_commissions(service_id);
```

#### Phase 2: TaskMate AIç™»éŒ²ã¨ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ

```sql
-- Step 1: TaskMate AI ã‚’ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ç™»éŒ²
INSERT INTO services (
  id,
  name,
  description,
  domain,
  tracking_base_url,
  app_redirect_url,
  line_channel_id,
  line_channel_secret,
  line_channel_access_token,
  line_official_url,
  default_commission_rate,
  default_referral_rate,
  subscription_price,
  status
) VALUES (
  'b5e8f3c2-1a4d-4e9b-8f6a-2c3d4e5f6a7b',  -- å›ºå®šUUID
  'TaskMate AI',
  'AIæ­è¼‰ã®ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ',
  'taskmateai.net',
  'https://taskmateai.net/t',
  'https://taskmateai.net/app',
  '${LINE_CHANNEL_ID}',      -- ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
  '${LINE_CHANNEL_SECRET}',
  '${LINE_ACCESS_TOKEN}',
  'https://lin.ee/FMy4xlx',
  20.00,
  2.00,
  10000,
  'active'
);

-- Step 2: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã« service_id ã‚’è¨­å®š
UPDATE agency_tracking_links
SET service_id = 'b5e8f3c2-1a4d-4e9b-8f6a-2c3d4e5f6a7b'
WHERE service_id IS NULL;

UPDATE agency_tracking_visits
SET service_id = 'b5e8f3c2-1a4d-4e9b-8f6a-2c3d4e5f6a7b'
WHERE service_id IS NULL;

UPDATE agency_conversions
SET service_id = 'b5e8f3c2-1a4d-4e9b-8f6a-2c3d4e5f6a7b'
WHERE service_id IS NULL;

UPDATE agency_commissions
SET service_id = 'b5e8f3c2-1a4d-4e9b-8f6a-2c3d4e5f6a7b'
WHERE service_id IS NULL;

-- Step 3: NOT NULL åˆ¶ç´„è¿½åŠ 
ALTER TABLE agency_tracking_links ALTER COLUMN service_id SET NOT NULL;
ALTER TABLE agency_tracking_visits ALTER COLUMN service_id SET NOT NULL;
ALTER TABLE agency_conversions ALTER COLUMN service_id SET NOT NULL;
ALTER TABLE agency_commissions ALTER COLUMN service_id SET NOT NULL;

-- Step 4: æ—¢å­˜ä»£ç†åº—ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½œæˆ
INSERT INTO agency_service_settings (agency_id, service_id, is_active)
SELECT
  id AS agency_id,
  'b5e8f3c2-1a4d-4e9b-8f6a-2c3d4e5f6a7b' AS service_id,
  true AS is_active
FROM agencies
WHERE status = 'active';
```

#### Phase 3: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIä¿®æ­£

```
ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ¨å®š15ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰:
âœ… line-webhook.js
âœ… track-redirect.js
âœ… agency-create-link.js
âœ… agency-stats.js
âœ… agency-analytics.js
âœ… agency-commissions.js
âœ… agency-billing-stats.js
âœ… agency-link-visits.js
âœ… agency-referral-users.js
... ãã®ä»–

ä¿®æ­£å†…å®¹:
1. service_id ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¿½åŠ 
2. WHEREå¥ã« service_id æ¡ä»¶è¿½åŠ 
3. ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã®å‹•çš„å–å¾—
```

#### Phase 4: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¿®æ­£

```
ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:
âœ… dashboard.js
   - services é…åˆ—è¿½åŠ 
   - selectedServiceId è¿½åŠ 
   - loadServices() å®Ÿè£…
   - å…¨APIå‘¼ã³å‡ºã—ã«service_idãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ 

âœ… index.html
   - ã‚µãƒ¼ãƒ“ã‚¹é¸æŠUIè¿½åŠ 
   - ã‚µãƒ¼ãƒ“ã‚¹ãƒãƒƒã‚¸è¡¨ç¤º
   - ã‚µãƒ¼ãƒ“ã‚¹åˆ¥è‰²åˆ†ã‘
```

#### Phase 5: ãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒ—ãƒ­ã‚¤

```
1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆ
   âœ… æ—¢å­˜æ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹ã‹ï¼ˆTaskMate AIï¼‰
   âœ… ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãŒå‹•ä½œã™ã‚‹ã‹

2. ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
   âœ… æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ç¢ºèª
   âœ… å…¨APIå‹•ä½œç¢ºèª

3. æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
   âœ… ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãªã—ã§ãƒ‡ãƒ—ãƒ­ã‚¤
   âœ… æ—¢å­˜ä»£ç†åº—ã¸ã®å½±éŸ¿ãªã—ç¢ºèª
```

### 9.2 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

```sql
-- ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨SQL

-- Step 1: NOT NULLåˆ¶ç´„å‰Šé™¤
ALTER TABLE agency_tracking_links ALTER COLUMN service_id DROP NOT NULL;
ALTER TABLE agency_tracking_visits ALTER COLUMN service_id DROP NOT NULL;
ALTER TABLE agency_conversions ALTER COLUMN service_id DROP NOT NULL;
ALTER TABLE agency_commissions ALTER COLUMN service_id DROP NOT NULL;

-- Step 2: service_id ã‚«ãƒ©ãƒ å‰Šé™¤ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰
-- ALTER TABLE agency_tracking_links DROP COLUMN service_id;
-- ALTER TABLE agency_tracking_visits DROP COLUMN service_id;
-- ALTER TABLE agency_conversions DROP COLUMN service_id;
-- ALTER TABLE agency_commissions DROP COLUMN service_id;

-- Step 3: æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰
-- DROP TABLE line_profile_services;
-- DROP TABLE agency_service_settings;
-- DROP TABLE services;
```

---

## 10. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### 10.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

- [ ] `services` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `agency_service_settings` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `line_profile_services` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã« `service_id` ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆ4ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆ8å€‹ï¼‰
- [ ] TaskMate AI ãƒ‡ãƒ¼ã‚¿ç™»éŒ²
- [ ] æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã« `service_id` è¨­å®š
- [ ] NOT NULL åˆ¶ç´„è¿½åŠ 
- [ ] æ—¢å­˜ä»£ç†åº—ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šä½œæˆ

### 10.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API

- [ ] `line-webhook.js` - ã‚µãƒ¼ãƒ“ã‚¹å‹•çš„å–å¾—ã€ç½²åæ¤œè¨¼ä¿®æ­£
- [ ] `track-redirect.js` - service_id è¨˜éŒ²
- [ ] `agency-create-link.js` - ã‚µãƒ¼ãƒ“ã‚¹é¸æŠå¯¾å¿œ
- [ ] `agency-stats.js` - ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ 
- [ ] `agency-analytics.js` - ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ 
- [ ] `agency-commissions.js` - ã‚µãƒ¼ãƒ“ã‚¹åˆ¥å ±é…¬è¨ˆç®—
- [ ] `agency-billing-stats.js` - ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ 
- [ ] `agency-link-visits.js` - ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ 
- [ ] `agency-referral-users.js` - ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ 
- [ ] **æ–°è¦** `agency-services.js` - ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§API
- [ ] å…¨APIé–¢æ•°ã® CORS è¨­å®šæ›´æ–°

### 10.3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆä»£ç†åº—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰

- [ ] `dashboard.js` - services, selectedServiceId è¿½åŠ 
- [ ] `dashboard.js` - loadServices() å®Ÿè£…
- [ ] `dashboard.js` - å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã«ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
- [ ] `index.html` - ã‚µãƒ¼ãƒ“ã‚¹é¸æŠUIheaderè¿½åŠ 
- [ ] `index.html` - ãƒªãƒ³ã‚¯ä½œæˆã‚¿ãƒ–ã«ã‚µãƒ¼ãƒ“ã‚¹é¸æŠè¿½åŠ 
- [ ] `index.html` - ãƒªãƒ³ã‚¯ä¸€è¦§ã«ã‚µãƒ¼ãƒ“ã‚¹ãƒãƒƒã‚¸è¿½åŠ 
- [ ] `index.html` - Analyticsã‚¿ãƒ–ã«ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ 
- [ ] `index.html` - å ±é…¬ã‚¿ãƒ–ã«ã‚µãƒ¼ãƒ“ã‚¹åˆ¥å†…è¨³è¿½åŠ 

### 10.4 å„ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

- [ ] TaskMate AI - `/t/[code]` ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè£…
- [ ] Service B - `/t/:code` ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè£…ï¼ˆå°†æ¥ï¼‰

### 10.5 ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤

- [ ] Netlify Site 1ï¼ˆä»£ç†åº—ç®¡ç†ï¼‰ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š
- [ ] Netlify Site 2ï¼ˆTaskMateï¼‰ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š
- [ ] DNS ãƒ¬ã‚³ãƒ¼ãƒ‰è¨­å®š
- [ ] SSLè¨¼æ˜æ›¸è¨­å®š
- [ ] ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆå„ã‚µã‚¤ãƒˆï¼‰
- [ ] LINE Developers Webhook URLè¨­å®šï¼ˆå„ã‚µãƒ¼ãƒ“ã‚¹ï¼‰

### 10.6 ãƒ†ã‚¹ãƒˆ

- [ ] æ—¢å­˜æ©Ÿèƒ½å›å¸°ãƒ†ã‚¹ãƒˆ
- [ ] ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‹•ä½œç¢ºèª
- [ ] ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ç”Ÿæˆãƒ»è¨˜éŒ²ãƒ†ã‚¹ãƒˆ
- [ ] Webhookå—ä¿¡ãƒ†ã‚¹ãƒˆï¼ˆå„ã‚µãƒ¼ãƒ“ã‚¹ï¼‰
- [ ] å ±é…¬è¨ˆç®—ãƒ†ã‚¹ãƒˆï¼ˆã‚µãƒ¼ãƒ“ã‚¹åˆ¥å ±é…¬ç‡ï¼‰
- [ ] CORSå‹•ä½œç¢ºèª

---

## 11. ãƒªã‚¹ã‚¯åˆ†æ

### 11.1 æŠ€è¡“ãƒªã‚¹ã‚¯

| ãƒªã‚¹ã‚¯ | å½±éŸ¿åº¦ | ç™ºç”Ÿç¢ºç‡ | å¯¾ç­– |
|-------|-------|---------|------|
| æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå¤±æ•— | é«˜ | ä½ | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»ç­–å®š |
| LINEç½²åæ¤œè¨¼ã‚¨ãƒ©ãƒ¼ | é«˜ | ä¸­ | ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã®æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆå¼·åŒ– |
| CORSè¨­å®šãƒŸã‚¹ | ä¸­ | ä¸­ | è¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒªã‚¹ãƒˆæ˜ç¢ºåŒ–ã€ãƒ†ã‚¹ãƒˆ |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ– | ä¸­ | ä½ | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–ã€ã‚¯ã‚¨ãƒªæœ€é©åŒ– |
| service_id NULLæ®‹å­˜ | é«˜ | ä½ | NOT NULLåˆ¶ç´„å‰ã®å®Œå…¨ãƒã‚§ãƒƒã‚¯ |

### 11.2 é‹ç”¨ãƒªã‚¹ã‚¯

| ãƒªã‚¹ã‚¯ | å½±éŸ¿åº¦ | ç™ºç”Ÿç¢ºç‡ | å¯¾ç­– |
|-------|-------|---------|------|
| ä»£ç†åº—ã®æ··ä¹± | ä¸­ | ä¸­ | äº‹å‰é€šçŸ¥ã€æ“ä½œã‚¬ã‚¤ãƒ‰ä½œæˆ |
| LINE Webhookè¨­å®šãƒŸã‚¹ | é«˜ | ä¸­ | è¨­å®šãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ |
| å ±é…¬è¨ˆç®—ãƒŸã‚¹ | é«˜ | ä½ | è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯äºŒé‡ãƒã‚§ãƒƒã‚¯ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ |
| ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ æ™‚ã®è¨­å®šæ¼ã‚Œ | ä¸­ | ä¸­ | ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€è‡ªå‹•åŒ– |

### 11.3 ãƒ“ã‚¸ãƒã‚¹ãƒªã‚¹ã‚¯

| ãƒªã‚¹ã‚¯ | å½±éŸ¿åº¦ | ç™ºç”Ÿç¢ºç‡ | å¯¾ç­– |
|-------|-------|---------|------|
| è¤‡é›‘åŒ–ã«ã‚ˆã‚‹ä¿å®ˆã‚³ã‚¹ãƒˆå¢— | ä¸­ | é«˜ | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™ã€ã‚³ãƒ¼ãƒ‰æ¨™æº–åŒ– |
| ã‚¹ã‚±ãƒ¼ãƒ«æ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | ä¸­ | ä¸­ | å®šæœŸçš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ |

---

## 12. ä»˜éŒ²

### 12.1 ç”¨èªé›†

| ç”¨èª | å®šç¾© |
|-----|------|
| ã‚µãƒ¼ãƒ“ã‚¹ | LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒã¤ç‹¬ç«‹ã—ãŸãƒ—ãƒ­ãƒ€ã‚¯ãƒˆï¼ˆä¾‹: TaskMate AIï¼‰ |
| ä»£ç†åº— | ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç´¹ä»‹ã—ã¦ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’å¾—ã‚‹ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ |
| ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ | ä»£ç†åº—ãŒç”Ÿæˆã™ã‚‹è¨ˆæ¸¬ç”¨URL |
| ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | LINEå‹é”è¿½åŠ ã¾ãŸã¯èª²é‡‘ç™»éŒ² |
| å ±é…¬ç‡ | ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¯¾ã™ã‚‹ä»£ç†åº—ã®ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ç‡ |
| ãƒªãƒ•ã‚¡ãƒ©ãƒ«å ±é…¬ | å‚˜ä¸‹ä»£ç†åº—ã®æˆæœã«å¯¾ã™ã‚‹å ±é…¬ |

### 12.2 æƒ³å®šFAQ

**Q1: æ—¢å­˜ã®ä»£ç†åº—ã«å½±éŸ¿ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ**
A: ã‚ã‚Šã¾ã›ã‚“ã€‚æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«TaskMate AIã‚µãƒ¼ãƒ“ã‚¹ã«ç´ä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚

**Q2: æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¿½åŠ ã™ã‚‹æ‰‹é †ã¯ï¼Ÿ**
A:
1. Supabase ã® `services` ãƒ†ãƒ¼ãƒ–ãƒ«ã«1ãƒ¬ã‚³ãƒ¼ãƒ‰è¿½åŠ 
2. å„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã« `/t/:code` ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè£…
3. LINE Developers ã§Webhook URLè¨­å®š

**Q3: ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«å ±é…¬ç‡ã‚’å¤‰ãˆã‚‰ã‚Œã¾ã™ã‹ï¼Ÿ**
A: ã¯ã„ã€‚`agency_service_settings` ã§ä»£ç†åº—Ã—ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«è¨­å®šå¯èƒ½ã§ã™ã€‚

**Q4: æ—¢å­˜ã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ã¯ä½¿ãˆã¾ã™ã‹ï¼Ÿ**
A: ã¯ã„ã€‚ã™ã¹ã¦TaskMate AIã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å‹•ä½œã—ã¾ã™ã€‚

**Q5: ä»£ç†åº—ã¯è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åŒæ™‚ã«æ‰±ãˆã¾ã™ã‹ï¼Ÿ**
A: ã¯ã„ã€‚1ã¤ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç®¡ç†ã§ãã¾ã™ã€‚

### 12.3 å‚è€ƒè³‡æ–™

- [LINE Messaging API Documentation](https://developers.line.biz/ja/docs/messaging-api/)
- [Supabase Documentation](https://supabase.com/docs)
- [Netlify Functions Documentation](https://docs.netlify.com/functions/overview/)

---

## å¤‰æ›´å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ | ä½œæˆè€… |
|----------|------|---------|-------|
| 1.0 | 2025-01-21 | åˆç‰ˆä½œæˆ | Claude Code |

---

**è¨­è¨ˆæ›¸çµ‚äº†**

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
